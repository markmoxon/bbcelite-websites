<?php
include_once("../../templates/template_functions.php");
page_header("all_source", "the_sentinel_c.html", "The Sentinel C source", "The Sentinel C source", "The The Sentinel C source file in The Sentinel", "the_sentinel-index", "source_all_source", "the_sentinel_c", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/all/the_sentinel_b.html">The Sentinel B source</a><a class="next" rel="next" title="Next routine" href="/source/all/the_sentinel_d.html">The Sentinel D source</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div><div><div class="headerBlockWrapper"><div class="headerBlock"><a id="header-checkenemygaze-part-1-of-2" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">CheckEnemyGaze (Part 1 of 2)</span>                            <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Check to see whether the current enemy can see a specific target</span>
             <span class="headerEntry">object of a specific type</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/checkenemygaze_part_1_of_2.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_2_of_8.html">ApplyTactics (Part 2 of 8)</a> calls <a href="#checkenemygaze">CheckEnemyGaze</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_5_of_8.html">ApplyTactics (Part 5 of 8)</a> calls <a href="#checkenemygaze">CheckEnemyGaze</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/findobjecttodrain.html">FindObjectToDrain</a> calls <a href="#checkenemygaze">CheckEnemyGaze</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/scanformeanietree.html">ScanForMeanieTree</a> calls <a href="#checkenemygaze">CheckEnemyGaze</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The type of the object to match against the target (this</span>
                        <span class="argumentEntry">ensures that we only perform the gaze calculations when</span>
                        <span class="argumentEntry">the target object is of this type; if it isn't, the</span>
                        <span class="argumentEntry">routine aborts without doing the calculations)</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">The number of the target object to analyse</span>

   <span class="argumentLabel">viewingObject</span>        <span class="argumentEntry">The viewing object (i.e. the enemy doing the scanning)</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">targetVisibility</span>     <span class="argumentEntry">The target visibility result:</span>

                        <span class="argumentEntry">  * If the target object is a robot, then bit 6 will be</span>
                        <span class="argumentEntry">    set if the robot object can be seen, even if the</span>
                        <span class="argumentEntry">    robot's tile can't be seen</span>

                        <span class="argumentEntry">  * Bit 7 will be set if the enemy can see the target</span>
                        <span class="argumentEntry">    object's tile</span>

   <span class="argumentLabel">treeVisibility</span>       <span class="argumentEntry">The tree visibility result:</span>

                        <span class="argumentEntry">  * If the target object is a robot, then bit 6 will be</span>
                        <span class="argumentEntry">    set if there is a tree blocking the view of the</span>
                        <span class="argumentEntry">    robot object</span>

                        <span class="argumentEntry">  * Bit 7 will be set if there is a tree blocking the</span>
                        <span class="argumentEntry">    view of the target object's tile</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag (though note that this is ignored for every</span>
                        <span class="argumentEntry">call to this routine):</span>

                        <span class="argumentEntry">  * Clear if the target object does not exist, or is not</span>
                        <span class="argumentEntry">    of the specified type, or the object is in the</span>
                        <span class="argumentEntry">    viewing arc</span>

                        <span class="argumentEntry">  * Set if the target object is not within the viewing</span>
                        <span class="argumentEntry">    arc of the enemy</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">X is preserved</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">Y is preserved</span>

</div></div>
<span class="label">.CheckEnemyGaze</span><a id="checkenemygaze" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ Store the object type in T so we can refer to it later</span>

 <span class="mne">STX</span> <a class="popup variable">xStoreEnemyGaze</a>    <span class="comment">\ Store X in xStoreEnemyGaze so it can be preserved</span>
                        <span class="comment">\ across calls to the routine</span>

 <span class="mne">STY</span> <a class="popup variable">targetObject</a>       <span class="comment">\ Store the target object in targetObject, so object #Y</span>
                        <span class="comment">\ is the target object</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Clear all bits of targetVisibility so we can set them</span>
 <span class="mne">STA</span> <a class="popup variable">targetVisibility</a>   <span class="comment">\ later with the results of the analysis</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ If bit 7 is set for object #Y then this object number</span>
 <span class="mne">BMI</span> <a class="popup destination">egaz3</a>              <span class="comment">\ is not allocated to an object, so jump to egaz3 to</span>
                        <span class="comment">\ return from the subroutine with the C flag clear to</span>
                        <span class="comment">\ indicate that the target object can't be seen by the</span>
                        <span class="comment">\ enemy</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ If object #Y is not an object of type T (which we set</span>
 <span class="mne">CMP</span> <a class="popup variable">T</a>                  <span class="comment">\ to the argument A above), then jump to egaz3 to return</span>
 <span class="mne">BNE</span> <a class="popup destination">egaz3</a>              <span class="comment">\ from the subroutine with the C flag clear to indicate</span>
                        <span class="comment">\ that the target object is of the wrong type</span>

 <span class="mne">JSR</span> <a class="popup destination">GetObjectAngles</a>    <span class="comment">\ Calculate the angles and distances of the vector from</span>
                        <span class="comment">\ the viewer to object #Y and put them into the</span>
                        <span class="comment">\ following variables:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Set objTypeToAnalyse to the type of object #Y</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Set objectViewYaw(Hi Lo) to the yaw angle of the</span>
                        <span class="comment">\     viewer's gaze towards the object, relative to the</span>
                        <span class="comment">\     screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Set angle(Hi Lo) to the angle of the hypotenuse of</span>
                        <span class="comment">\     the triangle formed by the x-axis and z-axis,</span>
                        <span class="comment">\     which is the projection of the 3D vector from the</span>
                        <span class="comment">\     viewer to the object down onto the ground plane</span>
                        <span class="comment">\     (so imagine a light shining down from above,</span>
                        <span class="comment">\     casting the vector's shadow onto the y = 0 plane,</span>
                        <span class="comment">\     and that's the hypotenuse)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Set hypotenuse(Hi Lo) to the length of the 3D</span>
                        <span class="comment">\     vector from the viewer to the object when</span>
                        <span class="comment">\     projected down onto the ground plane</span>
                        <span class="comment">\</span>
                        <span class="comment">\  * Set yDelta(Hi Lo) to the difference (the delta) in</span>
                        <span class="comment">\    the y-axis between the viewer and the object we are</span>
                        <span class="comment">\    analysing, so this gives us the altitude difference</span>
                        <span class="comment">\    between the viewer and the object</span>

                        <span class="comment">\ We now have a very short interlude to set up some of</span>
                        <span class="comment">\ the anti-cracker code before continuing in part 2</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-altercrackerseed" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">AlterCrackerSeed</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Cracker protection</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Create an altered version of the anti-cracker seed-related data,</span>
             <span class="headerEntry">as part of the anti-cracker code</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/altercrackerseed.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.AlterCrackerSeed</span><a id="altercrackerseed" class="anchor"></a>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">7</span>                 <span class="comment">\ Set X = 7, to add to the cracker seed when its last</span>
                        <span class="comment">\ digit is 9, so we effectively add 700 to the</span>
                        <span class="comment">\ landscape number</span>

 <span class="mne">LDA</span> <a class="popup variable">CrackerSeed</a><span class="operator">+</span><span class="decimal">1</span><span class="operator">-</span><span class="decimal">7</span>,<span class="register">X</span>  <span class="comment">\ Set T to the contents of CrackerSeed+1, which we set</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ in the SetCrackerSeed routine to the high byte of the</span>
                        <span class="comment">\ binary coded decimal (BCD) landscape number</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So if the landscape number 0123, T contains 01 in BCD</span>
                        <span class="comment">\ format</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00001111</span>         <span class="comment">\ Set A to the second digit in the BCD landscape number</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">9</span>                 <span class="comment">\ If the second digit in the BCD number is 9, skip the</span>
 <span class="mne">BEQ</span> <a class="popup destination">alts1</a>              <span class="comment">\ following instruction so that X stays set to 7</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Otherwise set X = 1, for when the second digit is in</span>
                        <span class="comment">\ the range 0 to 8, so we effectively add 100 to the</span>
                        <span class="comment">\ landscape number</span>

<span class="label">.alts1</span><a id="alts1" class="anchor"></a>

 <span class="mne">TXA</span>                    <span class="comment">\ Set alteredSeed = T + X</span>
 <span class="mne">CLC</span>                    <span class="comment">\</span>
 <span class="mne">ADC</span> <a class="popup variable">T</a>                  <span class="comment">\ Note that this addition is not done in BCD mode, so we</span>
 <span class="mne">STA</span> <a class="popup variable">alteredSeed</a>        <span class="comment">\ know that the following is true:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   alteredSeed > T</span>
                        <span class="comment">\</span>
                        <span class="comment">\ so:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   alteredSeed > CrackerSeed+1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ as the largest possible value of T is &99 when the</span>
                        <span class="comment">\ value of X is the largest possible at 7, and:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   &99 + 7 = &A0</span>
                        <span class="comment">\</span>
                        <span class="comment">\ so the addition never overflows and the result in</span>
                        <span class="comment">\ alteredSeed is greater than the original high byte in</span>
                        <span class="comment">\ CrackerSeed+1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This fact is used in the CheckCrackerSeed routine to</span>
                        <span class="comment">\ ensure that this part of the anti-cracker code has</span>
                        <span class="comment">\ been run correctly</span>

                        <span class="comment">\ Fall through into part 2 of CheckEnemyGaze to continue</span>
                        <span class="comment">\ checking the enemy's gaze</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-checkenemygaze-part-2-of-2" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">CheckEnemyGaze (Part 2 of 2)</span>                            <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate whether the current enemy can see the specified object</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/checkenemygaze_part_2_of_2.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
 <span class="mne">LDA</span> <a class="popup variable">enemyViewingArc</a>    <span class="comment">\ Set T = enemyViewingArc / 2</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ So T is the yaw width of half the enemy's viewing arc,</span>
                        <span class="comment">\ which is always 10 as enemyViewingArc is only ever set</span>
                        <span class="comment">\ to 20</span>

 <span class="mne">LDA</span> <a class="popup variable">objectViewYawHi</a>    <span class="comment">\ Set A = objectViewYawHi - 10 + T</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\ This sets A to the yaw angle of the viewer's gaze</span>
 <span class="mne">CLC</span>                    <span class="comment">\ towards the object, but relative to the enemy's</span>
 <span class="mne">ADC</span> <a class="popup variable">T</a>                  <span class="comment">\ viewing arc rather than the screen</span>

 <span class="mne">CMP</span> <a class="popup variable">enemyViewingArc</a>    <span class="comment">\ If A >= enemyViewingArc then the enemy's gaze towards</span>
 <span class="mne">BCS</span> <a class="popup destination">egaz4</a>              <span class="comment">\ the target object falls outside the viewing arc, so</span>
                        <span class="comment">\ the enemy can't see the target object, so jump to</span>
                        <span class="comment">\ egaz4 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set to indicate that the target object can't be seen</span>

 <span class="mne">LDA</span> <a class="popup variable">angleLo</a>            <span class="comment">\ Set vectorYawAngle(Hi Lo) = angle(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">vectorYawAngleLo</a>   <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">angleHi</a>            <span class="comment">\ So vectorYawAngle(Hi Lo) is the yaw angle of the enemy</span>
 <span class="mne">STA</span> <a class="popup variable">vectorYawAngleHi</a>   <span class="comment">\ gaze towards the object, as taken from the triangle on</span>
                        <span class="comment">\ the ground</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ Set gazeCheckCounter = 2 so we perform the gaze check</span>
 <span class="mne">STA</span> <a class="popup variable">gazeCheckCounter</a>   <span class="comment">\ twice in the loop below, once for the gaze from the</span>
                        <span class="comment">\ enemy to the target object, and once for the gaze from</span>
                        <span class="comment">\ the enemy to the target object's tile</span>

 <span class="mne">LDA</span> <a class="popup variable">objTypeToAnalyse</a>   <span class="comment">\ Set A to the type of object #Y, i.e. the object being</span>
                        <span class="comment">\ looked at by the enemy, which was set by the call to</span>
                        <span class="comment">\ GetObjectAngles above</span>

 <span class="mne">BNE</span> <a class="popup destination">egaz2</a>              <span class="comment">\ If the enemy is not looking at a robot (an object of</span>
                        <span class="comment">\ type 0), then jump to egaz2 to skip the first check</span>
                        <span class="comment">\ against the target object and move on to checking the</span>
                        <span class="comment">\ target object's tile</span>

                        <span class="comment">\ If we get here then the enemy is looking towards a</span>
                        <span class="comment">\ robot, so we now check whether the enemy can actually</span>
                        <span class="comment">\ see the robot object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The results will end up in bit 6 of targetVisibility</span>
                        <span class="comment">\ and treeVisibility, as the first pass will rotate the</span>
                        <span class="comment">\ results into bit 7 of the result variables, and the</span>
                        <span class="comment">\ second pass will then rotate this first result down</span>
                        <span class="comment">\ into bit 6</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set bit 7 of enemyCheckingRobot so the call to the</span>
 <span class="mne">ROR</span> <a class="popup variable">enemyCheckingRobot</a> <span class="comment">\ FollowGazeVector routine below will know that the</span>
                        <span class="comment">\ enemy is looking towards a robot</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This tells FollowGazeVector to return a positive</span>
                        <span class="comment">\ result for looking at the robot even when the viewer</span>
                        <span class="comment">\ is lower than the robot, so even though the enemy</span>
                        <span class="comment">\ can't see the tile that the robot is standing on, it</span>
                        <span class="comment">\ will still record that the enemy can see the robot</span>
                        <span class="comment">\ object (so the robot is partially visible and we can</span>
                        <span class="comment">\ use this to fill in the scanner halfway)</span>

 <span class="mne">LDA</span> <a class="popup variable">yDeltaLo</a>           <span class="comment">\ Set (A xDeltaLo) = yDelta(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">xDeltaLo</a>           <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">yDeltaHi</a>           <span class="comment">\ The call to GetObjectAngles set yDelta(Hi Lo) to the</span>
                        <span class="comment">\ difference in altitude between the enemy and the</span>
                        <span class="comment">\ object, so we put this into (A xDeltaLo) to pass to</span>
                        <span class="comment">\ GetPitchAngleDelta to calculate the pitch angle of the</span>
                        <span class="comment">\ gaze from the enemy to the object</span>

                        <span class="comment">\ Because the enemy is looking towards a robot, we do</span>
                        <span class="comment">\ the following loop twice, using the counter we set in</span>
                        <span class="comment">\ gazeCheckCounter</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The first time we follow the gaze from the enemy to</span>
                        <span class="comment">\ the target object, and the second time we follow the</span>
                        <span class="comment">\ gaze from the enemy to the target object's tile</span>

<span class="label">.egaz1</span><a id="egaz1" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">GetPitchAngleDelta</a> <span class="comment">\ Set angle(Hi Lo) to the pitch angle of the vector</span>
                        <span class="comment">\ along the hypotenuse of the vertical pitch angle</span>
                        <span class="comment">\ triangle, given a vertical opposite side of length</span>
                        <span class="comment">\ (A xDeltaLo) and an adjacent side along the ground of</span>
                        <span class="comment">\ length hypotenuse(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we now have the pitch angle of the vector from the</span>
                        <span class="comment">\ enemy to the object</span>

 <span class="mne">LDA</span> <a class="popup variable">angleLo</a>            <span class="comment">\ Set vectorPitchAngle(Hi Lo) = angle(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">vectorPitchAngleLo</a> <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ So vectorYawAngle(Hi Lo) is the pitch angle of the</span>
 <span class="mne">LDA</span> <a class="popup variable">angleHi</a>            <span class="comment">\ enemy towards the object, as taken from the vertical</span>
 <span class="mne">STA</span> <a class="popup variable">vectorPitchAngleHi</a> <span class="comment">\ triangle with the gaze vector as the hypotenuse</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This also sets T to the low byte in vectorPitchAngleLo</span>

 <span class="mne">JSR</span> <a class="popup destination">GetVectorForAngles</a> <span class="comment">\ Convert the pitch and yaw angles of the enemy's gaze</span>
                        <span class="comment">\ vector towards the object:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   vectorPitchAngle(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   vectorYawAngle(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ into a cartesian vector:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xVector(Lo Bot) ]</span>
                        <span class="comment">\   [ yVector(Lo Bot) ]</span>
                        <span class="comment">\   [ zVector(Lo Bot) ]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this is the gaze vector from the enemy to the</span>
                        <span class="comment">\ object we are checking</span>

 <span class="mne">JSR</span> <a class="popup destination">FollowGazeVector</a>   <span class="comment">\ Follow the gaze vector from the viewing object to</span>
                        <span class="comment">\ determine whether the enemy can see a flat tile or</span>
                        <span class="comment">\ platform (i.e. boulder or tower) or the target object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This sets the C flag as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Clear if the viewing object can see a tile along</span>
                        <span class="comment">\     the gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Set if the viewing object can't see a tile along</span>
                        <span class="comment">\     the gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It also sets bit 7 of targetOnTile depending on</span>
                        <span class="comment">\ whether the gaze vector can see a tile containing the</span>
                        <span class="comment">\ object whose number is in targetObject:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bit 7 clear = gaze vector cannot see the target</span>
                        <span class="comment">\                   object</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bit 7 set = gaze vector can see the target object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and if the gaze cannot see the target, then bit 7 of</span>
                        <span class="comment">\ gazeCanSeeTree is set depending on whether the gaze</span>
                        <span class="comment">\ vector can see a tree:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bit 7 clear = gaze vector cannot see a tree</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bit 7 set = gaze vector can see a tree</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If we call this with bit 7 of enemyCheckingRobot set,</span>
                        <span class="comment">\ which we do on the first pass when the enemy is</span>
                        <span class="comment">\ looking at a robot, then this will return a positive</span>
                        <span class="comment">\ response even if the enemy is at a lower altitude than</span>
                        <span class="comment">\ the robot and can't see the tile that the robot is on,</span>
                        <span class="comment">\ so this lets us record partial visibility of robots</span>

                        <span class="comment">\ The following rotations ensure that we record the</span>
                        <span class="comment">\ results correctly in the targetVisibility and</span>
                        <span class="comment">\ treeVisibility variables:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If the enemy is looking at a robot then they will</span>
                        <span class="comment">\     ensure that bit 6 records the results when looking</span>
                        <span class="comment">\     at the robot, and bit 7 records the results when</span>
                        <span class="comment">\     looking at the robot's tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If the enemy is not looking at a robot then they</span>
                        <span class="comment">\     will ensure that bit 7 records the results of</span>
                        <span class="comment">\     looking at the target object's tile</span>

 <span class="mne">ROL</span> <a class="popup variable">targetOnTile</a>       <span class="comment">\ Rotate bit 7 of targetOnTile into bit 7 of</span>
 <span class="mne">ROR</span> <a class="popup variable">targetVisibility</a>   <span class="comment">\ targetVisibility</span>

 <span class="mne">ROL</span> <a class="popup variable">gazeCanSeeTree</a>     <span class="comment">\ Rotate bit 7 of gazeCanSeeTree into bit 7 of</span>
 <span class="mne">ROR</span> <a class="popup variable">treeVisibility</a>     <span class="comment">\ treeVisibility</span>

<span class="label">.egaz2</span><a id="egaz2" class="anchor"></a>

 <span class="mne">LSR</span> <a class="popup variable">enemyCheckingRobot</a> <span class="comment">\ Clear bit 7 of enemyCheckingRobot to pass to the next</span>
                        <span class="comment">\ call to FollowGazeVector, so it returns results for</span>
                        <span class="comment">\ the tile visibility rather than the object itself (so</span>
                        <span class="comment">\ this will be on the second call if we are looking at a</span>
                        <span class="comment">\ robot, or the only call if we are not looking at a</span>
                        <span class="comment">\ robot)</span>

 <span class="mne">LDA</span> <a class="popup variable">yDeltaLo</a>           <span class="comment">\ Set (A xDeltaLo) = yDelta(Hi Lo) - &E0</span>
 <span class="mne">SEC</span>                    <span class="comment">\                  = yDelta(Hi Lo) - 224</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&E0</span>               <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">xDeltaLo</a>           <span class="comment">\ The object is spawned at a y-coordinate of 224 above</span>
 <span class="mne">LDA</span> <a class="popup variable">yDeltaHi</a>           <span class="comment">\ the tile, so this sets (A xDeltaLo) to the altitude of</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&00</span>               <span class="comment">\ the target object's tile rather than the target object</span>
                        <span class="comment">\ itself</span>

 <span class="mne">DEC</span> <a class="popup variable">gazeCheckCounter</a>   <span class="comment">\ Decrement the loop counter in gazeCheckCounter</span>

 <span class="mne">BNE</span> <a class="popup destination">egaz1</a>              <span class="comment">\ Loop back to repeat the check, but this time using the</span>
                        <span class="comment">\ gaze vector from the enemy to the target object's tile</span>

<span class="label">.egaz3</span><a id="egaz3" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to return from the subroutine to</span>
                        <span class="comment">\ indicate that we have performed the gaze checks</span>

<span class="label">.egaz4</span><a id="egaz4" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">xStoreEnemyGaze</a>    <span class="comment">\ Restore the value of X from xStoreEnemyGaze that we</span>
                        <span class="comment">\ stored at the start of the routine, so that it's</span>
                        <span class="comment">\ preserved</span>

 <span class="mne">LDY</span> <a class="popup variable">targetObject</a>       <span class="comment">\ Set Y to targetObject so that Y is preserved</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-xstoreenemygaze" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">xStoreEnemyGaze</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Variable</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Temporary storage for X so it can be preserved through calls to</span>
             <span class="headerEntry">CheckEnemyGaze</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this variable <a href="/source/main/variable/xstoreenemygaze.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This variable is used as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkenemygaze_part_1_of_2.html">CheckEnemyGaze (Part 1 of 2)</a> uses <a href="#xstoreenemygaze">xStoreEnemyGaze</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkenemygaze_part_2_of_2.html">CheckEnemyGaze (Part 2 of 2)</a> uses <a href="#xstoreenemygaze">xStoreEnemyGaze</a></span>
</div>
</div></div>
<span class="label">.xStoreEnemyGaze</span><a id="xstoreenemygaze" class="anchor"></a>

 <span class="mne">EQUB</span> <span class="decimal">0</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-getplayerdrain" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">GetPlayerDrain</span>                                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate whether the player is being scanned by an enemy and</span>
             <span class="headerEntry">whether the enemy can see the player's tile</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/getplayerdrain.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processgameplay.html">ProcessGameplay</a> calls <a href="#getplayerdrain">GetPlayerDrain</a></span>
</div>
</div></div>
<span class="label">.GetPlayerDrain</span><a id="getplayerdrain" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set Y = 0 to use as the default state of the scanner</span>
                        <span class="comment">\ (fill scanner with black)</span>

 <span class="mne">STY</span> <a class="popup variable">T</a>                  <span class="comment">\ Set T = 0 to store in playerTileIsHidden after the</span>
                        <span class="comment">\ loop below, so the default value is that the player</span>
                        <span class="comment">\ is not exposed to an enemy scan (though we may change</span>
                        <span class="comment">\ this)</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">7</span>                 <span class="comment">\ We now loop through all eight enemies, so set an enemy</span>
                        <span class="comment">\ counter in X</span>

<span class="label">.pdra1</span><a id="pdra1" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">X</span>      <span class="comment">\ If bit 7 is set for object #Y then this object number</span>
 <span class="mne">BMI</span> <a class="popup destination">pdra3</a>              <span class="comment">\ is not allocated to an object, so jump to pdra3 to</span>
                        <span class="comment">\ move on to the next enemy object</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ Set A to the object type for the enemy in object #X</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ If object #X is a sentry (an object of type 1) then</span>
 <span class="mne">BEQ</span> <a class="popup destination">pdra2</a>              <span class="comment">\ jump to pdra2</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ If object #X is not the Sentinel (an object of type</span>
 <span class="mne">BNE</span> <a class="popup destination">pdra3</a>              <span class="comment">\ 5), then jump to pdra3 to move on to the next enemy</span>
                        <span class="comment">\ object</span>

<span class="label">.pdra2</span><a id="pdra2" class="anchor"></a>

                        <span class="comment">\ If we get here then object #X is the Sentinel or a</span>
                        <span class="comment">\ sentry</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyTarget</a>,<span class="register">X</span>      <span class="comment">\ If the enemy's target is not the player, jump to pdra3</span>
 <span class="mne">CMP</span> <a class="popup variable">playerObject</a>       <span class="comment">\ to move on to the next enemy object</span>
 <span class="mne">BNE</span> <a class="popup destination">pdra3</a>

 <span class="mne">LDA</span> <a class="popup variable">enemyDrainTimer</a>,<span class="register">X</span>  <span class="comment">\ If the drain timer for the enemy is zero, jump to</span>
 <span class="mne">BEQ</span> <a class="popup destination">pdra3</a>              <span class="comment">\ pdra3 to move on to the next enemy object</span>

                        <span class="comment">\ If we get here then the enemy is targeting the player</span>
                        <span class="comment">\ and has a non-zero drain timer, so the player is at</span>
                        <span class="comment">\ least partially exposed to an enemy who can drain them</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Set Y = 4 to use as the state of the scanner (fill the</span>
                        <span class="comment">\ scanner with static in colour 3)</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyVisibility</a>,<span class="register">X</span>  <span class="comment">\ Set T to the visibility of the enemy's target (the</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ player) to store in playerTileIsHidden after the loop</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This will either have bit 7 set (target's tile is</span>
                        <span class="comment">\ visible) or bit 6 set (target's tile is not visible</span>
                        <span class="comment">\ but target object is)</span>

 <span class="mne">BMI</span> <a class="popup destination">pdra4</a>              <span class="comment">\ If bit 7 of enemyVisibility is set then the enemy can</span>
                        <span class="comment">\ see the player's tile, so jump to pdra4 to record this</span>
                        <span class="comment">\ fact</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If bit 7 of enemyVisibility is clear then the enemy</span>
                        <span class="comment">\ can see the player object but it can't see the</span>
                        <span class="comment">\ player's tile, so we keep looping in case there is</span>
                        <span class="comment">\ another target whose tile the enemy can see, as this</span>
                        <span class="comment">\ will take precedence over the partially exposed player</span>

<span class="label">.pdra3</span><a id="pdra3" class="anchor"></a>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the enemy counter in X</span>

 <span class="mne">BPL</span> <a class="popup destination">pdra1</a>              <span class="comment">\ Loop back until we have checked all eight enemies</span>

<span class="label">.pdra4</span><a id="pdra4" class="anchor"></a>

 <span class="mne">STY</span> <a class="popup variable">scannerUpdate</a>      <span class="comment">\ Set scannerUpdate to the value of Y, which will be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Zero if the player is not exposed to the enemy (so</span>
                        <span class="comment">\     the scanner will not be updated)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Non-zero (i.e. 4) if the player is exposed to the</span>
                        <span class="comment">\     enemy (so the scanner will then be updated)</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set playerTileIsHidden to the value of T, which will</span>
 <span class="mne">STA</span> <a class="popup variable">playerTileIsHidden</a> <span class="comment">\ be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Zero if the player is not exposed to the enemy</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 128 (i.e. bit 7 set) if the player's tile is</span>
                        <span class="comment">\     exposed to the enemy</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 64 (i.e. bit 6 set) if the player is exposed to</span>
                        <span class="comment">\     the enemy but the enemy can't see the player's</span>
                        <span class="comment">\     tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This value is used in the UpdateScannerNow routine</span>
                        <span class="comment">\ to determine whether we show the scanner with a full</span>
                        <span class="comment">\ display of static (not 64) or only half (64)</span>

 <span class="mne">LDA</span> <a class="popup variable">soundEffect</a>        <span class="comment">\ Set A to soundEffect, which determines how the current</span>
                        <span class="comment">\ sound is processed by the ProcessSound routine</span>

 <span class="mne">CPY</span> <a class="popup variable">soundEffect</a>        <span class="comment">\ Set the flags on the comparison of the current setting</span>
                        <span class="comment">\ of soundEffect and the value of Y</span>

 <span class="mne">STY</span> <a class="popup variable">soundEffect</a>        <span class="comment">\ Set soundEffect to Y, which will be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Zero if the player is not exposed to the enemy (so</span>
                        <span class="comment">\     no sound processing is required)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Non-zero (i.e. 4) if the player is exposed to the</span>
                        <span class="comment">\     enemy (so the scanner sound is processed in the</span>
                        <span class="comment">\     ProcessSound routine)</span>

 <span class="mne">BEQ</span> <a class="popup destination">pdra5</a>              <span class="comment">\ If the value of soundEffect has not changed, jump to</span>
                        <span class="comment">\ pdra5 to return from the subroutine</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="hex">&12</span>               <span class="comment">\ Set the first parameter of sound block #2 (channel) to</span>
 <span class="mne">STY</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">16</span>       <span class="comment">\ &12, so we make the scanner sound on channel 2 and</span>
                        <span class="comment">\ with a flush control of 1 to make the sound instantly</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ We set A to soundEffect above, so if soundEffect = 3,</span>
 <span class="mne">BEQ</span> <a class="popup destination">pdra5</a>              <span class="comment">\ which denotes that we are currently applying the music</span>
                        <span class="comment">\ sound effect, jump to pdra5 to return from the</span>
                        <span class="comment">\ subroutine to let the music sound finish first</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">6</span>                 <span class="comment">\ Otherwise we are not currently applying the music</span>
 <span class="mne">JSR</span> <a class="popup destination">FlushBuffer</a>        <span class="comment">\ sound effect, so call the FlushBuffer routine with</span>
                        <span class="comment">\ X = 6 to flush the sound channel 2 buffer</span>

<span class="label">.pdra5</span><a id="pdra5" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-resetmeaniescan" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">ResetMeanieScan</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Reset the data stored for any meanie scans that the enemy has</span>
             <span class="headerEntry">tried in the past, so we can start looking with a clean slate</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/resetmeaniescan.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/addenemiestotiles.html">AddEnemiesToTiles</a> calls <a href="#resetmeaniescan">ResetMeanieScan</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_5_of_8.html">ApplyTactics (Part 5 of 8)</a> calls <a href="#resetmeaniescan">ResetMeanieScan</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_6_of_8.html">ApplyTactics (Part 6 of 8)</a> calls <a href="#resetmeaniescan">ResetMeanieScan</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">The object number of the enemy being added</span>

</div></div>
<span class="label">.ResetMeanieScan</span><a id="resetmeaniescan" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set bit 7 of enemyMeanieTree for object #X to indicate</span>
 <span class="mne">STA</span> <a class="popup variable">enemyMeanieTree</a>,<span class="register">X</span>  <span class="comment">\ that the enemy has not turned a tree into a meanie</span>

 <span class="mne">STA</span> <a class="popup variable">enemyFailTarget</a>,<span class="register">X</span>  <span class="comment">\ Set bit 7 of enemyFailTarget for object #X to remove</span>
                        <span class="comment">\ the details of any failed meanie scans for this enemy</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Zero enemyFailCounter for object #X to reset the</span>
 <span class="mne">STA</span> <a class="popup variable">enemyFailCounter</a>,<span class="register">X</span> <span class="comment">\ recorded number of failed meanie scans for this enemy</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">64</span>                <span class="comment">\ Set enemyMeanieCheck = 64 for the enemy so if we start</span>
 <span class="mne">STA</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ scanning objects for trees to potentially turn into a</span>
                        <span class="comment">\ meanie, we start from the last object and work down</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-scanformeanietree" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">ScanForMeanieTree</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Scan through the objects in the landscape to see if any of them</span>
             <span class="headerEntry">are trees that are suitable for turning into a meanie</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/scanformeanietree.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_7_of_8.html">ApplyTactics (Part 7 of 8)</a> calls <a href="#scanformeanietree">ScanForMeanieTree</a></span>
</div>
<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">The result of the tree scan:</span>

                        <span class="argumentEntry">  * Clear = we have successfully turned a tree into a</span>
                        <span class="argumentEntry">            meanie</span>

                        <span class="argumentEntry">  * Set = we have not been able to find a suitable tree</span>
                        <span class="argumentEntry">          to turn into a meanie</span>

</div></div>
<span class="label">.ScanForMeanieTree</span><a id="scanformeanietree" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">40</span>                <span class="comment">\ Set enemyViewingArc = 40, so the enemy's gaze has a</span>
 <span class="mne">STA</span> <a class="popup variable">enemyViewingArc</a>    <span class="comment">\ viewing arc that's twice the width of the screen (as</span>
                        <span class="comment">\ the screen is 20 yaw angles across)</span>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set the viewing object to the enemy so the gaze checks</span>
 <span class="mne">STX</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ below are performed from the point of view of the</span>
                        <span class="comment">\ enemy object</span>

<span class="label">.mean1</span><a id="mean1" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set X to the object number of the enemy to which we</span>
                        <span class="comment">\ are applying tactics (so this is now object #X)</span>

 <span class="mne">LDY</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ Set Y to the object number that we have reached while</span>
                        <span class="comment">\ scanning for a tree to turn into a meanie, which is</span>
                        <span class="comment">\ stored in the enemyMeanieScan for this enemy</span>

 <span class="mne">BNE</span> <a class="popup destination">mean2</a>              <span class="comment">\ If enemyMeanieScan is non-zero then we have not yet</span>
                        <span class="comment">\ scanned every object for a tree to turn into a meanie,</span>
                        <span class="comment">\ so jump to mean2 to check the next object</span>

 <span class="mne">INC</span> <a class="popup variable">enemyFailCounter</a>,<span class="register">X</span> <span class="comment">\ We just failed to find a suitable tree to attack the</span>
                        <span class="comment">\ target, so increment the failure counter for the enemy</span>
                        <span class="comment">\ in enemyFailCounter</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyTarget</a>,<span class="register">X</span>      <span class="comment">\ We just failed to find a suitable tree to attack the</span>
 <span class="mne">STA</span> <a class="popup variable">enemyFailTarget</a>,<span class="register">X</span>  <span class="comment">\ target, so store the target number in enemyFailTarget</span>
                        <span class="comment">\ for this enemy to record this fact, so the enemy</span>
                        <span class="comment">\ doesn't try spawning a meanie for this target again</span>
                        <span class="comment">\ (at least, until the enemy's data is reset)</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to indicate that we have not been able</span>
                        <span class="comment">\ to find a suitable tree to turn into a meanie</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.mean2</span><a id="mean2" class="anchor"></a>

 <span class="mne">DEC</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ Decrement the object number that we are checking for</span>
                        <span class="comment">\ meanie potential, so we work our way down the object</span>
                        <span class="comment">\ list</span>

 <span class="mne">DEY</span>                    <span class="comment">\ We already set Y to the object number before jumping</span>
                        <span class="comment">\ here, so decrement Y as well, so object #Y is our</span>
                        <span class="comment">\ potential meanie</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ If bit 7 of the object flags for the potential meanie</span>
 <span class="mne">BMI</span> <a class="popup destination">mean1</a>              <span class="comment">\ is set then the object number doesn't have an</span>
                        <span class="comment">\ associated object, so jump to mean1 to move on to the</span>
                        <span class="comment">\ next object to check that instead</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ If the potential meanie is not a tree (an object of</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ type 2) then it can't be turned into a meanie, so jump</span>
 <span class="mne">BNE</span> <a class="popup destination">mean1</a>              <span class="comment">\ to mean1 to move on to the next object to check that</span>
                        <span class="comment">\ instead</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyTarget</a>,<span class="register">X</span>      <span class="comment">\ Set X to the enemy's current target object, so object</span>
 <span class="mne">TAX</span>                    <span class="comment">\ #X is the target object</span>

 <span class="mne">LDA</span> <a class="popup variable">xObject</a>,<span class="register">X</span>          <span class="comment">\ Set A to the difference in x-coordinate between object</span>
 <span class="mne">SEC</span>                    <span class="comment">\ #X and object #Y (i.e. between the target and</span>
 <span class="mne">SBC</span> <a class="popup variable">xObject</a>,<span class="register">Y</span>          <span class="comment">\ potential meanie)</span>

 <span class="mne">BPL</span> <a class="popup destination">mean3</a>              <span class="comment">\ If the result is positive, jump to mean3 as the result</span>
                        <span class="comment">\ is already the correct sign</span>

 <span class="mne">EOR</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ Negate A using two's complement, so that A is now</span>
 <span class="mne">CLC</span>                    <span class="comment">\ positive and contains the absolute value of the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ distance in the x-axis between the target and</span>
                        <span class="comment">\ potential meanie</span>

<span class="label">.mean3</span><a id="mean3" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\ If the target and potential meanie are ten or more</span>
 <span class="mne">BCS</span> <a class="popup destination">mean1</a>              <span class="comment">\ tiles apart then this is too far away from the target</span>
                        <span class="comment">\ to be turned into a meanie, so jump to mean1 to move</span>
                        <span class="comment">\ on to the next object to check that instead</span>

 <span class="mne">LDA</span> <a class="popup variable">zObject</a>,<span class="register">X</span>          <span class="comment">\ Set A to the difference in z-coordinate between object</span>
 <span class="mne">SEC</span>                    <span class="comment">\ #X and object #Y (i.e. between the target and</span>
 <span class="mne">SBC</span> <a class="popup variable">zObject</a>,<span class="register">Y</span>          <span class="comment">\ potential meanie)</span>

 <span class="mne">BPL</span> <a class="popup destination">mean4</a>              <span class="comment">\ If the result is positive, jump to mean4 as the result</span>
                        <span class="comment">\ is already the correct sign</span>

 <span class="mne">EOR</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ Negate A using two's complement, so that A is now</span>
 <span class="mne">CLC</span>                    <span class="comment">\ positive and contains the absolute value of the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ distance in the z-axis between the target and</span>
                        <span class="comment">\ potential meanie</span>

<span class="label">.mean4</span><a id="mean4" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\ If the target and potential meanie are ten or more</span>
 <span class="mne">BCS</span> <a class="popup destination">mean1</a>              <span class="comment">\ tiles apart then this is too far away from the target</span>
                        <span class="comment">\ to be turned into a meanie, so jump to mean1 to move</span>
                        <span class="comment">\ on to the next object to check that instead</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ Call CheckEnemyGaze to check the gaze of the enemy</span>
 <span class="mne">JSR</span> <a class="popup destination">CheckEnemyGaze</a>     <span class="comment">\ towards the potential meanie in object #Y, returning</span>
                        <span class="comment">\ the following if object #Y is a tree (an object of</span>
                        <span class="comment">\ type 2), which we have already confirmed:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * targetVisibility = bit 7 set if the tree's tile</span>
                        <span class="comment">\     is visible, bit 6 set if the tree is visible</span>

 <span class="mne">LDA</span> <a class="popup variable">targetVisibility</a>   <span class="comment">\ If bit 7 of targetVisibility is clear then the enemy</span>
 <span class="mne">BPL</span> <a class="popup destination">mean1</a>              <span class="comment">\ can't see the tree's tile, so it can't turn it into</span>
                        <span class="comment">\ a meanie, so jump to mean1 to move on to the next</span>
                        <span class="comment">\ object to check that instead</span>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set X to the object number of the enemy to which we</span>
                        <span class="comment">\ are applying tactics (so this is now object #X)</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Set A to the object number of the potential meanie</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckObjVisibility</a> <span class="comment">\ Check whether the potential meanie in object A is</span>
                        <span class="comment">\ visible and could therefore be seen on-screen by the</span>
                        <span class="comment">\ player</span>

 <span class="mne">BCC</span> <a class="popup destination">mean5</a>              <span class="comment">\ If the C flag is clear then we are about to repeat the</span>
                        <span class="comment">\ same screen pan (as the player is still holding down</span>
                        <span class="comment">\ the same pan key) and the potential meanie would be</span>
                        <span class="comment">\ visible in the landscape view if we drew it again</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that when we pan the screen, the new part</span>
                        <span class="comment">\ of the screen that pans into view might show part of</span>
                        <span class="comment">\ the meanie while the rest of the screen won't, and</span>
                        <span class="comment">\ that won't look good</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So jump to mean5 to stop processing this potential</span>
                        <span class="comment">\ meanie for now, but set things up so we can come back</span>
                        <span class="comment">\ to it the next time we process tactics for this enemy,</span>
                        <span class="comment">\ as the player might not be panning the screen by then</span>

                        <span class="comment">\ If we get here then we have found a suitable tree to</span>
                        <span class="comment">\ turn into a meanie, so let's do that</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Set enemyMeanieTree for this enemy to Y, as object #Y</span>
 <span class="mne">STA</span> <a class="popup variable">enemyMeanieTree</a>,<span class="register">X</span>  <span class="comment">\ is the object number of the tree that we are going to</span>
                        <span class="comment">\ turn into a meanie, and storing it in enemyMeanieTree</span>
                        <span class="comment">\ records the fact that the enemy has changed this</span>
                        <span class="comment">\ object from a tree into a meanie</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Set the type of object #Y to 4, so it turns into a</span>
 <span class="mne">STA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ meanie (an object of type 4)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">104</span>               <span class="comment">\ Set minObjWidth = 104 so we use the width of the wider</span>
 <span class="mne">STA</span> <a class="popup variable">minObjWidth</a>        <span class="comment">\ object, the tree, when we calculate the object's</span>
                        <span class="comment">\ visibility when updating the object on-screen ???</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that we have successfully</span>
                        <span class="comment">\ turned a tree into a meanie</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.mean5</span><a id="mean5" class="anchor"></a>

 <span class="mne">INC</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ If we get here then we have found a suitable tree to</span>
                        <span class="comment">\ turn into a meanie but updating it on-screen might</span>
                        <span class="comment">\ corrupt the landscape view as a pan is in progress</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So increment the object number in enemyMeanieScan, so</span>
                        <span class="comment">\ the next time we apply tactics to this enemy, we can</span>
                        <span class="comment">\ pick up where we left off, by which time the player</span>
                        <span class="comment">\ might no longer be panning the screen</span>

 <span class="mne">JMP</span> <a class="popup destination">FinishEnemyTactics</a> <span class="comment">\ Jump to FinishEnemyTactics to stop applying tactics to</span>
                        <span class="comment">\ the current enemy and return to the ProcessGameplay</span>
                        <span class="comment">\ routine to continue with the gameplay loop</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-drainobjectenergy" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">DrainObjectEnergy</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Drain energy from an object into an enemy, transforming it into an</span>
             <span class="headerEntry">object with an energy level of one unit less (if applicable)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/drainobjectenergy.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_5_of_8.html">ApplyTactics (Part 5 of 8)</a> calls <a href="#drainobjectenergy">DrainObjectEnergy</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_7_of_8.html">ApplyTactics (Part 7 of 8)</a> calls <a href="#drainobjectenergy">DrainObjectEnergy</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">targetObject</span>         <span class="argumentEntry">The number of the object being drained of energy</span>

   <span class="argumentLabel">enemyObject</span>          <span class="argumentEntry">The number of the object doing the draining</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Result flag:</span>

                        <span class="argumentEntry">  * Set if the player object is being drained and they</span>
                        <span class="argumentEntry">    still have a positive energy level after the</span>
                        <span class="argumentEntry">    draining</span>

                        <span class="argumentEntry">  * Clear if one of the following is true:</span>

                        <span class="argumentEntry">    * The player object is being drained and they now</span>
                        <span class="argumentEntry">      have a negative energy level, so the Sentinel has</span>
                        <span class="argumentEntry">      won</span>

                        <span class="argumentEntry">    * The player object is not being drained</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">The object number of the target that has been drained of</span>
                        <span class="argumentEntry">energy (and which has therefore been transformed into a</span>
                        <span class="argumentEntry">different object type)</span>

</div></div>
<span class="label">.dobj1</span><a id="dobj1" class="anchor"></a>

                        <span class="comment">\ If we jump here from below here then the player has</span>
                        <span class="comment">\ run out of energy</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set bit 7 of sentinelHasWon to indicate that the</span>
 <span class="mne">STA</span> <a class="popup variable">sentinelHasWon</a>     <span class="comment">\ player has run out of energy and the Sentinel has won</span>

 <span class="mne">JMP</span> <a class="popup destination">FinishEnemyTactics</a> <span class="comment">\ Jump to FinishEnemyTactics to stop applying tactics to</span>
                        <span class="comment">\ the current enemy and return to the ProcessGameplay</span>
                        <span class="comment">\ routine to continue with the gameplay loop</span>

<span class="label">.DrainObjectEnergy</span><a id="drainobjectenergy" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">targetObject</a>       <span class="comment">\ Set X to the object number that is being drained of</span>
                        <span class="comment">\ energy</span>

 <span class="mne">CPX</span> <a class="popup variable">playerObject</a>       <span class="comment">\ If this is not the player object, jump to dobj2 to</span>
 <span class="mne">BNE</span> <a class="popup destination">dobj2</a>              <span class="comment">\ drain energy from object #X rather than the player</span>

                        <span class="comment">\ If we get here then this is the player object, so we</span>
                        <span class="comment">\ now drain energy from the player</span>

 <span class="mne">LDA</span> <a class="popup variable">playerEnergy</a>       <span class="comment">\ If the player has no energy then draining more energy</span>
 <span class="mne">BEQ</span> <a class="popup destination">dobj1</a>              <span class="comment">\ will kill them, so jump to dobj1 to process this</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Subtract 1 from the player's energy</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">1</span>
 <span class="mne">STA</span> <a class="popup variable">playerEnergy</a>

 <span class="mne">JSR</span> <a class="popup destination">UpdateIconsScanner</a> <span class="comment">\ Update the icons in the top-left corner of the screen</span>
                        <span class="comment">\ to show the player's current energy level and redraw</span>
                        <span class="comment">\ the scanner box</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ Make sound #5 (ping)</span>
 <span class="mne">JSR</span> <a class="popup destination">MakeSound</a>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to indicate that the player still has a</span>
                        <span class="comment">\ non-zero energy level</span>

 <span class="mne">JMP</span> <a class="popup destination">dobj7</a>              <span class="comment">\ Jump to dobj7 to finish up and return from the</span>
                        <span class="comment">\ subroutine</span>

<span class="label">.dobj2</span><a id="dobj2" class="anchor"></a>

                        <span class="comment">\ If we get here then we need to drain energy from</span>
                        <span class="comment">\ object #X</span>

 <span class="mne">TXA</span>                    <span class="comment">\ Check to see whether it is safe to redraw object #X</span>
 <span class="mne">JSR</span> <a class="popup destination">AbortWhenVisible</a>   <span class="comment">\ without risk of corrupting a screen pan (if there is</span>
                        <span class="comment">\ a risk and it can't be updated, then the call to</span>
                        <span class="comment">\ AbortWhenVisible will not return here and will instead</span>
                        <span class="comment">\ abort tactics for this iteration of the gameplay loop)</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ Set A to the type of object #X</span>

 <span class="mne">BNE</span> <a class="popup destination">dobj3</a>              <span class="comment">\ If object #X is not a robot (i.e. not an object of</span>
                        <span class="comment">\ type 0), jump to dobj3</span>

                        <span class="comment">\ If we get here then we are draining energy from a</span>
                        <span class="comment">\ robot in object #X</span>

 <span class="mne">LDY</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set enemyDrainTimer = 0 to restart the drain counter</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ for the enemy in part 5 of ApplyTactics, so it doesn't</span>
 <span class="mne">STA</span> <a class="popup variable">enemyDrainTimer</a>,<span class="register">Y</span>  <span class="comment">\ drain energy for another 120 timer ticks (120 * 0.06 =</span>
                        <span class="comment">\ 7.2 seconds)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ Set A = 3 so the robot loses one energy unit and</span>
                        <span class="comment">\ changes into a boulder (i.e. an object of type 3)</span>

 <span class="mne">BNE</span> <a class="popup destination">dobj5</a>              <span class="comment">\ Jump to dobj5 to set the new object type of object #X</span>
                        <span class="comment">\ to the value in A, so the robot turns into a boulder</span>

<span class="label">.dobj3</span><a id="dobj3" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ If object #X is not a tree (i.e. not an object of</span>
 <span class="mne">BNE</span> <a class="popup destination">dobj4</a>              <span class="comment">\ type 2), jump to dobj4</span>

                        <span class="comment">\ If we get here then we are draining energy from a</span>
                        <span class="comment">\ tree in object #X</span>

 <span class="mne">JSR</span> <a class="popup destination">DeleteObject</a>       <span class="comment">\ Delete object #X and remove it from the landscape,</span>
                        <span class="comment">\ as trees only have one energy unit, so draining one</span>
                        <span class="comment">\ unit from a tree removes it altogether</span>

 <span class="mne">JMP</span> <a class="popup destination">dobj6</a>              <span class="comment">\ Jump to dobj6 to skip updating the energy for object</span>
                        <span class="comment">\ #X, as we just deleted it</span>

<span class="label">.dobj4</span><a id="dobj4" class="anchor"></a>

                        <span class="comment">\ If we get here then we must be draining energy from a</span>
                        <span class="comment">\ boulder in object #X, so now we change it into a tree</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">116</span>               <span class="comment">\ Set minObjWidth = 116 so we use the width of the wider</span>
 <span class="mne">STA</span> <a class="popup variable">minObjWidth</a>        <span class="comment">\ object, the boulder, when we calculate the object's</span>
                        <span class="comment">\ visibility when updating the object on-screen ???</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ Set A = 2 so the boulder loses one energy unit and</span>
                        <span class="comment">\ changes into a tree (i.e. an object of type 2)</span>

<span class="label">.dobj5</span><a id="dobj5" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ Set the object type of object #X to the new type in A</span>

<span class="label">.dobj6</span><a id="dobj6" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to return from the subroutine</span>

<span class="label">.dobj7</span><a id="dobj7" class="anchor"></a>

 <span class="mne">PHP</span>                    <span class="comment">\ Store the C flag on the stack so we can retrieve it</span>
                        <span class="comment">\ below to return from the subroutine</span>

 <span class="mne">LDY</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Increment the energy level for the enemy object by one</span>
 <span class="mne">LDA</span> <a class="popup variable">enemyEnergy</a>,<span class="register">Y</span>      <span class="comment">\ unit, as the enemy just absorbed one unit from the</span>
 <span class="mne">CLC</span>                    <span class="comment">\ target object</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>
 <span class="mne">STA</span> <a class="popup variable">enemyEnergy</a>,<span class="register">Y</span>

 <span class="mne">PLP</span>                    <span class="comment">\ Retrieve the C flag from the stack to return from the</span>
                        <span class="comment">\ subroutine</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-expendenemyenergy" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">ExpendEnemyEnergy</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Drain one unit of energy from an enemy and expend it onto the</span>
             <span class="headerEntry">landscape by spawning a tree, if possible</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/expendenemyenergy.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applyenemytactics.html">ApplyEnemyTactics</a> calls <a href="#expendenemyenergy">ExpendEnemyEnergy</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_3_of_8.html">ApplyTactics (Part 3 of 8)</a> calls <a href="#expendenemyenergy">ExpendEnemyEnergy</a></span>
</div>
<hr class="light">
 If we can't spawn a tree because we are about to pan the screen and the tree
 would spawn in a position that would be visible on-screen, then the routine
 does not drain energy or spawn a tree, and instead it gives up and aborts
 applying tactics for this gameplay loop.

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">enemyObject</span>          <span class="argumentEntry">The object number of the enemy to drain</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag:</span>

                        <span class="argumentEntry">  * Clear if the energy is drained and a tree is spawned</span>
                        <span class="argumentEntry">    successfully</span>

                        <span class="argumentEntry">  * Set if:</span>

                        <span class="argumentEntry">    * The enemy had no energy to drain</span>

                        <span class="argumentEntry">    * We could not spawn a tree to take on the drained</span>
                        <span class="argumentEntry">      energy</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">The object number of the spawned tree, if one was</span>
                        <span class="argumentEntry">spawned</span>

</div></div>
<span class="label">.ExpendEnemyEnergy</span><a id="expendenemyenergy" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set X to the object number of the enemy we are</span>
                        <span class="comment">\ draining (so this is now object #X)</span>

 <span class="mne">SEC</span>                    <span class="comment">\ If the enemy has zero energy, jump to dren1 to return</span>
 <span class="mne">LDA</span> <a class="popup variable">enemyEnergy</a>,<span class="register">X</span>      <span class="comment">\ from the subroutine with the C flag set</span>
 <span class="mne">BEQ</span> <a class="popup destination">dren1</a>

                        <span class="comment">\ If we get here then the enemy has got some energy</span>
                        <span class="comment">\ left, so we spawn a tree and decrease the enemy's</span>
                        <span class="comment">\ energy level by one (as a tree is worth one energy</span>
                        <span class="comment">\ unit)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ Spawn a tree (an object of type 2), returning the</span>
 <span class="mne">JSR</span> <a class="popup destination">SpawnObject</a>        <span class="comment">\ object number of the new object in X and currentObject</span>

 <span class="mne">LDA</span> <a class="popup variable">minEnemyAltitude</a>   <span class="comment">\ Set A to altitude of the lowest enemy on the landscape</span>

 <span class="mne">JSR</span> <a class="popup destination">PlaceObjectBelow</a>   <span class="comment">\ Attempt to place the tree on a tile that is below the</span>
                        <span class="comment">\ maximum altitude specified in A (though we may end up</span>
                        <span class="comment">\ placing the tree higher than this)</span>

 <span class="mne">BCS</span> <a class="popup destination">dren1</a>              <span class="comment">\ If the call to PlaceObjectBelow sets the C flag then</span>
                        <span class="comment">\ the tree has not been successfully placed, so jump to</span>
                        <span class="comment">\ dren1 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set</span>

 <span class="mne">TXA</span>                    <span class="comment">\ Set A to the object number of the tree we added to the</span>
                        <span class="comment">\ landscape so we can pass it to CheckObjVisibility</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckObjVisibility</a> <span class="comment">\ Check whether the tree in object A is visible and</span>
                        <span class="comment">\ could therefore be seen on-screen by the player</span>

 <span class="mne">BCC</span> <a class="popup destination">dren2</a>              <span class="comment">\ If the C flag is clear then we are about to repeat the</span>
                        <span class="comment">\ same screen pan (as the player is still holding down</span>
                        <span class="comment">\ the same pan key) and the tree we just added would be</span>
                        <span class="comment">\ visible in the landscape view if we drew it again</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that when we pan the screen, the new part</span>
                        <span class="comment">\ of the screen that pans into view might show part of</span>
                        <span class="comment">\ the tree while the rest of the screen won't, and that</span>
                        <span class="comment">\ won't look good</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So jump to dren2 to delete the tree and stop applying</span>
                        <span class="comment">\ tactics to the enemy, thus aborting the whole process</span>

                        <span class="comment">\ If we get here then we are either not repeating the</span>
                        <span class="comment">\ same screen pan, or we are but the object is not</span>
                        <span class="comment">\ visible on-screen, so in either case the tree won't</span>
                        <span class="comment">\ only partially appear on-screen so we can go ahead</span>
                        <span class="comment">\ with the energy drain</span>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Decrement enemyEnergy for the enemy object we are</span>
 <span class="mne">DEC</span> <a class="popup variable">enemyEnergy</a>,<span class="register">X</span>      <span class="comment">\ draining</span>

 <span class="mne">LDX</span> <a class="popup variable">currentObject</a>      <span class="comment">\ Set X to currentObject to return from the subroutine,</span>
                        <span class="comment">\ which the call to CheckObjVisibility set to the object</span>
                        <span class="comment">\ number of the newly spawned tree</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate success</span>

<span class="label">.dren1</span><a id="dren1" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.dren2</span><a id="dren2" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">DeleteObject</a>       <span class="comment">\ Delete the tree in object #X and remove it from the</span>
                        <span class="comment">\ landscape</span>

 <span class="mne">JMP</span> <a class="popup destination">FinishEnemyTactics</a> <span class="comment">\ Jump to FinishEnemyTactics to stop applying tactics to</span>
                        <span class="comment">\ the current enemy and return to the ProcessGameplay</span>
                        <span class="comment">\ routine to continue with the gameplay loop</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-finishlandscape" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FinishLandscape</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Main game loop</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Add the player's energy to the landscape number to get the number</span>
             <span class="headerEntry">of the next landscape and display that landscape's secret code</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/finishlandscape.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/maingameloop.html">MainGameLoop</a> calls <a href="#finishlandscape">FinishLandscape</a></span>
</div>
</div></div>
<span class="label">.FinishLandscape</span><a id="finishlandscape" class="anchor"></a>

 <span class="mne">SED</span>                    <span class="comment">\ Set the D flag to switch arithmetic to binary coded</span>
                        <span class="comment">\ decimal (BCD), so the call to GetPlayerEnergyBCD and</span>
                        <span class="comment">\ the following addition are all done in BCD</span>

 <span class="mne">JSR</span> <a class="popup destination">GetPlayerEnergyBCD</a> <span class="comment">\ Set A to the player's energy in BCD</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Set (Y X) = landscapeNumber(Hi Lo) + A</span>
 <span class="mne">ADC</span> <a class="popup variable">landscapeNumberLo</a>  <span class="comment">\</span>
 <span class="mne">TAX</span>                    <span class="comment">\ This addition is done in BCD so the result is a new</span>
 <span class="mne">LDA</span> <a class="popup variable">landscapeNumberHi</a>  <span class="comment">\ landscape number that's also in BCD (which we need to</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ do as landscape numbers are in BCD)</span>
 <span class="mne">TAY</span>

 <span class="mne">CLD</span>                    <span class="comment">\ Clear the D flag to switch arithmetic to normal</span>

 <span class="mne">JSR</span> <a class="popup destination">InitialiseSeeds</a>    <span class="comment">\ Initialise the seed number generator to generate the</span>
                        <span class="comment">\ sequence of seed numbers for the landscape number in</span>
                        <span class="comment">\ (Y X) and set maxNumberOfEnemies and the landscapeZero</span>
                        <span class="comment">\ flag accordingly</span>

                        <span class="comment">\ We set bit 7 of doNotPlayLandscape when the landscape</span>
                        <span class="comment">\ was completed in the PerformHyperspace routine, so the</span>
                        <span class="comment">\ following calls to GenerateLandscape and SpawnPlayer</span>
                        <span class="comment">\ return normally, without previewing the landscape</span>
                        <span class="comment">\ (GenerateLandscape) or starting the game (SpawnPlayer)</span>

 <span class="mne">JSR</span> <a class="popup destination">GenerateLandscape</a>  <span class="comment">\ Call GenerateLandscape to generate the landscape</span>

 <span class="mne">JSR</span> <a class="popup destination">SpawnEnemies</a>       <span class="comment">\ Calculate the number of enemies for this landscape,</span>
                        <span class="comment">\ add them to the landscape and set the palette</span>
                        <span class="comment">\ accordingly</span>

 <span class="mne">JSR</span> <a class="popup destination">SpawnPlayer</a>        <span class="comment">\ Add the player and trees to the landscape</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&80</span>               <span class="comment">\ Call DrawTitleScreen with A = &80 to draw the screen</span>
 <span class="mne">JSR</span> <a class="popup destination">DrawTitleScreen</a>    <span class="comment">\ showing the landscape's secret code</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ Print text token 5: Print "SECRET ENTRY CODE" at</span>
 <span class="mne">JSR</span> <a class="popup destination">PrintTextToken</a>     <span class="comment">\ (64, 768), "LANDSCAPE" at (192, 704), move cursor</span>
                        <span class="comment">\ right</span>

 <span class="mne">JMP</span> <a class="popup destination">PrintLandscapeNum</a>  <span class="comment">\ Print the four-digit landscape (0000 to 9999) and</span>
                        <span class="comment">\ return from the subroutine using a tail call</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-findobjecttodrain" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FindObjectToDrain</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Find a suitable target object for an enemy to drain</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/findobjecttodrain.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_4_of_8.html">ApplyTactics (Part 4 of 8)</a> calls <a href="#findobjecttodrain">FindObjectToDrain</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_5_of_8.html">ApplyTactics (Part 5 of 8)</a> calls <a href="#findobjecttodrain">FindObjectToDrain</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">viewingObject</span>        <span class="argumentEntry">The viewing object (i.e. the enemy doing the scanning)</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag:</span>

                        <span class="argumentEntry">  * Clear if we have found an object that is a suitable</span>
                        <span class="argumentEntry">    target for the enemy to drain (i.e. a tree that is</span>
                        <span class="argumentEntry">    stacked on top of another object, or a boulder,</span>
                        <span class="argumentEntry">    which is exposed to the enemy and on a tile that can</span>
                        <span class="argumentEntry">    be seen by the enemy)</span>

                        <span class="argumentEntry">  * Set if no objects of them are suitable targets for</span>
                        <span class="argumentEntry">    the enemy to drain</span>

   <span class="argumentLabel">targetObject</span>         <span class="argumentEntry">The number of the target object (if the C flag is set)</span>

</div></div>
<span class="label">.FindObjectToDrain</span><a id="findobjecttodrain" class="anchor"></a>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">63</span>                <span class="comment">\ Set a counter in X to work through the object numbers</span>
                        <span class="comment">\ until we find a suitable tree or boulder that can be</span>
                        <span class="comment">\ seen by the viewing object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that we only call this routine with the viewing</span>
                        <span class="comment">\ object set to the enemy that we are processing in the</span>
                        <span class="comment">\ ApplyTactics routine, so I'll refer to the viewing</span>
                        <span class="comment">\ object as the enemy in the following to make it</span>
                        <span class="comment">\ easier to follow</span>

<span class="label">.dran1</span><a id="dran1" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">X</span>      <span class="comment">\ Set A to the object flags for object #X, which are</span>
                        <span class="comment">\ stored in the X-th entry in the objectFlags table</span>

 <span class="mne">BMI</span> <a class="popup destination">dran4</a>              <span class="comment">\ If bit 7 of object flags for object #X is set then</span>
                        <span class="comment">\ this object number is not yet allocated to an object,</span>
                        <span class="comment">\ so jump to dran4 to move on to the next object number</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ If bit 6 of the object flags for object #X is set</span>
 <span class="mne">BCS</span> <a class="popup destination">dran2</a>              <span class="comment">\ then object #X is stacked on top of another object,</span>
                        <span class="comment">\ so jump to dran2 to keep checking as this is a</span>
                        <span class="comment">\ potential target</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ If object #X is not a boulder (an object of type 3)</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ then jump to dran4 to move on to the next object</span>
 <span class="mne">BNE</span> <a class="popup destination">dran4</a>              <span class="comment">\ number</span>

<span class="label">.dran2</span><a id="dran2" class="anchor"></a>

                        <span class="comment">\ If we get here then object #X is either a boulder or</span>
                        <span class="comment">\ it is an object that is stacked on top of another</span>
                        <span class="comment">\ object</span>

 <span class="mne">LDA</span> <a class="popup variable">xObject</a>,<span class="register">X</span>          <span class="comment">\ Set (xTile, zTile) to the tile coordinates of the</span>
 <span class="mne">STA</span> <a class="popup variable">xTile</a>              <span class="comment">\ tile containing object #X</span>
 <span class="mne">LDA</span> <a class="popup variable">zObject</a>,<span class="register">X</span>
 <span class="mne">STA</span> <a class="popup variable">zTile</a>

 <span class="mne">JSR</span> <a class="popup destination">GetTileData</a>        <span class="comment">\ Set A to the tile data for the tile anchored at</span>
                        <span class="comment">\ (xTile, zTile), setting the C flag if the tile</span>
                        <span class="comment">\ contains an object</span>

 <span class="mne">BCC</span> <a class="popup destination">dran4</a>              <span class="comment">\ If the C flag is clear then this tile does not already</span>
                        <span class="comment">\ have an object placed on it, so jump to dran4 to move</span>
                        <span class="comment">\ on to the next object number</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">TAY</span>                    <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into Y (so</span>
                        <span class="comment">\ object #Y is either directly on the tile or is on the</span>
                        <span class="comment">\ top of the stack, so in either case it is the exposed</span>
                        <span class="comment">\ object in terms of potential targets)</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the type of object that's exposed on the tile</span>
                        <span class="comment">\ (i.e. the type of object #Y)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ If the exposed object is a tree (an object of type 2),</span>
 <span class="mne">BEQ</span> <a class="popup destination">dran3</a>              <span class="comment">\ jump to dran3 to keep checking as this is a potential</span>
                        <span class="comment">\ target</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ If the exposed object is a boulder (an object of</span>
 <span class="mne">BNE</span> <a class="popup destination">dran4</a>              <span class="comment">\ type 3), jump to dran4 to move on to the next object</span>
                        <span class="comment">\ number</span>

<span class="label">.dran3</span><a id="dran3" class="anchor"></a>

                        <span class="comment">\ If we get here then object #Y is either a boulder or</span>
                        <span class="comment">\ it is a tree that is stacked on top of another object,</span>
                        <span class="comment">\ and it is exposed as a potential target, so now we</span>
                        <span class="comment">\ check whether the enemy can see the object's tile (and</span>
                        <span class="comment">\ therefore whether it can be drained of energy by the</span>
                        <span class="comment">\ enemy)</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckEnemyGaze</a>     <span class="comment">\ Call CheckEnemyGaze to check the gaze of the enemy</span>
                        <span class="comment">\ towards object #Y, returning the following if the</span>
                        <span class="comment">\ the object matches the object type in A:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * targetVisibility = bit 7 set if the object's tile</span>
                        <span class="comment">\     is visible, bit 6 set if the object is visible</span>

 <span class="mne">LDA</span> <a class="popup variable">targetVisibility</a>   <span class="comment">\ If bit 7 of targetVisibility is clear then the enemy</span>
 <span class="mne">BPL</span> <a class="popup destination">dran4</a>              <span class="comment">\ can't see the exposed object's tile, so jump to dran4</span>
                        <span class="comment">\ to move on to the next object number</span>

                        <span class="comment">\ If we get here then object #Y's tile can be seen by</span>
                        <span class="comment">\ the enemy, so it is a suitable target for draining</span>

 <span class="mne">STY</span> <a class="popup variable">targetObject</a>       <span class="comment">\ Set targetObject to the object number in Y</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that the enemy can see a</span>
                        <span class="comment">\ drainable tree or boulder</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.dran4</span><a id="dran4" class="anchor"></a>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the counter in X to move on to the next</span>
                        <span class="comment">\ object number</span>

 <span class="mne">BPL</span> <a class="popup destination">dran1</a>              <span class="comment">\ Loop back to dran1 to check the next object number</span>

 <span class="mne">SEC</span>                    <span class="comment">\ If we get here then we have checked all 64 object</span>
                        <span class="comment">\ numbers and none of them are suitable targets for the</span>
                        <span class="comment">\ enemy to drain, so set the C flag to indicate this</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-abortwhenvisible" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">AbortWhenVisible</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Abort applying the tactics for this gameplay loop if updating the</span>
             <span class="headerEntry">object on-screen will corrupt a screen pan</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/abortwhenvisible.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_2_of_8.html">ApplyTactics (Part 2 of 8)</a> calls <a href="#abortwhenvisible">AbortWhenVisible</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_6_of_8.html">ApplyTactics (Part 6 of 8)</a> calls <a href="#abortwhenvisible">AbortWhenVisible</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/drainobjectenergy.html">DrainObjectEnergy</a> calls <a href="#abortwhenvisible">AbortWhenVisible</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The number of the object to check</span>

</div></div>
<span class="label">.AbortWhenVisible</span><a id="abortwhenvisible" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">CheckObjVisibility</a> <span class="comment">\ Check whether object A is visible and could therefore</span>
                        <span class="comment">\ be seen on-screen by the player</span>

 <span class="mne">BCS</span> <a class="popup destination">cvis1</a>              <span class="comment">\ If the C flag is clear then the object is partially</span>
                        <span class="comment">\ on-screen and we are about to repeat a screen pan, so</span>
                        <span class="comment">\ the object must not be updated or it could corrupt the</span>
                        <span class="comment">\ landscape view, so in this case fall through into</span>
                        <span class="comment">\ FinishEnemyTactics to stop applying tactics for this</span>
                        <span class="comment">\ gameplay loop</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Otherwise the C flag is set so we can safely update</span>
                        <span class="comment">\ the object without fear of corrupting a screen pan,</span>
                        <span class="comment">\ so we can jump to cvis1 to return from the subroutine</span>
                        <span class="comment">\ without aborting the tactics routine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-finishenemytactics" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FinishEnemyTactics</span>                                      <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Stop applying tactics to the current enemy and return to the</span>
             <span class="headerEntry">ProcessGameplay routine to continue with the gameplay loop</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/finishenemytactics.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/drainobjectenergy.html">DrainObjectEnergy</a> calls <a href="#finishenemytactics">FinishEnemyTactics</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/expendenemyenergy.html">ExpendEnemyEnergy</a> calls <a href="#finishenemytactics">FinishEnemyTactics</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/scanformeanietree.html">ScanForMeanieTree</a> calls <a href="#finishenemytactics">FinishEnemyTactics</a></span>
</div>
</div></div>
<span class="label">.FinishEnemyTactics</span><a id="finishenemytactics" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">gameplayStack</a>      <span class="comment">\ Restore the stack pointer to the position it was in</span>
 <span class="mne">TXS</span>                    <span class="comment">\ when we called ApplyEnemyTactics from ProcessGameplay,</span>
                        <span class="comment">\ so that executing an RTS instruction will now take us</span>
                        <span class="comment">\ back to the ProcessGameplay routine, just after the</span>
                        <span class="comment">\ JSR ApplyEnemyTactics instruction at play2</span>

 <span class="mne">JMP</span> <a class="popup destination">MoveOnToNextEnemy</a>  <span class="comment">\ Jump to MoveOnToNextEnemy to stop applying tactics to</span>
                        <span class="comment">\ this enemy and set things up so we move on to the next</span>
                        <span class="comment">\ enemy in the next iteration of the gameplay loop</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-checkobjvisibility" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">CheckObjVisibility</span>                                      <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing objects</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Check whether an object is visible on-screen and should therefore</span>
             <span class="headerEntry">not be changed if a pan operation is about to happen</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/checkobjvisibility.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/abortwhenvisible.html">AbortWhenVisible</a> calls <a href="#checkobjvisibility">CheckObjVisibility</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/expendenemyenergy.html">ExpendEnemyEnergy</a> calls <a href="#checkobjvisibility">CheckObjVisibility</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/scanformeanietree.html">ScanForMeanieTree</a> calls <a href="#checkobjvisibility">CheckObjVisibility</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/abortwhenvisible.html">AbortWhenVisible</a> calls via <a href="#cvis1">cvis1</a></span></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The number of the object to check</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">The object's visibility:</span>

                        <span class="argumentEntry">  * Clear = we are about to repeat a pan and at least</span>
                        <span class="argumentEntry">            some of the object is visible on-screen (so</span>
                        <span class="argumentEntry">            the object must not be updated or it could</span>
                        <span class="argumentEntry">            corrupt the landscape view)</span>

                        <span class="argumentEntry">  * Set = we are about to repeat a pan and the object is</span>
                        <span class="argumentEntry">          not visible on-screen, or we are not about to</span>
                        <span class="argumentEntry">          repeat a pan (so the object can be updated)</span>

   <span class="argumentLabel">bufferColumns</span>        <span class="argumentEntry">If the object is visible, this is set to the number of</span>
                        <span class="argumentEntry">character columns in the screen buffer that the object</span>
                        <span class="argumentEntry">spans</span>

   <span class="argumentLabel">objYawOffset</span>         <span class="argumentEntry">If the object is visible, this is set to the yaw offset</span>
                        <span class="argumentEntry">of the left edge of the object from the left edge of the</span>
                        <span class="argumentEntry">screen, in character columns</span>

   <span class="argumentLabel">currentObject</span>        <span class="argumentEntry">If we are about to repeat a pan, this is set to the</span>
                        <span class="argumentEntry">object number in A</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">X is preserved</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">Y is preserved</span>

<hr class="light">
<span class="subheader"> Other entry points:</span>

   <span class="argumentLabel">cvis1</span>                <span class="argumentEntry">Contains an RTS</span>

</div></div>
<span class="label">.CheckObjVisibility</span><a id="checkobjvisibility" class="anchor"></a>

 <span class="mne">SEC</span>                    <span class="comment">\ If bit 6 of samePanKeyPress is clear then the player</span>
 <span class="mne">BIT</span> <a class="popup variable">samePanKeyPress</a>    <span class="comment">\ if not holding down the same pan key following the</span>
 <span class="mne">BPL</span> <a class="popup destination">cvis1</a>              <span class="comment">\ completion of a landscape pan, so jump to cvis1 to</span>
                        <span class="comment">\ return from the subroutine with the C flag set</span>

                        <span class="comment">\ If we get here then we have just completed a pan of</span>
                        <span class="comment">\ the landscape view and the player is still holding</span>
                        <span class="comment">\ down the same pan key</span>

 <span class="mne">STA</span> <a class="popup variable">currentObject</a>      <span class="comment">\ Set currentObject to the object in A to pass to the</span>
                        <span class="comment">\ GetObjVisibility routine so we check whether the</span>

 <span class="mne">LDA</span> <a class="popup variable">playerObject</a>       <span class="comment">\ Set viewingObject to the object number of the player,</span>
 <span class="mne">STA</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ so any future view calculations are done from the</span>
                        <span class="comment">\ aspect of the player rather than the enemy object</span>

 <span class="mne">TXA</span>                    <span class="comment">\ Store X and Y on the stack so they can be preserved</span>
 <span class="mne">PHA</span>                    <span class="comment">\ across the call to GetObjVisibility</span>
 <span class="mne">TYA</span>
 <span class="mne">PHA</span>

 <span class="mne">JSR</span> <a class="popup destination">GetObjVisibility</a>   <span class="comment">\ Calculate whether any part of an object is visible</span>
                        <span class="comment">\ on-screen and set the C flag as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Clear = at least some of the object is visible</span>
                        <span class="comment">\             on-screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Set = the object is not visible on-screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If the object is visible, also set the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * bufferColumns = the number of character columns</span>
                        <span class="comment">\     in the screen buffer that the object spans</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * objYawOffset = the yaw offset of the left edge of</span>
                        <span class="comment">\     the object from the left edge of the screen, in</span>
                        <span class="comment">\     character columns</span>

 <span class="mne">PLA</span>                    <span class="comment">\ Retrieve X and Y from the stack so they can be</span>
 <span class="mne">TAY</span>                    <span class="comment">\ preserved</span>
 <span class="mne">PLA</span>
 <span class="mne">TAX</span>

<span class="label">.cvis1</span><a id="cvis1" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-processactionkeys-part-1-of-2" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">ProcessActionKeys (Part 1 of 2)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Keyboard</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Process an action key press from key logger entry 1 (absorb,</span>
             <span class="headerEntry">transfer, create, hyperspace, U-turn)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/processactionkeys_part_1_of_2.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processgameplay.html">ProcessGameplay</a> calls <a href="#processactionkeys">ProcessActionKeys</a></span>
</div>
<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag:</span>

                        <span class="argumentEntry">  * Clear if we have added or removed an object:</span>

                        <span class="argumentEntry">    * Player has absorbed (and therefore removed) an</span>
                        <span class="argumentEntry">      object</span>

                        <span class="argumentEntry">    * Player has created an object</span>

                        <span class="argumentEntry">  * Set if we have not added or removed any objects:</span>

                        <span class="argumentEntry">    * Player has hyperspaced</span>

                        <span class="argumentEntry">    * Player has done a U-turn</span>

                        <span class="argumentEntry">    * Player has transferred to a new tile</span>

                        <span class="argumentEntry">    * Player has tried to do something that results in</span>
                        <span class="argumentEntry">      an error sound and no action (such as trying to</span>
                        <span class="argumentEntry">      transfer to an empty tile or into an object that</span>
                        <span class="argumentEntry">      isn't a robot, for example)</span>

</div></div>
<span class="label">.ProcessActionKeys</span><a id="processactionkeys" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">keyPress</a>           <span class="comment">\ Set A to the value from the key logger for the key</span>
                        <span class="comment">\ press we want to process, which we know contains a</span>
                        <span class="comment">\ valid key press as we only call this routine when</span>
                        <span class="comment">\ bit 7 of the key logger value is clear</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The possible values for key logger entry 1 are:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 0  for key press "R" (Create robot)</span>
                        <span class="comment">\   * 2  for key press "T" (Create tree)</span>
                        <span class="comment">\   * 3  for key press "B" (Create boulder)</span>
                        <span class="comment">\   * 32 for key press "A" (Absorb)</span>
                        <span class="comment">\   * 33 for key press "Q" (Transfer)</span>
                        <span class="comment">\   * 34 for key press "H" (Hyperspace)</span>
                        <span class="comment">\   * 35 for key press "U" (U-turn)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So now we perform the correct action for the key press</span>
                        <span class="comment">\ in A</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">34</span>                <span class="comment">\ If A &lt;> 34 then the "H" key (hyperspace) is not being</span>
 <span class="mne">BNE</span> <a class="popup destination">pkey2</a>              <span class="comment">\ pressed, so jump to pkey2 to move on to the next check</span>

                        <span class="comment">\ If we get here then "H" (hyperspace) is being pressed</span>

 <span class="mne">JSR</span> <a class="popup destination">PerformHyperspace</a>  <span class="comment">\ Hyperspace the player to a brand new tile</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set titleObjectToDraw to the object type for a robot,</span>
 <span class="mne">STA</span> <a class="popup variable">titleObjectToDraw</a>  <span class="comment">\ so if the hyperspace fails because the player doesn't</span>
                        <span class="comment">\ have enough energy, then the game over screen will</span>
                        <span class="comment">\ show a robot to indicate that the player was</span>
                        <span class="comment">\ responsible for their own demise</span>

<span class="label">.pkey1</span><a id="pkey1" class="anchor"></a>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to denote that no object has been added</span>
                        <span class="comment">\ or removed by the routine</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.pkey2</span><a id="pkey2" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ Set X to the object number of the viewer, which we set</span>
                        <span class="comment">\ to the player object in MainGameLoop before getting</span>
                        <span class="comment">\ here via the ProcessGameplay routine</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">35</span>                <span class="comment">\ If A &lt;> 35 then the "U" key (U-turn) is not being</span>
 <span class="mne">BNE</span> <a class="popup destination">pkey3</a>              <span class="comment">\ pressed, so jump to pkey3 to move on to the next check</span>

                        <span class="comment">\ If we get here then "U" (U-turn) is being pressed</span>

                        <span class="comment">\ If we get here with bit 6 of uTurnStatus set, then</span>
                        <span class="comment">\ this is the first time we have reached this point</span>
                        <span class="comment">\ since the key was pressed (as we are about to clear</span>
                        <span class="comment">\ bit 6), so we can perform the requested U-turn</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If we get here with bit 6 of uTurnStatus clear, then</span>
                        <span class="comment">\ this isn't the first time we've reached this point</span>
                        <span class="comment">\ since the key was pressed, so in this case we don't</span>
                        <span class="comment">\ do another U-turn, as we're already done one</span>

 <span class="mne">ASL</span> <a class="popup variable">uTurnStatus</a>        <span class="comment">\ Clear bit 6 uTurnStatus to prevent the "U" key from</span>
                        <span class="comment">\ performing a U-turn, so that the "U" key has to be</span>
                        <span class="comment">\ released before a second U-turn can be performed</span>

 <span class="mne">BPL</span> <a class="popup destination">pkey1</a>              <span class="comment">\ If bit 7 of uTurnStatus is now clear, then that means</span>
                        <span class="comment">\ that bit 6 was clear before the above shift, which</span>
                        <span class="comment">\ means we are currently ignoring the "U" key to prevent</span>
                        <span class="comment">\ doing a second U-turn, so jump to pkey1 to skip doing</span>
                        <span class="comment">\ another U-turn and instead return from the subroutine</span>
                        <span class="comment">\ with the C flag set</span>

                        <span class="comment">\ If we get here then "U" is being pressed and bit 6 of</span>
                        <span class="comment">\ uTurnStatus was set before being cleared above, so we</span>
                        <span class="comment">\ now perform a U-turn</span>

 <span class="mne">LDA</span> <a class="popup variable">objectYawAngle</a>,<span class="register">X</span>   <span class="comment">\ Rotate the player's yaw angle through 180 degrees by</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ flipping bit 7, which turns the player around</span>
 <span class="mne">STA</span> <a class="popup variable">objectYawAngle</a>,<span class="register">X</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">40</span>                <span class="comment">\ Set A = 40 to pass to the PlayMusic routine after we</span>
                        <span class="comment">\ jump to pkey4, so it plays the music for a U-turn</span>

 <span class="mne">BNE</span> <a class="popup destination">pkey4</a>              <span class="comment">\ Jump to pkey4 to play the U-turn music and return from</span>
                        <span class="comment">\ the subroutine with the C flag set (this BNE is</span>
                        <span class="comment">\ effectively a JMP as A is never zero)</span>

<span class="label">.pkey3</span><a id="pkey3" class="anchor"></a>

                        <span class="comment">\ If we get here then the key press is either create,</span>
                        <span class="comment">\ absorb or transfer</span>

 <span class="mne">LSR</span> <a class="popup variable">enemyCheckingRobot</a> <span class="comment">\ Clear bit 7 of enemyCheckingRobot to pass to the call</span>
                        <span class="comment">\ to FollowGazeVector below, so it returns results for</span>
                        <span class="comment">\ the tile visibility rather than the object itself</span>

 <span class="mne">JSR</span> <a class="popup destination">GetSightsVector</a>    <span class="comment">\ Calculate the vector from the player's eyes to the</span>
                        <span class="comment">\ sights, returning it in both angle format:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   vectorYawAngle(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   vectorPitchAngle(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and as a cartesian vector:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xVector(Lo Bot) ]</span>
                        <span class="comment">\   [ yVector(Lo Bot) ]</span>
                        <span class="comment">\   [ zVector(Lo Bot) ]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This vector is the vector from the player's eyes to</span>
                        <span class="comment">\ the sights, divided by 16 by the GetVectorForAngles</span>
                        <span class="comment">\ routine that GetSightsVector uses</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The "divided by 16" part is important, as we want to</span>
                        <span class="comment">\ divide the vector from the player to the sights into</span>
                        <span class="comment">\ small steps, so we can move along the vector</span>
                        <span class="comment">\ sequentially, checking on each step whether the</span>
                        <span class="comment">\ vector is passing through a flat tile or platform</span>

 <span class="mne">JSR</span> <a class="popup destination">FollowGazeVector</a>   <span class="comment">\ Follow the gaze vector from the player's eyes to the</span>
                        <span class="comment">\ sights to determine whether the player can see a flat</span>
                        <span class="comment">\ tile or platform (i.e. boulder or tower) or the</span>
                        <span class="comment">\ target object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If it does hit a tile or platform, it sets xCoordHi</span>
                        <span class="comment">\ and zCoordHi to the tile coordinates of the tile,</span>
                        <span class="comment">\ which we use below for creating or removing objects</span>
                        <span class="comment">\ on the tile in the sights</span>

 <span class="mne">BCS</span> <a class="popup destination">pkey7</a>              <span class="comment">\ If the C flag is set then this means the player can't</span>
                        <span class="comment">\ see a tile or platform through the sights, so jump to</span>
                        <span class="comment">\ pkey7 to make an error sound and return from the</span>
                        <span class="comment">\ subroutine as we can't see a suitable surface for the</span>
                        <span class="comment">\ create, absorb or transfer action</span>

 <span class="mne">LDA</span> <a class="popup variable">keyPress</a>           <span class="comment">\ If bit 5 of keypress is clear then A is not 32 or 33,</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00100000</span>         <span class="comment">\ so A must be 0, 2 or 3 (one of the create keys), so</span>
 <span class="mne">BEQ</span> <a class="popup destination">pkey8</a>              <span class="comment">\ jump to pkey8 to spawn a robot, tree or boulder</span>

                        <span class="comment">\ If we get here then A must be 32 or 33, so the key</span>
                        <span class="comment">\ press is either absorb or transfer</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileData</a>        <span class="comment">\ Set A to the tile data for the tile anchored at</span>
                        <span class="comment">\ (xTile, zTile), setting the C flag if the tile</span>
                        <span class="comment">\ contains an object</span>

 <span class="mne">BCC</span> <a class="popup destination">pkey7</a>              <span class="comment">\ The tile does not contain an object, so jump to pkey7</span>
                        <span class="comment">\ to make an error sound and return from the subroutine</span>
                        <span class="comment">\ as we can't absorb or transfer to an empty tile</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">TAX</span>                    <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into X</span>

 <span class="mne">LDA</span> <a class="popup variable">keyPress</a>           <span class="comment">\ If bit 0 of keypress is clear then A must be 32, which</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ is absorb, so jump to pkey5 to absorb the object on</span>
 <span class="mne">BCC</span> <a class="popup destination">pkey5</a>              <span class="comment">\ the tile anchored at (xTile, zTile)</span>

                        <span class="comment">\ If we get here then A must be 33, so the key press is</span>
                        <span class="comment">\ transfer and the player is trying to transfer to the</span>
                        <span class="comment">\ tile anchored at (xTile, zTile), which contains</span>
                        <span class="comment">\ object #X</span>

 <span class="mne">LDY</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ Set Y to the type of object #X</span>

 <span class="mne">BNE</span> <a class="popup destination">pkey7</a>              <span class="comment">\ If object #X is not a robot (i.e. not an object of</span>
                        <span class="comment">\ type 0), jump to pkey7 to make an error sound and</span>
                        <span class="comment">\ return from the subroutine as the player can only</span>
                        <span class="comment">\ transfer into other robots</span>

 <span class="mne">JSR</span> <a class="popup destination">FocusOnKeyAction</a>   <span class="comment">\ Tell the game to start focusing effort on the key</span>
                        <span class="comment">\ action that has been initiated (i.e. the transfer)</span>

 <span class="mne">STX</span> <a class="popup variable">playerObject</a>       <span class="comment">\ Set the player's object number to that of the robot</span>
                        <span class="comment">\ on the tile anchored at (xTile, zTile), so this</span>
                        <span class="comment">\ effectively performs the transfer across to the new</span>
                        <span class="comment">\ robot</span>

                        <span class="comment">\ We now take a short interlude to set the value of</span>
                        <span class="comment">\ playerIsOnTower, as part of the game's anti-cracker</span>
                        <span class="comment">\ code, and we pick up the robot transfer code in part 2</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-setplayerisontower" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">SetPlayerIsOnTower</span>                                      <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Cracker protection</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Set up the playerIsOnTower value for checking the game is won, as</span>
             <span class="headerEntry">part of the anti-cracker code</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/setplayerisontower.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.SetPlayerIsOnTower</span><a id="setplayerisontower" class="anchor"></a>

                        <span class="comment">\ We now work out whether the player just transferred</span>
                        <span class="comment">\ into a robot on the Sentinel's tower</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We do this by starting at object #X, which is the</span>
                        <span class="comment">\ robot that the player just transferred into, and if</span>
                        <span class="comment">\ it's on top of another object or stack of objects, we</span>
                        <span class="comment">\ work our way down the stack, checking to see if the</span>
                        <span class="comment">\ stack contains the Sentinel's tower</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The Sentinel's tower is always the first object to be</span>
                        <span class="comment">\ spawned, and object numbers are allocated from 63 and</span>
                        <span class="comment">\ down, so this means the tower is always object #63, or</span>
                        <span class="comment">\ %111111, so that's what we look for while working</span>
                        <span class="comment">\ through the object stack</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This forms part of the code to protect the game from</span>
                        <span class="comment">\ crackers, as all we do with this information is to set</span>
                        <span class="comment">\ playerIsOnTower to the object type of the tower (which</span>
                        <span class="comment">\ is 6). This value is then used to generate the secret</span>
                        <span class="comment">\ code for the completed landscape, so if crackers have</span>
                        <span class="comment">\ jumped straight to the end of the level without</span>
                        <span class="comment">\ setting playerIsOnTower to 6, then the wrong code will</span>
                        <span class="comment">\ be generated in the SpawnSecretCode3D routine</span>

<span class="label">.ptow1</span><a id="ptow1" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">X</span>      <span class="comment">\ Set A to the object flags for object #X</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ If both bits 6 and 7 of the object flags for object #X</span>
 <span class="mne">BCC</span> <a class="popup destination">ptow2</a>              <span class="comment">\ are clear then object #X is not stacked on top of</span>
                        <span class="comment">\ another object (so if we have looped back here from</span>
                        <span class="comment">\ below, we have reached the bottom of the stack), so</span>
                        <span class="comment">\ jump to ptow2 to stop looping through the object stack</span>
                        <span class="comment">\ and go back to the ProcessActionKeys routine</span>

                        <span class="comment">\ If we get here then object #X is stacked on top of</span>
                        <span class="comment">\ another object, and the number of the object below</span>
                        <span class="comment">\ object #X is in bits 0 to 5 of the object flags for</span>
                        <span class="comment">\ object #X, which is currently in A</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Extract bits 0 to 5 of the object flags into A and X,</span>
 <span class="mne">TAX</span>                    <span class="comment">\ so X now contains the object number of the next object</span>
                        <span class="comment">\ down in the stack</span>

 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ If the object number in A is not the Sentinel's tower</span>
 <span class="mne">BNE</span> <a class="popup destination">ptow1</a>              <span class="comment">\ (i.e. it is not 63, or %111111), then loop back to</span>
                        <span class="comment">\ check the next object down in the stack</span>

                        <span class="comment">\ If we get here then the player has just transferred</span>
                        <span class="comment">\ into a robot on the Sentinel's tower</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ Set playerIsOnTower = 6 (which is the object type of</span>
 <span class="mne">STA</span> <a class="popup variable">playerIsOnTower</a>    <span class="comment">\ the Sentinel's tower, whose object number is in X)</span>

<span class="label">.ptow2</span><a id="ptow2" class="anchor"></a>

                        <span class="comment">\ Fall through into part 2 of ProcessActionKeys to</span>
                        <span class="comment">\ continue with the robot transfer</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-processactionkeys-part-2-of-2" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">ProcessActionKeys (Part 2 of 2)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Keyboard</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Process an action key press from key logger entry 1 (absorb,</span>
             <span class="headerEntry">transfer, create, hyperspace, U-turn)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/processactionkeys_part_2_of_2.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
                        <span class="comment">\ If we get here then the player has just transferred</span>
                        <span class="comment">\ into a robot</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">25</span>                <span class="comment">\ Set A = 25 to pass to the PlayMusic routine so it</span>
                        <span class="comment">\ plays the music for when the player transfers into a</span>
                        <span class="comment">\ new robot</span>

<span class="label">.pkey4</span><a id="pkey4" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">PlayMusic</a>          <span class="comment">\ Call PlayMusic to play the music specified in A (so</span>
                        <span class="comment">\ that's either the music for transferring into a new</span>
                        <span class="comment">\ robot or the music for a U-turn)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set bit 7 of playerHasMovedTile to indicate that the</span>
 <span class="mne">STA</span> <a class="popup variable">playerHasMovedTile</a> <span class="comment">\ player has moved to a new tile</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to denote that no object has been added</span>
                        <span class="comment">\ or removed by the routine</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.pkey5</span><a id="pkey5" class="anchor"></a>

                        <span class="comment">\ If we get here then we are absorbing an object of type</span>
                        <span class="comment">\ X from the tile anchored at (xTile, zTile)</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>        <span class="comment">\ The Sentinel is always object #0, so this checks</span>
 <span class="mne">BMI</span> <a class="popup destination">pkey7</a>              <span class="comment">\ whether bit 7 of the Sentinel's object is set, which</span>
                        <span class="comment">\ indicates that the Sentinel's object number is not</span>
                        <span class="comment">\ allocated</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that the Sentinel no longer exists and has</span>
                        <span class="comment">\ been absorbed by the player, at which point the player</span>
                        <span class="comment">\ is no longer allowed to absorb other objects, so jump</span>
                        <span class="comment">\ to pkey7 to make an error sound and return from the</span>
                        <span class="comment">\ subroutine</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ If the player is trying to absorb a meanie (an object</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ of type 4), jump to pkey11 to implement this</span>
 <span class="mne">BEQ</span> <a class="popup destination">pkey11</a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">6</span>                 <span class="comment">\ If the player is trying to absorb the Sentinel's tower</span>
 <span class="mne">BEQ</span> <a class="popup destination">pkey7</a>              <span class="comment">\ (an object of type 6), jump to pkey7 to make an error</span>
                        <span class="comment">\ sound and return from the subroutine</span>

<span class="label">.pkey6</span><a id="pkey6" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">DeleteObject</a>       <span class="comment">\ Delete object #X and remove it from the landscape</span>

 <span class="mne">STX</span> <a class="popup variable">currentObject</a>      <span class="comment">\ Set currentObject to the number of the deleted object</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Call UpdatePlayerEnergy with the C flag clear to add</span>
 <span class="mne">JSR</span> <a class="popup destination">UpdatePlayerEnergy</a> <span class="comment">\ the amount of energy in the now-deleted object #X to</span>
                        <span class="comment">\ the player's energy</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to denote that an object has been</span>
                        <span class="comment">\ removed by the routine</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.pkey7</span><a id="pkey7" class="anchor"></a>

                        <span class="comment">\ If we get here then the player has tried to:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Absorb or transfer to an empty tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Create, absorb or transfer to a tile or platform</span>
                        <span class="comment">\     that they see directly</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Transfer to an object that is not a robot</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Absorb an object after the Sentinel has been</span>
                        <span class="comment">\     absorbed</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Absorb the Sentinel's tower</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Create an object when there are no unallocated</span>
                        <span class="comment">\     object numbers</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Create an object that takes their energy level</span>
                        <span class="comment">\     below zero</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Create an object that can't be added to the tile</span>
                        <span class="comment">\     (if the tile is occupied by an object that is not</span>
                        <span class="comment">\     a boulder or tower, for example)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In each case we make an error sound and return from</span>
                        <span class="comment">\ the subroutine</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">170</span>               <span class="comment">\ Set the third parameter of sound data block #3 (the</span>
 <span class="mne">STA</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">28</span>       <span class="comment">\ pitch) to 170</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ Make sound #5 (ping)</span>
 <span class="mne">JSR</span> <a class="popup destination">MakeSound</a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">144</span>               <span class="comment">\ Set the third parameter of sound data block #3 (the</span>
 <span class="mne">STA</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">28</span>       <span class="comment">\ pitch) to 144</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to denote that no object has been added</span>
                        <span class="comment">\ or removed by the routine</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.pkey8</span><a id="pkey8" class="anchor"></a>

                        <span class="comment">\ If we get here then the player is trying to create an</span>
                        <span class="comment">\ object of the type given in keyPress</span>

 <span class="mne">JSR</span> <a class="popup destination">SpawnObject+3</a>      <span class="comment">\ Spawn an object of type keyPress, returning the object</span>
                        <span class="comment">\ number of the new object in X and currentObject</span>

 <span class="mne">BCS</span> <a class="popup destination">pkey7</a>              <span class="comment">\ If there are no free object numbers then the call to</span>
                        <span class="comment">\ SpawnObject will return with the C flag set and the</span>
                        <span class="comment">\ object will not have been created, so jump to pkey7 to</span>
                        <span class="comment">\ make an error sound and return from the subroutine</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Call UpdatePlayerEnergy with the C flag set to</span>
 <span class="mne">JSR</span> <a class="popup destination">UpdatePlayerEnergy</a> <span class="comment">\ subtract the amount of energy in object #X from the</span>
                        <span class="comment">\ player's energy, so this subtracts the energy required</span>
                        <span class="comment">\ to create the object from the player</span>

 <span class="mne">BCS</span> <a class="popup destination">pkey7</a>              <span class="comment">\ If the creation of object #X reduces the player's</span>
                        <span class="comment">\ energy below zero, then the call to UpdatePlayerEnergy</span>
                        <span class="comment">\ will return with the C flag set, so jump to pkey7 to</span>
                        <span class="comment">\ make an error sound and return from the subroutine</span>

 <span class="mne">LDX</span> <a class="popup variable">currentObject</a>      <span class="comment">\ Set X to the object number of the object we just</span>
                        <span class="comment">\ created</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordHi</a>           <span class="comment">\ Set (xTile, zTile) to the tile coordinates of the tile</span>
 <span class="mne">STA</span> <a class="popup variable">xTile</a>              <span class="comment">\ in the sights, which we set in part 1 with the call to</span>
 <span class="mne">LDA</span> <a class="popup variable">zCoordHi</a>           <span class="comment">\ FollowGazeVector</span>
 <span class="mne">STA</span> <a class="popup variable">zTile</a>

 <span class="mne">JSR</span> <a class="popup destination">PlaceObjectOnTile</a>  <span class="comment">\ Place object #X on the tile anchored at (xTile, zTile)</span>

 <span class="mne">BCC</span> <a class="popup destination">pkey9</a>              <span class="comment">\ If the object was successfully placed on the tile then</span>
                        <span class="comment">\ the call to PlaceObjectOnTile will return with the C</span>
                        <span class="comment">\ flag clear, so jump to pkey9 to keep going</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Otherwise we failed to add the object to the tile, so</span>
 <span class="mne">JSR</span> <a class="popup destination">UpdatePlayerEnergy</a> <span class="comment">\ call UpdatePlayerEnergy with the C flag clear to</span>
                        <span class="comment">\ refund the energy that we used to create the object</span>
                        <span class="comment">\ back to the player</span>

 <span class="mne">JMP</span> <a class="popup destination">pkey7</a>              <span class="comment">\ We failed to place the object on the tile, so jump to</span>
                        <span class="comment">\ pkey7 to make an error sound and return from the</span>
                        <span class="comment">\ subroutine</span>

<span class="label">.pkey9</span><a id="pkey9" class="anchor"></a>

                        <span class="comment">\ If we get here then a new object has been successfully</span>
                        <span class="comment">\ created and added to a tile, as object #X</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ If the type of object that was added is not a robot</span>
 <span class="mne">BNE</span> <a class="popup destination">pkey10</a>             <span class="comment">\ (type 0), jump to pkey10 to return from the subroutine</span>
                        <span class="comment">\ with the C flag clear</span>

                        <span class="comment">\ We just created a robot, so we now rotate it so that</span>
                        <span class="comment">\ it faces the player</span>

 <span class="mne">LDY</span> <a class="popup variable">playerObject</a>       <span class="comment">\ Set A to the yaw angle of the player object</span>
 <span class="mne">LDA</span> <a class="popup variable">objectYawAngle</a>,<span class="register">Y</span>

 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Flip bit 7 to rotate the angle through 180 degrees</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The degree system in the Sentinel looks like this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\            0</span>
                        <span class="comment">\      -32   |   +32         Overhead view of object</span>
                        <span class="comment">\         \  |  /</span>
                        <span class="comment">\          \ | /             0 = looking straight ahead</span>
                        <span class="comment">\           \|/              +64 = looking sharp right</span>
                        <span class="comment">\   -64 -----+----- +64      -64 = looking sharp left</span>
                        <span class="comment">\           /|\</span>
                        <span class="comment">\          / | \</span>
                        <span class="comment">\         /  |  \</span>
                        <span class="comment">\      -96   |   +96</span>
                        <span class="comment">\           128</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Flipping bit 7 changes 0 into 128, +32 into -96, +64</span>
                        <span class="comment">\ into -64 and so on, so it's the same as rotating by</span>
                        <span class="comment">\ 180 degrees</span>

 <span class="mne">STA</span> <a class="popup variable">objectYawAngle</a>,<span class="register">X</span>   <span class="comment">\ Set the yaw angle for the newly created robot to the</span>
                        <span class="comment">\ player's yaw angle rotated through 180 degrees, so the</span>
                        <span class="comment">\ new robot faces the player</span>

<span class="label">.pkey10</span><a id="pkey10" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to denote that an object has been</span>
                        <span class="comment">\ added by the routine</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.pkey11</span><a id="pkey11" class="anchor"></a>

                        <span class="comment">\ If we get here then the player is trying to absorb a</span>
                        <span class="comment">\ meanie in object #X</span>

                        <span class="comment">\ We now loop through all the enemy objects, of which</span>
                        <span class="comment">\ there are up to eight, looking for the object whose</span>
                        <span class="comment">\ enemyMeanieTree entry is X (so we are looking for the</span>
                        <span class="comment">\ enemy that turned a tree into this meanie)</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">7</span>                 <span class="comment">\ The enemies have object numbers 0 (for the Sentinel)</span>
                        <span class="comment">\ or 1 to 7 (for any sentries in the landscape), so set</span>
                        <span class="comment">\ a counter in Y to work through the enemy object</span>
                        <span class="comment">\ numbers</span>

<span class="label">.pkey12</span><a id="pkey12" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ If bit 7 is set for object #Y then this object number</span>
 <span class="mne">BMI</span> <a class="popup destination">pkey14</a>             <span class="comment">\ is not allocated to an object, so jump to pkey14 to</span>
                        <span class="comment">\ move on to the next enemy object</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the object type for object #Y</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ If object #Y is a sentry (an object of type 1) then</span>
 <span class="mne">BEQ</span> <a class="popup destination">pkey13</a>             <span class="comment">\ jump to pkey13</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ If object #Y is not the Sentinel (an object of type</span>
 <span class="mne">BNE</span> <a class="popup destination">pkey14</a>             <span class="comment">\ 5), then jump to pkey14 to move on to the next enemy</span>
                        <span class="comment">\ object</span>

<span class="label">.pkey13</span><a id="pkey13" class="anchor"></a>

                        <span class="comment">\ If we get here then object #Y is the Sentinel or a</span>
                        <span class="comment">\ sentry</span>

 <span class="mne">TXA</span>                    <span class="comment">\ Set A to the object number of the meanie that the</span>
                        <span class="comment">\ player is trying to absorb</span>

 <span class="mne">CMP</span> <a class="popup variable">enemyMeanieTree</a>,<span class="register">Y</span>  <span class="comment">\ If enemyMeanieTree for object #Y does not match the</span>
 <span class="mne">BNE</span> <a class="popup destination">pkey14</a>             <span class="comment">\ object number of the meanie we are absorbing, then</span>
                        <span class="comment">\ this means object #Y did not create this meanie, so</span>
                        <span class="comment">\ jump to pkey14 to move on to the next enemy object</span>

                        <span class="comment">\ If we get here then we have found the enemy that</span>
                        <span class="comment">\ turned a tree into the meanie that is being absorbed</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set bit 7 of enemyMeanieTree so the enemy that turned</span>
 <span class="mne">STA</span> <a class="popup variable">enemyMeanieTree</a>,<span class="register">Y</span>  <span class="comment">\ a tree into the meanie is no longer flagged as such</span>
                        <span class="comment">\ (as the meanie has been absorbed)</span>

 <span class="mne">BNE</span> <a class="popup destination">pkey6</a>              <span class="comment">\ Jump to pkey6 to delete the meanie in object #X, add</span>
                        <span class="comment">\ the meanie's energy to the player's energy, and return</span>
                        <span class="comment">\ from the subroutine with the C flag clear (this BNE is</span>
                        <span class="comment">\ effectively a JMP as A is never zero)</span>

<span class="label">.pkey14</span><a id="pkey14" class="anchor"></a>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the counter in Y to move on to the next</span>
                        <span class="comment">\ enemy object number</span>

 <span class="mne">BPL</span> <a class="popup destination">pkey12</a>             <span class="comment">\ Loop back until we have processed all eight possible</span>
                        <span class="comment">\ enemy objects</span>

 <span class="mne">BMI</span> <a class="popup destination">pkey6</a>              <span class="comment">\ Jump to pkey6 to delete the meanie in object #X, add</span>
                        <span class="comment">\ the meanie's energy to the player's energy, and return</span>
                        <span class="comment">\ from the subroutine with the C flag clear</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-getsightsvector" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">GetSightsVector</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate the angles of the vector from the player's eyes to the</span>
             <span class="headerEntry">sights</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/getsightsvector.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processactionkeys_part_1_of_2.html">ProcessActionKeys (Part 1 of 2)</a> calls <a href="#getsightsvector">GetSightsVector</a></span>
</div>
<hr class="light">
 The vector from the player's eyes to the sights is calculated as follows:

   vectorYawAngle = (xSights * 32) + (objectYawAngle,X 0) - (10 0)

   vectorPitchAngle = (ySights - 5) * 16 + (objectPitchAngle,X 0) + (3 32)

 The (10 0) element in the yaw angle calculation represents half a screen
 width, as the screen is 20 yaw angles wide, so subtracting (10 0) from the
 object's yaw angle makes it to the left edge of the screen, and then we add
 the x-coordinate of the sights on-screen to get the vector's yaw angle.

 The -5 in the pitch angle calculation caters for the distance between the top
 of the sights and the centre of the sights, and the (3 32) element represents
 ???.

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">This is always set to the object number of the player</span>
                        <span class="argumentEntry">(it is set in ProcessActionKeys before it calls this</span>
                        <span class="argumentEntry">routine)</span>

</div></div>
<span class="label">.GetSightsVector</span><a id="getsightsvector" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">xSights</a>            <span class="comment">\ Set (U A) = xSights</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>

 <span class="mne">LSR</span> <a class="popup variable">U</a>                  <span class="comment">\ Set (U A) = (U A) / 8</span>
 <span class="mne">ROR</span> <span class="register">A</span>                  <span class="comment">\           = xSights / 8</span>
 <span class="mne">LSR</span> <a class="popup variable">U</a>
 <span class="mne">ROR</span> <span class="register">A</span>
 <span class="mne">LSR</span> <a class="popup variable">U</a>
 <span class="mne">ROR</span> <span class="register">A</span>
                        <span class="comment">\ We now calculate the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (U A) + (objectYawAngle,X 0) - (10 0)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and store it in vectorYawAngle(Hi Lo)</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag for the following</span>

 <span class="mne">STA</span> <a class="popup variable">vectorYawAngleLo</a>   <span class="comment">\ Store the low byte of the calculation (which we know</span>
                        <span class="comment">\ will be A) in vectorYawAngleLo</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Calculate the high byte of the calculation as</span>
 <span class="mne">ADC</span> <a class="popup variable">objectYawAngle</a>,<span class="register">X</span>   <span class="comment">\ follows:</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\   U + objectYawAngle,X - 10</span>
 <span class="mne">STA</span> <a class="popup variable">vectorYawAngleHi</a>   <span class="comment">\</span>
                        <span class="comment">\ and store it in vectorYawAngleHi</span>

                        <span class="comment">\ So vectorYawAngle(Hi Lo) is now equal to the</span>
                        <span class="comment">\ following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (xSights / 8) + (objectYawAngle,X 0) - (10 0)</span>

 <span class="mne">LDA</span> <a class="popup variable">ySights</a>            <span class="comment">\ Set (U A) = ySights - 5</span>
 <span class="mne">SEC</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">5</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>

 <span class="mne">LSR</span> <a class="popup variable">U</a>                  <span class="comment">\ Set (U A) = (U A) / 16</span>
 <span class="mne">ROR</span> <span class="register">A</span>                  <span class="comment">\           = (ySights - 5) / 16</span>
 <span class="mne">LSR</span> <a class="popup variable">U</a>
 <span class="mne">ROR</span> <span class="register">A</span>
 <span class="mne">LSR</span> <a class="popup variable">U</a>
 <span class="mne">ROR</span> <span class="register">A</span>
 <span class="mne">LSR</span> <a class="popup variable">U</a>
 <span class="mne">ROR</span> <span class="register">A</span>

                        <span class="comment">\ We now calculate the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (U A) + (objectPitchAngle,X 0) + (3 32)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and store it in both (A T) and in</span>
                        <span class="comment">\ vectorPitchAngle(Hi Lo)</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Calculate the low byte and store it in both T and</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ vectorPitchAngleLo</span>
 <span class="mne">STA</span> <a class="popup variable">vectorPitchAngleLo</a>
 <span class="mne">STA</span> <a class="popup variable">T</a>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Calculate the high byte, keep it in A and store it in</span>
 <span class="mne">ADC</span> <a class="popup variable">objectPitchAngle</a>,<span class="register">X</span> <span class="comment">\ vectorPitchAngleHi</span>
 <span class="mne">CLC</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">3</span>
 <span class="mne">STA</span> <a class="popup variable">vectorPitchAngleHi</a>

                        <span class="comment">\ So by this point we have the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   vectorYawAngle(Hi Lo)</span>
                        <span class="comment">\   = (xSights / 8) + (objectYawAngle,X 0) - (10 0)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   vectorPitchAngle(Hi Lo)</span>
                        <span class="comment">\   = (ySights-5) / 16 + (objectPitchAngle,X 0) + (3 32)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now fall through into GetVectorForAngles to convert</span>
                        <span class="comment">\ these two angles into a cartesian vector:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xVector(Lo Bot) ]</span>
                        <span class="comment">\   [ yVector(Lo Bot) ]</span>
                        <span class="comment">\   [ zVector(Lo Bot) ]</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-getvectorforangles" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">GetVectorForAngles</span>                                      <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Convert a vector from pitch and yaw angles into a 3D cartesian</span>
             <span class="headerEntry">vector</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/getvectorforangles.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkenemygaze_part_2_of_2.html">CheckEnemyGaze (Part 2 of 2)</a> calls <a href="#getvectorforangles">GetVectorForAngles</a></span>
</div>
<hr class="light">
 This routine uses the rotation matrix routine from Revs to convert a vector
 from a pair of pitch and yaw angles into a cartesian [x y z] vector.

 The pitch and yaw angles are 16-bit numbers as follows:

   vectorPitchAngle(Hi Lo)

   vectorYawAngle(Hi Lo)

 The same vector, but expressed as a cartesian vector, is calculated as
 follows:

   [ xVector(Lo Bot) ]
   [ yVector(Lo Bot) ]
   [ zVector(Lo Bot) ]

 The calculation is this:

   yVector = sinVectorPitchAngle / 16

   zVector = cosVectorPitchAngle * cosVectorYawAngle / 16

   xVector = cosVectorPitchAngle * sinVectorYawAngle / 16

</div></div>
<span class="label">.GetVectorForAngles</span><a id="getvectorforangles" class="anchor"></a>

                        <span class="comment">\ In the following commentary I am talking about the</span>
                        <span class="comment">\ vector from the player's eyes to the sights, as that</span>
                        <span class="comment">\ makes it easier to describe the various points, but</span>
                        <span class="comment">\ this routine can convert any vector into angles using</span>
                        <span class="comment">\ the same process</span>

                        <span class="comment">\ We start by converting the pitch angle of the vector</span>
                        <span class="comment">\ from the player's eyes to the sights into a cartesian</span>
                        <span class="comment">\ y-coordinate in the global 3D coordinate system, where</span>
                        <span class="comment">\ the y-axis is the up-down axis</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We store the resulting y-coordinate in the 16-bit</span>
                        <span class="comment">\ variable yVector(Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We calculate yVector by considering a triangle with</span>
                        <span class="comment">\ the sights vector as the hypotenuse, and we drop the</span>
                        <span class="comment">\ end point down onto the y = 0 plane (i.e. onto the</span>
                        <span class="comment">\ ground)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Consider the case where the player is looking up at an</span>
                        <span class="comment">\ angle of vectorPitchAngle, so the vector from the</span>
                        <span class="comment">\ player's eye to the sights is from the bottom-left to</span>
                        <span class="comment">\ the top-right in the following triangle:</span>
                        <span class="comment">\</span>
                        <span class="comment">\                                   sights</span>
                        <span class="comment">\                               _.-+             ^</span>
                        <span class="comment">\                           _.-   |             |</span>
                        <span class="comment">\              vector   _.-       |         y-axis (up)</span>
                        <span class="comment">\                   _.-           |</span>
                        <span class="comment">\               _.-               |  y</span>
                        <span class="comment">\           _.-                   |</span>
                        <span class="comment">\        .- vectorPitchAngle      |</span>
                        <span class="comment">\   eye +--------------------------+</span>
                        <span class="comment">\                   p</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To make the calculations easier, let's say the length</span>
                        <span class="comment">\ of the vector is 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Trigonometry gives us the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sin(vectorPitchAngle) = opposite / hypotenuse</span>
                        <span class="comment">\                         = y / 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So the y-coordinate is given by:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   y = sin(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ which is what we calculate now</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Incidentally, the adjacent side p, which is the length</span>
                        <span class="comment">\ of the vector projected down onto the y = 0 plane, is</span>
                        <span class="comment">\ calculated in a similar way:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(vectorPitchAngle) = adjacent / hypotenuse</span>
                        <span class="comment">\                         = p / 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So p = cos(vectorPitchAngle), which we will use to</span>
                        <span class="comment">\ calculate the x- and z-coordinates of the vector later</span>

 <span class="mne">JSR</span> <a class="popup destination">GetRotationMatrix</a>  <span class="comment">\ This routine is taken from Revs, where it calculates a</span>
                        <span class="comment">\ rotation matrix from an angle</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We don't need a full rotation matrix here, but the</span>
                        <span class="comment">\ Revs routine calculates the values that we do need</span>
                        <span class="comment">\ here, specifically:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cosVectorPitchAngle = cos(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sinVectorPitchAngle = sin(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ These calculations return 16-bit sign-magnitude</span>
                        <span class="comment">\ numbers with the sign in bit 0, which the DivideBy16</span>
                        <span class="comment">\ routine converts into normal 16-bit signed numbers</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that because GetRotationMatrix is copied from</span>
                        <span class="comment">\ Revs, where we only ever rotate through the yaw angle,</span>
                        <span class="comment">\ the matrix values are actually returned in the various</span>
                        <span class="comment">\ yawAngle variables, but for simplicity let's pretend</span>
                        <span class="comment">\ they are returned as above</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set (A X) = cosVectorPitchAngle / 16</span>
 <span class="mne">JSR</span> <a class="popup destination">DivideBy16</a>

 <span class="mne">STA</span> <a class="popup variable">cosVectorPitchHi</a>   <span class="comment">\ Set cosVectorPitch(Hi Lo) = cosVectorPitchAngle / 16</span>
 <span class="mne">STX</span> <a class="popup variable">cosVectorPitchLo</a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set (A X) = sinVectorPitchAngle / 16</span>
 <span class="mne">JSR</span> <a class="popup destination">DivideBy16</a>

 <span class="mne">STA</span> <a class="popup variable">yVectorLo</a>          <span class="comment">\ Set yVector(Lo Bot) = sinVectorPitchAngle / 16</span>
 <span class="mne">STX</span> <a class="popup variable">yVectorBot</a>         <span class="comment">\</span>
                        <span class="comment">\ So we now have the y-coordinate of the sights vector</span>
                        <span class="comment">\ as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   y = sin(vectorPitchAngle)</span>

                        <span class="comment">\ Now we convert the yaw angle of the sights vector</span>
                        <span class="comment">\ into cartesian x- and z-coordinates, where the x-axis</span>
                        <span class="comment">\ is the left-right axis and the z-axis goes into the</span>
                        <span class="comment">\ screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We store the resulting x-coordinate in the 16-bit</span>
                        <span class="comment">\ variable xVector(Lo Bot) and the z-coordinate in</span>
                        <span class="comment">\ zVector(Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We calculate xVector and zVector by considering a</span>
                        <span class="comment">\ triangle on the y = 0 plane, so that's a triangle on</span>
                        <span class="comment">\ the ground</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The hypotenuse of this triangle is side p from the</span>
                        <span class="comment">\ first calculation, which is the sights vector</span>
                        <span class="comment">\ projected down onto the ground - the shadow from a</span>
                        <span class="comment">\ light source directly above, if you like</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The opposite and adjacent sides of this tringle will</span>
                        <span class="comment">\ give us the x- and z-coordinates of the vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To see this, consider the same vector as before, with</span>
                        <span class="comment">\ p as the vector projected down onto the ground, and</span>
                        <span class="comment">\ where the player is looking sideways at a yaw angle of</span>
                        <span class="comment">\ vectorYawAngle</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This gives us a triangle like this, when viewed from</span>
                        <span class="comment">\ above, so it's as if we are the light source directly</span>
                        <span class="comment">\ above the sights vector, projecting the vector down</span>
                        <span class="comment">\ onto p, and with the vector going from the top-left to</span>
                        <span class="comment">\ the bottom-right, and the sights end of the vector</span>
                        <span class="comment">\ higher than the eye end:</span>
                        <span class="comment">\</span>
                        <span class="comment">\                   z</span>
                        <span class="comment diff">\   eye +--------------------------+       z-axis --></span>
                        <span class="comment">\        `-._ vectorYawAngle       |       into screen</span>
                        <span class="comment">\            `-._                  |</span>
                        <span class="comment">\                `-._              | x</span>
                        <span class="comment">\                 p  `-._          |</span>
                        <span class="comment">\                        `-._      |        x-axis left</span>
                        <span class="comment">\                            `-._  |          to right</span>
                        <span class="comment">\                                `-+             |</span>
                        <span class="comment">\                                    sights      v</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Again, simple trigonometry gives us the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sin(vectorYawAngle) = opposite / hypotenuse</span>
                        <span class="comment">\                       = x / p</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   x = p * sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ And:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(vectorYawAngle) = adjacent / hypotenuse</span>
                        <span class="comment">\                       = z / p</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   z = p * cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We calculated above that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   p = cos(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So substituting that into our result gives us:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   x = p * sin(vectorYawAngle)</span>
                        <span class="comment">\     = cos(vectorPitchAngle) * sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   z = p * cos(vectorYawAngle)</span>
                        <span class="comment">\     = cos(vectorPitchAngle) * cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ which is what we calculate now</span>

 <span class="mne">LDA</span> <a class="popup variable">vectorYawAngleLo</a>   <span class="comment">\ Set (A T) = vectorYawAngle(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>
 <span class="mne">LDA</span> <a class="popup variable">vectorYawAngleHi</a>

 <span class="mne">JSR</span> <a class="popup destination">GetRotationMatrix</a>  <span class="comment">\ Calculate the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cosVectorYawAngle = cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sinVectorYawAngle = sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Again these are returned as 16-bit sign-magnitude</span>
                        <span class="comment">\ numbers with the sign in bit 0, which the</span>
                        <span class="comment">\ MultiplyCoords converts into normal 16-bit signed</span>
                        <span class="comment">\ numbers</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Call MultiplyCoords with Y = 1 and X = 2 to calculate</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ the following:</span>
 <span class="mne">JSR</span> <a class="popup destination">MultiplyCoords</a>     <span class="comment">\</span>
                        <span class="comment">\   zVector(Lo Bot)</span>
                        <span class="comment">\       = cosVectorPitchAngle * cosVectorYawAngle / 16</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Zero X and Y and fall through into MultiplyCoords to</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ calculate the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   xVector(Lo Bot)</span>
                        <span class="comment">\        = cosVectorPitchAngle * sinVectorYawAngle / 16</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and return from the subroutine using a tail call</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-multiplycoords" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">MultiplyCoords</span>                                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Arithmetic)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Multiply a 16-bit signed number and a 16-bit sign-magnitude value</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/multiplycoords.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getvectorforangles.html">GetVectorForAngles</a> calls <a href="#multiplycoords">MultiplyCoords</a></span>
</div>
<hr class="light">
 This routine multiplies two 16-bit values and stores the result according to
 the arguments, as follows.

 When Y = 0, it calculates:

   cosVectorPitch(Hi Lo) * sinAngle(Hi Lo)

 i.e. cosVectorPitch * sinAngle

 When Y = 1, it calculates:

   cosVectorPitch(Hi Lo) * cosAngle(Hi Lo)

 i.e. cosVectorPitch * cosAngle

 When X = 0, store the result in xVector(Lo Bot).

 When X = 2, store the result in zVector(Lo Bot).

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">cosVectorPitchHi</span>     <span class="argumentEntry">The 16-bit signed number to multiply (high byte)</span>

   <span class="argumentLabel">cosVectorPitchLo</span>     <span class="argumentEntry">The 16-bit signed number to multiply (low byte)</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">Offset of the 16-bit sign-magnitude value to multiply:</span>

                        <span class="argumentEntry">  * 0 = sinAngle</span>

                        <span class="argumentEntry">  * 1 = cosAngle</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">Offset of the variable to store the result in:</span>

                        <span class="argumentEntry">  * 0 = xVector(Lo Bot)</span>

                        <span class="argumentEntry">  * 2 = zVector(Lo Bot)</span>

</div></div>
<span class="label">.MultiplyCoords</span><a id="multiplycoords" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set H to sign to apply to the result of Multiply16x16</span>
 <span class="mne">STA</span> <a class="popup variable">H</a>                  <span class="comment">\ (in bit 7), so setting H  0 ensures that that the</span>
                        <span class="comment">\ result is positive</span>

 <span class="mne">LDA</span> <a class="popup variable">cosVectorPitchLo</a>   <span class="comment">\ Set (QQ PP) = cosVectorPitch(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">PP</a>                 <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">cosVectorPitchHi</a>   <span class="comment">\ where (QQ PP) is a 16-bit signed number</span>
 <span class="mne">STA</span> <a class="popup variable">QQ</a>

 <span class="mne">LDA</span> <a class="popup variable">sinAngleLo</a>,<span class="register">Y</span>       <span class="comment">\ Set (SS RR) to the 16-bit sign-magnitude number</span>
 <span class="mne">STA</span> <a class="popup variable">RR</a>                 <span class="comment">\ pointed to by Y</span>
 <span class="mne">LDA</span> <a class="popup variable">sinAngleHi</a>,<span class="register">Y</span>
 <span class="mne">STA</span> <a class="popup variable">SS</a>

 <span class="mne">JSR</span> <a class="popup destination">Multiply16x16</a>      <span class="comment">\ Set (A T) = (QQ PP) * (SS RR)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ And apply the sign from bit 7 of H to ensure the</span>
                        <span class="comment">\ result is positive</span>

 <span class="mne">STA</span> <a class="popup variable">xVectorLo</a>,<span class="register">X</span>        <span class="comment">\ Store the result in:</span>
 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">xVectorBot</a>,<span class="register">X</span>       <span class="comment">\   * xVector(Lo Bot) when X = 0</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * zVector(Lo Bot) when X = 2</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-divideby16" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">DivideBy16</span>                                              <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Arithmetic)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Divide a 16-bit sign-magnitude number by 16</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/divideby16.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getvectorforangles.html">GetVectorForAngles</a> calls <a href="#divideby16">DivideBy16</a></span>
</div>
<hr class="light">
 This routine divides a 16-bit sign-magnitude number by 16 and returns the
 result as a signed 16-bit number.

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">Offset of the 16-bit sign-magnitude number to divide:</span>

                        <span class="argumentEntry">  * 0 = sinAngle</span>

                        <span class="argumentEntry">  * 1 = cosAngle</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">(A X)</span>                <span class="argumentEntry">The 16-bit signed number containing the result</span>

</div></div>
<span class="label">.DivideBy16</span><a id="divideby16" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">sinAngleLo</a>,<span class="register">Y</span>       <span class="comment">\ Set (A T) to the 16-bit sign-magnitude number pointed</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ to by Y</span>
 <span class="mne">LDA</span> <a class="popup variable">sinAngleHi</a>,<span class="register">Y</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set (A T) = (A T) / 16</span>
 <span class="mne">ROR</span> <a class="popup variable">T</a>                  <span class="comment">\</span>
 <span class="mne">PHP</span>                    <span class="comment">\ We store bit 0 of the original 16-bit sign-magnitude</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ number on the stack in the C flag (as it gets rotated</span>
 <span class="mne">ROR</span> <a class="popup variable">T</a>                  <span class="comment">\ out from bit 0 on the first ROR T)</span>
 <span class="mne">LSR</span> <span class="register">A</span>
 <span class="mne">ROR</span> <a class="popup variable">T</a>
 <span class="mne">LSR</span> <span class="register">A</span>
 <span class="mne">ROR</span> <a class="popup variable">T</a>

 <span class="mne">PLP</span>                    <span class="comment">\ We stored the sign bit from the original 16-bit</span>
                        <span class="comment">\ sign-magnitude number on the stack, so fetch it into</span>
                        <span class="comment">\ the C flag</span>

 <span class="mne">BCC</span> <a class="popup destination">divi1</a>              <span class="comment">\ If the sign bit was 0 then the original number was</span>
                        <span class="comment">\ positive, so skip the following</span>

 <span class="mne">JSR</span> <a class="popup destination">Negate16Bit</a>        <span class="comment">\ The original 16-bit sign-magnitude number was negative</span>
                        <span class="comment">\ so call Negate16Bit to negate the result as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (A T) = -(A T)</span>

<span class="label">.divi1</span><a id="divi1" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">T</a>                  <span class="comment">\ Set (A X) = (A T)</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-addvectortocoord" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">AddVectorToCoord</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Add a vector to a coordinate</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/addvectortocoord.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/followgazevector_part_1_of_5.html">FollowGazeVector (Part 1 of 5)</a> calls <a href="#addvectortocoord">AddVectorToCoord</a></span>
</div>
<hr class="light">
 This routine adds a vector to a coordinate:

   [ xCoord ]   [ xCoord ]   [ xVector ]
   [ yCoord ] = [ yCoord ] + [ yVector ]
   [ zCoord ]   [ zCoord ]   [ zVector ]

 where the coordinate consists of 24-bit signed numbers:

   [ xCoord ]   [ xCoord(Hi Lo Bot) ]
   [ yCoord ] = [ yCoord(Hi Lo Bot) ]
   [ zCoord ]   [ zCoord(Hi Lo Bot) ]

 and the vector consists of 16-bit signed numbers:

   [ xVector ]   [ xVector(Lo Bot) ]
   [ yVector ] = [ yVector(Lo Bot) ]
   [ zVector ]   [ zVector(Lo Bot) ]

</div></div>
<span class="label">.AddVectorToCoord</span><a id="addvectortocoord" class="anchor"></a>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ We now work through all three axes in turn, so set an</span>
                        <span class="comment">\ axis counter in X to iterate through 2, 1 and 0 (for</span>
                        <span class="comment">\ the z-axis, y-axis and x-axis respectively)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The comments in the following loop will concentrate on</span>
                        <span class="comment">\ the x-axis to keep things simple</span>

<span class="label">.addv1</span><a id="addv1" class="anchor"></a>

                        <span class="comment">\ We now perform the following addition of a 24-bit</span>
                        <span class="comment">\ coordinate and a 16-bit vector:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   xCoord = xCoord + xVector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ where:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * xCoord is xCoord(Hi Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * xVector is xVector(Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We do this for each axis in turn, but let's talk about</span>
                        <span class="comment">\ the x-axis</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set T = 0</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\</span>
                        <span class="comment">\ We use T as the high byte of xVector, which we either</span>
                        <span class="comment">\ set to 0 (if xVector is positive) or &FF (if xVector</span>
                        <span class="comment">\ is negative)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We set T for positive numbers here, and change it to</span>
                        <span class="comment">\ &FF during the addition if xVector turns out to be</span>
                        <span class="comment">\ negative</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The addition therefore supports signed numbers</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordBot</a>,<span class="register">X</span>        <span class="comment">\ Add the bottom bytes of the calculation</span>
 <span class="mne">CLC</span>
 <span class="mne">ADC</span> <a class="popup variable">xVectorBot</a>,<span class="register">X</span>
 <span class="mne">STA</span> <a class="popup variable">xCoordBot</a>,<span class="register">X</span>

 <span class="mne">LDA</span> <a class="popup variable">xVectorLo</a>,<span class="register">X</span>        <span class="comment">\ Set A to xVectorLo so we can check its sign</span>

 <span class="mne">BPL</span> <a class="popup destination">addv2</a>              <span class="comment">\ If xVectorLo is negative, set T = &FF so we can use it</span>
 <span class="mne">DEC</span> <a class="popup variable">T</a>                  <span class="comment">\ as the high byte in the negative 24-bit number, like</span>
                        <span class="comment">\ this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (&FF xVectorLo xVectorBot)</span>

<span class="label">.addv2</span><a id="addv2" class="anchor"></a>

 <span class="mne">ADC</span> <a class="popup variable">xCoordLo</a>,<span class="register">X</span>         <span class="comment">\ Now add the low bytes of the calculation</span>
 <span class="mne">STA</span> <a class="popup variable">xCoordLo</a>,<span class="register">X</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordHi</a>,<span class="register">X</span>         <span class="comment">\ And then add the high bytes, incorporating the high</span>
 <span class="mne">ADC</span> <a class="popup variable">T</a>                  <span class="comment">\ byte of xVector that we set in T</span>
 <span class="mne">STA</span> <a class="popup variable">xCoordHi</a>,<span class="register">X</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the axis counter in X to move on to the next</span>
                        <span class="comment">\ axis</span>

 <span class="mne">BPL</span> <a class="popup destination">addv1</a>              <span class="comment">\ Loop back until we have processed all three axes</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

 <span class="mne">EQUB</span> <span class="hex">&00</span>               <span class="comment">\ This byte appears to be unused</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-followgazevector-part-1-of-5" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FollowGazeVector (Part 1 of 5)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Follow a gaze vector from a viewing object to determine whether</span>
             <span class="headerEntry">the viewer can see a flat tile or platform (i.e. boulder or tower)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/followgazevector_part_1_of_5.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkenemygaze_part_2_of_2.html">CheckEnemyGaze (Part 2 of 2)</a> calls <a href="#followgazevector">FollowGazeVector</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processactionkeys_part_1_of_2.html">ProcessActionKeys (Part 1 of 2)</a> calls <a href="#followgazevector">FollowGazeVector</a></span>
</div>
<hr class="light">
 This routine follows the gaze of a viewing object to see if it hits a tile or
 a platform (where a platform is a boulder or the Sentinel's tower)

 The gaze is defined by the following vector:

   [ xVector ]   [ xVector(Lo Bot) ]
   [ yVector ] = [ yVector(Lo Bot) ]
   [ zVector ]   [ zVector(Lo Bot) ]

 This contains the gaze vector, scaled down to be very small, so we can trace
 the line of the gaze by repeatedly adding this vector to the coordinates of
 the viewing object to step along the line of the gaze. At each step we check
 to see whether the gaze has hit a tile, repeating this until we either hit a
 tile or fall off the edge of the landscape.

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">viewingObject</span>        <span class="argumentEntry">The number of the object that is performing the gaze</span>

   <span class="argumentLabel">xVector(Lo Bot)</span>      <span class="argumentEntry">The x-coordinate of the scaled-down gaze vector</span>

   <span class="argumentLabel">yVector(Lo Bot)</span>      <span class="argumentEntry">The y-coordinate of the scaled-down gaze vector</span>

   <span class="argumentLabel">zVector(Lo Bot)</span>      <span class="argumentEntry">The z-coordinate of the scaled-down gaze vector</span>

   <span class="argumentLabel">enemyCheckingRobot</span>   <span class="argumentEntry">Set bit 7 if this routine is being called when an enemy</span>
                        <span class="argumentEntry">is checking to see if it can see a robot object (i.e. in</span>
                        <span class="argumentEntry">the CheckEnemyGaze routine)</span>

   <span class="argumentLabel">targetObject</span>         <span class="argumentEntry">The target object</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag:</span>

                        <span class="argumentEntry">  * Clear if the viewing object can see a tile along</span>
                        <span class="argumentEntry">    the gaze vector (or, if enemyCheckingRobot is set,</span>
                        <span class="argumentEntry">    if the viewing object can see a robot)</span>

                        <span class="argumentEntry">  * Set if the viewing object can't see a tile along</span>
                        <span class="argumentEntry">    the gaze vector</span>

   <span class="argumentLabel">targetOnTile</span>         <span class="argumentEntry">Records whether the gaze vector can see a tile</span>
                        <span class="argumentEntry">containing the target object:</span>

                        <span class="argumentEntry">  * Bit 7 clear = gaze vector cannot see the target</span>
                        <span class="argumentEntry">                  object</span>

                        <span class="argumentEntry">  * Bit 7 set = gaze vector can see the target object</span>

   <span class="argumentLabel">gazeCanSeeTree</span>       <span class="argumentEntry">Records whether the gaze vector can see a tree:</span>

                        <span class="argumentEntry">  * Bit 7 clear = gaze vector cannot see a tree</span>

                        <span class="argumentEntry">  * Bit 7 set = gaze vector can see a tree</span>

   <span class="argumentLabel">xCoordHi</span>             <span class="argumentEntry">The tile x-coordinate of the tile that can be seen</span>

   <span class="argumentLabel">zCoordHi</span>             <span class="argumentEntry">The tile z-coordinate of the tile that can be seen</span>

</div></div>
<span class="label">.FollowGazeVector</span><a id="followgazevector" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ Set X to the number of the object that is performing</span>
                        <span class="comment">\ the gaze (i.e. doing the looking or scanning)</span>

 <span class="mne">LSR</span> <a class="popup variable">targetOnTile</a>       <span class="comment">\ Clear bit 7 of targetOnTile so it can be set if the</span>
                        <span class="comment">\ tile contains the target object whose number is in</span>
                        <span class="comment">\ targetObject</span>

 <span class="mne">LSR</span> <a class="popup variable">gazeCanSeeTree</a>     <span class="comment">\ Clear bit 7 of gazeCanSeeTree so it can be set if</span>
                        <span class="comment">\ there is tree on the tile that can be seen by the</span>
                        <span class="comment">\ gaze vector</span>

 <span class="mne">JSR</span> <a class="popup destination">GetObjectCoords</a>    <span class="comment">\ Fetch the cartesian coordinates of the viewing object</span>
                        <span class="comment">\ as three 24-bit numbers, as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   xCoord(Hi Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   yCoord(Hi Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   zCoord(Hi Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now repeatedly add the scaled-down gaze vector to</span>
                        <span class="comment">\ this coordinate to step along the gaze from the</span>
                        <span class="comment">\ viewing object and see if it hits anything</span>

<span class="label">.gaze1</span><a id="gaze1" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">AddVectorToCoord</a>   <span class="comment">\ Add the coordinates and the vector as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xCoord ]   [ xCoord ]   [ xVector ]</span>
                        <span class="comment">\   [ yCoord ] = [ yCoord ] + [ yVector ]</span>
                        <span class="comment">\   [ zCoord ]   [ zCoord ]   [ zVector ]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ where:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xCoord ]   [ xCoord(Hi Lo Bot) ]</span>
                        <span class="comment">\   [ yCoord ] = [ yCoord(Hi Lo Bot) ]</span>
                        <span class="comment">\   [ zCoord ]   [ zCoord(Hi Lo Bot) ]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xVector ]   [ xVector(Lo Bot) ]</span>
                        <span class="comment">\   [ yVector ] = [ yVector(Lo Bot) ]</span>
                        <span class="comment">\   [ zVector ]   [ zVector(Lo Bot) ]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This adds the scaled-down gaze vector to the</span>
                        <span class="comment">\ coordinate to perform a step along the object's gaze</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordHi</a>           <span class="comment">\ Set xTile to the high byte of the result (i.e. the</span>
 <span class="mne">STA</span> <a class="popup variable">xTile</a>              <span class="comment">\ tile x-coordinate below our current position along the</span>
                        <span class="comment">\ viewer's gaze)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">31</span>                <span class="comment">\ If we just stepped beyond the right edge of the</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze4</a>              <span class="comment">\ landscape then the gaze does not land upon a tile, so</span>
                        <span class="comment">\ jump to gaze4 to return from the subroutine with the</span>
                        <span class="comment">\ C flag set to indicate that the viewer is not looking</span>
                        <span class="comment">\ at a tile</span>

 <span class="mne">LDA</span> <a class="popup variable">zCoordHi</a>           <span class="comment">\ Set zTile to the high byte of the result (i.e. the</span>
 <span class="mne">STA</span> <a class="popup variable">zTile</a>              <span class="comment">\ tile z-coordinate below our current position along the</span>
                        <span class="comment">\ viewer's gaze)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">31</span>                <span class="comment">\ If we just stepped beyond the rear edge of the</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze4</a>              <span class="comment">\ landscape then the gaze does not land upon a tile, so</span>
                        <span class="comment">\ jump to gaze4 to return from the subroutine with the</span>
                        <span class="comment">\ C flag set to indicate that the viewer is not looking</span>
                        <span class="comment">\ at a tile</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set bit 7 and clear bit 6 of considerObjects so the</span>
 <span class="mne">STA</span> <a class="popup variable">considerObjects</a>    <span class="comment">\ following call to GetTileAltitude will include trees</span>
                        <span class="comment">\ and platform objects in its calculations</span>

 <span class="mne">STA</span> <a class="popup variable">yAccuracyLo</a>        <span class="comment">\ Set yAccuracyLo = 128, so by default the gaze vector</span>
                        <span class="comment">\ has to be no more than half a tile's height above a</span>
                        <span class="comment">\ tile for us to consider it as potentially seeing the</span>
                        <span class="comment">\ tile (this figure is changed for the Sentinel's tower</span>
                        <span class="comment">\ to make the player have to be much more accurate when</span>
                        <span class="comment">\ trying to view the Sentinel's tile)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set yPlatformLo = 0, so if the tile doesn't contain</span>
 <span class="mne">STA</span> <a class="popup variable">yPlatformLo</a>        <span class="comment">\ a platform, yPlatformLo will be zero</span>

 <span class="mne">STA</span> <a class="popup variable">boulderOnTile</a>      <span class="comment">\ Clear bit 7 of boulderOnTile to denote that the tile</span>
                        <span class="comment">\ does not contain a boulder, so GetTileAltitude can</span>
                        <span class="comment">\ set bit 7 if it does contain a boulder</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileAltitude</a>    <span class="comment">\ Call GetTileAltitude with bit 7 of considerObjects</span>
                        <span class="comment">\ set to extract the following tile data:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * (A yPlatformLo) = if the tile contains a boulder</span>
                        <span class="comment">\     or the Sentinel's tower, then this is set to the</span>
                        <span class="comment">\     altitude of the platform object, plus 32 for the</span>
                        <span class="comment">\     tower or plus 96 for the boulder</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = if the tile contains a non-platform object</span>
                        <span class="comment">\         then this is set to the high byte of the</span>
                        <span class="comment">\         tile's altitude, which is the same as the high</span>
                        <span class="comment">\         byte of the object's altitude</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = if the tile is not flat then this is set to</span>
                        <span class="comment">\         the tile altitude from the tile data</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * C flag = the tile's shape, clear if the tile is</span>
                        <span class="comment">\              flat or set if the tile is not flat</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * boulderOnTile has bit 7 set if the tile contains a</span>
                        <span class="comment">\     boulder</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * considerObjects has bit 6 if the tile contains a</span>
                        <span class="comment">\     boulder or the Sentinel's tower and the current</span>
                        <span class="comment">\     position along the gaze vector is not within the</span>
                        <span class="comment">\     platform object (so the gaze vector is passing</span>
                        <span class="comment">\     close by the platform object but is not hitting</span>
                        <span class="comment">\     it)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * yAccuracyLo is changed from 128 to 16 if the tile</span>
                        <span class="comment">\     contains the Sentinel's tower and the gaze vector</span>
                        <span class="comment">\     is pointing at the sides of the tower</span>

 <span class="mne">BCS</span> <a class="popup destination">gaze5</a>              <span class="comment">\ If the tile is not flat, jump to gaze5 to calculate</span>
                        <span class="comment">\ the gaze vector's interaction with the tile slopes</span>

                        <span class="comment">\ If we get here then the tile is flat and may contain</span>
                        <span class="comment">\ an object</span>

 <span class="mne">TAX</span>                    <span class="comment">\ Set (X A) to the altitude of the platform (if there is</span>
 <span class="mne">LDA</span> <a class="popup variable">yPlatformLo</a>        <span class="comment">\ one) or the altitude of the tile (is there isn't)</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the following:</span>
 <span class="mne">SBC</span> <a class="popup variable">yCoordLo</a>           <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">yPlatformLo</a>        <span class="comment">\   (A yPlatformLo) = (X A) - yCoord(Hi Lo)</span>
 <span class="mne">TXA</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <a class="popup variable">yCoordHi</a>           <span class="comment">\ So this contains the relative altitude of the tile or</span>
                        <span class="comment">\ platform compared to our current position along the</span>
                        <span class="comment">\ viewer's gaze (as we are subtracting the altitude of</span>
                        <span class="comment">\ the gaze from the altitude of the tile/platform)</span>

 <span class="mne">BMI</span> <a class="popup destination">gaze1</a>              <span class="comment">\ If the high byte of the result is negative then the</span>
                        <span class="comment">\ gaze is passing through the y-coordinate above the</span>
                        <span class="comment">\ tile or platform, in terms of whole numbers (so it is</span>
                        <span class="comment">\ essentially more than one "tile cube" above the tile)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means it hasn't hit the tile and is still passing</span>
                        <span class="comment">\ through empty space above the landscape, so loop back</span>
                        <span class="comment">\ to gaze1 to move along the gaze vector and restart the</span>
                        <span class="comment">\ checks</span>

 <span class="mne">BNE</span> <a class="popup destination">gaze4</a>              <span class="comment">\ If the high byte of the result is non-zero and</span>
                        <span class="comment">\ positive, then the gaze is passing through the</span>
                        <span class="comment">\ y-coordinate below the tile or platform, in terms of</span>
                        <span class="comment">\ whole numbers (so it is essentially in the "tile cube"</span>
                        <span class="comment">\ beneath the tile)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means the gaze must have passed through a slope</span>
                        <span class="comment">\ and "into" the ground beneath the tile, so jump to</span>
                        <span class="comment">\ gaze4 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set to indicate that the viewer is not looking at a</span>
                        <span class="comment">\ tile</span>

                        <span class="comment">\ If we get here then the gaze is currently sitting</span>
                        <span class="comment">\ within the "tile cube" above the tile</span>

 <span class="mne">LDA</span> <a class="popup variable">yPlatformLo</a>        <span class="comment">\ If yPlatformLo >= yAccuracyLo, then the vertical</span>
 <span class="mne">CMP</span> <a class="popup variable">yAccuracyLo</a>        <span class="comment">\ distance between the gaze and the platform is greater</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze4</a>              <span class="comment">\ than the accuracy specified in yAccuracyLo, so jump to</span>
                        <span class="comment">\ gaze4 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set to indicate that the viewer is not looking at a</span>
                        <span class="comment">\ tile or object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that yAccuracyLo = 128 for all tiles (i.e. no</span>
                        <span class="comment">\ more than 0.5 of a tile's height above the tile) apart</span>
                        <span class="comment">\ from the tile containing the Sentinel's tower, when it</span>
                        <span class="comment">\ is reduced to 16 if the gaze vector is pointing at the</span>
                        <span class="comment">\ sides of the tower (i.e. no more than 0.025 of a</span>
                        <span class="comment">\ tile's height above the tile)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This makes the player have to be much more accurate</span>
                        <span class="comment">\ when trying to view the Sentinel's tile</span>

 <span class="mne">BIT</span> <a class="popup variable">considerObjects</a>    <span class="comment">\ If bit 6 of considerObjects is set then the tile</span>
 <span class="mne">BVS</span> <a class="popup destination">gaze4</a>              <span class="comment">\ contains a boulder or the Sentinel's tower and the</span>
                        <span class="comment">\ current position along the gaze vector is not within</span>
                        <span class="comment">\ the platform object (so the gaze vector is passing</span>
                        <span class="comment">\ close by the platform object but is not hitting it),</span>
                        <span class="comment">\ so jump to gaze4 to return from the subroutine with</span>
                        <span class="comment">\ the C flag set to indicate that the viewer is not</span>
                        <span class="comment">\ looking at a tile, as the platform will be at least</span>
                        <span class="comment">\ partially obscuring any tiles that are visible to the</span>
                        <span class="comment">\ sides of the boulder or tower</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyCheckingRobot</a> <span class="comment">\ If bit 7 is set in either of enemyCheckingRobot and</span>
 <span class="mne">ORA</span> <a class="popup variable">boulderOnTile</a>      <span class="comment">\ boulderOnTile, skip the following test, as we do not</span>
 <span class="mne">BMI</span> <a class="popup destination">gaze2</a>              <span class="comment">\ care if the gaze is upwards when either of the</span>
                        <span class="comment">\ following is true:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * This is an enemy is looking for a robot, in which</span>
                        <span class="comment">\     case we are still interested even if the enemy is</span>
                        <span class="comment">\     below the robot and can't see the tile that the</span>
                        <span class="comment">\     robot is on</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * We are looking at a boulder, in which case it can</span>
                        <span class="comment">\     still be above us and a suitable target for an</span>
                        <span class="comment">\     action (as we can create or absorb from a boulder</span>
                        <span class="comment">\     stack by looking at any of the boulders on the</span>
                        <span class="comment">\     stack, even if they are above us)</span>

                        <span class="comment">\ If we get here then neither of the above special cases</span>
                        <span class="comment">\ are true, so we now check whether the viewer is</span>
                        <span class="comment">\ looking upwards, as that will mean they can't see down</span>
                        <span class="comment">\ onto the tile</span>

 <span class="mne">LDA</span> <a class="popup variable">yVectorLo</a>          <span class="comment">\ If the low byte (i.e. the fractional part) of the gaze</span>
 <span class="mne">BPL</span> <a class="popup destination">gaze4</a>              <span class="comment">\ vector's y-coordinate is positive, then the viewer is</span>
                        <span class="comment">\ looking upwards and therefore can't see down onto the</span>
                        <span class="comment">\ tile, so jump to gaze4 to return from the subroutine</span>
                        <span class="comment">\ with the C flag set to indicate that the viewer is not</span>
                        <span class="comment">\ looking at a tile</span>

<span class="label">.gaze2</span><a id="gaze2" class="anchor"></a>

                        <span class="comment">\ If we get here then the viewer's gaze has landed on a</span>
                        <span class="comment">\ tile, so the final check is to make sure the viewer is</span>
                        <span class="comment">\ not looking at their own tile</span>

 <span class="mne">LDX</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ Set X to the number of the object that is performing</span>
                        <span class="comment">\ the gaze (i.e. doing the looking or scanning)</span>

 <span class="mne">LDA</span> <a class="popup variable">xTile</a>              <span class="comment">\ If the x-coordinate of the viewing object is not the</span>
 <span class="mne">CMP</span> <a class="popup variable">xObject</a>,<span class="register">X</span>          <span class="comment">\ same as the x-coordinate of the tile that the gaze has</span>
 <span class="mne">BNE</span> <a class="popup destination">gaze3</a>              <span class="comment">\ hit, jump to gaze3 to return from the subroutine with</span>
                        <span class="comment">\ the C flag clear, to indicate that the viewer is</span>
                        <span class="comment">\ looking at a tile</span>

                        <span class="comment">\ If we get here then the x-coordinates match, so we now</span>
                        <span class="comment">\ need to check the z-coordinates</span>

 <span class="mne">LDA</span> <a class="popup variable">zTile</a>              <span class="comment">\ If the z-coordinate of the viewing object is the same</span>
 <span class="mne">CMP</span> <a class="popup variable">zObject</a>,<span class="register">X</span>          <span class="comment">\ as the x-coordinate, then the viewer is looking at</span>
 <span class="mne">BEQ</span> <a class="popup destination">gaze1</a>              <span class="comment">\ their own tile, so loop back to gaze1 to move along</span>
                        <span class="comment">\ the gaze vector and restart the checks</span>

                        <span class="comment">\ If we get here then the z-coordinates do not match, so</span>
                        <span class="comment">\ we can now return from the subroutine with the C flag</span>
                        <span class="comment">\ clear, to indicate that the viewer is looking at a</span>
                        <span class="comment">\ tile</span>

<span class="label">.gaze3</span><a id="gaze3" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Set the C flag to indicate that the gaze hit</span>
                        <span class="comment">\ something, so the viewing object is looking at</span>
                        <span class="comment">\ something</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.gaze4</span><a id="gaze4" class="anchor"></a>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to indicate that the gaze didn't hit</span>
                        <span class="comment">\ anything, so the viewing object isn't looking at</span>
                        <span class="comment">\ anything</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-followgazevector-part-2-of-5" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FollowGazeVector (Part 2 of 5)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate the altitudes of the four corners in a non-flat tile</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/followgazevector_part_2_of_5.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.gaze5</span><a id="gaze5" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile is not flat and A is set</span>
                        <span class="comment">\ to the tile altitude from the tile data</span>

 <span class="mne">STA</span> <a class="popup variable">S</a>                  <span class="comment">\ Set S to the tile altitude</span>

 <span class="mne">STA</span> <a class="popup variable">W</a>                  <span class="comment">\ Set W to the tile altitude</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This ensures that when we access the altitudes of the</span>
                        <span class="comment">\ four tile corners in part 5 using variables S, T, U</span>
                        <span class="comment">\ and V, the list wraps around in memory into variable W</span>
                        <span class="comment">\ to support corner pairs for all four edges - see part</span>
                        <span class="comment">\ 5 for details</span>

 <span class="mne">LSR</span> <a class="popup variable">considerObjects</a>    <span class="comment">\ Clear bit 7 of considerObjects so GetTileAltitude will</span>
                        <span class="comment">\ only extract the altitude and flatness of the tiles</span>
                        <span class="comment">\ when we call it below, ignoring any objects on the</span>
                        <span class="comment">\ landscape</span>

 <span class="mne">INC</span> <a class="popup variable">xTile</a>              <span class="comment">\ Move along the x-axis to fetch the next tile to the</span>
                        <span class="comment">\ right</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileAltitude</a>    <span class="comment">\ Call GetTileAltitude with bit 7 of considerObjects</span>
                        <span class="comment">\ clear to extract the following tile data:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = the high byte of the tile's altitude (which</span>
                        <span class="comment">\         is also the altitude of the tile corner)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * C flag = the tile's shape, clear if the tile is</span>
                        <span class="comment">\              flat or set if the tile is not flat</span>

 <span class="mne">STA</span> <a class="popup variable">V</a>                  <span class="comment">\ Set V to the altitude of the tile to the right</span>

 <span class="mne">INC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Move along the x-axis to fetch the next tile into the</span>
                        <span class="comment">\ screen</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileAltitude</a>    <span class="comment">\ Call GetTileAltitude with bit 7 of considerObjects</span>
                        <span class="comment">\ clear to extract the following tile data:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = the high byte of the tile's altitude (which</span>
                        <span class="comment">\         is also the altitude of the tile corner)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * C flag = the tile's shape, clear if the tile is</span>
                        <span class="comment">\              flat or set if the tile is not flat</span>

 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set U to the altitude of the tile behind</span>

 <span class="mne">DEC</span> <a class="popup variable">xTile</a>              <span class="comment">\ Move back along the x-axis to fetch the next tile to</span>
                        <span class="comment">\ the left</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileAltitude</a>    <span class="comment">\ Call GetTileAltitude with bit 7 of considerObjects</span>
                        <span class="comment">\ clear to extract the following tile data:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = the high byte of the tile's altitude (which</span>
                        <span class="comment">\         is also the altitude of the tile corner)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * C flag = the tile's shape, clear if the tile is</span>
                        <span class="comment">\              flat or set if the tile is not flat</span>

 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set V to the altitude of the tile to the left</span>

 <span class="mne">DEC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Move out of the screen, back along the z-axis to take</span>
                        <span class="comment">\ us back to the tile we are processing</span>

                        <span class="comment">\ So at this point we have the altitudes of four tile</span>
                        <span class="comment">\ corners, as follows, with the view from above:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      ^           [T]  [U]</span>
                        <span class="comment">\      |</span>
                        <span class="comment">\      |           [S]  [V]</span>
                        <span class="comment">\   z-axis</span>
                        <span class="comment">\    into</span>
                        <span class="comment diff">\   screen      x-axis from left to right ---></span>
                        <span class="comment">\</span>
                        <span class="comment">\ S is the altitude of the tile corner that anchors the</span>
                        <span class="comment">\ tile below the current position along the viewer's</span>
                        <span class="comment">\ gaze, and T, U and V are the altitudes of the tile's</span>
                        <span class="comment">\ other three corners, so now we can analyse how the</span>
                        <span class="comment">\ gaze interacts with the shape of the tile</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileData</a>        <span class="comment">\ Set A to the tile data for the tile anchored at</span>
                        <span class="comment">\ (xTile, zTile)</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00001111</span>         <span class="comment">\ The tile shape is in the low nibble of the tile data,</span>
                        <span class="comment">\ so extract the tile shape into A</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ If the tile shape is 4 then jump to gaze6</span>
 <span class="mne">BEQ</span> <a class="popup destination">gaze6</a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">12</span>                <span class="comment">\ If the tile shape is 12 then keep going, otherwise</span>
 <span class="mne">BNE</span> <a class="popup destination">gaze8</a>              <span class="comment">\ jump to gaze8</span>

<span class="label">.gaze6</span><a id="gaze6" class="anchor"></a>

                        <span class="comment">\ The tile shape is 4 or 12, so fall through into part 3</span>
                        <span class="comment">\ to process this shape</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-followgazevector-part-3-of-5" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FollowGazeVector (Part 3 of 5)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate whether the viewing object's gaze is obstructed by a</span>
             <span class="headerEntry">tile of shape 4 or 12 (i.e. a tile with one horizontal edge)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/followgazevector_part_3_of_5.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
                        <span class="comment">\ If we get here then the tile shape is 4 or 12, so the</span>
                        <span class="comment">\ tile has one horizontal edge with the other two points</span>
                        <span class="comment">\ being arbitrary (but not at the same height as the</span>
                        <span class="comment">\ horizontal edge)</span>

 <span class="mne">LDA</span> <a class="popup variable">yCoordHi</a>           <span class="comment">\ If yCoordHi is higher than any of the four tile</span>
 <span class="mne">CMP</span> <a class="popup variable">S</a>                  <span class="comment">\ corners, then the current position along the viewer's</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze7</a>              <span class="comment">\ gaze is above the tile surface, so jump to gaze1 via</span>
 <span class="mne">CMP</span> <a class="popup variable">T</a>                  <span class="comment">\ gaze7 to move along the gaze vector and restart the</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze7</a>              <span class="comment">\ checks</span>
 <span class="mne">CMP</span> <a class="popup variable">U</a>
 <span class="mne">BCS</span> <a class="popup destination">gaze7</a>
 <span class="mne">CMP</span> <a class="popup variable">V</a>
 <span class="mne">BCS</span> <a class="popup destination">gaze7</a>

 <span class="mne">JMP</span> <a class="popup destination">gaze4</a>              <span class="comment">\ Otherwise the current position along the viewer's</span>
                        <span class="comment">\ gaze is below the height of at least one tile corner,</span>
                        <span class="comment">\ so we consider this to be enough interference to be</span>
                        <span class="comment">\ blocking the viewer's gaze of any tiles that might be</span>
                        <span class="comment">\ partially visible beyond (which might be possible if</span>
                        <span class="comment">\ the slope is from left to right, for example)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So jump to gaze4 to return from the subroutine with</span>
                        <span class="comment">\ the C flag set to indicate that the viewer is not</span>
                        <span class="comment">\ looking at a tile</span>

<span class="label">.gaze7</span><a id="gaze7" class="anchor"></a>

 <span class="mne">JMP</span> <a class="popup destination">gaze1</a>              <span class="comment">\ Jump to gaze1 to move along the gaze vector and</span>
                        <span class="comment">\ restart the checks (this jump point is for use by</span>
                        <span class="comment">\ branching instructions)</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-followgazevector-part-4-of-5" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FollowGazeVector (Part 4 of 5)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">For non-flat tiles with two horizontal edges, work out which tile</span>
             <span class="headerEntry">edge to use when checking for obstruction of the gaze vector</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/followgazevector_part_4_of_5.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.gaze8</span><a id="gaze8" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape in A is not 4 or 12</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It also isn't 0, as the tile is not flat, and it isn't</span>
                        <span class="comment">\ 8 either, as that shape number isn't used</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The tile shape is therefore one of the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   1, 2, 3, 5, 6, 7, 9, 10, 11, 13, 14, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ All of these shapes have two horizontal edges and two</span>
                        <span class="comment">\ sloping edges, so we now work out which of the sloping</span>
                        <span class="comment">\ edges we should use to check against the gaze vector</span>
                        <span class="comment">\ to see if the slope is obstructing the gaze</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We pass this information to part 5 as a single tile</span>
                        <span class="comment">\ corner number in A, which tells part 5 to use the edge</span>
                        <span class="comment">\ from corner A to corner A + 1 in the calculation</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To recap, we set the tile altitudes in part 2 like</span>
                        <span class="comment">\ this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      ^           [T]  [U]</span>
                        <span class="comment">\      |</span>
                        <span class="comment">\      |           [S]  [V]</span>
                        <span class="comment">\   z-axis</span>
                        <span class="comment">\    into</span>
                        <span class="comment diff">\   screen      x-axis from left to right ---></span>
                        <span class="comment">\</span>
                        <span class="comment">\ We can also number these corners so we can pass a</span>
                        <span class="comment">\ corner number to part 5, so let's number them like</span>
                        <span class="comment">\ this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      [T]  [U]          [1]  [2]</span>
                        <span class="comment">\                   =</span>
                        <span class="comment">\      [S]  [V]          [0]  [3]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As mentioned above, when we pass a corner number in A</span>
                        <span class="comment">\ to part 5, this tells part 5 to use the edge from</span>
                        <span class="comment">\ corner A to corner A + 1 in the calculation, so if we</span>
                        <span class="comment">\ pass A = 0 to part 5, that will tell it to use the</span>
                        <span class="comment">\ left edge (from 0 to 1) in the calculation, while</span>
                        <span class="comment">\ passing A = 2 will make it use the right edge (from 2</span>
                        <span class="comment">\ to 3)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This part is therefore all about setting A to the</span>
                        <span class="comment">\ correct corner number for the edge that we want to use</span>
                        <span class="comment">\ in the gaze vector calculation</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We start by working out which two edges in the tile</span>
                        <span class="comment">\ shape are the sloping edges</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ If bit 0 of the shape number is clear, jump to gaze10</span>
 <span class="mne">BCC</span> <a class="popup destination">gaze10</a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxxx1 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   1, 3, 5, 7, 9, 11, 13, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 1</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ If bit 1 of the shape number is set, jump to gaze9</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze9</a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxx01 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   1, 5, 9, 13</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 2 to give:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0, 1, 2, 3</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set A to bit 0 of A, which is bit 2 of the original</span>
                        <span class="comment">\ shape number, so:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 if the tile shape is 1 or 9</span>
                        <span class="comment">\           (i.e. %xxxxx001 in binary)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 if the tile shape is 5 or 13</span>
                        <span class="comment">\           (i.e. %xxxxx101 in binary)</span>

                        <span class="comment">\ At this point we have a suitable value of A to pass</span>
                        <span class="comment">\ to part 5, as we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 to denote the left edge for shapes 1 and 9</span>
                        <span class="comment">\</span>
                        <span class="comment">\                          0 0   or   1 1</span>
                        <span class="comment">\                          1 1        0 0</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 to denote the top edge for shapes 5 and 13</span>
                        <span class="comment">\</span>
                        <span class="comment">\                          1 0   or   0 1</span>
                        <span class="comment">\                          1 0        0 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As the sloping edges in these shapes have the exact</span>
                        <span class="comment">\ same slope gradient, either of them can be used in the</span>
                        <span class="comment">\ calculation</span>

 <span class="mne">JMP</span> <a class="popup destination">gaze13</a>             <span class="comment">\ Jump to gaze13 in part 5 to check the gaze vector</span>
                        <span class="comment">\ against the edge specified in A</span>

<span class="label">.gaze9</span><a id="gaze9" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxx11 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   3, 7, 11, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 2 to give:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0, 1, 2, 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and the C flag is set</span>

 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set A = (A + 2) mod 4, to give:</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\</span>
                        <span class="comment">\   2, 3, 0, 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The addition adds 2 because the C flag is set</span>

 <span class="mne">JMP</span> <a class="popup destination">gaze11</a>             <span class="comment">\ Jump to gaze11 to analyse this shape</span>

<span class="label">.gaze10</span><a id="gaze10" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxxx0 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   2, 6, 10, 14</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 1</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Shift A right by one place, so the tile shape is one</span>
                        <span class="comment">\ of the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   2, 6, 10, 14</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 2 to give:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0, 1, 2, 3</span>

<span class="label">.gaze11</span><a id="gaze11" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape is one of:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   2, 3, 6, 7, 10, 11, 14, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains a number that tells us which two edges</span>
                        <span class="comment">\ are the sloping edges:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 0, the bottom and left edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 1, the top and left edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 2, the top and right edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 3, the bottom and right edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We either jump here with:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 if the tile shape is 11     0 0     Bottom</span>
                        <span class="comment">\                                       1 0     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 if the tile shape is 15     0 1     Top</span>
                        <span class="comment">\                                       1 1     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 2 if the tile shape is 3      1 0     Top</span>
                        <span class="comment">\                                       1 1     Right</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 3 if the tile shape is 7      1 1     Bottom</span>
                        <span class="comment">\                                       1 0     Right</span>
                        <span class="comment">\</span>
                        <span class="comment">\ or we fall through from above with:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 if the tile shape is 2      1 1     Bottom</span>
                        <span class="comment">\                                       0 1     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 if the tile shape is 6      1 0     Top</span>
                        <span class="comment">\                                       0 0     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 2 if the tile shape is 10     0 1     Top</span>
                        <span class="comment">\                                       0 0     Right</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 3 if the tile shape is 14     0 0     Bottom</span>
                        <span class="comment">\                                       0 1     Right</span>

                        <span class="comment">\ The next step is to choose which of these sloping</span>
                        <span class="comment">\ edges is the closest to the current position along</span>
                        <span class="comment">\ the gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The tileEdges table helps us do this</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It is made up of two numbers for each pair of edges</span>
                        <span class="comment">\ represented by A; these are the corner numbers at the</span>
                        <span class="comment">\ start of each of the two edges in the pair, so for</span>
                        <span class="comment">\ each value of A, we need to choose one of the corner</span>
                        <span class="comment">\ numbers from the pair to pass to part 5</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We choose the correct value according to whether the</span>
                        <span class="comment">\ gaze vector is closer to the edge along the x-axis</span>
                        <span class="comment">\ or the z-axis</span>
                        <span class="comment">\</span>
                        <span class="comment">\ For example, consider tile shape 11, for which we will</span>
                        <span class="comment">\ will have A = 0 to denote that the bottom and left</span>
                        <span class="comment">\ edges are the sloping edges in this shape:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0 0</span>
                        <span class="comment">\   1 0</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The tileEdges table contains 0 and 3 for this shape</span>
                        <span class="comment">\ (to denote the left and bottom edges respectively)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Zooming in on the tile, we have the following, where</span>
                        <span class="comment">\ [x] is the current position along the gaze vector when</span>
                        <span class="comment">\ looking at the tile from above:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [1]                 [2]</span>
                        <span class="comment">\    | xCoordLo</span>
                        <span class="comment diff">\    |<--------> [x]</span>
                        <span class="comment">\    |            ^</span>
                        <span class="comment">\    |            |</span>
                        <span class="comment">\    |            |  zCoordLo</span>
                        <span class="comment">\    |            v</span>
                        <span class="comment">\   [0] --------------- [3]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The calculation below clears the C flag so we compare</span>
                        <span class="comment">\ xCoordLo and zCoordLo, so the calculation is:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If xCoordLo &lt; zCoordLo, we pick the first entry</span>
                        <span class="comment">\     from tileEdges, i.e. 0, which is the left edge</span>
                        <span class="comment">\     (because the gaze point in [x] is closer to the</span>
                        <span class="comment">\     left edge than the bottom edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If xCoordLo >= zCoordLo, we pick the second entry</span>
                        <span class="comment">\     from tileEdges, i.e. 3, which is the bottom edge</span>
                        <span class="comment">\     (because the gaze point in [x] is closer to the</span>
                        <span class="comment">\     bottom edge than the left edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The comparison is flipped around for tiles where the</span>
                        <span class="comment">\ slopes are along the top/left or bottom/right edges,</span>
                        <span class="comment">\ so we compare ~xCoordLo instead, like this example</span>
                        <span class="comment">\ when the slopes are along the bottom and right edges:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [1]                 [2]</span>
                        <span class="comment">\              ~xCoordLo |</span>
                        <span class="comment diff">\         [x] <--------> |</span>
                        <span class="comment">\                  ^     |</span>
                        <span class="comment">\                  |     |</span>
                        <span class="comment">\        zCoordLo  |     |</span>
                        <span class="comment">\                  v     |</span>
                        <span class="comment">\   [0] --------------- [3]</span>

 <span class="mne">STA</span> <a class="popup variable">G</a>                  <span class="comment">\ Store the value of A in G so we can retrieve it below</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set the C flag to bit 0 of A, so it is:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 0 if G = 0 or 2 (bottom/left or top/right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 1 if G = 1 or 3 (top/left or bottom/right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we compare against ~xCoordLo in the following for</span>
                        <span class="comment">\ the top/left or bottom/right edge pairs</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordLo</a>           <span class="comment">\ Set A to xCoordLo when C = 0 or ~xCoordLo when C = 1</span>
 <span class="mne">BCC</span> <a class="popup destination">gaze12</a>             <span class="comment">\</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\ This ensures that the correct x-axis distance is used</span>
                        <span class="comment">\ in the comparison</span>

<span class="label">.gaze12</span><a id="gaze12" class="anchor"></a>

 <span class="mne">CMP</span> <a class="popup variable">zCoordLo</a>           <span class="comment">\ Set the C flag as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 0 if xCoordLo &lt; zCoordLo (i.e. gaze vector is</span>
                        <span class="comment">\          closer to the left or right edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 1 if xCoordLo >= zCoordLo i.e. gaze vector is</span>
                        <span class="comment">\          closer to the top or bottom edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we choose the first entry from tileEdges when the</span>
                        <span class="comment">\ gaze vector is closer to the left or right edge, or</span>
                        <span class="comment">\ the second entry when the gaze vector is closer to the</span>
                        <span class="comment">\ top or bottom edge</span>

 <span class="mne">LDA</span> <a class="popup variable">G</a>                  <span class="comment">\ Set Y = (G * 2) + C</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">TAY</span>                    <span class="comment">\ So Y can be used as an index into the tileEdges table</span>
                        <span class="comment">\ that points to the entry in pair number G as specified</span>
                        <span class="comment">\ by the C flag</span>

 <span class="mne">LDA</span> <a class="popup variable">tileEdges</a>,<span class="register">Y</span>        <span class="comment">\ Set A to the edge number that we should test against</span>
                        <span class="comment">\ the gaze vector</span>

                        <span class="comment">\ Fall into part 5 to check whether the gaze vector is</span>
                        <span class="comment">\ obscured by the edge we just chose</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-followgazevector-part-5-of-5" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">FollowGazeVector (Part 5 of 5)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">For non-flat tiles with two horizontal edges, work out whether the</span>
             <span class="headerEntry">tile edge obstructs the gaze vector</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/followgazevector_part_5_of_5.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.gaze13</span><a id="gaze13" class="anchor"></a>

                        <span class="comment">\ We jump here with A set to the number of the tile edge</span>
                        <span class="comment">\ that we can test against the gaze vector (where the</span>
                        <span class="comment">\ edge goes from corner A to corner A + 1)</span>

 <span class="mne">TAX</span>                    <span class="comment">\ Copy A into X so we can use it as an index into the</span>
                        <span class="comment">\ corner height variables we set up above</span>

                        <span class="comment">\ By this point the value of X (and, currently, of A)</span>
                        <span class="comment">\ is in the range 0 to 3, and it represents the first</span>
                        <span class="comment">\ corner of the edge within the tile we are analysing</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Here are the tile's corner heights that we set in the</span>
                        <span class="comment">\ S, T, U and V variables above:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      ^           [T]  [U]</span>
                        <span class="comment">\      |</span>
                        <span class="comment">\      |           [S]  [V]</span>
                        <span class="comment">\   z-axis</span>
                        <span class="comment">\    into</span>
                        <span class="comment diff">\   screen      x-axis from left to right ---></span>
                        <span class="comment">\</span>
                        <span class="comment">\ The variables S, T, U and V are consecutive in memory,</span>
                        <span class="comment">\ so LDA S,X can be used to select corner altitudes for</span>
                        <span class="comment">\ values of X, like this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      [T]  [U]          [1]  [2]</span>
                        <span class="comment">\                   =</span>
                        <span class="comment">\      [S]  [V]          [0]  [3]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Similarly, LDA T,X will select the altitude for tile</span>
                        <span class="comment">\ corner X + 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that back in part 2, we set W to the same value</span>
                        <span class="comment">\ as S, so this approach will still work if X = 3, as</span>
                        <span class="comment">\ LDA T,X will fetch the value of W, which is the tile</span>
                        <span class="comment">\ altitude of corner 0, just like S</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So X (and A) represent the starting corner, and we now</span>
                        <span class="comment">\ calculate the coordinates and gradient of the tile</span>
                        <span class="comment">\ edge from corner X to corner X + 1, so we can work out</span>
                        <span class="comment">\ whether the gaze passes above or below the edge</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We start by calculating the distance along the tile</span>
                        <span class="comment">\ edge that corresponds to the current position of the</span>
                        <span class="comment">\ gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To see how this works, consider the axes of the tile</span>
                        <span class="comment">\ corners:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      ^           [1]  [2]</span>
                        <span class="comment">\      |</span>
                        <span class="comment">\      |           [0]  [3]</span>
                        <span class="comment">\   z-axis</span>
                        <span class="comment">\    into</span>
                        <span class="comment diff">\   screen      x-axis from left to right ---></span>
                        <span class="comment">\</span>
                        <span class="comment">\ The low bytes of the current gaze vector in xCoordLo</span>
                        <span class="comment">\ and zCoordLo give us the fractional part of the</span>
                        <span class="comment">\ coordinate of the current position along the gaze, and</span>
                        <span class="comment">\ the fractional part gives us the position of the</span>
                        <span class="comment">\ coordinate within the tile (as the tile corners are on</span>
                        <span class="comment">\ the integer coordinates)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Zooming in on the tile, we have the following, where</span>
                        <span class="comment">\ [x] is the current position along the gaze vector when</span>
                        <span class="comment">\ looking at the tile from above:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [1]                 [2]</span>
                        <span class="comment">\     xCoordLo</span>
                        <span class="comment diff">\   <----------> [x]</span>
                        <span class="comment">\                 ^</span>
                        <span class="comment">\                 |</span>
                        <span class="comment">\                 |  zCoordLo</span>
                        <span class="comment">\                 |</span>
                        <span class="comment">\   [0]           v     [3]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now set edgeGazeDistance to the corner-relative</span>
                        <span class="comment">\ coordinate of the gaze vector along the edge that we</span>
                        <span class="comment">\ are considering (so if we are examining the edge from</span>
                        <span class="comment">\ corner X to corner X + 1, we're looking for the</span>
                        <span class="comment">\ distance between corner X and the [x] of the gaze</span>
                        <span class="comment">\ vector)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ For example, if we are considering the left edge from</span>
                        <span class="comment">\ 0 to 1, the distance of the [x] relative to corner 0</span>
                        <span class="comment">\ and along the edge is zCoordLo, while on the top edge</span>
                        <span class="comment">\ from 1 to 2, the distance of the [x] relative to</span>
                        <span class="comment">\ corner 1 and along the edge is xCoordLo</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The other two edges are similar but the distances are</span>
                        <span class="comment">\ in the opposite direction to the axes</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So if we are considering the bottom edge from 3 to 0,</span>
                        <span class="comment">\ the distance is ~xCoordLo, because:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   xCoordLo + ~xCoordLo = 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So adding xCoordLo and ~xCoordLo together gives us the</span>
                        <span class="comment">\ distance between the tile corners (which is 1), so it</span>
                        <span class="comment">\ follows that ~xCoordLo is the distance from corner 3</span>
                        <span class="comment">\ to the gaze point, as xCoordLo is the distance from</span>
                        <span class="comment">\ corner 0 to the gaze point</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now set edgeGazeDistance to the correct value</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set Y as follows:</span>
 <span class="mne">LDY</span> <a class="popup variable">xCoordLo</a>           <span class="comment">\</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze14</a>             <span class="comment">\   * xCoordLo if A = 1 or 3 (i.e. bit 0 of A is 1)</span>
 <span class="mne">LDY</span> <a class="popup variable">zCoordLo</a>           <span class="comment">\</span>
                        <span class="comment">\   * zCoordLo if A = 0 or 2 (i.e. bit 0 of A is 1)</span>

<span class="label">.gaze14</span><a id="gaze14" class="anchor"></a>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set A as follows:</span>
 <span class="mne">TYA</span>                    <span class="comment">\</span>
 <span class="mne">BCC</span> <a class="popup destination">gaze15</a>             <span class="comment">\   * A = Y if A = 0 or 1 (i.e. bit 1 of A is 0)</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\</span>
                        <span class="comment">\   * A = ~Y if A = 2 or 3 (i.e. bit 1 of A is 1)</span>

<span class="label">.gaze15</span><a id="gaze15" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">edgeGazeDistance</a>   <span class="comment">\ Set edgeGazeDistance to the result in A, so we set it</span>
                        <span class="comment">\ as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * edgeGazeDistance = zCoordLo if A = 0</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * edgeGazeDistance = xCoordLo if A = 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * edgeGazeDistance = ~zCoordLo if A = 2</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * edgeGazeDistance = ~xCoordLo if A = 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We use edgeGazeDistance below to calculate where the</span>
                        <span class="comment">\ gaze vector crosses the edge</span>

                        <span class="comment">\ We now calculate the gradient of the tile edge</span>

 <span class="mne">LDA</span> <a class="popup variable">S</a>,<span class="register">X</span>                <span class="comment">\ Set G to the altitude of corner X, which we use in the</span>
 <span class="mne">STA</span> <a class="popup variable">G</a>                  <span class="comment">\ calculation at the end of the routine</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>,<span class="register">X</span>                <span class="comment">\ Set A to the altitude of corner X + 1 minus the</span>
 <span class="mne">SEC</span>                    <span class="comment">\ altitude of corner X</span>
 <span class="mne">SBC</span> <a class="popup variable">S</a>,<span class="register">X</span>                <span class="comment">\</span>
                        <span class="comment">\ So this is the gradient of the edge between corner</span>
                        <span class="comment">\ X and corner X + 1</span>

 <span class="mne">PHP</span>                    <span class="comment">\ Store the flags of the result on the stack, so we can</span>
                        <span class="comment">\ retrieve the sign below</span>

 <span class="mne">BPL</span> <a class="popup destination">gaze16</a>             <span class="comment">\ If the result is negative then negate it to make it</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\ positive, so A now contains the absolute value of the</span>
 <span class="mne">CLC</span>                    <span class="comment">\ edge gradient</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>

<span class="label">.gaze16</span><a id="gaze16" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set U to the absolute gradient of the edge</span>

 <span class="mne">LDA</span> <a class="popup variable">edgeGazeDistance</a>   <span class="comment">\ Set A to the fractional distance along the edge that</span>
                        <span class="comment">\ corresponds to the current position along the gaze</span>
                        <span class="comment">\ vector</span>

 <span class="mne">JSR</span> <a class="popup destination">Multiply8x8</a>        <span class="comment">\ Set (A T) = A * U</span>
                        <span class="comment">\           = fractional distance * |gradient|</span>

 <span class="mne">PLP</span>                    <span class="comment">\ Restore the sign of the gradient which we stored on</span>
                        <span class="comment">\ the stack above, so the N flag reflects the sign of</span>
                        <span class="comment">\ the gradient</span>

 <span class="mne">JSR</span> <a class="popup destination">Absolute16Bit</a>      <span class="comment">\ Set the sign of (A T) to match the gradient, so A is</span>
                        <span class="comment">\ now the correct sign for the calculation and we have</span>
                        <span class="comment">\ the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (A T) = fractional distance * gradient</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The fractional distance is a fractional value that</span>
                        <span class="comment">\ represents how far along the edge we would need to go</span>
                        <span class="comment">\ in order to be at the corresponding coordinate as the</span>
                        <span class="comment">\ current position along the gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The gradient is the change in altitude as we move from</span>
                        <span class="comment">\ one end of the edge to the other</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Multiplying these two therefore gives us the height of</span>
                        <span class="comment">\ the point along the edge that corresponds to the</span>
                        <span class="comment">\ current position along the gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This height is relative to the tile corner at the</span>
                        <span class="comment">\ start of the edge (i.e. corner X), so to get the</span>
                        <span class="comment">\ altitude of the point in the 3D world, we need to add</span>
                        <span class="comment">\ the result in (A T) to the altitude of corner X</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We set G above to the altitude of corner X, which came</span>
                        <span class="comment">\ from the call to GetTileAltitude, so G contains the</span>
                        <span class="comment">\ high byte of the altitude and is therefore an integer</span>
                        <span class="comment">\ value, so we add a low byte of 0 in the addition</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Set (U T) = (G 0) + (A T)</span>
 <span class="mne">ADC</span> <a class="popup variable">G</a>                  <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ So (U T) contains the altitude of the point on the</span>
                        <span class="comment">\ edge that corresponds to the current position of the</span>
                        <span class="comment">\ gaze vector</span>

 <span class="mne">LDA</span> <a class="popup variable">yCoordLo</a>           <span class="comment">\ Set (A *) = yCoord(Hi Lo) - (U T)</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <a class="popup variable">T</a>                  <span class="comment">\ So A contains the high byte of the difference in</span>
 <span class="mne">LDA</span> <a class="popup variable">yCoordHi</a>           <span class="comment">\ altitude between the current position along the gaze</span>
 <span class="mne">SBC</span> <a class="popup variable">U</a>                  <span class="comment">\ vector and the point on the edge that corresponds to</span>
                        <span class="comment">\ the vector</span>

 <span class="mne">BPL</span> <a class="popup destination">gaze17</a>             <span class="comment">\ If the current position along the gaze vector is</span>
                        <span class="comment">\ higher than the corresponding point on the edge, then</span>
                        <span class="comment">\ the viewer's gaze is not being obstructed by the edge,</span>
                        <span class="comment">\ so jump to gaze1 via gaze17 to move along the gaze</span>
                        <span class="comment">\ vector and restart the checks</span>

 <span class="mne">JMP</span> <a class="popup destination">gaze4</a>              <span class="comment">\ Otherwise the current position along the gaze vector</span>
                        <span class="comment">\ is below the corresponding point on the edge, and the</span>
                        <span class="comment">\ viewer's gaze is being obstructed by the edge, so jump</span>
                        <span class="comment">\ to gaze4 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set to indicate that the viewer is not looking at a</span>
                        <span class="comment">\ tile</span>

<span class="label">.gaze17</span><a id="gaze17" class="anchor"></a>

 <span class="mne">JMP</span> <a class="popup destination">gaze1</a>              <span class="comment">\ Jump to gaze1 to move along the gaze vector and</span>
                        <span class="comment">\ restart the checks (this jump point is for use by</span>
                        <span class="comment">\ branching instructions)</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-tileedges" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">tileEdges</span>                                               <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Variable</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">A table to map tile shapes and gaze vector direction to tile edges</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this variable <a href="/source/main/variable/tileedges.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This variable is used as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/followgazevector_part_4_of_5.html">FollowGazeVector (Part 4 of 5)</a> uses <a href="#tileedges">tileEdges</a></span>
</div>
<hr class="light">
 This table contains tile corner numbers from a tile:

      ^           [1]  [2]
      |
      |           [0]  [3]
   z-axis
    into
   screen      x-axis from left to right ---&gt;

 Each tile corner number represents an edge from the number to the number + 1,
 so 1 represents the edge from corner 1 to corner 2, for example.

 The table is used to work out which edge should be chosen for the calculation
 in the FollowGazeVector routine, where we work out whether the gaze vector is
 hitting a tile slope in a tile with two horizontal edges.

 See part 4 of the FollowGazeVector routine for details of how this table
 works.

</div></div>
<span class="label">.tileEdges</span><a id="tileedges" class="anchor"></a>

 <span class="mne">EQUB</span> <span class="decimal">0</span><span class="comma">,</span> <span class="decimal">3</span>              <span class="comment">\ Left and bottom edges (G = 0)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ First entry (left edge) for xCoordLo &lt; zCoordLo</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Second entry (bottom edge) for xCoordLo >= zCoordLo</span>

 <span class="mne">EQUB</span> <span class="decimal">1</span><span class="comma">,</span> <span class="decimal">0</span>              <span class="comment">\ Top and left edges (G = 1)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ First entry (top edge) for ~xCoordLo &lt; zCoordLo</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Second entry (left edge) for ~xCoordLo >= zCoordLo</span>

 <span class="mne">EQUB</span> <span class="decimal">1</span><span class="comma">,</span> <span class="decimal">2</span>              <span class="comment">\ Top and right edges (G = 2)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ First entry (top edge) for xCoordLo &lt; zCoordLo</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Second entry (right edge) for xCoordLo >= zCoordLo</span>

 <span class="mne">EQUB</span> <span class="decimal">2</span><span class="comma">,</span> <span class="decimal">3</span>              <span class="comment">\ Right and bottom edges (G = 3)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ First entry (right edge) for ~xCoordLo &lt; zCoordLo</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Second entry (bottom edge) for ~xCoordLo >= zCoordLo</span>


<div class="headerBlockWrapper"><div class="headerBlock"><a id="header-gettilealtitude" class="anchor"></a><span class="headerLabel">       Name:</span> <span class="headerEntry">GetTileAltitude</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate the altitude of a tile, optionally including platform</span>
             <span class="headerEntry">objects and trees in the calculation</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/main/subroutine/gettilealtitude.html">on its own page</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/followgazevector_part_1_of_5.html">FollowGazeVector (Part 1 of 5)</a> calls <a href="#gettilealtitude">GetTileAltitude</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/followgazevector_part_2_of_5.html">FollowGazeVector (Part 2 of 5)</a> calls <a href="#gettilealtitude">GetTileAltitude</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/gettilealtitudes.html">GetTileAltitudes</a> calls <a href="#gettilealtitude">GetTileAltitude</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">(xTile, zTile)</span>       <span class="argumentEntry">The coordinates of the tile to analyse</span>

   <span class="argumentLabel">considerObjects</span>      <span class="argumentEntry">The data to extract:</span>

                        <span class="argumentEntry">  * Bit 7 clear = extract the tile's altitude and</span>
                        <span class="argumentEntry">                  flatness, ignoring any objects on the</span>
                        <span class="argumentEntry">                  tile</span>

                        <span class="argumentEntry">  * Bit 7 set = if the tile contains a platform object</span>
                        <span class="argumentEntry">                (i.e. boulder or tower) or a tree, then</span>
                        <span class="argumentEntry">                extract data for the object instead of</span>
                        <span class="argumentEntry">                the tile when applicable (this option</span>
                        <span class="argumentEntry">                is only set when calling this routine</span>
                        <span class="argumentEntry">                from FollowGazeVector)</span>

   <span class="argumentLabel">xCoordLo</span>             <span class="argumentEntry">The low byte (i.e. fractional part) of the x-coordinate</span>
                        <span class="argumentEntry">of the current position along the gaze vector (when</span>
                        <span class="argumentEntry">the routine is called from FollowGazeVector)</span>

   <span class="argumentLabel">zCoordLo</span>             <span class="argumentEntry">The low byte (i.e. fractional part) of the z-coordinate</span>
                        <span class="argumentEntry">of the current position along the gaze vector (when</span>
                        <span class="argumentEntry">the routine is called from FollowGazeVector)</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The high byte of the tile's altitude (though if bit 7 of</span>
                        <span class="argumentEntry">considerObjects is set, see yPlatformLo below)</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">The tile's shape:</span>

                        <span class="argumentEntry">  * Clear if the tile is flat</span>

                        <span class="argumentEntry">  * Set if the tile is not flat</span>

   <span class="argumentLabel">yPlatformLo</span>          <span class="argumentEntry">If bit 7 of considerObjects is set and the tile contains</span>
                        <span class="argumentEntry">the Sentinel's tower or a boulder, the altitude of the</span>
                        <span class="argumentEntry">platform on the top of the tower or boulder is returned</span>
                        <span class="argumentEntry">in (A yPlatformLo)</span>

   <span class="argumentLabel">boulderOnTile</span>        <span class="argumentEntry">If bit 7 of considerObjects is set, this records whether</span>
                        <span class="argumentEntry">the tile contains a boulder:</span>

                        <span class="argumentEntry">  * Bit 7 clear = tile does not contain a boulder</span>

                        <span class="argumentEntry">  * Bit 7 set = tile contains a boulder</span>

   <span class="argumentLabel">targetOnTile</span>         <span class="argumentEntry">If bit 7 of considerObjects is set, this records whether</span>
                        <span class="argumentEntry">the tile contains the target object whose number is in</span>
                        <span class="argumentEntry">targetOnTile:</span>

                        <span class="argumentEntry">  * Bit 7 clear = tile does not contain the target</span>
                        <span class="argumentEntry">                  object</span>

                        <span class="argumentEntry">  * Bit 7 set = tile does contain the target object</span>

   <span class="argumentLabel">gazeCanSeeTree</span>       <span class="argumentEntry">If bit 7 of considerObjects is set and bit 7 of</span>
                        <span class="argumentEntry">targetOnTile is clear, this records whether the tile</span>
                        <span class="argumentEntry">contains a tree that can be seen by the gaze vector:</span>

                        <span class="argumentEntry">  * Bit 7 clear = tile does not contain a tree that can</span>
                        <span class="argumentEntry">                  be seen by the gaze vector</span>

                        <span class="argumentEntry">  * Bit 7 set = tile contains a tree that can be seen by</span>
                        <span class="argumentEntry">                the gaze vector</span>

   <span class="argumentLabel">considerObjects</span>      <span class="argumentEntry">If bit 7 of considerObjects is set then bit 6 will also</span>
                        <span class="argumentEntry">be set by the routine if the tile contains a platform</span>
                        <span class="argumentEntry">object (i.e. boulder or Sentinel's tower) and the</span>
                        <span class="argumentEntry">current position along the gaze vector is not within the</span>
                        <span class="argumentEntry">platform object (so the gaze vector is passing close by</span>
                        <span class="argumentEntry">the platform object but is not hitting it)</span>

   <span class="argumentLabel">yAccuracyLo</span>          <span class="argumentEntry">Set to 16 if the tile contains the Sentinel's tower and</span>
                        <span class="argumentEntry">the gaze vector is pointing at the sides of the tower</span>

</div></div>
<span class="label">.GetTileAltitude</span><a id="gettilealtitude" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">GetTileData</a>        <span class="comment">\ Set A to the tile data for the tile anchored at</span>
                        <span class="comment">\ (xTile, zTile), setting the C flag if the tile</span>
                        <span class="comment">\ contains an object</span>

 <span class="mne">BCS</span> <a class="popup destination">tile3</a>              <span class="comment">\ If the tile contains an object then jump to tile3</span>

 <span class="mne">PHA</span>                    <span class="comment">\ Store the tile data on the stack</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00001111</span>         <span class="comment">\ The tile shape is in the low nibble of the tile data,</span>
 <span class="mne">TAY</span>                    <span class="comment">\ so extract the tile shape into Y</span>

 <span class="mne">PLA</span>                    <span class="comment">\ Retrieve the tile data from the stack</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set A to the tile altitude, which is in the top nibble</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ of the tile data</span>
 <span class="mne">LSR</span> <span class="register">A</span>
 <span class="mne">LSR</span> <span class="register">A</span>

 <span class="mne">CPY</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Clear the C flag if Y &lt; 1, which will only happen when</span>
                        <span class="comment">\ Y = 0, so this clears the C flag if the tile shape is</span>
                        <span class="comment">\ flat, or sets the C flag if the tile shape is not flat</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.tile1</span><a id="tile1" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile contains object #Y and</span>
                        <span class="comment">\ bit 7 of considerObjects is set, so we need to process</span>
                        <span class="comment">\ the objects on the stack</span>

 <span class="mne">CPY</span> <a class="popup variable">targetObject</a>       <span class="comment">\ If Y = targetObject then the target object is on the</span>
 <span class="mne">BNE</span> <a class="popup destination">tile2</a>              <span class="comment">\ tile, so set bit 7 of targetOnTile to indicate this</span>
 <span class="mne">ROR</span> <a class="popup variable">targetOnTile</a>

<span class="label">.tile2</span><a id="tile2" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the type of object that's already on the tile</span>
                        <span class="comment">\ (i.e. the type of object #Y)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ If the tile contains a boulder (an object of type 3),</span>
 <span class="mne">BEQ</span> <a class="popup destination">tile4</a>              <span class="comment">\ jump to tile4 to extract details about the boulder</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ If the tile contains a tree (an object of type 2),</span>
 <span class="mne">BEQ</span> <a class="popup destination">tile4</a>              <span class="comment">\ jump to tile4 to extract details about the tree</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">6</span>                 <span class="comment">\ If the tile doesn't contain the Sentinel's tower (type</span>
 <span class="mne">BNE</span> <a class="popup destination">tile7</a>              <span class="comment">\ 6) then it must contain a robot, sentry, meanie or the</span>
                        <span class="comment">\ Sentinel, so jump to tile7 to return the altitude of</span>
                        <span class="comment">\ the tile rather than the object</span>

                        <span class="comment">\ If we get here then the tile contains the Sentinel's</span>
                        <span class="comment">\ tower in object #Y</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckForTileCentre</a> <span class="comment">\ Set T = max(|xCoordLo - 128|, |zCoordLo - 128|)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and return the same value in A</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This calculates how close the current position along</span>
                        <span class="comment">\ the gaze vector is to the centre of the tile, in terms</span>
                        <span class="comment">\ of the x-coordinate and z-coordinate</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">100</span>               <span class="comment">\ If A >= 100 then the gaze vector is a long way from</span>
 <span class="mne">BCS</span> <a class="popup destination">tile6</a>              <span class="comment">\ the centre of the tile (i.e. more than 100/128 = 78%</span>
                        <span class="comment">\ of the distance from the centre to the tile edge,</span>
                        <span class="comment">\ which is outside the body of the tower), so jump to</span>
                        <span class="comment">\ tile6 to set bit 6 of considerObjects and return the</span>
                        <span class="comment">\ altitude of the tile</span>

                        <span class="comment">\ If we get here then the gaze vector is pointing at the</span>
                        <span class="comment">\ sides of the tower, so we return the altitude of the</span>
                        <span class="comment">\ platform on top of the tower</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">16</span>                <span class="comment">\ Set yAccuracyLo = 16, so the gaze vector has to be</span>
 <span class="mne">STA</span> <a class="popup variable">yAccuracyLo</a>        <span class="comment">\ no more than 0.025 of a tile's height above the tile</span>
                        <span class="comment">\ for us to consider it as potentially hitting the tile</span>
                        <span class="comment">\ when we return to the FollowGazeVector routine (this</span>
                        <span class="comment">\ makes the player have to be much more accurate when</span>
                        <span class="comment">\ trying to view the Sentinel's tile)</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectLo</a>,<span class="register">Y</span>        <span class="comment">\ Set the following:</span>
 <span class="mne">CLC</span>                    <span class="comment">\</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\   (A yPlatformLo) = yObject(Hi Lo) + 32</span>
 <span class="mne">STA</span> <a class="popup variable">yPlatformLo</a>        <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">yObjectHi</a>,<span class="register">Y</span>        <span class="comment">\ where yObject is the altitude of the Sentinel's tower</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&00</span>               <span class="comment">\</span>
                        <span class="comment">\ So we return the altitude of the top of the tower by</span>
                        <span class="comment">\ effectively adding the tower's height to the tower</span>
                        <span class="comment">\ object's altitude, bearing in mind that objects are</span>
                        <span class="comment">\ spawned at a height of 224 above their tiles, so this</span>
                        <span class="comment">\ returns the altitude of the top of the tower, with</span>
                        <span class="comment">\ the tower being 224 + 32 = 256 fractional parts above</span>
                        <span class="comment">\ the tile (so the tower is the height of one entire</span>
                        <span class="comment">\ integer y-coordinate)</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that the tile is flat</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.tile3</span><a id="tile3" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile contains an object</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">TAY</span>                    <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into Y (so</span>
                        <span class="comment">\ the tile effectively contains object #Y)</span>

 <span class="mne">BIT</span> <a class="popup variable">considerObjects</a>    <span class="comment">\ If bit 7 of considerObjects is clear, jump to tile7 to</span>
 <span class="mne">BPL</span> <a class="popup destination">tile7</a>              <span class="comment">\ return the altitude of the bottom object on the tile,</span>
                        <span class="comment">\ iterating down through the stack of objects if there</span>
                        <span class="comment">\ is more than one object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The altitude of the bottom object is the same as the</span>
                        <span class="comment">\ altitude of the tile itself, so this ensures that we</span>
                        <span class="comment">\ return the tile's altitude from the subroutine, as per</span>
                        <span class="comment">\ bit 7 of considerObjects</span>

 <span class="mne">BMI</span> <a class="popup destination">tile1</a>              <span class="comment">\ Otherwise bit 7 of considerObjects is set and we need</span>
                        <span class="comment">\ to take any objects on the tile into consideration, so</span>
                        <span class="comment">\ jump to tile1 to process the objects on the stack</span>
                        <span class="comment">\ (this BMI is effectively a JMP as we just passed</span>
                        <span class="comment">\ through a BPL)</span>

<span class="label">.tile4</span><a id="tile4" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile contains a tree or a</span>
                        <span class="comment">\ boulder in object #Y</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckForTileCentre</a> <span class="comment">\ Set T = max(|xCoordLo - 128|, |zCoordLo - 128|)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and return the same value in A</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This calculates how close the current position along</span>
                        <span class="comment">\ the gaze vector is to the centre of the tile, in terms</span>
                        <span class="comment">\ of the x-coordinate and z-coordinate</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">64</span>                <span class="comment">\ If A >= 64 then the gaze vector is more than half way</span>
 <span class="mne">BCS</span> <a class="popup destination">tile6</a>              <span class="comment">\ from the centre of the tile (i.e. more than 64/128 =</span>
                        <span class="comment">\ 50% of the distance from the centre to the tile edge,</span>
                        <span class="comment">\ which is outside the body of the tree or boulder), so</span>
                        <span class="comment">\ jump to tile6 to set bit 6 of considerObjects (if this</span>
                        <span class="comment">\ is a boulder) and return the altitude of the tile</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ If object #Y is a tree (an object of type 2), jump to</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ tile5</span>
 <span class="mne">BEQ</span> <a class="popup destination">tile5</a>

                        <span class="comment">\ If we get here then the tile contains a boulder in</span>
                        <span class="comment">\ object #Y</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set bit 7 of boulderOnTile to indicate that the tile</span>
 <span class="mne">ROR</span> <a class="popup variable">boulderOnTile</a>      <span class="comment">\ contains a boulder</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectLo</a>,<span class="register">Y</span>        <span class="comment">\ Set the following:</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&60</span>               <span class="comment">\   (A yPlatformLo) = yObject(Hi Lo) - 96</span>
 <span class="mne">STA</span> <a class="popup variable">yPlatformLo</a>        <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">yObjectHi</a>,<span class="register">Y</span>        <span class="comment">\ where yObject is the altitude of the boulder</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&00</span>
                        <span class="comment">\ So we return the altitude of the top of the boulder by</span>
                        <span class="comment">\ effectively adding the boulder's height to the boulder</span>
                        <span class="comment">\ object's altitude, bearing in mind that objects are</span>
                        <span class="comment">\ spawned at a height of 224 above their tiles, so this</span>
                        <span class="comment">\ returns the altitude of the top of the boulder, with</span>
                        <span class="comment">\ the boulder being 224 - 96 = 128 fractional parts</span>
                        <span class="comment">\ above the tile (so the boulder is the height of one</span>
                        <span class="comment">\ half of a y-coordinate)</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that the tile is flat</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.tile5</span><a id="tile5" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile contains a tree in</span>
                        <span class="comment">\ object #Y</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectLo</a>,<span class="register">Y</span>        <span class="comment">\ Set the following:</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <a class="popup variable">yCoordLo</a>           <span class="comment">\   (A U) =  yObject(Hi Lo) - yCoord(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">yObjectHi</a>,<span class="register">Y</span>        <span class="comment">\ where yObject is the altitude of the tree</span>
 <span class="mne">SBC</span> <a class="popup variable">yCoordHi</a>           <span class="comment">\</span>
                        <span class="comment">\ So (A U) contains the relative altitude of the current</span>
                        <span class="comment">\ position along the gaze vector compared to the tree,</span>
                        <span class="comment">\ with a positive value indicating that the gaze is</span>
                        <span class="comment">\ is below the tree, and a negative value indicating</span>
                        <span class="comment">\ that the gaze is above the tree</span>

 <span class="mne">PHA</span>                    <span class="comment">\ Set (A U) = (A U) + 224</span>
 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\</span>
 <span class="mne">CLC</span>                    <span class="comment">\ This adds the height of the tree to (A U), as trees</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&E0</span>               <span class="comment">\ have a height of 224 fractional y-coordinates, so the</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ value in (A U) is now relative to the top of the tree,</span>
 <span class="mne">PLA</span>                    <span class="comment">\ so it is effectively the height difference between the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&00</span>               <span class="comment">\ gaze and the tree top</span>

 <span class="mne">BMI</span> <a class="popup destination">tile6</a>              <span class="comment">\ If A is negative then the current position along the</span>
                        <span class="comment">\ gaze vector is above the top of the tree, so jump to</span>
                        <span class="comment">\ tile6 to return the altitude of the tile</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set (A U) = (A U) / 2</span>
 <span class="mne">ROR</span> <a class="popup variable">U</a>                  <span class="comment">\</span>
                        <span class="comment">\ So (A U) is now half the height difference between the</span>
                        <span class="comment">\ gaze and tree top</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ If any of bits 1 to 7 of A are set then A >> 1 will be</span>
 <span class="mne">BNE</span> <a class="popup destination">tile6</a>              <span class="comment">\ non-zero and the original value of (A U) must have</span>
                        <span class="comment">\ been at least %100, so that's a positive value with a</span>
                        <span class="comment">\ high byte of at least 4</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means the gaze vector is too far below the tree</span>
                        <span class="comment">\ for it to be visible, so jump to tile6 to return the</span>
                        <span class="comment">\ altitude of the tile</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ If we get here then we know A >> 1 = 0, so we can</span>
 <span class="mne">ROR</span> <span class="register">A</span>                  <span class="comment">\ halve (U A) again and discard the top byte, as it will</span>
                        <span class="comment">\ be zero, so this sets:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   A = (U A) / 2</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this is the original height difference between the</span>
                        <span class="comment">\ gaze and tree top, divided by 4</span>

                        <span class="comment">\ We set T above to the maximum distance between the</span>
                        <span class="comment">\ gaze vector and the centre of the tile in terms of the</span>
                        <span class="comment">\ horizontal axes</span>

 <span class="mne">CMP</span> <a class="popup variable">T</a>                  <span class="comment">\ If A &lt; T then the gaze is further from the centre of</span>
 <span class="mne">BCC</span> <a class="popup destination">tile6</a>              <span class="comment">\ the tile than the height difference to the tree top</span>
                        <span class="comment">\ divided by 4, so jump to tile6 to return the altitude</span>
                        <span class="comment">\ of the tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The centre point of the tile is the tree trunk, so</span>
                        <span class="comment">\ this test means that gazes at the lower parts of the</span>
                        <span class="comment">\ tree can be further from the centre point than gazes</span>
                        <span class="comment">\ at the upper parts of the tree, while still being</span>
                        <span class="comment">\ considered gazes that fall upon the tree</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This fits in with the tree's shape and makes the tree</span>
                        <span class="comment">\ detection code more accurate</span>

 <span class="mne">BIT</span> <a class="popup variable">targetOnTile</a>       <span class="comment">\ If bit 7 of targetOnTile is set then the tree is</span>
 <span class="mne">BMI</span> <a class="popup destination">tile6</a>              <span class="comment">\ the targeted object, so skip the following so that we</span>
                        <span class="comment">\ only set bit 7 of gazeCanSeeTree if the tree is not</span>
                        <span class="comment">\ the target (i.e. if bit 7 of targetOnTile is clear)</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set bit 7 of gazeCanSeeTree to indicate that the tree</span>
 <span class="mne">ROR</span> <a class="popup variable">gazeCanSeeTree</a>     <span class="comment">\ can be seen by the gaze vector</span>

<span class="label">.tile6</span><a id="tile6" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the type of object #Y</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ If the tile contains a tree (an object of type 2),</span>
 <span class="mne">BEQ</span> <a class="popup destination">tile7</a>              <span class="comment">\ jump to tile7 to skip the following instruction</span>

                        <span class="comment">\ If we get here then the tile contains a boulder or the</span>
                        <span class="comment">\ Sentinel's tower, and in either case the gaze vector</span>
                        <span class="comment">\ is not close enough to the platform object to hit it</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%11000000</span>         <span class="comment">\ Set bit 6 of considerObjects to denote that the gaze</span>
 <span class="mne">STA</span> <a class="popup variable">considerObjects</a>    <span class="comment">\ vector is passing close by the platform object but is</span>
                        <span class="comment">\ not hitting it, and set bit 7 so that it is unchanged</span>

<span class="label">.tile7</span><a id="tile7" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the object flags for object #Y</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ If bit 6 of the object flags for object #Y is set</span>
 <span class="mne">BCS</span> <a class="popup destination">tile3</a>              <span class="comment">\ then object #Y is stacked on top of another object,</span>
                        <span class="comment">\ so jump to tile3 with the object number in bits 0 to</span>
                        <span class="comment">\ 5 of the object flags in A, so we can process that</span>
                        <span class="comment">\ object instead</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectHi</a>,<span class="register">Y</span>        <span class="comment">\ At this point we have reached the object on the tile</span>
                        <span class="comment">\ itself, so set A to the y-coordinate of that object,</span>
                        <span class="comment">\ which will be the tile altitude, and return from the</span>
                        <span class="comment">\ subroutine with the C flag clear to denote a flat</span>
                        <span class="comment">\ tile, as objects are only ever placed on flat tiles</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>


</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-abortwhenvisible"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-abortwhenvisible">AbortWhenVisible</a> (category: Gameplay)</div><div class="summary">Abort applying the tactics for this gameplay loop if updating the object on-screen will corrupt a screen pan</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-absolute16bit"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_a.html#header-absolute16bit">Absolute16Bit</a> (category: Maths (Arithmetic))</div><div class="summary">Calculate the absolute value (modulus) of a 16-bit number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-addvectortocoord"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-addvectortocoord">AddVectorToCoord</a> (category: Maths (Geometry))</div><div class="summary">Add a vector to a coordinate</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkenemygaze"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-checkenemygaze-part-1-of-2">CheckEnemyGaze (Part 1 of 2)</a> (category: Gameplay)</div><div class="summary">Check to see whether the current enemy can see a specific target object of a specific type</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkfortilecentre"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-checkfortilecentre">CheckForTileCentre</a> (category: Maths (Geometry))</div><div class="summary">Calculate max(|xCoordLo - 128|, |zCoordLo - 128|)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkobjvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-checkobjvisibility">CheckObjVisibility</a> (category: Drawing objects)</div><div class="summary">Check whether an object is visible on-screen and should therefore not be changed if a pan operation is about to happen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-crackerseed"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_a.html#header-crackerseed">CrackerSeed</a> (category: Cracker protection)</div><div class="summary">Obfuscated storage for the high byte of the landscape number as part of the anti-cracker code</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-deleteobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-deleteobject">DeleteObject</a> (category: 3D objects)</div><div class="summary">Delete an object, removing it from the landscape and vacating its object number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-divideby16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-divideby16">DivideBy16</a> (category: Maths (Arithmetic))</div><div class="summary">Divide a 16-bit sign-magnitude number by 16</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawtitlescreen"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_f.html#header-drawtitlescreen">DrawTitleScreen</a> (category: Title screen)</div><div class="summary">Draw the title screen or the screen showing the secret code</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-finishenemytactics"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-finishenemytactics">FinishEnemyTactics</a> (category: Gameplay)</div><div class="summary">Stop applying tactics to the current enemy and return to the ProcessGameplay routine to continue with the gameplay loop</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-flushbuffer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-flushbuffer">FlushBuffer</a> (category: Keyboard)</div><div class="summary">Flush the specified buffer</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-focusonkeyaction"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_b.html#header-focusonkeyaction">FocusOnKeyAction</a> (category: Keyboard)</div><div class="summary">Tell the game to start focusing effort on the action that has been initiated, such as a pan of the landscape, absorb, transfer etc.</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-followgazevector"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-1-of-5">FollowGazeVector (Part 1 of 5)</a> (category: Maths (Geometry))</div><div class="summary">Follow a gaze vector from a viewing object to determine whether the viewer can see a flat tile or platform (i.e. boulder or tower)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-g"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#g">G</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-generatelandscape"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_e.html#header-generatelandscape">GenerateLandscape</a> (category: Landscape)</div><div class="summary">Generate tile data for the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getobjvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-getobjvisibility">GetObjVisibility</a> (category: Gameplay)</div><div class="summary">Calculate whether any part of an object is visible on-screen, and if so, which character columns it spans on the screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getobjectangles"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_j.html#header-getobjectangles">GetObjectAngles</a> (category: 3D objects)</div><div class="summary">Calculate the angles and distances of the vector from the viewer to a specific object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getobjectcoords"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-getobjectcoords">GetObjectCoords</a> (category: 3D objects)</div><div class="summary">Get an object's coordinates</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getpitchangledelta"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_i.html#header-getpitchangledelta">GetPitchAngleDelta</a> (category: Maths (Geometry))</div><div class="summary">Calculate the pitch angle of a vector relative to an object's pitch angle</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getplayerenergybcd"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-getplayerenergybcd">GetPlayerEnergyBCD</a> (category: Maths (Arithmetic))</div><div class="summary">Fetch the player's energy in binary coded decimal (BCD)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getrotationmatrix"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_a.html#header-getrotationmatrix-part-1-of-5">GetRotationMatrix (Part 1 of 5)</a> (category: Maths (Geometry))</div><div class="summary">Calculate the rotation matrix for rotating the pitch or yaw angle for the sights into the global 3D coordinate system</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getsightsvector"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-getsightsvector">GetSightsVector</a> (category: Maths (Geometry))</div><div class="summary">Calculate the angles of the vector from the player's eyes to the sights</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettilealtitude"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a> (category: Landscape)</div><div class="summary">Calculate the altitude of a tile, optionally including platform objects and trees in the calculation</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettiledata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_e.html#header-gettiledata">GetTileData</a> (category: Landscape)</div><div class="summary">Get the tile data and tile data address for a specific tile</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getvectorforangles"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-getvectorforangles">GetVectorForAngles</a> (category: Maths (Geometry))</div><div class="summary">Convert a vector from pitch and yaw angles into a 3D cartesian vector</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-h"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#h">H</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in the maths routines</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-initialiseseeds"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-initialiseseeds">InitialiseSeeds</a> (category: Landscape)</div><div class="summary">Initialise the seed number generator so it generates the sequence of seed numbers for a specific landscape number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-makesound"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-makesound">MakeSound</a> (category: Sound)</div><div class="summary">Make a sound</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-moveontonextenemy"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_b.html#header-moveontonextenemy">MoveOnToNextEnemy</a> (category: Gameplay)</div><div class="summary">Update enemyObject so the next time we consider applying enemy tactics, we apply them to the next enemy, looping from 7 to 0</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-multiply16x16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_a.html#header-multiply16x16">Multiply16x16</a> (category: Maths (Arithmetic))</div><div class="summary">Multiply a sign-magnitude 16-bit number and a signed 16-bit number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-multiply8x8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_a.html#header-multiply8x8">Multiply8x8</a> (category: Maths (Arithmetic))</div><div class="summary">Calculate (A T) = T * U</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-multiplycoords"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_c.html#header-multiplycoords">MultiplyCoords</a> (category: Maths (Arithmetic))</div><div class="summary">Multiply a 16-bit signed number and a 16-bit sign-magnitude value</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-negate16bit"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_a.html#header-negate16bit">Negate16Bit</a> (category: Maths (Arithmetic))</div><div class="summary">Negate a 16-bit number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pp"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#pp">PP</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in the maths routines</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-performhyperspace"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-performhyperspace">PerformHyperspace</a> (category: Gameplay)</div><div class="summary">Hyperspace the player to a brand new tile, ideally at the same altitude as the current tile</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-placeobjectbelow"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_b.html#header-placeobjectbelow">PlaceObjectBelow</a> (category: 3D objects)</div><div class="summary">Attempt to place an object on a tile that is below the maximum altitude specified in A</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-placeobjectontile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-placeobjectontile">PlaceObjectOnTile</a> (category: 3D objects)</div><div class="summary">Place an object on a tile, putting it on top of any existing boulders or towers</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playmusic"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_j.html#header-playmusic">PlayMusic</a> (category: Sound)</div><div class="summary">Play a piece of music</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-printlandscapenum"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-printlandscapenum">PrintLandscapeNum</a> (category: Text)</div><div class="summary">Print the four-digit landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-printtexttoken"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-printtexttoken">PrintTextToken</a> (category: Text)</div><div class="summary">Print a recursive text token</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-qq"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#qq">QQ</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in the maths routines</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#rr">RR</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in the maths routines</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-s"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#s">S</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ss"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#ss">SS</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in the maths routines</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnenemies"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_b.html#header-spawnenemies">SpawnEnemies</a> (category: Landscape)</div><div class="summary">Calculate the number of enemies for this landscape, add them to the landscape and set the palette accordingly</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-spawnobject">SpawnObject</a> (category: 3D objects)</div><div class="summary">Add a new object of the specified type to the objectTypes table</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnobject-plus-3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Entry point <a href="/source/all/the_sentinel_d.html#spawnobject">SpawnObject+3</a> in subroutine <a href="/source/all/the_sentinel_d.html#header-spawnobject">SpawnObject</a> (category: 3D objects)</div><div class="summary">Spawn an object of the type specified in keyPress</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnplayer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_b.html#header-spawnplayer">SpawnPlayer</a> (category: Landscape)</div><div class="summary">Add the player object to the landscape, ideally placing it below all the enemies and in the bottom half of the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#t">T</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-u"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#u">U</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-updateiconsscanner"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_g.html#header-updateiconsscanner">UpdateIconsScanner</a> (category: Scanner/energy row)</div><div class="summary">Update the icons in the top-left corner of the screen to show the player's current energy level and redraw the scanner box</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-updateplayerenergy"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/all/the_sentinel_d.html#header-updateplayerenergy">UpdatePlayerEnergy</a> (category: Gameplay)</div><div class="summary">Update the player's energy levels by adding or subtracting the amount of energy in a specific object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-v"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#v">V</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-w"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#w">W</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-addv1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#addv1">addv1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-addvectortocoord">AddVectorToCoord</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-addv2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#addv2">addv2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-addvectortocoord">AddVectorToCoord</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-alteredseed"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#alteredseed">alteredSeed</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">An altered version of the anti-cracker seed-related data that gets created in AlterCrackerSeed and checked in CheckCreckerSeed as part of the anti-cracker code</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-alts1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#alts1">alts1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-altercrackerseed">AlterCrackerSeed</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-anglehi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#anglehi">angleHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The low byte of an angle</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-anglelo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#anglelo">angleLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The high byte of an angle</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-boulderontile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#boulderontile">boulderOnTile</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record whether the tile being analysed in the GetTileAltitude routine contains a boulder</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-considerobjects"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#considerobjects">considerObjects</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Controls whether the GetTileAltitude routine takes platform objects into consideration when calculating tile altitudes (bit 7) and returns details about the gaze vector (bit 6)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-cosvectorpitchhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#cosvectorpitchhi">cosVectorPitchHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The high byte of cos(vectorPitchAngle) when converting pitch and yaw angles to cartesian vectors</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-cosvectorpitchlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#cosvectorpitchlo">cosVectorPitchLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The low byte of cos(vectorPitchAngle) when converting pitch and yaw angles to cartesian vectors</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-currentobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#currentobject">currentObject</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The number of the object we are currently processing</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-cvis1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Entry point <a href="/source/all/the_sentinel_c.html#cvis1">cvis1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-checkobjvisibility">CheckObjVisibility</a> (category: Drawing objects)</div><div class="summary">Contains an RTS</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-divi1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#divi1">divi1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-divideby16">DivideBy16</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj1">dobj1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj2">dobj2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj3">dobj3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj4">dobj4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj5">dobj5</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj6">dobj6</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dobj7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dobj7">dobj7</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-drainobjectenergy">DrainObjectEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dran1">dran1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-findobjecttodrain">FindObjectToDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dran2">dran2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-findobjecttodrain">FindObjectToDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dran3">dran3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-findobjecttodrain">FindObjectToDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dran4">dran4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-findobjecttodrain">FindObjectToDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dren1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dren1">dren1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-expendenemyenergy">ExpendEnemyEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dren2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#dren2">dren2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-expendenemyenergy">ExpendEnemyEnergy</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-edgegazedistance"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#edgegazedistance">edgeGazeDistance</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The fractional distance along a tile edge that matches the current position along the gaze vector</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-egaz1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#egaz1">egaz1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-checkenemygaze-part-2-of-2">CheckEnemyGaze (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-egaz2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#egaz2">egaz2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-checkenemygaze-part-2-of-2">CheckEnemyGaze (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-egaz3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#egaz3">egaz3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-checkenemygaze-part-2-of-2">CheckEnemyGaze (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-egaz4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#egaz4">egaz4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-checkenemygaze-part-2-of-2">CheckEnemyGaze (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemycheckingrobot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemycheckingrobot">enemyCheckingRobot</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to pass to the FollowGazeVector routine, with bit 7 set if the routine is being called when an enemy is checking to see if it can see a robot object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemydraintimer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemydraintimer">enemyDrainTimer</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A timer for each enemy that counts down every 0.06</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyenergy"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemyenergy">enemyEnergy</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Enemy energy levels (one byte per enemy)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyfailcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemyfailcounter">enemyFailCounter</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Enemy failed to find meanie: counter (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyfailtarget"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemyfailtarget">enemyFailTarget</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Enemy failed to find meanie: target object (one byte</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemymeaniescan"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemymeaniescan">enemyMeanieScan</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Enemy meanie scan object counter (one byte per enemy)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemymeanietree"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemymeanietree">enemyMeanieTree</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Enemy has turned a tree into a meanie (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#enemyobject">enemyObject</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The object number of the enemy to which we are applying tactics in this iteration around the main loop (0-7)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemytarget"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemytarget">enemyTarget</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The object number of the enemy's target (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyviewingarc"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemyviewingarc">enemyViewingArc</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The viewing arc of the enemy that is being processed in the ApplyTactics routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#enemyvisibility">enemyVisibility</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Visibility of the enemy's target (one byte per enemy)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gameplaystack"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#gameplaystack">gameplayStack</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The value of the stack pointer at the start of the ApplyEnemyTactics routine, so we can return back to the ProcessGameplay routine from deep within the tactics routines if required</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze1">gaze1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-1-of-5">FollowGazeVector (Part 1 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze10">gaze10</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-4-of-5">FollowGazeVector (Part 4 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze11">gaze11</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-4-of-5">FollowGazeVector (Part 4 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze12">gaze12</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-4-of-5">FollowGazeVector (Part 4 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze13"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze13">gaze13</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-5-of-5">FollowGazeVector (Part 5 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze14"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze14">gaze14</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-5-of-5">FollowGazeVector (Part 5 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze15"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze15">gaze15</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-5-of-5">FollowGazeVector (Part 5 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze16">gaze16</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-5-of-5">FollowGazeVector (Part 5 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze17"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze17">gaze17</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-5-of-5">FollowGazeVector (Part 5 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze2">gaze2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-1-of-5">FollowGazeVector (Part 1 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze3">gaze3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-1-of-5">FollowGazeVector (Part 1 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze4">gaze4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-1-of-5">FollowGazeVector (Part 1 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze5">gaze5</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-2-of-5">FollowGazeVector (Part 2 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze6">gaze6</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-2-of-5">FollowGazeVector (Part 2 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze7">gaze7</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-3-of-5">FollowGazeVector (Part 3 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze8">gaze8</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-4-of-5">FollowGazeVector (Part 4 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#gaze9">gaze9</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-4-of-5">FollowGazeVector (Part 4 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gazecanseetree"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#gazecanseetree">gazeCanSeeTree</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record whether the gaze vector can see a tree</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gazecheckcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#gazecheckcounter">gazeCheckCounter</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">A counter for the number of checks that are performed when following an enemy's gaze in CheckEnemyGaze</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-keypress"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#keypress">keyPress</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The key logger value for a key press</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-landscapenumberhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#landscapenumberhi">landscapeNumberHi</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The high byte of the four-digit binary coded decimal landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-landscapenumberlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#landscapenumberlo">landscapeNumberLo</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The low byte of the four-digit binary coded decimal landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#mean1">mean1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-scanformeanietree">ScanForMeanieTree</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#mean2">mean2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-scanformeanietree">ScanForMeanieTree</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#mean3">mean3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-scanformeanietree">ScanForMeanieTree</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#mean4">mean4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-scanformeanietree">ScanForMeanieTree</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#mean5">mean5</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-scanformeanietree">ScanForMeanieTree</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-minenemyaltitude"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#minenemyaltitude">minEnemyAltitude</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The altitude of the lowest enemy on the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-minobjwidth"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#minobjwidth">minObjWidth</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The on-screen width to use when updating objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objtypetoanalyse"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#objtypetoanalyse">objTypeToAnalyse</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The type of the object being analysed in the GetObjectAngles routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#objectflags">objectFlags</a> in workspace <a href="/source/all/workspaces.html#header-stack-variables">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectpitchangle"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#objectpitchangle">objectPitchAngle</a> in workspace <a href="/source/all/workspaces.html#header-stack-variables">Stack variables</a></div><div class="summary">The pitch angle for each object (i.e. the vertical direction in which they are facing)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objecttypes"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_a.html#header-objecttypes">objectTypes</a> (category: 3D objects)</div><div class="summary">The object types table for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectviewyawhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#objectviewyawhi">objectViewYawHi</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The yaw angle of the object being analysed, relative to the current viewer (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectyawangle"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_a.html#header-objectyawangle">objectYawAngle</a> (category: 3D objects)</div><div class="summary">The yaw angle for each object (i.e. the horizontal direction in which they are facing)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pdra1">pdra1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-getplayerdrain">GetPlayerDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pdra2">pdra2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-getplayerdrain">GetPlayerDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pdra3">pdra3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-getplayerdrain">GetPlayerDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pdra4">pdra4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-getplayerdrain">GetPlayerDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pdra5">pdra5</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-getplayerdrain">GetPlayerDrain</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey1">pkey1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-1-of-2">ProcessActionKeys (Part 1 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey10">pkey10</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey11">pkey11</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey12">pkey12</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey13"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey13">pkey13</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey14"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey14">pkey14</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey2">pkey2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-1-of-2">ProcessActionKeys (Part 1 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey3">pkey3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-1-of-2">ProcessActionKeys (Part 1 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey4">pkey4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey5">pkey5</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey6">pkey6</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey7">pkey7</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey8">pkey8</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pkey9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#pkey9">pkey9</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-processactionkeys-part-2-of-2">ProcessActionKeys (Part 2 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playerenergy"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#playerenergy">playerEnergy</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The player's energy level (in the range 0 to 63)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playerhasmovedtile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#playerhasmovedtile">playerHasMovedTile</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record whether the player has moved to a new tile by transferring or hyperspacing, so we can decide whether to regenerate the player's landscape view</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playerisontower"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#playerisontower">playerIsOnTower</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record whether the player is on top of the the Sentinel's tower</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playerobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#playerobject">playerObject</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The number of the player object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playertileishidden"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#playertileishidden">playerTileIsHidden</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag that records when the player is being scanned but the player's tile is hidden from the Sentinel or sentry doing the scan</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ptow1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#ptow1">ptow1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-setplayerisontower">SetPlayerIsOnTower</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ptow2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#ptow2">ptow2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-setplayerisontower">SetPlayerIsOnTower</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-samepankeypress"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#samepankeypress">samePanKeyPress</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Records whether the same pan key is being held down after we have just finished panning the landscape view</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scannerupdate"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#scannerupdate">scannerUpdate</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to control whether the scanner gets updated</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sentinelhaswon"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#sentinelhaswon">sentinelHasWon</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record when the player runs out of energy (i.e. the energy level goes negative), at which point the Sentinel wins</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sinanglehi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#sinanglehi">sinAngleHi</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The high byte of the sine of a pitch or yaw angle, as calculated by the GetRotationMatrix routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sinanglelo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#sinanglelo">sinAngleLo</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The low byte of the sine of a pitch or yaw angle, as calculated by the GetRotationMatrix routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sounddata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_i.html#header-sounddata">soundData</a> (category: Sound)</div><div class="summary">OSWORD blocks for making the various game sounds</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-soundeffect"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#soundeffect">soundEffect</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Determines how the current sound is processed by the ProcessSound routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-targetobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#targetobject">targetObject</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The number of the object that is being targeted in the DrainObjectEnergy routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-targetontile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#targetontile">targetOnTile</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record whether the tile being analysed in the GetTileAltitude routine contains the target object whose number is in targetObject</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-targetvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#targetvisibility">targetVisibility</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Reports whether a target object is visible from an enemy in the CheckEnemyGaze routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile1">tile1</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile2">tile2</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile3">tile3</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile4">tile4</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile5">tile5</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile6">tile6</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tile7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/all/the_sentinel_c.html#tile7">tile7</a> in subroutine <a href="/source/all/the_sentinel_c.html#header-gettilealtitude">GetTileAltitude</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tileedges"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_c.html#header-tileedges">tileEdges</a> (category: Landscape)</div><div class="summary">A table to map tile shapes and gaze vector direction to tile edges</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-titleobjecttodraw"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#titleobjecttodraw">titleObjectToDraw</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The object we are drawing in the DrawTitleView routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-treevisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#treevisibility">treeVisibility</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">Reports whether a gaze is interrupted by a tree in the CheckEnemyGaze routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-uturnstatus"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#uturnstatus">uTurnStatus</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">A flag to record whether we are performing or have just performed a U-turn</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-vectorpitchanglehi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#vectorpitchanglehi">vectorPitchAngleHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The pitch angle of a vector (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-vectorpitchanglelo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#vectorpitchanglelo">vectorPitchAngleLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The pitch angle of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-vectoryawanglehi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#vectoryawanglehi">vectorYawAngleHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The yaw angle of a vector (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-vectoryawanglelo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#vectoryawanglelo">vectorYawAngleLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The yaw angle of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-viewingobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#viewingobject">viewingObject</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The number of the viewing object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordbot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xcoordbot">xCoordBot</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The x-coordinate of an object or point (bottom byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xcoordhi">xCoordHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The x-coordinate of an object or point (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xcoordlo">xCoordLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The x-coordinate of an object or point (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xdeltalo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xdeltalo">xDeltaLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The difference between two x-coordinates (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_a.html#header-xobject">xObject</a> (category: 3D objects)</div><div class="summary">The x-coordinates in 3D space for the 3D objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xsights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#xsights">xSights</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The pixel x-coordinate of the sights on-screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xstoreenemygaze"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_c.html#header-xstoreenemygaze">xStoreEnemyGaze</a> (category: Gameplay)</div><div class="summary">Temporary storage for X so it can be preserved through calls to CheckEnemyGaze</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xtile">xTile</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Tile corner x-coordinate</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xvectorbot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xvectorbot">xVectorBot</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The x-coordinate of a vector (bottom byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xvectorlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#xvectorlo">xVectorLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The x-coordinate of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yaccuracylo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#yaccuracylo">yAccuracyLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The vertical accuracy for considering a tile as being seen by the viewer, as a fractional part</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ycoordhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#ycoordhi">yCoordHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The y-coordinate of an object or point (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ycoordlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#ycoordlo">yCoordLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The y-coordinate of an object or point (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ydeltahi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#ydeltahi">yDeltaHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The difference between two y-coordinates (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ydeltalo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#ydeltalo">yDeltaLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The difference between two y-coordinates (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yobjecthi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_a.html#header-yobjecthi">yObjectHi</a> (category: 3D objects)</div><div class="summary">The y-coordinates in 3D space for the 3D objects (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yobjectlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_a.html#header-yobjectlo">yObjectLo</a> (category: 3D objects)</div><div class="summary">The y-coordinates in 3D space for the 3D objects (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yplatformlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#yplatformlo">yPlatformLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The low byte of the altitude of the Sentinel's tower or boulder when returning tile data from the GetTileAltitude routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ysights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/the_sentinel_a.html#ysights">ySights</a> in workspace <a href="/source/all/the_sentinel_a.html#header-main-variable-workspace">Main variable workspace</a></div><div class="summary">The pixel y-coordinate of the sights on-screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yvectorbot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#yvectorbot">yVectorBot</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The y-coordinate of a vector (bottom byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yvectorlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#yvectorlo">yVectorLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The y-coordinate of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zcoordhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#zcoordhi">zCoordHi</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The z-coordinate of an object or point (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zcoordlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#zcoordlo">zCoordLo</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">The z-coordinate of an object or point (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/all/the_sentinel_a.html#header-zobject">zObject</a> (category: 3D objects)</div><div class="summary">The z-coordinates in 3D space for the 3D objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ztile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/all/workspaces.html#ztile">zTile</a> in workspace <a href="/source/all/workspaces.html#header-zero-page">Zero page</a></div><div class="summary">Tile corner z-coordinate</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/all/the_sentinel_b.html">The Sentinel B source</a><a class="next" rel="next" title="Next routine" href="/source/all/the_sentinel_d.html">The Sentinel D source</a></nav>
				</div>
			</article>

<?php
include_once("../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
