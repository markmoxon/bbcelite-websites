<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_the_landscape", "subroutine_drawlandscapeview_part_2_of_3.html", "The DrawLandscapeView (Part 2 of 3) subroutine", "Drawing the landscape: DrawLandscapeView (Part 2 of 3)", "Annotated code for the DrawLandscapeView (Part 2 of 3) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_the_landscape", "subroutine_drawlandscapeview_part_2_of_3", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drawlandscapeview_part_1_of_3.html">DrawLandscapeView (Part 1 of 3)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html">DrawLandscapeView (Part 3 of 3)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">DrawLandscapeView (Part 2 of 3)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing the landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Work through the landscape, drawing one row of tiles/objects at a</span>
             <span class="headerEntry">time, from the back row to the front row</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_e.html#header-drawlandscapeview-part-2-of-3">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.dlan4</span><a id="dlan4" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">31</span>                <span class="comment">\ We now iterate through all the tile rows, from back to</span>
 <span class="mne">STA</span> <a class="popup variable">zTile</a>              <span class="comment">\ front towards the viewer, so set a row counter in</span>
                        <span class="comment">\ zTile to iterate from 31 to 0</span>

 <span class="mne">LDA</span> <a class="popup variable">xTileLeftPrevious</a>  <span class="comment">\ Set xTileViewLeft = xTileLeftPrevious, so we start</span>
 <span class="mne">STA</span> <a class="popup variable">xTileViewLeft</a>      <span class="comment">\ checking for the view edges, starting from the left</span>
                        <span class="comment">\ edge from the previous calculation (or from tile zero</span>
                        <span class="comment">\ if this is the first time)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This makes the search for edges more efficient as the</span>
                        <span class="comment">\ edges in neighbouring rows will be close together</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set drawingTableOffset = 0 so the call to first call</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ GetTileViewEdges (for tile row 31) will populate the</span>
                        <span class="comment">\ tables at tileViewData+0, tileViewYaw+0 and</span>
                        <span class="comment">\ tileViewPitch+0 with the angles of the tile being</span>
                        <span class="comment">\ analysed</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewEdges</a>   <span class="comment">\ For the row of tile corners at the very back of the</span>
                        <span class="comment">\ landscape from the point of view of the viewer, work</span>
                        <span class="comment">\ out the edges of the visible portion of the row in</span>
                        <span class="comment">\ the current player view, as left to right tile</span>
                        <span class="comment">\ numbers in xTileViewLeft and xTileViewRight</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We don't draw this row as it doesn't have any tiles</span>
                        <span class="comment">\ anchored by the corners, but we generate the data so</span>
                        <span class="comment">\ we can use it when drawing the tile rows below</span>

 <span class="mne">LDA</span> <a class="popup variable">xTileViewLeft</a>      <span class="comment">\ Store the column number for the left edge of the</span>
 <span class="mne">STA</span> <a class="popup variable">xTileLeftPrevious</a>  <span class="comment">\ visible portion of the row in xTileLeftPrevious, so</span>
                        <span class="comment">\ we can refer to it above when we move on to the next</span>
                        <span class="comment">\ row in front</span>

                        <span class="comment">\ We now loop through each row of tile corners that has</span>
                        <span class="comment">\ a row of tiles anchored, drawing each row in turn,</span>
                        <span class="comment">\ from the back of the view to the front</span>

<span class="label">.dlan5</span><a id="dlan5" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ Flip drawingTableOffset between 0 and 32, so each call</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ to GetTileViewEdges and GetTileViewAngles alternates</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ between storing the tile view data in:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and storing it in:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * (drawViewYawHi+32 drawViewYawLo+32)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * (drawViewPitchHi+32 drawViewPitchLo+32)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData+32</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This lets us store tile view data for both the current</span>
                        <span class="comment">\ row that we are drawing and the previously drawn row</span>

 <span class="mne">LDA</span> <a class="popup variable">xTileViewLeft</a>      <span class="comment">\ Set xTileViewLeftEdge to the tile number of the left</span>
 <span class="mne">STA</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ edge of the visible portion of the row we are</span>
                        <span class="comment">\ analysing (i.e. zTile) so that we can generate results</span>
                        <span class="comment">\ for other rows without losing this information</span>

 <span class="mne">LDA</span> <a class="popup variable">xTileViewRight</a>     <span class="comment">\ Set xTileViewRightEdge to the tile number of the right</span>
 <span class="mne">STA</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ edge of the visible portion of the row we are</span>
                        <span class="comment">\ analysing (i.e. zTile) so that we can generate results</span>
                        <span class="comment">\ for other rows without losing this information</span>

 <span class="mne">JSR</span> <a class="popup destination">ProcessSound</a>       <span class="comment">\ Process any sounds or music that are being made in the</span>
                        <span class="comment">\ background</span>

 <span class="mne">DEC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Decrement zTile to the z-coordinate of the next tile</span>
                        <span class="comment">\ row forward, towards the viewer, so we can draw this</span>
                        <span class="comment">\ new row</span>

 <span class="mne">BMI</span> <a class="popup destination">dlan6</a>              <span class="comment">\ If we have already drawn all the rows from 31 to 0,</span>
                        <span class="comment">\ jump to dlan6 to return from the subroutine with the</span>
                        <span class="comment">\ C flag clear</span>

 <span class="mne">LDY</span> <a class="popup variable">zTile</a>              <span class="comment">\ If the new tile row is not the tile row that contains</span>
 <span class="mne">CPY</span> <a class="popup variable">zTileViewer</a>        <span class="comment">\ the viewer, jump to dlan7 to draw it</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan7</a>

 <span class="mne">JMP</span> <a class="popup destination">dlan18</a>             <span class="comment">\ The new tile row contains the viewer, so jump to</span>
                        <span class="comment">\ dlan18 to draw this row as a special case</span>

<span class="label">.dlan6</span><a id="dlan6" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that we have drawn the</span>
                        <span class="comment">\ whole landscape</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.dlan7</span><a id="dlan7" class="anchor"></a>

                        <span class="comment">\ We now check whether the new row, which we are about</span>
                        <span class="comment">\ to draw, has the same visible portion as the</span>
                        <span class="comment">\ previously drawn row, or if whether the new row's</span>
                        <span class="comment">\ visible portion extends beyond the previous visible</span>
                        <span class="comment">\ row or doesn't extend as far</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If the visible portions don't match, then we either</span>
                        <span class="comment">\ need to extend the tile data for the current row to</span>
                        <span class="comment">\ match, or we need to go back and extend the tile data</span>
                        <span class="comment">\ on the previous row to match the current row</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is so we can draw the tiles properly, as tiles</span>
                        <span class="comment">\ are made up of tiles from both the current and</span>
                        <span class="comment">\ previous rows of tile corners, so the calculate tile</span>
                        <span class="comment">\ view data needs to match between the two rows</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewEdges</a>   <span class="comment">\ For the new tile row, work out the edges of the</span>
                        <span class="comment">\ visible portion of the row in the current player view,</span>
                        <span class="comment">\ as left to right tile numbers in xTileViewLeft and</span>
                        <span class="comment">\ xTileViewRight</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewLeft</a>      <span class="comment">\ If xTileViewLeft = xTileViewLeftEdge then the left</span>
 <span class="mne">CPY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ edge of the visible row in this new row is at the same</span>
 <span class="mne">BEQ</span> <a class="popup destination">dlan11</a>             <span class="comment">\ place as in the previous row, so jump to dlan11 to</span>
                        <span class="comment">\ do the same check on the right edge</span>

 <span class="mne">BCC</span> <a class="popup destination">dlan9</a>              <span class="comment">\ If xTileViewLeft &lt; xTileViewLeftEdge then the left</span>
                        <span class="comment">\ edge of the visible row in this new row is less than</span>
                        <span class="comment">\ (i.e. to the left of) the edge in the previous row, so</span>
                        <span class="comment">\ jump to dlan9 to go back to the previous row to fetch</span>
                        <span class="comment">\ the tile data needed to make the datasets match</span>

                        <span class="comment">\ Otherwise xTileViewLeft > xTileViewLeftEdge and the</span>
                        <span class="comment">\ left edge of the visible row in this new row is</span>
                        <span class="comment">\ greater (i.e. to the right of) the edge in the</span>
                        <span class="comment">\ previous row, so we need to fetch more data on the</span>
                        <span class="comment">\ left end of the current row to make the datasets match</span>

<span class="label">.dlan8</span><a id="dlan8" class="anchor"></a>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement Y to move left along the row by one tile</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

 <span class="mne">CPY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ Loop back until we have moved left along the tile row</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan8</a>              <span class="comment">\ all the way to the left edge in the previous row</span>

 <span class="mne">BEQ</span> <a class="popup destination">dlan11</a>             <span class="comment">\ Jump to dlan11 to move on to the checks on the right</span>
                        <span class="comment">\ edge (this BEQ is effectively a JMP as we just passed</span>
                        <span class="comment">\ through a BNE)</span>

<span class="label">.dlan9</span><a id="dlan9" class="anchor"></a>

                        <span class="comment">\ If we get here then xTileViewLeft &lt; xTileViewLeftEdge,</span>
                        <span class="comment">\ so we need to go back to the previous row to fetch</span>
                        <span class="comment">\ more tile data for the left end of the row, so we can</span>
                        <span class="comment">\ use it to work out what to draw for the left end of</span>
                        <span class="comment">\ the new row we are trying to draw</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is because the visible part of the new row (the</span>
                        <span class="comment">\ row in front) is extending left beyond the left edge</span>
                        <span class="comment">\ of the visible part of the previous row (the one</span>
                        <span class="comment">\ behind), so we won't have calculated the required</span>
                        <span class="comment">\ tile data for the non-visible part of the previous</span>
                        <span class="comment">\ row</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we do that now by switching back to the previous</span>
                        <span class="comment">\ row and calculating all the tile data for the tiles on</span>
                        <span class="comment">\ the left of the previous row that have visible tiles</span>
                        <span class="comment">\ in front of them in the new row</span>

 <span class="mne">LDA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ Flip drawingTableOffset between 0 and 32, so the calls</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ to GetTileViewEdges and GetTileViewAngles store their</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ data into the storage area that we used for the</span>
                        <span class="comment">\ previous row, so we effectively extend the data to the</span>
                        <span class="comment">\ left for the previous row</span>

 <span class="mne">INC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Increment xTile to the tile row number behind the one</span>
                        <span class="comment">\ we are drawing, i.e. the previous row in this process</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ Set Y to the left edge for the previous row</span>

<span class="label">.dlan10</span><a id="dlan10" class="anchor"></a>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement Y to move left along the row by one tile</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

 <span class="mne">CPY</span> <a class="popup variable">xTileViewLeft</a>      <span class="comment">\ Loop back until we have moved left along the tile row</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan10</a>             <span class="comment">\ all the way to the left edge in the new row in front</span>

 <span class="mne">STY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ Update xTileViewLeftEdge to store the newly moved edge</span>
                        <span class="comment">\ for the previous row</span>

 <span class="mne">DEC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Decrement zTile once again to move back to the row</span>
                        <span class="comment">\ that we are drawing</span>

 <span class="mne">LDA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ Flip drawingTableOffset back again, so the calls</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ to GetTileViewEdges and GetTileViewAngles once again</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ store data in the new row's storage area</span>

<span class="label">.dlan11</span><a id="dlan11" class="anchor"></a>

                        <span class="comment">\ By this point we have checked the left edges of the</span>
                        <span class="comment">\ current and previous rows to fill in gaps in the tile</span>
                        <span class="comment">\ data caused by the new row overlapping the previous</span>
                        <span class="comment">\ row, and we now do the exact same thing for the right</span>
                        <span class="comment">\ edges</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewRight</a>     <span class="comment">\ If xTileViewRight = xTileViewRightEdge then the right</span>
 <span class="mne">CPY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ edge of the visible row in this new row is at the same</span>
 <span class="mne">BEQ</span> <a class="popup destination">dlan15</a>             <span class="comment">\ place as in the previous row, so jump to dlan15 to</span>
                        <span class="comment">\ draw the new row as we have all the tile information</span>
                        <span class="comment">\ we need</span>

 <span class="mne">BCS</span> <a class="popup destination">dlan13</a>             <span class="comment">\ If xTileViewRight > xTileViewRightEdge then the right</span>
                        <span class="comment">\ edge of the visible row in this new row is greater</span>
                        <span class="comment">\ then (i.e. to the right of) the edge in the previous</span>
                        <span class="comment">\ row, so jump to dlan13 to go back to the previous row</span>
                        <span class="comment">\ to fetch the tile data needed to make the datasets</span>
                        <span class="comment">\ match</span>

                        <span class="comment">\ Otherwise xTileViewRight &lt; xTileViewRightEdge and the</span>
                        <span class="comment">\ right edge of the visible row in this new row is less</span>
                        <span class="comment">\ than (i.e. to the left of) the edge in the previous</span>
                        <span class="comment">\ row, so we need to fetch more data on the right end of</span>
                        <span class="comment">\ the current row to make the datasets match</span>

<span class="label">.dlan12</span><a id="dlan12" class="anchor"></a>

 <span class="mne">INY</span>                    <span class="comment">\ Increment Y to move right along the row by one tile</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

 <span class="mne">CPY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ Loop back until we have moved right along the tile row</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan12</a>             <span class="comment">\ all the way to the right edge in the previous row</span>

 <span class="mne">BEQ</span> <a class="popup destination">dlan15</a>             <span class="comment">\ Jump to dlan15 to draw the new row as we have all the</span>
                        <span class="comment">\ tile information we need (this BEQ is effectively a</span>
                        <span class="comment">\ JMP as we just passed through a BNE)</span>

<span class="label">.dlan13</span><a id="dlan13" class="anchor"></a>

                        <span class="comment">\ If we get here, xTileViewRight > xTileViewRightEdge,</span>
                        <span class="comment">\ so we need to go back to the previous row to fetch</span>
                        <span class="comment">\ more tile data for the right end of the row, so we can</span>
                        <span class="comment">\ use it to work out what to draw for the right end of</span>
                        <span class="comment">\ the new row we are trying to draw</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is because the visible part of the new row (the</span>
                        <span class="comment">\ row in front) is extending right beyond the right edge</span>
                        <span class="comment">\ of the visible part of the previous row (the one</span>
                        <span class="comment">\ behind), so we won't have calculated the required</span>
                        <span class="comment">\ tile data for the non-visible part of the previous</span>
                        <span class="comment">\ row</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we do that now by switching back to the previous</span>
                        <span class="comment">\ row and calculating all the tile data for the tiles on</span>
                        <span class="comment">\ the right of the previous row that have visible tiles</span>
                        <span class="comment">\ in front of them in the new row</span>

 <span class="mne">LDA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ Flip drawingTableOffset between 0 and 32, so the calls</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ to GetTileViewEdges and GetTileViewAngles store their</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ data into the storage area that we used for the</span>
                        <span class="comment">\ previous row, so we effectively extend the data to the</span>
                        <span class="comment">\ left for the previous row</span>

 <span class="mne">INC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Increment xTile to the tile row number behind the one</span>
                        <span class="comment">\ we are drawing, i.e. the previous row in this process</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ Set Y to the right edge for the previous row</span>

<span class="label">.dlan14</span><a id="dlan14" class="anchor"></a>

 <span class="mne">INY</span>                    <span class="comment">\ Increment Y to move right along the row by one tile</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

 <span class="mne">CPY</span> <a class="popup variable">xTileViewRight</a>     <span class="comment">\ Loop back until we have moved right along the tile row</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan14</a>             <span class="comment">\ all the way to the right edge in the new row in front</span>

 <span class="mne">STY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ Update xTileViewRightEdge to store the newly moved</span>
                        <span class="comment">\ edge for the previous row</span>

 <span class="mne">DEC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Decrement zTile once again to move back to the row</span>
                        <span class="comment">\ that we are drawing</span>

 <span class="mne">LDA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ Flip drawingTableOffset back again, so the calls</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ to GetTileViewEdges and GetTileViewAngles once again</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ store data in the new row's storage area</span>

<span class="label">.dlan15</span><a id="dlan15" class="anchor"></a>

                        <span class="comment">\ By this point we have ensured that we have all the</span>
                        <span class="comment">\ tile data that we need to draw the new row</span>

 <span class="mne">JSR</span> <a class="popup destination">DrawLandscapeRow</a>   <span class="comment">\ Draw the tile row at z-coordinate zTile, between tiles</span>
                        <span class="comment">\ xTileViewLeftEdge and xTileViewRightEdge, including</span>
                        <span class="comment">\ any objects on any of the tiles</span>

 <span class="mne">BIT</span> <a class="popup variable">keepCheckingPanKey</a> <span class="comment">\ If bit 7 of keepCheckingPanKey is clear then we should</span>
 <span class="mne">BPL</span> <a class="popup destination">dlan16</a>             <span class="comment">\ keep drawing the landscape irrespective of whether the</span>
                        <span class="comment">\ pan key is still being pressed, so jump to dlan16 to</span>
                        <span class="comment">\ jump back to dlan5 to keep drawing the landscape</span>

                        <span class="comment">\ If we get here then we need to check whether the same</span>
                        <span class="comment">\ pan key is still being held down, and abort the</span>
                        <span class="comment">\ drawing process if it isn't (this happens if the</span>
                        <span class="comment">\ player initiates a pan, thus triggering this drawing</span>
                        <span class="comment">\ process, but releases the key before the drawing has</span>
                        <span class="comment">\ finished, in which case we don't need to finish off</span>
                        <span class="comment">\ drawing the landscape)</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckForSamePanKey</a> <span class="comment">\ Check to see whether the same pan key is being</span>
                        <span class="comment">\ held down compared to the last time we checked</span>

 <span class="mne">BNE</span> <a class="popup destination">dlan17</a>             <span class="comment">\ If the same pan key is not being held down, jump to</span>
                        <span class="comment">\ dlan17 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set to indicate that this is the case</span>

<span class="label">.dlan16</span><a id="dlan16" class="anchor"></a>

 <span class="mne">JMP</span> <a class="popup destination">dlan5</a>              <span class="comment">\ Loop back to dlan5 to analyse and draw the next tile</span>
                        <span class="comment">\ row forward, towards the viewer</span>

<span class="label">.dlan17</span><a id="dlan17" class="anchor"></a>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to indicate that we are aborting the</span>
                        <span class="comment">\ drawing of the landscape as the panning key is no</span>
                        <span class="comment">\ longer being held down</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkforsamepankey"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/checkforsamepankey.html">CheckForSamePanKey</a> (category: Keyboard)</div><div class="summary">Check to see whether the same pan key is being held down compared to the last time we checked</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawlandscaperow"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/drawlandscaperow.html">DrawLandscapeRow</a> (category: Drawing the landscape)</div><div class="summary">Draw a row of tiles between the left visible edge and the right visible, in two parts towards each side of the viewer</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettileviewangles"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/gettileviewangles_part_1_of_4.html">GetTileViewAngles (Part 1 of 4)</a> (category: Drawing the landscape)</div><div class="summary">Calculate the pitch and yaw angles for a tile corner, relative to a viewer object (e.g. the player), and whether it is on-screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettileviewedges"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/gettileviewedges.html">GetTileViewEdges</a> (category: Drawing the landscape)</div><div class="summary">For a given tile row, work out the edges of the visible portion of the row in the current player view, as left to right tile numbers</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-processsound"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/processsound.html">ProcessSound</a> (category: Sound)</div><div class="summary">Process any sound effects that have been configured so they play in the background (this is called regularly throughout gameplay)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan10">dlan10</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan11">dlan11</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan12">dlan12</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan13"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan13">dlan13</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan14"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan14">dlan14</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan15"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan15">dlan15</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan16">dlan16</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan17"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan17">dlan17</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan18"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html#dlan18">dlan18</a> in subroutine <a href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html">DrawLandscapeView (Part 3 of 3)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan5">dlan5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan6">dlan6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan7">dlan7</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan8">dlan8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html#dlan9">dlan9</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawingtableoffset"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawingtableoffset">drawingTableOffset</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to use within the various drawing data tables for the tile we are analysing</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-keepcheckingpankey"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#keepcheckingpankey">keepCheckingPanKey</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Controls whether the DrawLandscapeView routine aborts drawing if the pan key is released before it has finished</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileleftprevious"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#xtileleftprevious">xTileLeftPrevious</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The previous value of xTileViewLeft</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewleft"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewleft">xTileViewLeft</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile number at the left edge of the tile row we are currently processing when drawing the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewleftedge"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewleftedge">xTileViewLeftEdge</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile number at the left edge of the visible portion of the row we are currently processing when drawing the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewright"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewright">xTileViewRight</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile number at the right edge of the tile row we are currently processing when drawing the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewrightedge"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewrightedge">xTileViewRightEdge</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile number at the right edge of the visible portion of the row we are currently processing when drawing the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ztile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#ztile">zTile</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Tile corner z-coordinate</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ztileviewer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#ztileviewer">zTileViewer</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile z-coordinate of the viewer, but with the axes rotated to match the orientation of the viewer, so we can draw the landscape along the line of sight, towards the viewer's tile</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drawlandscapeview_part_1_of_3.html">DrawLandscapeView (Part 1 of 3)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html">DrawLandscapeView (Part 3 of 3)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
