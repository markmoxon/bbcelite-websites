<?php
include_once("../../../templates/template_functions.php");
page_header("maths_arithmetic", "subroutine_getnextseednumber.html", "The GetNextSeedNumber subroutine", "Maths (Arithmetic): GetNextSeedNumber", "Annotated code for the GetNextSeedNumber subroutine in The Sentinel", "the_sentinel-code", "source_maths_arithmetic", "subroutine_getnextseednumber", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/modifystoringcode.html">ModifyStoringCode</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/ystorenextseed.html">yStoreNextSeed</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetNextSeedNumber</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Arithmetic)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Set A to a seed number</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-getnextseednumber">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/addenemiestotiles.html">AddEnemiesToTiles</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/corruptsecretcode.html">CorruptSecretCode</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/generatelandscape.html">GenerateLandscape</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getenemycount.html">GetEnemyCount</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getnextseed0to22.html">GetNextSeed0To22</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getnextseed0to30.html">GetNextSeed0To30</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getnextseedasbcd.html">GetNextSeedAsBCD</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/moveontonextenemy.html">MoveOnToNextEnemy</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/placeobjectontile.html">PlaceObjectOnTile</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processsound.html">ProcessSound</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processtiledata.html">ProcessTileData</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/spawnsecretcode3d.html">SpawnSecretCode3D</a> calls <a href="#getnextseednumber">GetNextSeedNumber</a></span>
</div>
<hr class="light">
 Seed numbers in The Sentinel are produced using a five-byte (40-bit) linear
 feedback shift register (LFSR) with EOR feedback.

 Specifically, to generate a new seed number, we shift the LFSR left by eight
 places, and on each shift we insert the EOR of bits 19 and 32 into bit 0 of
 the register. After eight shifts, the top byte is our next seed number.

</div></div>
<span class="label">.GetNextSeedNumber</span><a id="getnextseednumber" class="anchor"></a>

 <span class="mne">STY</span> <a class="popup variable">yStoreNextSeed</a>     <span class="comment">\ Store Y in yStoreNextSeed so it can be preserved</span>
                        <span class="comment">\ across calls to the routine</span>

                        <span class="comment">\ We generate a new seed number by shifting the</span>
                        <span class="comment">\ five-byte linear feedback shift register in</span>
                        <span class="comment">\ seedNumberLFSR(4 3 2 1 0) by eight places, inserting</span>
                        <span class="comment">\ EOR feedback as we do so</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">8</span>                 <span class="comment">\ Set a shift counter in Y</span>

<span class="label">.rand1</span><a id="rand1" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">2</span>   <span class="comment">\ Apply EOR feedback to the linear feedback shift</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ register by taking the middle byte seedNumberLFSR+2,</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ shifting it right by three places, EOR'ing it with</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ seedNumberLFSR+4 in the output end of the shift</span>
 <span class="mne">EOR</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">4</span>   <span class="comment">\ register and rotating bit 0 of the result into the C</span>
 <span class="mne">ROR</span> <span class="register">A</span>                  <span class="comment">\ flag</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is the same as taking bit 3 of seedNumberLFSR+2</span>
                        <span class="comment">\ and EOR'ing it with bit 0 of seedNumberLFSR+4 into the</span>
                        <span class="comment">\ C flag</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now use the C flag as the next input bit into the</span>
                        <span class="comment">\ shift register</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this is the same as EOR'ing bits 19 and 32 of our</span>
                        <span class="comment">\ 40-bit register and shifting the result into bit 0 of</span>
                        <span class="comment">\ the register</span>

 <span class="mne">ROL</span> <a class="popup variable">seedNumberLFSR</a>     <span class="comment">\ Shift seedNumberLFSR(4 3 2 1 0) to the left by one</span>
 <span class="mne">ROL</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ place, inserting the C flag into bit 0 of the input</span>
 <span class="mne">ROL</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">2</span>   <span class="comment">\ end of the shift register in seedNumberLFSR</span>
 <span class="mne">ROL</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">3</span>
 <span class="mne">ROL</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">4</span>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the shift counter</span>

 <span class="mne">BNE</span> <a class="popup destination">rand1</a>              <span class="comment">\ Loop back until we have shifted eight times</span>

 <span class="mne">LDY</span> <a class="popup variable">yStoreNextSeed</a>     <span class="comment">\ Restore the value of Y from yStoreNextSeed that we</span>
                        <span class="comment">\ stored at the start of the routine, so that it's</span>
                        <span class="comment">\ preserved</span>

 <span class="mne">LDA</span> <a class="popup variable">seedNumberLFSR</a><span class="operator">+</span><span class="decimal">4</span>   <span class="comment">\ Set A to the output end of the shift register in</span>
                        <span class="comment">\ seedNumberLFSR+4 to give us our next seed number</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rand1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getnextseednumber.html#rand1">rand1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-seednumberlfsr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#seednumberlfsr">seedNumberLFSR</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A five-byte linear feedback shift register for</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ystorenextseed"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/ystorenextseed.html">yStoreNextSeed</a> (category: Maths (Arithmetic))</div><div class="summary">Temporary storage for Y so it can be preserved through calls to GetNextSeedNumber</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/modifystoringcode.html">ModifyStoringCode</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/ystorenextseed.html">yStoreNextSeed</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
