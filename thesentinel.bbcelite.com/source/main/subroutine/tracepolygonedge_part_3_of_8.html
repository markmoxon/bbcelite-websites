<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_polygons", "subroutine_tracepolygonedge_part_3_of_8.html", "The TracePolygonEdge (Part 3 of 8) subroutine", "Drawing polygons: TracePolygonEdge (Part 3 of 8)", "Annotated code for the TracePolygonEdge (Part 3 of 8) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_polygons", "subroutine_tracepolygonedge_part_3_of_8", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html">TracePolygonEdge (Part 2 of 8)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/tracepolygonedge_part_4_of_8.html">TracePolygonEdge (Part 4 of 8)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">TracePolygonEdge (Part 3 of 8)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing polygons</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Trace a polygon edge with a shallow gradient by stepping along the</span>
             <span class="headerEntry">x-axis</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-tracepolygonedge-part-3-of-8">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.tred18</span><a id="tred18" class="anchor"></a>

                        <span class="comment">\ If we get here then xEdgeDelta >= yEdgeDeltaLo, so the</span>
                        <span class="comment">\ x-axis delta is the biggest and the polygon edge has a</span>
                        <span class="comment">\ shallow gradient</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We therefore step along the x-axis one pixel at a time</span>
                        <span class="comment">\ and cumulatively add the gradient to calculate the</span>
                        <span class="comment">\ y-coordinate at each step</span>

 <span class="mne">STA</span> <a class="popup variable">tred24</a><span class="operator">+</span><span class="decimal">2</span>           <span class="comment">\ Modify the instruction at tred24 to use the address in</span>
 <span class="mne">STY</span> <a class="popup variable">tred24</a><span class="operator">+</span><span class="decimal">1</span>           <span class="comment">\ (A Y), so it becomes:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   STX into address (xPolygonAddrHi yEdgeStartLo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ xPolygonAddrHi is set to the high byte of either</span>
                        <span class="comment">\ xPolygonLeft or xPolygonRight, and both of these</span>
                        <span class="comment">\ tables start on a page boundary, so this sets the</span>
                        <span class="comment">\ address to offset yEdgeStartLo within the table</span>
                        <span class="comment">\ specified by xPolygonAddrHi</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We will decrement this address when we need to step</span>
                        <span class="comment">\ along the y-axis, according to the cumulative value of</span>
                        <span class="comment">\ the slope error</span>

 <span class="mne">STX</span> <a class="popup variable">tred22</a>             <span class="comment">\ Modify the instruction at tred12 to use the opcode</span>
                        <span class="comment">\ specified in X, so we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * DEX when xEdgeStartLo - xEdgeEndLo is positive</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * INX when xEdgeStartLo - xEdgeEndLo is negative</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We store the x-coordinate in X, so this ensures that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * We step left when required with DEX, for when the</span>
                        <span class="comment">\     start point is to the right of the end point</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * We step right when required with INX, for when the</span>
                        <span class="comment">\     start point is to the left of the end point</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We will run this instruction for each step along the</span>
                        <span class="comment">\ edge, so we step along the x-axis as we trace the edge</span>

 <span class="mne">LDY</span> <span class="hash">#</span><a class="popup variable">tred24</a><span class="operator">-</span><a class="popup variable">tred23</a><span class="operator">-</span><span class="decimal">2</span>   <span class="comment">\ Set Y to the operand required to modify the BCC</span>
                        <span class="comment">\ instruction at tred23 to the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   BCC tred24</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="operator">HI</span><span class="bracket">(</span><a class="popup variable">xPolygonLeft</a><span class="bracket">)</span>  <span class="comment">\ If we are tracing a left edge of the polygon, jump to</span>
 <span class="mne">BEQ</span> <a class="popup destination">tred19</a>             <span class="comment">\ tred19</span>

                        <span class="comment">\ If we get here then we are tracing a right edge of the</span>
                        <span class="comment">\ polygon</span>

 <span class="mne">CPX</span> <span class="hash">#</span><span class="hex">&CA</span>               <span class="comment">\ If we are going to be stepping along the x-axis with a</span>
 <span class="mne">BEQ</span> <a class="popup destination">tred20</a>             <span class="comment">\ DEX instruction (opcode &DA), jump to tred20 so we can</span>
                        <span class="comment">\ modify the instruction at tred23 to BCC tred25</span>

 <span class="mne">BNE</span> <a class="popup destination">tred21</a>             <span class="comment">\ Otherwise we are going to be stepping along the x-axis</span>
                        <span class="comment">\ with an INX instruction, so jump to tred21 to modify</span>
                        <span class="comment">\ the instruction at tred23 to BCC tred24 (this BNE is</span>
                        <span class="comment">\ effectively a JMP as we just passed through a BEQ)</span>

<span class="label">.tred19</span><a id="tred19" class="anchor"></a>

                        <span class="comment">\ If we get here then we are tracing a left edge of the</span>
                        <span class="comment">\ polygon</span>

 <span class="mne">CPX</span> <span class="hash">#</span><span class="hex">&CA</span>               <span class="comment">\ If we are going to be stepping along the x-axis with a</span>
 <span class="mne">BEQ</span> <a class="popup destination">tred21</a>             <span class="comment">\ DEX instruction (opcode &DA), jump to tred21 so we can</span>
                        <span class="comment">\ modify the instruction at tred23 to BCC tred24</span>

<span class="label">.tred20</span><a id="tred20" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><a class="popup variable">tred25</a><span class="operator">-</span><a class="popup variable">tred23</a><span class="operator">-</span><span class="decimal">2</span>   <span class="comment">\ Set Y to the operand required to modify the BCC</span>
                        <span class="comment">\ instruction at tred23 to the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   BCC tred25</span>

<span class="label">.tred21</span><a id="tred21" class="anchor"></a>

 <span class="mne">STY</span> <a class="popup variable">tred23</a><span class="operator">+</span><span class="decimal">1</span>           <span class="comment">\ Modify the instruction at tred23 to use the operand</span>
                        <span class="comment">\ specified in Y, so we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * BCC tred24 when we are tracing a right edge and</span>
                        <span class="comment">\     stepping along the x-axis with INX or a left edge</span>
                        <span class="comment">\     and stepping along with DEX</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * BCC tred25 when we are tracing a right edge and</span>
                        <span class="comment">\     stepping along the x-axis with DEX or a left edge</span>
                        <span class="comment">\     and stepping along with INX</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This ensures that we store the x-coordinate of the</span>
                        <span class="comment">\ outermost pixel along the edge for each horizontal</span>
                        <span class="comment">\ polygon line (see tred23 below for details)</span>

 <span class="mne">LDY</span> <a class="popup variable">xEdgeDelta</a>         <span class="comment">\ Set Y = xEdgeDelta + 1</span>
 <span class="mne">INY</span>                    <span class="comment">\</span>
                        <span class="comment">\ We can use this as a pixel counter when stepping along</span>
                        <span class="comment">\ the polygon edge's x-axis delta one pixel at a time,</span>
                        <span class="comment">\ as there are xEdgeDelta + 1 pixels along the edge</span>
                        <span class="comment">\ (the additional one ensures we include the pixels at</span>
                        <span class="comment">\ both ends)</span>

 <span class="mne">LDA</span> <a class="popup variable">xEdgeDelta</a>         <span class="comment">\ Set A = ~(xEdgeDelta / 2)</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ We use A to keep track of the slope error ???</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag so the first addition we do in the</span>
                        <span class="comment">\ following loop will work correctly</span>

                        <span class="comment">\ We already ensured in part 1 that yEdgeStart(Hi Lo)</span>
                        <span class="comment">\ is positive, so the following check only matches</span>
                        <span class="comment">\ yEdgeStartHi when it's in the range 1 to 127</span>

 <span class="mne">LDX</span> <a class="popup variable">yEdgeStartHi</a>       <span class="comment">\ If 0 &lt; yEdgeStartHi &lt; 128 then the start point is</span>
 <span class="mne">BNE</span> <a class="popup destination">tred31</a>             <span class="comment">\ beyond the top of the screen, so jump to part 5 to</span>
                        <span class="comment">\ trace the edge from the start until it reaches the</span>
                        <span class="comment">\ screen, but without storing the results</span>
                        <span class="comment">\</span>
                        <span class="comment">\ When the tracing reaches the top of the screen, part 4</span>
                        <span class="comment">\ will jump into the loop below at tred14 to continue</span>
                        <span class="comment">\ the normal tracing process</span>

 <span class="mne">LDX</span> <a class="popup variable">xEdgeStartLo</a>       <span class="comment">\ Set X to the x-coordinate of the starting point, so we</span>
                        <span class="comment">\ can start tracing from the start of the edge</span>

 <span class="mne">JMP</span> <a class="popup destination">tred24</a>             <span class="comment">\ Jump into the middle of the loop at tred24</span>

<span class="label">.tred22</span><a id="tred22" class="anchor"></a>

 <span class="mne">DEX</span>                    <span class="comment">\ This instruction is modified above to:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * INX (if we are stepping right along the x-axis)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * DEX (if we are stepping left along the x-axis)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So in either case this steps us along the x-axis by</span>
                        <span class="comment">\ one pixel</span>

 <span class="mne">ADC</span> <a class="popup variable">yEdgeDeltaLo</a>       <span class="comment">\ Add the y-axis delta to the slope error in A, so we</span>
                        <span class="comment">\ keep track of the slope error as we move along the</span>
                        <span class="comment">\ x-axis</span>

<span class="label">.tred23</span><a id="tred23" class="anchor"></a>

 <span class="mne">BCC</span> <a class="popup destination">tred25</a>             <span class="comment">\ This instruction is modified above to:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * BCC tred24 when we are tracing a right edge with</span>
                        <span class="comment">\     INX or a left edge with DEX</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * BCC tred25 when we are tracing a right edge with</span>
                        <span class="comment">\     DEX or a left edge with INX</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So if the addition didn't overflow then we have not</span>
                        <span class="comment">\ moved into a new y-coordinate with this step along the</span>
                        <span class="comment">\ x-axis, so jump to tred24 or tred25 so we do not move</span>
                        <span class="comment">\ along the y-axis</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The difference in the two branches is as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * BCC tred24 stores the coordinate</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * BCC tred25 does not store the coordinate</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So when we are tracing a right edge with DEX and we</span>
                        <span class="comment">\ are moving left along the x-axis, then we only</span>
                        <span class="comment">\ update the coordinate when the slope error overflows,</span>
                        <span class="comment">\ so we store the x-coordinate for the rightmost pixel</span>
                        <span class="comment">\ there is more than one pixel along the x-axis for this</span>
                        <span class="comment">\ step (so we store the rightmost pixels from the edge,</span>
                        <span class="comment">\ which is what we want)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The same is true when we are tracing a left edge with</span>
                        <span class="comment">\ INX and we are moving right along the x-axis, but in</span>
                        <span class="comment">\ this case we store the x-coordinate for the leftmost</span>
                        <span class="comment">\ pixel for each step (so we store the leftmost pixels</span>
                        <span class="comment">\ from this edge, which is what we want)</span>

 <span class="mne">SBC</span> <a class="popup variable">xEdgeDelta</a>         <span class="comment">\ Set A = A - xEdgeDelta ???</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This subtraction works as we just passed through a</span>
                        <span class="comment">\ BCC, so we know the C flag is set</span>

 <span class="mne">DEC</span> <a class="popup variable">tred24</a><span class="operator">+</span><span class="decimal">1</span>           <span class="comment">\ Decrement the low byte of the address in the</span>
                        <span class="comment">\ instruction below so that it points to the table</span>
                        <span class="comment">\ entry for the next y-coordinate down</span>

 <span class="mne">BEQ</span> <a class="popup destination">tred17</a>             <span class="comment">\ If we just decremented the low byte of the address to</span>
                        <span class="comment">\ zero then we have finished stepping along the y-axis,</span>
                        <span class="comment">\ so jump to tred17 in part 2 to finish off</span>

<span class="label">.tred24</span><a id="tred24" class="anchor"></a>

 <span class="mne">STX</span> <a class="popup variable">xPolygonRight</a><span class="operator">+</span><span class="hex">&9E</span>  <span class="comment">\ This instruction is modified above to the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   STX into address (xPolygonAddrHi yEdgeStartLo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this stores the current x-coordinate as we step</span>
                        <span class="comment">\ along the edge, storing the coordinate in either the</span>
                        <span class="comment">\ xPolygonRight or xPolygonLeft table, and storing the</span>
                        <span class="comment">\ coordinate in the offset given by the y-coordinate</span>
                        <span class="comment">\ of the current position along the edge we are tracing</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The original value of xPolygonRight+&9E is just</span>
                        <span class="comment">\ workspace noise and has no meaning, as it is modified</span>
                        <span class="comment">\ before we get here</span>

<span class="label">.tred25</span><a id="tred25" class="anchor"></a>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the pixel counter in Y</span>

 <span class="mne">BNE</span> <a class="popup destination">tred22</a>             <span class="comment">\ Loop back to keep tracing the polygon edge until we</span>
                        <span class="comment">\ have worked our way through all the pixels along the</span>
                        <span class="comment">\ x-axis</span>

                        <span class="comment">\ If we get here then we have finished tracing the edge</span>
                        <span class="comment">\ and Y = 0, so we can now finish off by setting the</span>
                        <span class="comment">\ value of drawPolygon to zero so the polygon gets drawn</span>

 <span class="mne">JMP</span> <a class="popup destination">tred15</a>             <span class="comment">\ Jump to tred15 to set drawPolygon and return from the</span>
                        <span class="comment">\ subroutine (this BEQ is effectively a JMP as Y is</span>
                        <span class="comment">\ always zero)</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred15"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred15">tred15</a> in subroutine <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html">TracePolygonEdge (Part 2 of 8)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred17"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred17">tred17</a> in subroutine <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html">TracePolygonEdge (Part 2 of 8)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred19"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred19">tred19</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred20"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred20">tred20</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred21"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred21">tred21</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred22"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred22">tred22</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred23"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred23">tred23</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred24"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred24">tred24</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred25"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html#tred25">tred25</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred31"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_5_of_8.html#tred31">tred31</a> in subroutine <a href="/source/main/subroutine/tracepolygonedge_part_5_of_8.html">TracePolygonEdge (Part 5 of 8)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xedgedelta"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xedgedelta">xEdgeDelta</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The scaled and signed x-axis delta between two polygon points when tracing the polygon edges (single byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xedgestartlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xedgestartlo">xEdgeStartLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of the start point in the polygon edge being processed (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonleft"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xpolygonleft.html">xPolygonLeft</a> (category: Drawing polygons)</div><div class="summary">The pixel x-coordinate of the left edge of each pixel line in the polygon being drawn</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonright"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xpolygonright.html">xPolygonRight</a> (category: Drawing polygons)</div><div class="summary">The pixel x-coordinate of the right edge of each pixel line in the polygon being drawn</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yedgedeltalo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#yedgedeltalo">yEdgeDeltaLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The difference in pitch angle between two polygon points, i.e. the delta along the y-axis (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yedgestarthi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#yedgestarthi">yEdgeStartHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The y-coordinate of the start point in the polygon edge being processed (high byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html">TracePolygonEdge (Part 2 of 8)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/tracepolygonedge_part_4_of_8.html">TracePolygonEdge (Part 4 of 8)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
