<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_polygons", "subroutine_getpolygonlines_part_3_of_6.html", "The GetPolygonLines (Part 3 of 6) subroutine", "Drawing polygons: GetPolygonLines (Part 3 of 6)", "Annotated code for the GetPolygonLines (Part 3 of 6) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_polygons", "subroutine_getpolygonlines_part_3_of_6", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getpolygonlines_part_2_of_6.html">GetPolygonLines (Part 2 of 6)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getpolygonlines_part_4_of_6.html">GetPolygonLines (Part 4 of 6)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetPolygonLines (Part 3 of 6)</span>                           <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing polygons</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Convert all the polygon point yaw angles into pixel x-coordinates</span>
             <span class="headerEntry">(for larger yaw angles that convert into a 16-bit x-coordinate)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-getpolygonlines-part-3-of-6">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.gpol4</span><a id="gpol4" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%11000000</span>         <span class="comment">\ Set bit 6 of xPolygonPointScale to indicate that the</span>
 <span class="mne">STA</span> <a class="popup variable">xPolygonPointScale</a> <span class="comment">\ pixel x-coordinate of this polygon point needs to be</span>
                        <span class="comment">\ stored as a two-byte number</span>

 <span class="mne">LDY</span> <a class="popup variable">polygonEdgeCount</a>   <span class="comment">\ We now loop through all the points in the polygon, so</span>
                        <span class="comment">\ set Y to count through the number of edges in the</span>
                        <span class="comment">\ polygon that we are drawing (as that's also the number</span>
                        <span class="comment">\ of unique points in the polygon)</span>

<span class="label">.gpol5</span><a id="gpol5" class="anchor"></a>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">drawViewAngles</a><span class="bracket">)</span>,<span class="register">Y</span> <span class="comment">\ Set X to the offset within the drawing tables of the</span>
 <span class="mne">TAX</span>                    <span class="comment">\ Y-th point in the polygon</span>

 <span class="mne">LDA</span> <a class="popup variable">drawViewYawLo</a>,<span class="register">X</span>    <span class="comment">\ Set the following:</span>
 <span class="mne">CLC</span>                    <span class="comment">\</span>
 <span class="mne">ADC</span> <a class="popup variable">bufferOriginLo</a>     <span class="comment">\   (A T) = drawViewYaw(Hi Lo) + bufferOrigin(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">drawViewYawHi</a>,<span class="register">X</span>    <span class="comment">\ for the Y-th polygon point, so this adds the yaw angle</span>
 <span class="mne">ADC</span> <a class="popup variable">bufferOriginHi</a>     <span class="comment">\ offset in bufferOrigin(Hi Lo) to the polygon point</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The yaw angles in drawViewYaw(Hi Lo) are relative to</span>
                        <span class="comment">\ the origin in the centre of the screen (i.e. the</span>
                        <span class="comment">\ direction of the viewer's gaze), so this converts the</span>
                        <span class="comment">\ yaw angle from having the origin in the centre to</span>
                        <span class="comment">\ having the origin on the left edge of the buffer</span>

 <span class="mne">ASL</span> <a class="popup variable">T</a>                  <span class="comment">\ Set (A T) = (A T) * 8</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">ROL</span> <a class="popup variable">T</a>                  <span class="comment">\ So (A T) contains the yaw angle in pixels, which is</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\ the same as a pixel x-coordinate, with the integer</span>
 <span class="mne">ROL</span> <a class="popup variable">T</a>                  <span class="comment">\ part in A and the fractional part in T</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\</span>
                        <span class="comment">\ Also, the top three bits of the original A are in the</span>
                        <span class="comment">\ bottom two bits of T and the C flag, as all but the</span>
                        <span class="comment">\ first instruction are rotations rather than shifts</span>

 <span class="mne">STA</span> <a class="popup variable">xPolygonPointLo</a>,<span class="register">X</span>  <span class="comment">\ Store the pixel x-coordinate for the Y-th point of the</span>
                        <span class="comment">\ polygon in the xPolygonPointLo table, storing the</span>
                        <span class="comment">\ result at the offset given in the drawViewAngles table</span>
                        <span class="comment">\ (i.e. in the correct place for the polygon point</span>
                        <span class="comment">\ number in Y)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This stores the low byte of the two-byte value in</span>
                        <span class="comment">\ (A T) * 8, so now we calculate and store the high byte</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Rotate the C flag into bit 0 of T and put the result</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\ in A, so top three bits of the original A are now in</span>
                        <span class="comment">\ the bottom three bits of A</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000111</span>         <span class="comment">\ Clear all the other bits in A, so A just contains the</span>
                        <span class="comment">\ top three bits of the original A</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In other words, A now contains the overflow from the</span>
                        <span class="comment">\ left-shifted (A T), which spilled out into a third top</span>
                        <span class="comment">\ byte when the multiplication was applied</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%00000100</span>         <span class="comment">\ If bit 2 of A is set then bit 7 of the original A must</span>
 <span class="mne">BCC</span> <a class="popup destination">gpol6</a>              <span class="comment">\ have been set so the original yaw angle must have been</span>
 <span class="mne">ORA</span> <span class="hash">#</span><span class="binary">%11111000</span>         <span class="comment">\ negative, so set bits 3 to 7 of the top byte</span>

<span class="label">.gpol6</span><a id="gpol6" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">xPolygonPointHi</a>,<span class="register">X</span>  <span class="comment">\ Store the pixel x-coordinate for the Y-th point of the</span>
                        <span class="comment">\ polygon in the xPolygonPointHi table, storing the</span>
                        <span class="comment">\ result at the offset given in the drawViewAngles table</span>
                        <span class="comment">\ (i.e. in the correct place for the polygon point</span>
                        <span class="comment">\ number in Y)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This stores the high byte of the two-byte value in</span>
                        <span class="comment">\ (A T) * 8</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this calculation is for polygon points that have a</span>
                        <span class="comment">\ pixel x-coordinate greater than 255 (as recorded by</span>
                        <span class="comment">\ the set bit 6 in xPolygonPointScale)</span>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the point counter in Y</span>

 <span class="mne">BPL</span> <a class="popup destination">gpol5</a>              <span class="comment">\ Loop back until we have converted all the polygon</span>
                        <span class="comment">\ point yaw angles into pixel x-coordinates</span>

 <span class="mne">JMP</span> <a class="popup destination">gpol9</a>              <span class="comment">\ Jump to part 5 to continue analysing the polygon</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-bufferoriginhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#bufferoriginhi">bufferOriginHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to add to yaw angles for the current screen buffer to convert them from having the origin in the buffer centre to having the origin on the left edge of the buffer (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-bufferoriginlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#bufferoriginlo">bufferOriginLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to add to yaw angles for the current screen buffer to convert them from having the origin in the buffer centre to having the origin on the left edge of the buffer (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewangles"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawviewangles">drawViewAngles</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The address in drawViewAngles(1 0) of the pitch and yaw angles of the tile and polygon points that we are drawing in the landscape view</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewyawhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewyawhi.html">drawViewYawHi</a> (category: Drawing the landscape)</div><div class="summary">Storage for the yaw angles of tiles and object points for drawing the current landscape view (high bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewyawlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewyawlo.html">drawViewYawLo</a> (category: Drawing the landscape)</div><div class="summary">Storage for the yaw angles of tiles and object points for drawing the current landscape view (low bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gpol5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getpolygonlines_part_3_of_6.html#gpol5">gpol5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gpol6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getpolygonlines_part_3_of_6.html#gpol6">gpol6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gpol9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getpolygonlines_part_5_of_6.html#gpol9">gpol9</a> in subroutine <a href="/source/main/subroutine/getpolygonlines_part_5_of_6.html">GetPolygonLines (Part 5 of 6)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-polygonedgecount"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#polygonedgecount">polygonEdgeCount</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of sides in the polygon we are drawing, which is one less than the number of points in the polygon's point list (as the last point in the list is always a repeat of the first point)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonpointhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xpolygonpointhi.html">xPolygonPointHi</a> (category: Drawing polygons)</div><div class="summary">Pixel x-coordinates for all the points in the polygon that we are currently drawing (high bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonpointlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xpolygonpointlo.html">xPolygonPointLo</a> (category: Drawing polygons)</div><div class="summary">Pixel x-coordinates for all the points in the polygon that we are currently drawing (low bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonpointscale"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xpolygonpointscale">xPolygonPointScale</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A flag to record whether the pixel x-coordinate of the polygon points being processed fit into one or two bytes</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getpolygonlines_part_2_of_6.html">GetPolygonLines (Part 2 of 6)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getpolygonlines_part_4_of_6.html">GetPolygonLines (Part 4 of 6)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
