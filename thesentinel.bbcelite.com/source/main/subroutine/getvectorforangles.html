<?php
include_once("../../../templates/template_functions.php");
page_header("maths_geometry", "subroutine_getvectorforangles.html", "The GetVectorForAngles subroutine", "Maths (Geometry): GetVectorForAngles", "Annotated code for the GetVectorForAngles subroutine in The Sentinel", "the_sentinel-code", "source_maths_geometry", "subroutine_getvectorforangles", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getsightsvector.html">GetSightsVector</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/multiplycoords.html">MultiplyCoords</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetVectorForAngles</span>                                      <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Convert a vector from pitch and yaw angles into a 3D cartesian</span>
             <span class="headerEntry">vector</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-getvectorforangles">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkenemygaze_part_2_of_2.html">CheckEnemyGaze (Part 2 of 2)</a> calls <a href="#getvectorforangles">GetVectorForAngles</a></span>
</div>
<hr class="light">
 This routine uses the rotation matrix routine from Revs to convert a vector
 from a pair of pitch and yaw angles into a cartesian [x y z] vector.

 The pitch and yaw angles are 16-bit numbers as follows:

   vectorPitchAngle(Hi Lo)

   vectorYawAngle(Hi Lo)

 The same vector, but expressed as a cartesian vector, is calculated as
 follows:

   [ xVector(Lo Bot) ]
   [ yVector(Lo Bot) ]
   [ zVector(Lo Bot) ]

 The calculation is this:

   yVector = sinVectorPitchAngle / 16

   zVector = cosVectorPitchAngle * cosVectorYawAngle / 16

   xVector = cosVectorPitchAngle * sinVectorYawAngle / 16

</div></div>
<span class="label">.GetVectorForAngles</span><a id="getvectorforangles" class="anchor"></a>

                        <span class="comment">\ In the following commentary I am talking about the</span>
                        <span class="comment">\ vector from the player's eyes to the sights, as that</span>
                        <span class="comment">\ makes it easier to describe the various points, but</span>
                        <span class="comment">\ this routine can convert any vector into angles using</span>
                        <span class="comment">\ the same process</span>

                        <span class="comment">\ We start by converting the pitch angle of the vector</span>
                        <span class="comment">\ from the player's eyes to the sights into a cartesian</span>
                        <span class="comment">\ y-coordinate in the global 3D coordinate system, where</span>
                        <span class="comment">\ the y-axis is the up-down axis</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We store the resulting y-coordinate in the 16-bit</span>
                        <span class="comment">\ variable yVector(Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We calculate yVector by considering a triangle with</span>
                        <span class="comment">\ the sights vector as the hypotenuse, and we drop the</span>
                        <span class="comment">\ end point down onto the y = 0 plane (i.e. onto the</span>
                        <span class="comment">\ ground)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Consider the case where the player is looking up at an</span>
                        <span class="comment">\ angle of vectorPitchAngle, so the vector from the</span>
                        <span class="comment">\ player's eye to the sights is from the bottom-left to</span>
                        <span class="comment">\ the top-right in the following triangle:</span>
                        <span class="comment">\</span>
                        <span class="comment">\                                   sights</span>
                        <span class="comment">\                               _.-+             ^</span>
                        <span class="comment">\                           _.-´   |             |</span>
                        <span class="comment">\              vector   _.-´       |         y-axis (up)</span>
                        <span class="comment">\                   _.-´           |</span>
                        <span class="comment">\               _.-´               |  y</span>
                        <span class="comment">\           _.-´                   |</span>
                        <span class="comment">\        .-´ vectorPitchAngle      |</span>
                        <span class="comment">\   eye +--------------------------+</span>
                        <span class="comment">\                   p</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To make the calculations easier, let's say the length</span>
                        <span class="comment">\ of the vector is 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Trigonometry gives us the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sin(vectorPitchAngle) = opposite / hypotenuse</span>
                        <span class="comment">\                         = y / 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So the y-coordinate is given by:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   y = sin(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ which is what we calculate now</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Incidentally, the adjacent side p, which is the length</span>
                        <span class="comment">\ of the vector projected down onto the y = 0 plane, is</span>
                        <span class="comment">\ calculated in a similar way:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(vectorPitchAngle) = adjacent / hypotenuse</span>
                        <span class="comment">\                         = p / 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So p = cos(vectorPitchAngle), which we will use to</span>
                        <span class="comment">\ calculate the x- and z-coordinates of the vector later</span>

 <span class="mne">JSR</span> <a class="popup destination">GetRotationMatrix</a>  <span class="comment">\ This routine is taken from Revs, where it calculates a</span>
                        <span class="comment">\ rotation matrix from an angle</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We don't need a full rotation matrix here, but the</span>
                        <span class="comment">\ Revs routine calculates the values that we do need</span>
                        <span class="comment">\ here, specifically:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cosVectorPitchAngle = cos(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sinVectorPitchAngle = sin(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ These calculations return 16-bit sign-magnitude</span>
                        <span class="comment">\ numbers with the sign in bit 0, which the DivideBy16</span>
                        <span class="comment">\ routine converts into normal 16-bit signed numbers</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that because GetRotationMatrix is copied from</span>
                        <span class="comment">\ Revs, where we only ever rotate through the yaw angle,</span>
                        <span class="comment">\ the matrix values are actually returned in the various</span>
                        <span class="comment">\ yawAngle variables, but for simplicity let's pretend</span>
                        <span class="comment">\ they are returned as above</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set (A X) = cosVectorPitchAngle / 16</span>
 <span class="mne">JSR</span> <a class="popup destination">DivideBy16</a>

 <span class="mne">STA</span> <a class="popup variable">cosVectorPitchHi</a>   <span class="comment">\ Set cosVectorPitch(Hi Lo) = cosVectorPitchAngle / 16</span>
 <span class="mne">STX</span> <a class="popup variable">cosVectorPitchLo</a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set (A X) = sinVectorPitchAngle / 16</span>
 <span class="mne">JSR</span> <a class="popup destination">DivideBy16</a>

 <span class="mne">STA</span> <a class="popup variable">yVectorLo</a>          <span class="comment">\ Set yVector(Lo Bot) = sinVectorPitchAngle / 16</span>
 <span class="mne">STX</span> <a class="popup variable">yVectorBot</a>         <span class="comment">\</span>
                        <span class="comment">\ So we now have the y-coordinate of the sights vector</span>
                        <span class="comment">\ as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   y = sin(vectorPitchAngle)</span>

                        <span class="comment">\ Now we convert the yaw angle of the sights vector</span>
                        <span class="comment">\ into cartesian x- and z-coordinates, where the x-axis</span>
                        <span class="comment">\ is the left-right axis and the z-axis goes into the</span>
                        <span class="comment">\ screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We store the resulting x-coordinate in the 16-bit</span>
                        <span class="comment">\ variable xVector(Lo Bot) and the z-coordinate in</span>
                        <span class="comment">\ zVector(Lo Bot)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We calculate xVector and zVector by considering a</span>
                        <span class="comment">\ triangle on the y = 0 plane, so that's a triangle on</span>
                        <span class="comment">\ the ground</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The hypotenuse of this triangle is side p from the</span>
                        <span class="comment">\ first calculation, which is the sights vector</span>
                        <span class="comment">\ projected down onto the ground - the shadow from a</span>
                        <span class="comment">\ light source directly above, if you like</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The opposite and adjacent sides of this tringle will</span>
                        <span class="comment">\ give us the x- and z-coordinates of the vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To see this, consider the same vector as before, with</span>
                        <span class="comment">\ p as the vector projected down onto the ground, and</span>
                        <span class="comment">\ where the player is looking sideways at a yaw angle of</span>
                        <span class="comment">\ vectorYawAngle</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This gives us a triangle like this, when viewed from</span>
                        <span class="comment">\ above, so it's as if we are the light source directly</span>
                        <span class="comment">\ above the sights vector, projecting the vector down</span>
                        <span class="comment">\ onto p, and with the vector going from the top-left to</span>
                        <span class="comment">\ the bottom-right, and the sights end of the vector</span>
                        <span class="comment">\ higher than the eye end:</span>
                        <span class="comment">\</span>
                        <span class="comment">\                   z</span>
                        <span class="comment diff">\   eye +--------------------------+       z-axis --></span>
                        <span class="comment">\        `-._ vectorYawAngle       |       into screen</span>
                        <span class="comment">\            `-._                  |</span>
                        <span class="comment">\                `-._              | x</span>
                        <span class="comment">\                 p  `-._          |</span>
                        <span class="comment">\                        `-._      |        x-axis left</span>
                        <span class="comment">\                            `-._  |          to right</span>
                        <span class="comment">\                                `-+             |</span>
                        <span class="comment">\                                    sights      v</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Again, simple trigonometry gives us the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sin(vectorYawAngle) = opposite / hypotenuse</span>
                        <span class="comment">\                       = x / p</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   x = p * sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ And:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(vectorYawAngle) = adjacent / hypotenuse</span>
                        <span class="comment">\                       = z / p</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   z = p * cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We calculated above that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   p = cos(vectorPitchAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So substituting that into our result gives us:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   x = p * sin(vectorYawAngle)</span>
                        <span class="comment">\     = cos(vectorPitchAngle) * sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   z = p * cos(vectorYawAngle)</span>
                        <span class="comment">\     = cos(vectorPitchAngle) * cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ which is what we calculate now</span>

 <span class="mne">LDA</span> <a class="popup variable">vectorYawAngleLo</a>   <span class="comment">\ Set (A T) = vectorYawAngle(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>
 <span class="mne">LDA</span> <a class="popup variable">vectorYawAngleHi</a>

 <span class="mne">JSR</span> <a class="popup destination">GetRotationMatrix</a>  <span class="comment">\ Calculate the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cosVectorYawAngle = cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sinVectorYawAngle = sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Again these are returned as 16-bit sign-magnitude</span>
                        <span class="comment">\ numbers with the sign in bit 0, which the</span>
                        <span class="comment">\ MultiplyCoords converts into normal 16-bit signed</span>
                        <span class="comment">\ numbers</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Call MultiplyCoords with Y = 1 and X = 2 to calculate</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ the following:</span>
 <span class="mne">JSR</span> <a class="popup destination">MultiplyCoords</a>     <span class="comment">\</span>
                        <span class="comment">\   zVector(Lo Bot)</span>
                        <span class="comment">\       = cosVectorPitchAngle * cosVectorYawAngle / 16</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Zero X and Y and fall through into MultiplyCoords to</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ calculate the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   xVector(Lo Bot)</span>
                        <span class="comment">\        = cosVectorPitchAngle * sinVectorYawAngle / 16</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and return from the subroutine using a tail call</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-divideby16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/divideby16.html">DivideBy16</a> (category: Maths (Arithmetic))</div><div class="summary">Divide a 16-bit sign-magnitude number by 16</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getrotationmatrix"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/getrotationmatrix_part_1_of_5.html">GetRotationMatrix (Part 1 of 5)</a> (category: Maths (Geometry))</div><div class="summary">Calculate the rotation matrix for rotating the pitch or yaw angle for the sights into the global 3D coordinate system</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-multiplycoords"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/multiplycoords.html">MultiplyCoords</a> (category: Maths (Arithmetic))</div><div class="summary">Multiply a 16-bit signed number and a 16-bit sign-magnitude value</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-cosvectorpitchhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#cosvectorpitchhi">cosVectorPitchHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The high byte of cos(vectorPitchAngle) when converting pitch and yaw angles to cartesian vectors</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-cosvectorpitchlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#cosvectorpitchlo">cosVectorPitchLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The low byte of cos(vectorPitchAngle) when converting pitch and yaw angles to cartesian vectors</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-vectoryawanglehi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#vectoryawanglehi">vectorYawAngleHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The yaw angle of a vector (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-vectoryawanglelo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#vectoryawanglelo">vectorYawAngleLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The yaw angle of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yvectorbot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#yvectorbot">yVectorBot</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The y-coordinate of a vector (bottom byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yvectorlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#yvectorlo">yVectorLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The y-coordinate of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getsightsvector.html">GetSightsVector</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/multiplycoords.html">MultiplyCoords</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
