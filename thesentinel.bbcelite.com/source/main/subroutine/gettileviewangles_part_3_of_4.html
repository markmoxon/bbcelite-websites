<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_the_landscape", "subroutine_gettileviewangles_part_3_of_4.html", "The GetTileViewAngles (Part 3 of 4) subroutine", "Drawing the landscape: GetTileViewAngles (Part 3 of 4)", "Annotated code for the GetTileViewAngles (Part 3 of 4) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_the_landscape", "subroutine_gettileviewangles_part_3_of_4", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/gettileviewangles_part_2_of_4.html">GetTileViewAngles (Part 2 of 4)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/gettileviewangles_part_4_of_4.html">GetTileViewAngles (Part 4 of 4)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetTileViewAngles (Part 3 of 4)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing the landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate the pitch angle for the tile corner</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_e.html#header-gettileviewangles-part-3-of-4">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
                        <span class="comment">\ By this point, A contains the tile data for the tile</span>
                        <span class="comment">\ we are analysing and Y contains the index offset of</span>
                        <span class="comment">\ the tile data from tileDataPage(1 0)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%11000000</span>         <span class="comment">\ If both bits 6 and 7 are set in the tile data then the</span>
 <span class="mne">BCC</span> <a class="popup destination">tang8</a>              <span class="comment">\ tile we are analysing contains an object, in which</span>
                        <span class="comment">\ case keep going, otherwise there is no object on the</span>
                        <span class="comment">\ tile so jump to tang8</span>

<span class="label">.tang7</span><a id="tang7" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile we are analysing contains</span>
                        <span class="comment">\ an object and the tile data is in A</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">TAY</span>                    <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into Y (so</span>
                        <span class="comment">\ the tile effectively contains object #Y)</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the object flags for the object on the tile</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ If bit 6 of the object flags for object #Y is set</span>
 <span class="mne">BCS</span> <a class="popup destination">tang7</a>              <span class="comment">\ then object #Y is stacked on top of another object,</span>
                        <span class="comment">\ and that object number is in bits 0 to 5 of the object</span>
                        <span class="comment">\ flags, so jump to tang7 to extract that object number</span>
                        <span class="comment">\ from A and check the flags again (so this works down</span>
                        <span class="comment">\ through the stack of objects until we reach the object</span>
                        <span class="comment">\ at the bottom of the stack)</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectHi</a>,<span class="register">Y</span>        <span class="comment">\ At this point we have reached the object on the tile</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ itself, so set U to the y-coordinate of that object,</span>
                        <span class="comment">\ which will be the tile altitude, and return from the</span>
                        <span class="comment">\ subroutine with the C flag clear to denote a flat</span>
                        <span class="comment">\ tile, as objects are only ever placed on flat tiles</span>

 <span class="mne">JMP</span> <a class="popup destination">tang9</a>              <span class="comment">\ Jump to tang9 to keep going, leaving the tile's entry</span>
                        <span class="comment">\ in the tileViewData table alone (so it still contains</span>
                        <span class="comment">\ the tile data that we stored in part 2)</span>

<span class="label">.tang8</span><a id="tang8" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile we are analysing does not</span>
                        <span class="comment">\ contain an object and the tile data is in A, with Y</span>
                        <span class="comment">\ containing the index offset of the tile data from</span>
                        <span class="comment">\ tileDataPage(1 0)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ From part 2, we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * T = bits 0-1 of xTile</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Y = (xTile div 4) * &20 + zTile</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ The high nibble of the tile data contains the altitude</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ of the tile's anchor, so shift this into U</span>
 <span class="mne">LSR</span> <span class="register">A</span>
 <span class="mne">LSR</span> <span class="register">A</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>

                        <span class="comment">\ We now fetch the tile's visibility bit from the</span>
                        <span class="comment">\ tileVisibility table, using the reverse of the logic</span>
                        <span class="comment">\ in the GetTileVisibility routine for calculating the</span>
                        <span class="comment">\ address of the visibility bit</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Shift Y right by one place, so the C flag is set to</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ bit 0 of zTile (the row number), and Y contains the</span>
 <span class="mne">TAY</span>                    <span class="comment">\ following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bits 4 to 6 contain bits 2 to 4 of xTile (the</span>
                        <span class="comment">\     column number)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bits 0 to 3 contain bits 1 to 4 of zTile (the</span>
                        <span class="comment">\     row number)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This therefore gives us the offset in the visibility</span>
                        <span class="comment">\ table for the tile's visibility byte, as per the</span>
                        <span class="comment">\ GetTileVisibility routine</span>

 <span class="mne">ROL</span> <a class="popup variable">T</a>                  <span class="comment">\ In part 2 we set T to bits 0-1 of xTile (the column</span>
                        <span class="comment">\ number), so this sets T as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\    * Bit 0 contains bit 0 of the of the tile row in</span>
                        <span class="comment">\      zTile (via the C flag from above)</span>
                        <span class="comment">\</span>
                        <span class="comment">\    * Bits 1-2 contain bits 0-1 of the column number in</span>
                        <span class="comment">\      xTile</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This therefore gives us the bit number within the byte</span>
                        <span class="comment">\ in the visibility table for the tile's visibility, as</span>
                        <span class="comment">\ per the GetTileVisibility routine</span>

 <span class="mne">LDA</span> <a class="popup variable">tileVisibility</a>,<span class="register">Y</span>   <span class="comment">\ Set A to the visibility byte that contains the</span>
                        <span class="comment">\ visibility bit for this tile</span>

 <span class="mne">LDY</span> <a class="popup variable">T</a>                  <span class="comment">\ Fetch the Y-th bit from the visibility byte, which</span>
 <span class="mne">AND</span> <a class="popup variable">visibileBitMask</a>,<span class="register">Y</span>  <span class="comment">\ contains the specific visibility bit for this tile</span>

 <span class="mne">BNE</span> <a class="popup destination">tang9</a>              <span class="comment">\ If the visibility bit is set then A will be non-zero,</span>
                        <span class="comment">\ so skip the following instruction, leaving the entry</span>
                        <span class="comment">\ for this tile to contain the non-zero tile data that</span>
                        <span class="comment">\ we stored in tileViewData,X at the end of part 2</span>

 <span class="mne">STA</span> <a class="popup variable">tileViewData</a>,<span class="register">X</span>     <span class="comment">\ The visibility bit is zero, so zero the entry in the</span>
                        <span class="comment">\ tileViewData table for this tile (which otherwise</span>
                        <span class="comment">\ would contain the tile data that we set in part 2)</span>

<span class="label">.tang9</span><a id="tang9" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ Set X to the number of the object that is viewing the</span>
                        <span class="comment">\ landscape</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set (A xDeltaLo) = (U 0) - y-coordinate of object #X</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <a class="popup variable">yObjectLo</a>,<span class="register">X</span>        <span class="comment">\ We set U above to the altitude of the tile that we are</span>
 <span class="mne">STA</span> <a class="popup variable">xDeltaLo</a>           <span class="comment">\ analysing, so (A xDeltaLo) now contains the vertical</span>
 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ distance between the viewer and the tile we are</span>
 <span class="mne">SBC</span> <a class="popup variable">yObjectHi</a>,<span class="register">X</span>        <span class="comment">\ analysing, ready to pass to GetPitchAngleDelta</span>

 <span class="mne">JSR</span> <a class="popup destination">GetPitchAngleDelta</a> <span class="comment">\ Set pitchDelta(Hi Lo) to the pitch angle of the vector</span>
                        <span class="comment">\ relative to the viewer's pitch angle</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The vector in question has x- and z-axis elements from</span>
                        <span class="comment">\ part 1:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * xDelta(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * zDelta(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and we calculated the hypotenuse(Hi Lo) for this in</span>
                        <span class="comment">\ part 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The vector also has y-axis element of (A xDeltaLo),</span>
                        <span class="comment">\ which we just calculated</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this call calculates the relative pitch angle for</span>
                        <span class="comment">\ the vector between the viewer and the tile that we are</span>
                        <span class="comment">\ analysing, so store it in the correct entry in the</span>
                        <span class="comment">\ table at drawViewPitch(Hi Lo)</span>

 <span class="mne">LDY</span> <a class="popup variable">drawingTableIndex</a>  <span class="comment">\ Set Y to the drawing table index for this tile</span>

 <span class="mne">LDA</span> <a class="popup variable">pitchDeltaHi</a>       <span class="comment">\ Store the high byte of the pitch vector in the correct</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewPitchHi</a>,<span class="register">Y</span>  <span class="comment">\ part of the drawViewPitchHi table</span>

 <span class="mne">LDA</span> <a class="popup variable">pitchDeltaLo</a>       <span class="comment">\ Store the low byte of the pitch vector in the correct</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewPitchLo</a>,<span class="register">Y</span>  <span class="comment">\ part of the drawViewPitchLo table</span>

                        <span class="comment">\ Fall through into part 4 to work out how much of the</span>
                        <span class="comment">\ tile is on-screen</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getpitchangledelta"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/getpitchangledelta.html">GetPitchAngleDelta</a> (category: Maths (Geometry))</div><div class="summary">Calculate the pitch angle of a vector relative to an object's pitch angle</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-u"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#u">U</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewpitchhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewpitchhi.html">drawViewPitchHi</a> (category: Drawing the landscape)</div><div class="summary">Storage for the pitch angles of tiles and object points for drawing the current landscape view (high bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewpitchlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewpitchlo.html">drawViewPitchLo</a> (category: Drawing the landscape)</div><div class="summary">Storage for the pitch angles of tiles and object points for drawing the current landscape view (low bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawingtableindex"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawingtableindex">drawingTableIndex</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The index into the drawing tables for the tile being analysed</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pitchdeltahi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#pitchdeltahi">pitchDeltaHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The delta between two pitch angles (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pitchdeltalo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#pitchdeltalo">pitchDeltaLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The delta between two pitch angles (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tang7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/gettileviewangles_part_3_of_4.html#tang7">tang7</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tang8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/gettileviewangles_part_3_of_4.html#tang8">tang8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tang9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/gettileviewangles_part_3_of_4.html#tang9">tang9</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tileviewdata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#tileviewdata">tileViewData</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">The tile data for tiles in the current landscape view</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tilevisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/tilevisibility.html">tileVisibility</a> (category: Drawing the landscape)</div><div class="summary">A table for storing the visibility of each tile from the player's point of view, with one bit per tile (1 = visible, 0 = hidden)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-viewingobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#viewingobject">viewingObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the viewing object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-visibilebitmask"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/visibilebitmask.html">visibileBitMask</a> (category: Drawing the landscape)</div><div class="summary">A table for converting a number in the range 0 to 7 into a bit mask with only that bit set, when counting from the left</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xdeltalo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xdeltalo">xDeltaLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The difference between two x-coordinates (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yobjecthi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/yobjecthi.html">yObjectHi</a> (category: 3D objects)</div><div class="summary">The y-coordinates in 3D space for the 3D objects (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yobjectlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/yobjectlo.html">yObjectLo</a> (category: 3D objects)</div><div class="summary">The y-coordinates in 3D space for the 3D objects (low byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/gettileviewangles_part_2_of_4.html">GetTileViewAngles (Part 2 of 4)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/gettileviewangles_part_4_of_4.html">GetTileViewAngles (Part 4 of 4)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
