<?php
include_once("../../../templates/template_functions.php");
page_header("maths_geometry", "subroutine_followgazevector_part_4_of_5.html", "The FollowGazeVector (Part 4 of 5) subroutine", "Maths (Geometry): FollowGazeVector (Part 4 of 5)", "Annotated code for the FollowGazeVector (Part 4 of 5) subroutine in The Sentinel", "the_sentinel-code", "source_maths_geometry", "subroutine_followgazevector_part_4_of_5", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/followgazevector_part_3_of_5.html">FollowGazeVector (Part 3 of 5)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/followgazevector_part_5_of_5.html">FollowGazeVector (Part 5 of 5)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">FollowGazeVector (Part 4 of 5)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">For non-flat tiles with two horizontal edges, work out which tile</span>
             <span class="headerEntry">edge to use when checking for obstruction of the gaze vector</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-followgazevector-part-4-of-5">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.gaze8</span><a id="gaze8" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape in A is not 4 or 12</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It also isn't 0, as the tile is not flat, and it isn't</span>
                        <span class="comment">\ 8 either, as that shape number isn't used</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The tile shape is therefore one of the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   1, 2, 3, 5, 6, 7, 9, 10, 11, 13, 14, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ All of these shapes have two horizontal edges and two</span>
                        <span class="comment">\ sloping edges, so we now work out which of the sloping</span>
                        <span class="comment">\ edges we should use to check against the gaze vector</span>
                        <span class="comment">\ to see if the slope is obstructing the gaze</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We pass this information to part 5 as a single tile</span>
                        <span class="comment">\ corner number in A, which tells part 5 to use the edge</span>
                        <span class="comment">\ from corner A to corner A + 1 in the calculation</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To recap, we set the tile altitudes in part 2 like</span>
                        <span class="comment">\ this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      ^           [T]  [U]</span>
                        <span class="comment">\      |</span>
                        <span class="comment">\      |           [S]  [V]</span>
                        <span class="comment">\   z-axis</span>
                        <span class="comment">\    into</span>
                        <span class="comment diff">\   screen      x-axis from left to right ---></span>
                        <span class="comment">\</span>
                        <span class="comment">\ We can also number these corners so we can pass a</span>
                        <span class="comment">\ corner number to part 5, so let's number them like</span>
                        <span class="comment">\ this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\      [T]  [U]          [1]  [2]</span>
                        <span class="comment">\                   =</span>
                        <span class="comment">\      [S]  [V]          [0]  [3]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As mentioned above, when we pass a corner number in A</span>
                        <span class="comment">\ to part 5, this tells part 5 to use the edge from</span>
                        <span class="comment">\ corner A to corner A + 1 in the calculation, so if we</span>
                        <span class="comment">\ pass A = 0 to part 5, that will tell it to use the</span>
                        <span class="comment">\ left edge (from 0 to 1) in the calculation, while</span>
                        <span class="comment">\ passing A = 2 will make it use the right edge (from 2</span>
                        <span class="comment">\ to 3)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This part is therefore all about setting A to the</span>
                        <span class="comment">\ correct corner number for the edge that we want to use</span>
                        <span class="comment">\ in the gaze vector calculation</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We start by working out which two edges in the tile</span>
                        <span class="comment">\ shape are the sloping edges</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ If bit 0 of the shape number is clear, jump to gaze10</span>
 <span class="mne">BCC</span> <a class="popup destination">gaze10</a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxxx1 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   1, 3, 5, 7, 9, 11, 13, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 1</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ If bit 1 of the shape number is set, jump to gaze9</span>
 <span class="mne">BCS</span> <a class="popup destination">gaze9</a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxx01 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   1, 5, 9, 13</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 2 to give:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0, 1, 2, 3</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set A to bit 0 of A, which is bit 2 of the original</span>
                        <span class="comment">\ shape number, so:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 if the tile shape is 1 or 9</span>
                        <span class="comment">\           (i.e. %xxxxx001 in binary)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 if the tile shape is 5 or 13</span>
                        <span class="comment">\           (i.e. %xxxxx101 in binary)</span>

                        <span class="comment">\ At this point we have a suitable value of A to pass</span>
                        <span class="comment">\ to part 5, as we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 to denote the left edge for shapes 1 and 9</span>
                        <span class="comment">\</span>
                        <span class="comment">\                          0 0   or   1 1</span>
                        <span class="comment">\                          1 1        0 0</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 to denote the top edge for shapes 5 and 13</span>
                        <span class="comment">\</span>
                        <span class="comment">\                          1 0   or   0 1</span>
                        <span class="comment">\                          1 0        0 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As the sloping edges in these shapes have the exact</span>
                        <span class="comment">\ same slope gradient, either of them can be used in the</span>
                        <span class="comment">\ calculation</span>

 <span class="mne">JMP</span> <a class="popup destination">gaze13</a>             <span class="comment">\ Jump to gaze13 in part 5 to check the gaze vector</span>
                        <span class="comment">\ against the edge specified in A</span>

<span class="label">.gaze9</span><a id="gaze9" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxx11 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   3, 7, 11, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 2 to give:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0, 1, 2, 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and the C flag is set</span>

 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set A = (A + 2) mod 4, to give:</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\</span>
                        <span class="comment">\   2, 3, 0, 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The addition adds 2 because the C flag is set</span>

 <span class="mne">JMP</span> <a class="popup destination">gaze11</a>             <span class="comment">\ Jump to gaze11 to analyse this shape</span>

<span class="label">.gaze10</span><a id="gaze10" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape is one of the</span>
                        <span class="comment">\ following (i.e. %xxxxxxx0 in binary):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   2, 6, 10, 14</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 1</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Shift A right by one place, so the tile shape is one</span>
                        <span class="comment">\ of the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   2, 6, 10, 14</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains the shape >> 2 to give:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0, 1, 2, 3</span>

<span class="label">.gaze11</span><a id="gaze11" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile shape is one of:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   2, 3, 6, 7, 10, 11, 14, 15</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and A contains a number that tells us which two edges</span>
                        <span class="comment">\ are the sloping edges:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 0, the bottom and left edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 1, the top and left edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 2, the top and right edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If A = 3, the bottom and right edges slope</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We either jump here with:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 if the tile shape is 11     0 0     Bottom</span>
                        <span class="comment">\                                       1 0     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 if the tile shape is 15     0 1     Top</span>
                        <span class="comment">\                                       1 1     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 2 if the tile shape is 3      1 0     Top</span>
                        <span class="comment">\                                       1 1     Right</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 3 if the tile shape is 7      1 1     Bottom</span>
                        <span class="comment">\                                       1 0     Right</span>
                        <span class="comment">\</span>
                        <span class="comment">\ or we fall through from above with:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 0 if the tile shape is 2      1 1     Bottom</span>
                        <span class="comment">\                                       0 1     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 1 if the tile shape is 6      1 0     Top</span>
                        <span class="comment">\                                       0 0     Left</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 2 if the tile shape is 10     0 1     Top</span>
                        <span class="comment">\                                       0 0     Right</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = 3 if the tile shape is 14     0 0     Bottom</span>
                        <span class="comment">\                                       0 1     Right</span>

                        <span class="comment">\ The next step is to choose which of these sloping</span>
                        <span class="comment">\ edges is the closest to the current position along</span>
                        <span class="comment">\ the gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The tileEdges table helps us do this</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It is made up of two numbers for each pair of edges</span>
                        <span class="comment">\ represented by A; these are the corner numbers at the</span>
                        <span class="comment">\ start of each of the two edges in the pair, so for</span>
                        <span class="comment">\ each value of A, we need to choose one of the corner</span>
                        <span class="comment">\ numbers from the pair to pass to part 5</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We choose the correct value according to whether the</span>
                        <span class="comment">\ gaze vector is closer to the edge along the x-axis</span>
                        <span class="comment">\ or the z-axis</span>
                        <span class="comment">\</span>
                        <span class="comment">\ For example, consider tile shape 11, for which we will</span>
                        <span class="comment">\ will have A = 0 to denote that the bottom and left</span>
                        <span class="comment">\ edges are the sloping edges in this shape:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   0 0</span>
                        <span class="comment">\   1 0</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The tileEdges table contains 0 and 3 for this shape</span>
                        <span class="comment">\ (to denote the left and bottom edges respectively)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Zooming in on the tile, we have the following, where</span>
                        <span class="comment">\ [x] is the current position along the gaze vector when</span>
                        <span class="comment">\ looking at the tile from above:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [1]                 [2]</span>
                        <span class="comment">\    | xCoordLo</span>
                        <span class="comment diff">\    |<--------> [x]</span>
                        <span class="comment">\    |            ^</span>
                        <span class="comment">\    |            |</span>
                        <span class="comment">\    |            |  zCoordLo</span>
                        <span class="comment">\    |            v</span>
                        <span class="comment">\   [0] --------------- [3]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The calculation below clears the C flag so we compare</span>
                        <span class="comment">\ xCoordLo and zCoordLo, so the calculation is:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If xCoordLo &lt; zCoordLo, we pick the first entry</span>
                        <span class="comment">\     from tileEdges, i.e. 0, which is the left edge</span>
                        <span class="comment">\     (because the gaze point in [x] is closer to the</span>
                        <span class="comment">\     left edge than the bottom edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If xCoordLo >= zCoordLo, we pick the second entry</span>
                        <span class="comment">\     from tileEdges, i.e. 3, which is the bottom edge</span>
                        <span class="comment">\     (because the gaze point in [x] is closer to the</span>
                        <span class="comment">\     bottom edge than the left edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The comparison is flipped around for tiles where the</span>
                        <span class="comment">\ slopes are along the top/left or bottom/right edges,</span>
                        <span class="comment">\ so we compare ~xCoordLo instead, like this example</span>
                        <span class="comment">\ when the slopes are along the bottom and right edges:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [1]                 [2]</span>
                        <span class="comment">\              ~xCoordLo |</span>
                        <span class="comment diff">\         [x] <--------> |</span>
                        <span class="comment">\                  ^     |</span>
                        <span class="comment">\                  |     |</span>
                        <span class="comment">\        zCoordLo  |     |</span>
                        <span class="comment">\                  v     |</span>
                        <span class="comment">\   [0] --------------- [3]</span>

 <span class="mne">STA</span> <a class="popup variable">G</a>                  <span class="comment">\ Store the value of A in G so we can retrieve it below</span>

 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Set the C flag to bit 0 of A, so it is:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 0 if G = 0 or 2 (bottom/left or top/right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 1 if G = 1 or 3 (top/left or bottom/right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we compare against ~xCoordLo in the following for</span>
                        <span class="comment">\ the top/left or bottom/right edge pairs</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordLo</a>           <span class="comment">\ Set A to xCoordLo when C = 0 or ~xCoordLo when C = 1</span>
 <span class="mne">BCC</span> <a class="popup destination">gaze12</a>             <span class="comment">\</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\ This ensures that the correct x-axis distance is used</span>
                        <span class="comment">\ in the comparison</span>

<span class="label">.gaze12</span><a id="gaze12" class="anchor"></a>

 <span class="mne">CMP</span> <a class="popup variable">zCoordLo</a>           <span class="comment">\ Set the C flag as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 0 if xCoordLo &lt; zCoordLo (i.e. gaze vector is</span>
                        <span class="comment">\          closer to the left or right edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 1 if xCoordLo >= zCoordLo i.e. gaze vector is</span>
                        <span class="comment">\          closer to the top or bottom edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we choose the first entry from tileEdges when the</span>
                        <span class="comment">\ gaze vector is closer to the left or right edge, or</span>
                        <span class="comment">\ the second entry when the gaze vector is closer to the</span>
                        <span class="comment">\ top or bottom edge</span>

 <span class="mne">LDA</span> <a class="popup variable">G</a>                  <span class="comment">\ Set Y = (G * 2) + C</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">TAY</span>                    <span class="comment">\ So Y can be used as an index into the tileEdges table</span>
                        <span class="comment">\ that points to the entry in pair number G as specified</span>
                        <span class="comment">\ by the C flag</span>

 <span class="mne">LDA</span> <a class="popup variable">tileEdges</a>,<span class="register">Y</span>        <span class="comment">\ Set A to the edge number that we should test against</span>
                        <span class="comment">\ the gaze vector</span>

                        <span class="comment">\ Fall into part 5 to check whether the gaze vector is</span>
                        <span class="comment">\ obscured by the edge we just chose</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-g"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#g">G</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/followgazevector_part_4_of_5.html#gaze10">gaze10</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/followgazevector_part_4_of_5.html#gaze11">gaze11</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/followgazevector_part_4_of_5.html#gaze12">gaze12</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze13"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/followgazevector_part_5_of_5.html#gaze13">gaze13</a> in subroutine <a href="/source/main/subroutine/followgazevector_part_5_of_5.html">FollowGazeVector (Part 5 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gaze9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/followgazevector_part_4_of_5.html#gaze9">gaze9</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tileedges"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/tileedges.html">tileEdges</a> (category: Landscape)</div><div class="summary">A table to map tile shapes and gaze vector direction to tile edges</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xcoordlo">xCoordLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of an object or point (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zcoordlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#zcoordlo">zCoordLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The z-coordinate of an object or point (low byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/followgazevector_part_3_of_5.html">FollowGazeVector (Part 3 of 5)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/followgazevector_part_5_of_5.html">FollowGazeVector (Part 5 of 5)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
