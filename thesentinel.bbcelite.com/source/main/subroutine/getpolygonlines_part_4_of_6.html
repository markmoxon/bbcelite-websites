<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_polygons", "subroutine_getpolygonlines_part_4_of_6.html", "The GetPolygonLines (Part 4 of 6) subroutine", "Drawing polygons: GetPolygonLines (Part 4 of 6)", "Annotated code for the GetPolygonLines (Part 4 of 6) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_polygons", "subroutine_getpolygonlines_part_4_of_6", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getpolygonlines_part_3_of_6.html">GetPolygonLines (Part 3 of 6)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getpolygonlines_part_5_of_6.html">GetPolygonLines (Part 5 of 6)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetPolygonLines (Part 4 of 6)</span>                           <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing polygons</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Convert all the polygon point yaw angles into pixel x-coordinates</span>
             <span class="headerEntry">(for smaller yaw angles that convert into an 8-bit x-coordinate)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-getpolygonlines-part-4-of-6">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.gpol7</span><a id="gpol7" class="anchor"></a>

                        <span class="comment">\ By this point the point numbers in the polygon have</span>
                        <span class="comment">\ been set up as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * polygonPoint to polygonPoint+3 (when drawing a</span>
                        <span class="comment">\     triangle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * polygonPoint to polygonPoint+4 (when drawing a</span>
                        <span class="comment">\     quadrilateral)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Each point number is given as an offset within the</span>
                        <span class="comment">\ drawing tables</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now calculate the pixel x-coordinates for each of</span>
                        <span class="comment">\ these points, storing the results in xPolygonPointLo</span>
                        <span class="comment">\ or xPolygonPoint(Hi Lo), depending on whether the</span>
                        <span class="comment">\ pixel x-coordinates fit into one byte (when they are</span>
                        <span class="comment">\ all in the range 0 to 255) or two bytes (when at least</span>
                        <span class="comment">\ one x-coordinate is 256 or more)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Clear bit 6 of xPolygonPointScale to indicate that the</span>
 <span class="mne">STA</span> <a class="popup variable">xPolygonPointScale</a> <span class="comment">\ pixel x-coordinate of this polygon point fits into one</span>
                        <span class="comment">\ byte (we will change this if the x-coordinate ends up</span>
                        <span class="comment">\ being too large to fit into the range 0 to 255)</span>

 <span class="mne">LDY</span> <a class="popup variable">polygonEdgeCount</a>   <span class="comment">\ We now loop through all the points in the polygon, so</span>
                        <span class="comment">\ set Y to count through the number of edges in the</span>
                        <span class="comment">\ polygon that we are drawing (as that's also the number</span>
                        <span class="comment">\ of unique points in the polygon)</span>

<span class="label">.gpol8</span><a id="gpol8" class="anchor"></a>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">drawViewAngles</a><span class="bracket">)</span>,<span class="register">Y</span> <span class="comment">\ Set X to the offset within the drawing tables of the</span>
 <span class="mne">TAX</span>                    <span class="comment">\ Y-th point in the polygon</span>

 <span class="mne">LDA</span> <a class="popup variable">drawViewYawLo</a>,<span class="register">X</span>    <span class="comment">\ Set the following:</span>
 <span class="mne">CLC</span>                    <span class="comment">\</span>
 <span class="mne">ADC</span> <a class="popup variable">bufferOriginLo</a>     <span class="comment">\   (A T) = drawViewYaw(Hi Lo) + bufferOrigin(Hi Lo)</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\</span>
 <span class="mne">LDA</span> <a class="popup variable">drawViewYawHi</a>,<span class="register">X</span>    <span class="comment">\ for the Y-th polygon point, so this adds the yaw angle</span>
 <span class="mne">ADC</span> <a class="popup variable">bufferOriginHi</a>     <span class="comment">\ offset in bufferOrigin(Hi Lo) to the polygon point</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The yaw angles in drawViewYaw(Hi Lo) are relative to</span>
                        <span class="comment">\ the origin in the centre of the screen (i.e. the</span>
                        <span class="comment">\ direction of the viewer's gaze), so this converts the</span>
                        <span class="comment">\ yaw angle from having the origin in the centre to</span>
                        <span class="comment">\ having the origin on the left edge of the buffer</span>

                        <span class="comment">\ We now convert the point's yaw angle in (A T) into a</span>
                        <span class="comment">\ pixel x-coordinate by multiplying the yaw angle by 8,</span>
                        <span class="comment">\ as there are 20 yaw angles in a screen width, the</span>
                        <span class="comment">\ screen is 160 pixels across, and 20 * 8 = 160</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%00100000</span>         <span class="comment">\ If the high byte in A is %00100000 or more then</span>
 <span class="mne">BCS</span> <a class="popup destination">gpol4</a>              <span class="comment">\ multiplying by 8 will overflow (as three left shifts</span>
                        <span class="comment">\ will spill out of the end of the high byte), so jump</span>
                        <span class="comment">\ up to part 3 to redo the x-coordinate calculations for</span>
                        <span class="comment">\ all the polygon points, but this time storing the</span>
                        <span class="comment">\ results in 16-bit numbers</span>
                        <span class="comment">\</span>
                        <span class="comment">\ After the calculations in part 3 are done, we will</span>
                        <span class="comment">\ then jump straight on to part 5</span>

                        <span class="comment">\ If we get here then the high byte in A is less than</span>
                        <span class="comment">\ %00100000, so we can multiply by 8 without risk of</span>
                        <span class="comment">\ overflow</span>

 <span class="mne">ASL</span> <a class="popup variable">T</a>                  <span class="comment">\ Set (A T) = (A T) * 8</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">ASL</span> <a class="popup variable">T</a>                  <span class="comment">\ So (A T) contains the yaw angle in pixels, which is</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\ the same as a pixel x-coordinate, with the integer</span>
 <span class="mne">ASL</span> <a class="popup variable">T</a>                  <span class="comment">\ part in A and the fractional part in T</span>
 <span class="mne">ROL</span> <span class="register">A</span>

 <span class="mne">STA</span> <a class="popup variable">xPolygonPointLo</a>,<span class="register">X</span>  <span class="comment">\ Store the pixel x-coordinate for the Y-th point of the</span>
                        <span class="comment">\ polygon in the xPolygonPointLo table, storing the</span>
                        <span class="comment">\ result at the offset given in the drawViewAngles table</span>
                        <span class="comment">\ (i.e. in the correct place for the polygon point</span>
                        <span class="comment">\ number in Y)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this calculation is for polygon points that have a</span>
                        <span class="comment">\ pixel x-coordinate in the range 0 to 255 (as recorded</span>
                        <span class="comment">\ by the clear bit 6 in xPolygonPointScale)</span>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the point counter in Y</span>

 <span class="mne">BPL</span> <a class="popup destination">gpol8</a>              <span class="comment">\ Loop back until we have converted all the polygon</span>
                        <span class="comment">\ point yaw angles into pixel x-coordinates</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-bufferoriginhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#bufferoriginhi">bufferOriginHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to add to yaw angles for the current screen buffer to convert them from having the origin in the buffer centre to having the origin on the left edge of the buffer (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-bufferoriginlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#bufferoriginlo">bufferOriginLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to add to yaw angles for the current screen buffer to convert them from having the origin in the buffer centre to having the origin on the left edge of the buffer (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewangles"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawviewangles">drawViewAngles</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The address in drawViewAngles(1 0) of the pitch and yaw angles of the tile and polygon points that we are drawing in the landscape view</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewyawhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewyawhi.html">drawViewYawHi</a> (category: Drawing the landscape)</div><div class="summary">Storage for the yaw angles of tiles and object points for drawing the current landscape view (high bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewyawlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewyawlo.html">drawViewYawLo</a> (category: Drawing the landscape)</div><div class="summary">Storage for the yaw angles of tiles and object points for drawing the current landscape view (low bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gpol4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getpolygonlines_part_3_of_6.html#gpol4">gpol4</a> in subroutine <a href="/source/main/subroutine/getpolygonlines_part_3_of_6.html">GetPolygonLines (Part 3 of 6)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gpol8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getpolygonlines_part_4_of_6.html#gpol8">gpol8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-polygonedgecount"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#polygonedgecount">polygonEdgeCount</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of sides in the polygon we are drawing, which is one less than the number of points in the polygon's point list (as the last point in the list is always a repeat of the first point)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonpointlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xpolygonpointlo.html">xPolygonPointLo</a> (category: Drawing polygons)</div><div class="summary">Pixel x-coordinates for all the points in the polygon that we are currently drawing (low bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonpointscale"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xpolygonpointscale">xPolygonPointScale</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A flag to record whether the pixel x-coordinate of the polygon points being processed fit into one or two bytes</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getpolygonlines_part_3_of_6.html">GetPolygonLines (Part 3 of 6)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getpolygonlines_part_5_of_6.html">GetPolygonLines (Part 5 of 6)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
