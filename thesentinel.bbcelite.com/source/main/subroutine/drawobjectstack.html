<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_objects", "subroutine_drawobjectstack.html", "The DrawObjectStack subroutine", "Drawing objects: DrawObjectStack", "Annotated code for the DrawObjectStack subroutine in The Sentinel", "the_sentinel-code", "source_drawing_objects", "subroutine_drawobjectstack", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/performhyperspace.html">PerformHyperspace</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/fillscreen.html">FillScreen</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">DrawObjectStack</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing objects</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Draw an entire stack of objects</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_d.html#header-drawobjectstack">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/drawtileandobjects.html">DrawTileAndObjects</a> calls <a href="#drawobjectstack">DrawObjectStack</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The tile data for the tile containing the stack</span>

</div></div>
<span class="label">.DrawObjectStack</span><a id="drawobjectstack" class="anchor"></a>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">STA</span> <a class="popup variable">topObjectOnStack</a>   <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into</span>
                        <span class="comment">\ topObjectOnStack</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ We now count the number of objects that are stacked on</span>
                        <span class="comment">\ the tile, so initialise a counter in X</span>

<span class="label">.stak1</span><a id="stak1" class="anchor"></a>

 <span class="mne">INX</span>                    <span class="comment">\ Increment the object counter in X to record that we</span>
                        <span class="comment">\ have found an object in the stack</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">TAY</span>                    <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into Y (so</span>
                        <span class="comment">\ object #Y is on the tile, though it might be part of</span>
                        <span class="comment">\ an object stack)</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the object flags for the object on the tile</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ If bit 6 of the object flags for object #Y is set</span>
 <span class="mne">BCS</span> <a class="popup destination">stak1</a>              <span class="comment">\ then object #Y is stacked on top of another object,</span>
                        <span class="comment">\ and that object number is in bits 0 to 5 of the object</span>
                        <span class="comment">\ flags, so jump to stak1 to increase the object count,</span>
                        <span class="comment">\ extract that object number from A and check the flags</span>
                        <span class="comment">\ again (so this works down through the stack of objects</span>
                        <span class="comment">\ until we reach the object at the bottom of the stack)</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Set objectStackCounter = X - 1 so we can use it as a</span>
 <span class="mne">STX</span> <a class="popup variable">objectStackCounter</a> <span class="comment">\ counter as we work through all the objects in the</span>
                        <span class="comment">\ stack</span>

 <span class="mne">BEQ</span> <a class="popup destination">stak7</a>              <span class="comment">\ If there is only one object on the tile then the stack</span>
                        <span class="comment">\ size will be zero, so jump to stak7 to draw the object</span>
                        <span class="comment">\ stack from object #Y down (which in this case will</span>
                        <span class="comment">\ just draw object #Y)</span>

                        <span class="comment">\ If we get here then there is more than one object in</span>
                        <span class="comment">\ the stack, so we now work out in which direction to</span>
                        <span class="comment">\ draw the stack: top to bottom or bottom to top</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If the player is at a lower altitude than the object</span>
                        <span class="comment">\ at the bottom of the stack, then the whole stack is</span>
                        <span class="comment">\ above the player and the object on the top of the</span>
                        <span class="comment">\ stack is the furthest away, so we need to draw the</span>
                        <span class="comment">\ stack from top to bottom</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If it's the other way around and the player is at the</span>
                        <span class="comment">\ same or higher altitude than the bottom of the stack,</span>
                        <span class="comment">\ then we need to draw the stack from bottom to top, as</span>
                        <span class="comment">\ the bottom object is the furthest away</span>
                        <span class="comment">\</span>
                        <span class="comment">\ There is one exception: if the object stack is the</span>
                        <span class="comment">\ Sentinel's tower and we are at the exact same height</span>
                        <span class="comment">\ as the tower, then we draw the stack from top to</span>
                        <span class="comment">\ bottom to ensure the Sentinel's feet are correctly</span>
                        <span class="comment">\ hidden by the platform</span>
                        <span class="comment">\</span>
                        <span class="comment">\ At this point, object #Y is the bottom object in the</span>
                        <span class="comment">\ stack and object #topObjectOnStack is the top object</span>

<span class="label">.stak2</span><a id="stak2" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">playerObject</a>       <span class="comment">\ Set X to the object number of the player</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectLo</a>,<span class="register">X</span>        <span class="comment">\ Set (A T) to the vertical distance between the player</span>
 <span class="mne">SEC</span>                    <span class="comment">\ and the object we are drawing, as follows:</span>
 <span class="mne">SBC</span> <a class="popup variable">yObjectLo</a>,<span class="register">Y</span>        <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\   (A T) = yObject,X - yObject,Y</span>
                        <span class="comment">\</span>
                        <span class="comment">\ starting with the low bytes</span>

 <span class="mne">LDA</span> <a class="popup variable">yObjectHi</a>,<span class="register">X</span>        <span class="comment">\ And then the high bytes</span>
 <span class="mne">SBC</span> <a class="popup variable">yObjectHi</a>,<span class="register">Y</span>

 <span class="mne">BMI</span> <a class="popup destination">stak6</a>              <span class="comment">\ If the result is negative then the player (object #X)</span>
                        <span class="comment">\ is at a lower altitude than the object we are drawing</span>
                        <span class="comment">\ (object #Y), so jump to stak6 to draw the entire</span>
                        <span class="comment">\ object stack from top to bottom, starting with the top</span>
                        <span class="comment">\ object and working down to the bottom</span>

                        <span class="comment">\ If we get here then the player is level with or higher</span>
                        <span class="comment">\ than the object we are drawing (object #Y)</span>

 <span class="mne">ORA</span> <a class="popup variable">T</a>                  <span class="comment">\ If at least one of A and T is non-zero then (A T) > 0,</span>
 <span class="mne">BNE</span> <a class="popup destination">stak3</a>              <span class="comment">\ then the player is at a higher altitude than the</span>
                        <span class="comment">\ object we are drawing, so jump to stak3 to skip the</span>
                        <span class="comment">\ following check</span>

                        <span class="comment">\ If we get here then the player is level with the</span>
                        <span class="comment">\ object we are drawing, so we need to check whether</span>
                        <span class="comment">\ we are thinking of drawing the Sentinel's tower,</span>
                        <span class="comment">\ because if we are, we need to draw the Sentinel before</span>
                        <span class="comment">\ the tower to ensure the Sentinel's feet are correctly</span>
                        <span class="comment">\ hidden by the platform</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ If the object we are drawing is the Sentinel's tower</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">6</span>                 <span class="comment">\ (an object of type 6), then jump to stak6 to draw the</span>
 <span class="mne">BEQ</span> <a class="popup destination">stak6</a>              <span class="comment">\ entire object stack from top to bottom, starting with</span>
                        <span class="comment">\ the top object (the Sentinel) and working down to the</span>
                        <span class="comment">\ bottom object (the tower)</span>

<span class="label">.stak3</span><a id="stak3" class="anchor"></a>

                        <span class="comment">\ If we get here then the player is higher than the</span>
                        <span class="comment">\ object we are drawing (object #Y), so we need to draw</span>
                        <span class="comment">\ the object stack upwards, from the bottom to the top</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This process is a bit convoluted, as the object flags</span>
                        <span class="comment">\ only store object numbers that are below other objects</span>
                        <span class="comment">\ rather than above, so we have to repeatedly count down</span>
                        <span class="comment">\ the stack to work out which object to draw next</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The first time we enter this loop, object #Y is the</span>
                        <span class="comment">\ object at the bottom of the stack, so this loop draws</span>
                        <span class="comment">\ the stack from the very bottom to the top</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The second time we enter this loop, object #Y is the</span>
                        <span class="comment">\ object above the original object #Y, so it's the next</span>
                        <span class="comment">\ object up</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We loop around until we have drawn the whole stack</span>
                        <span class="comment">\ from bottom to top</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This loop therefore draws object #Y and then works out</span>
                        <span class="comment">\ which object is above object #Y in the stack and loops</span>
                        <span class="comment">\ back to repeat the process, until we reach the top of</span>
                        <span class="comment">\ the stack</span>

 <span class="mne">JSR</span> <a class="popup destination">DrawObject</a>         <span class="comment">\ Draw object #Y onto the screen or into the screen</span>
                        <span class="comment">\ buffer</span>

                        <span class="comment">\ We now work out which object is above object #Y, which</span>
                        <span class="comment">\ we do by counting down the stack by the right amount,</span>
                        <span class="comment">\ from the top object down</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This count is stored in objectStackCounter, which</span>
                        <span class="comment">\ contains the number of objects we still have to draw,</span>
                        <span class="comment">\ which is the same as the number of objects above</span>
                        <span class="comment">\ object #Y</span>

 <span class="mne">LDY</span> <a class="popup variable">topObjectOnStack</a>   <span class="comment">\ Set Y to the number of the object on top of the stack,</span>
                        <span class="comment">\ so we can start counting down from the top</span>

 <span class="mne">DEC</span> <a class="popup variable">objectStackCounter</a> <span class="comment">\ Decrement the object stack counter as we have just</span>
                        <span class="comment">\ drawn object #Y</span>

 <span class="mne">BMI</span> <a class="popup destination">stak8</a>              <span class="comment">\ If we have drawn all the objects in the stack then the</span>
                        <span class="comment">\ counter will now be negative, so jump to stak8 to</span>
                        <span class="comment">\ return from the subroutine as we have drawn the whole</span>
                        <span class="comment">\ stack</span>

 <span class="mne">LDX</span> <a class="popup variable">objectStackCounter</a> <span class="comment">\ Otherwise set X to the updated object stack counter,</span>
                        <span class="comment">\ which is the number of objects above the object that</span>
                        <span class="comment">\ we just drew</span>

 <span class="mne">BPL</span> <a class="popup destination">stak5</a>              <span class="comment">\ Jump to stak5 to start counting down the stack for X</span>
                        <span class="comment">\ objects from the top, to give us the object that's</span>
                        <span class="comment">\ above object #Y in the stack (this BPL is effectively</span>
                        <span class="comment">\ a JMP as we know objectStackCounter is positive, so X</span>
                        <span class="comment">\ must also be positive)</span>

<span class="label">.stak4</span><a id="stak4" class="anchor"></a>

                        <span class="comment">\ If we get here then we need to move down the object</span>
                        <span class="comment">\ stack by one place from object #Y, updating Y to the</span>
                        <span class="comment">\ number of the next object down</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the object flags for object #Y</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Object #Y is stacked on top of another object, so the</span>
 <span class="mne">TAY</span>                    <span class="comment">\ number of the object below is in bits 0 to 5 of the</span>
                        <span class="comment">\ object flags, so extract the next object number down</span>
                        <span class="comment">\ the stack into Y</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the counter in X as we have just moved down</span>
                        <span class="comment">\ the stack by one place</span>

<span class="label">.stak5</span><a id="stak5" class="anchor"></a>

                        <span class="comment">\ This is the entry point for the loop that counts X</span>
                        <span class="comment">\ objects down the stack, from the top object down</span>

 <span class="mne">BNE</span> <a class="popup destination">stak4</a>              <span class="comment">\ If X &lt;> 0 then loop back to stak4 to move down the</span>
                        <span class="comment">\ stack</span>

 <span class="mne">BEQ</span> <a class="popup destination">stak2</a>              <span class="comment">\ Otherwise jump to stak2 to draw object #Y, as that is</span>
                        <span class="comment">\ the next object down the stack from the object we just</span>
                        <span class="comment">\ drew (this BEQ is effectively a JMP as we just passed</span>
                        <span class="comment">\ through a BNE)</span>

<span class="label">.stak6</span><a id="stak6" class="anchor"></a>

 <span class="mne">LDY</span> <a class="popup variable">topObjectOnStack</a>   <span class="comment">\ Set Y = topObjectOnStack so the following loop draws</span>
                        <span class="comment">\ the entire object stack from top to bottom, starting</span>
                        <span class="comment">\ with the top object and working down to the bottom</span>

<span class="label">.stak7</span><a id="stak7" class="anchor"></a>

                        <span class="comment">\ This loop draws all the objects in the stack in turn,</span>
                        <span class="comment">\ from object #Y at the top, all the way down to the</span>
                        <span class="comment">\ object at the bottom of the stack</span>

 <span class="mne">JSR</span> <a class="popup destination">DrawObject</a>         <span class="comment">\ Draw object #Y onto the screen or into the screen</span>
                        <span class="comment">\ buffer</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the object flags for the object we just drew</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ If object #Y is stacked on top of another object, then</span>
 <span class="mne">TAY</span>                    <span class="comment">\ the number of the object below is in bits 0 to 5 of</span>
                        <span class="comment">\ the object flags, so extract the next object number</span>
                        <span class="comment">\ down the stack into Y, so we can draw that object next</span>

 <span class="mne">DEC</span> <a class="popup variable">objectStackCounter</a> <span class="comment">\ Decrement the object stack counter as we have just</span>
                        <span class="comment">\ drawn an object</span>

 <span class="mne">BPL</span> <a class="popup destination">stak7</a>              <span class="comment">\ Loop back until we have drawn all the objects in the</span>
                        <span class="comment">\ stack, from object #Y down to the bottom of the stack</span>

<span class="label">.stak8</span><a id="stak8" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/drawobject.html">DrawObject</a> (category: Drawing objects)</div><div class="summary">Draw a 3D object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectstackcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#objectstackcounter">objectStackCounter</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A counter for the objects in an object stack, for use when drawing the stack</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objecttypes"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/objecttypes.html">objectTypes</a> (category: 3D objects)</div><div class="summary">The object types table for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playerobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#playerobject">playerObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the player object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak1">stak1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak2">stak2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak3">stak3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak4">stak4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak5">stak5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak6">stak6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak7">stak7</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stak8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawobjectstack.html#stak8">stak8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-topobjectonstack"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#topobjectonstack">topObjectOnStack</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The number of the object on the top of an object stack</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yobjecthi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/yobjecthi.html">yObjectHi</a> (category: 3D objects)</div><div class="summary">The y-coordinates in 3D space for the 3D objects (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yobjectlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/yobjectlo.html">yObjectLo</a> (category: 3D objects)</div><div class="summary">The y-coordinates in 3D space for the 3D objects (low byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/performhyperspace.html">PerformHyperspace</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/fillscreen.html">FillScreen</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
