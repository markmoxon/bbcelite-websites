<?php
include_once("../../../templates/template_functions.php");
page_header("keyboard", "subroutine_scanforgamekeys.html", "The ScanForGameKeys subroutine", "Keyboard: ScanForGameKeys", "Annotated code for the ScanForGameKeys subroutine in The Sentinel", "the_sentinel-code", "source_keyboard", "subroutine_scanforgamekeys", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/initialisesights.html">InitialiseSights</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/gamekeys.html">gameKeys</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">ScanForGameKeys</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Keyboard</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Scan for game key presses and update the key logger</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_b.html#header-scanforgamekeys">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkforkeypresses.html">CheckForKeyPresses</a> calls <a href="#scanforgamekeys">ScanForGameKeys</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkforsamepankey.html">CheckForSamePanKey</a> calls <a href="#scanforgamekeys">ScanForGameKeys</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/irqhandler.html">IRQHandler</a> calls <a href="#scanforgamekeys">ScanForGameKeys</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">The offset within gameKeys where we start the scan, with</span>
                        <span class="argumentEntry">the scan working towards the start of gameKeys</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">N flag</span>               <span class="argumentEntry">Determines whether a pan key is being pressed:</span>

                        <span class="argumentEntry">  * Bit 7 of A will be set if no pan keys are being</span>
                        <span class="argumentEntry">    pressed (so a BMI branch will be taken)</span>

                        <span class="argumentEntry">  * Bit 7 of A will be clear if at least one pan key is</span>
                        <span class="argumentEntry">    being pressed (so a BPL branch will be taken)</span>

</div></div>
<span class="label">.ScanForGameKeys</span><a id="scanforgamekeys" class="anchor"></a>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ We start by resetting the key logger, so set a loop</span>
                        <span class="comment">\ counter in X for resetting all four entries</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set A = %10000000 to reset all four entries, as the</span>
                        <span class="comment">\ set bit 7 indicates an empty entry in the logger</span>

<span class="label">.gkey1</span><a id="gkey1" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">keyLogger</a>,<span class="register">X</span>        <span class="comment">\ Reset the X-th entry in the key logger</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the loop counter</span>

 <span class="mne">BPL</span> <a class="popup destination">gkey1</a>              <span class="comment">\ Loop back until we have reset all four entries</span>

                        <span class="comment">\ We now work our way backwards through the gameKey</span>
                        <span class="comment">\ table, starting at offset Y, and checking to see if</span>
                        <span class="comment">\ each key is being pressed and logging the results in</span>
                        <span class="comment">\ the key logger</span>

<span class="label">.gkey2</span><a id="gkey2" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">gameKeys</a>,<span class="register">Y</span>         <span class="comment">\ Set X to the internal key number for the Y-th key in</span>
                        <span class="comment">\ the gameKey table</span>

 <span class="mne">JSR</span> <a class="popup destination">ScanKeyboard</a>       <span class="comment">\ Scan the keyboard to see if this key is being pressed</span>

 <span class="mne">BNE</span> <a class="popup destination">gkey3</a>              <span class="comment">\ If the key in X is not being pressed, jump to gkey3 to</span>
                        <span class="comment">\ move on to the next key in the table</span>

 <span class="mne">LDA</span> <a class="popup variable">keyLoggerConfig</a>,<span class="register">Y</span>  <span class="comment">\ Set X to the key logger entry where we should store</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000011</span>         <span class="comment">\ this key press, which is in bits 0 and 1 of the</span>
 <span class="mne">TAX</span>                    <span class="comment">\ corresponding entry in the keyLoggerConfig table</span>

 <span class="mne">LDA</span> <a class="popup variable">keyLoggerConfig</a>,<span class="register">Y</span>  <span class="comment">\ Set A to the value to store in the key logger for this</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ key, which is in bits 2 to 7 of the corresponding</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ entry in the keyLoggerConfig table</span>

 <span class="mne">STA</span> <a class="popup variable">keyLogger</a>,<span class="register">X</span>        <span class="comment">\ Store the configured value in the configured entry</span>
                        <span class="comment">\ for this key press</span>

<span class="label">.gkey3</span><a id="gkey3" class="anchor"></a>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the index in Y to move on to the next key</span>
                        <span class="comment">\ in the gameKey table</span>

 <span class="mne">BPL</span> <a class="popup destination">gkey2</a>              <span class="comment">\ Loop back until we have checked all the keys up to the</span>
                        <span class="comment">\ start of the gameKey table</span>

 <span class="mne">LDA</span> <a class="popup variable">keyLogger</a>          <span class="comment">\ Combine the key logger entry for "S" and "D" (pan left</span>
 <span class="mne">AND</span> <a class="popup variable">keyLogger</a><span class="operator">+</span><span class="decimal">2</span>        <span class="comment">\ and right) with the key logger entry for "L" and ","</span>
                        <span class="comment">\ (pan left and right and set the status flags according</span>
                        <span class="comment">\ to the result</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Specifically, if bit 7 is set in both entries, then no</span>
                        <span class="comment">\ pan keys are being pressed, so a BMI following the</span>
                        <span class="comment">\ call to ScanForGameKeys will be taken</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If, however, bit 7 is clear in either entry, then at</span>
                        <span class="comment">\ least one pan key is being pressed, so a BPL following</span>
                        <span class="comment">\ the call to ScanForGameKeys will be taken</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scankeyboard"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/scankeyboard.html">ScanKeyboard</a> (category: Keyboard)</div><div class="summary">Scan the keyboard for a specific key press</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gamekeys"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/gamekeys.html">gameKeys</a> (category: Keyboard)</div><div class="summary">Negative inkey values for the game keys</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gkey1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanforgamekeys.html#gkey1">gkey1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gkey2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanforgamekeys.html#gkey2">gkey2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gkey3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanforgamekeys.html#gkey3">gkey3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-keylogger"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#keylogger">keyLogger</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The four-byte key logger for logging game key presses</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-keyloggerconfig"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/keyloggerconfig.html">keyLoggerConfig</a> (category: Keyboard)</div><div class="summary">The configuration table for storing keys the key logger</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/initialisesights.html">InitialiseSights</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/gamekeys.html">gameKeys</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
