<?php
include_once("../../../templates/template_functions.php");
page_header("landscape", "subroutine_smoothtilecorners_part_3_of_4.html", "The SmoothTileCorners (Part 3 of 4) subroutine", "Landscape: SmoothTileCorners (Part 3 of 4)", "Annotated code for the SmoothTileCorners (Part 3 of 4) subroutine in The Sentinel", "the_sentinel-code", "source_landscape", "subroutine_smoothtilecorners_part_3_of_4", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html">SmoothTileCorners (Part 2 of 4)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/setcrackerseed.html">SetCrackerSeed</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">SmoothTileCorners (Part 3 of 4)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Smooth a strip by setting the tile corner altitudes to the average</span>
             <span class="headerEntry">of the current tile corner altitude and three following corners</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-smoothtilecorners-part-3-of-4">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
<hr class="light">
 This part smoothes the strip by working along the strip and replacing the
 altitude of each tile corner with the average of that corner's altitude plus
 the next three corners, working along rows from left to right and columns
 from near to far.

</div></div>
<span class="label">.stri11</span><a id="stri11" class="anchor"></a>

                        <span class="comment">\ If we get here then bit 6 of processAction is clear,</span>
                        <span class="comment">\ so we smooth the tile strip by working our way along</span>
                        <span class="comment">\ the strip and setting each tile's altitude to the</span>
                        <span class="comment">\ average of its altitude with the three following tiles</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ We now work our way along the strip, smoothing the</span>
                        <span class="comment">\ altitudes of tiles 0 to 31, so set a tile counter in X</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We work along rows from left to right and columns from</span>
                        <span class="comment">\ near to far</span>

<span class="label">.stri12</span><a id="stri12" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set U = 0 to use as the high byte of (U A), which we</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ will use to calculate the sum of the neighbouring tile</span>
                        <span class="comment">\ altitudes</span>

 <span class="mne">LDA</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ Set A to the altitude of the tile we are smoothing</span>
                        <span class="comment">\ (the one at index X)</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Add the altitude of the next tile along</span>
 <span class="mne">ADC</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">1</span>,<span class="register">X</span>

 <span class="mne">BCC</span> <a class="popup destination">stri13</a>             <span class="comment">\ If the addition overflowed then increment the high</span>
 <span class="mne">CLC</span>                    <span class="comment">\ byte in U, so we have the correct result of the sum</span>
 <span class="mne">INC</span> <a class="popup variable">U</a>                  <span class="comment">\ in (U A)</span>

<span class="label">.stri13</span><a id="stri13" class="anchor"></a>

 <span class="mne">ADC</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">2</span>,<span class="register">X</span>      <span class="comment">\ Add the altitude of the next tile along</span>

 <span class="mne">BCC</span> <a class="popup destination">stri14</a>             <span class="comment">\ If the addition overflowed then increment the high</span>
 <span class="mne">CLC</span>                    <span class="comment">\ byte in U, so we have the correct result of the sum</span>
 <span class="mne">INC</span> <a class="popup variable">U</a>                  <span class="comment">\ in (U A)</span>

<span class="label">.stri14</span><a id="stri14" class="anchor"></a>

 <span class="mne">ADC</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">3</span>,<span class="register">X</span>      <span class="comment">\ Add the altitude of the next tile along</span>

 <span class="mne">BCC</span> <a class="popup destination">stri15</a>             <span class="comment">\ If the addition overflowed then increment the high</span>
 <span class="mne">CLC</span>                    <span class="comment">\ byte in U, so we have the correct result of the sum</span>
 <span class="mne">INC</span> <a class="popup variable">U</a>                  <span class="comment">\ in (U A)</span>

<span class="label">.stri15</span><a id="stri15" class="anchor"></a>

                        <span class="comment">\ So by this point (U A) contains the sum of the</span>
                        <span class="comment">\ altitudes of the tile we are smoothing, and the next</span>
                        <span class="comment">\ three tiles along the strip</span>

 <span class="mne">LSR</span> <a class="popup variable">U</a>                  <span class="comment">\ Set (U A) = (U A) / 4</span>
 <span class="mne">ROR</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">LSR</span> <a class="popup variable">U</a>                  <span class="comment">\ So (U A) contains the average of the four altitudes,</span>
 <span class="mne">ROR</span> <span class="register">A</span>                  <span class="comment">\ and we know that the high byte in U will be zero as</span>
                        <span class="comment">\ each of the four elements of the sum fits into one</span>
                        <span class="comment">\ byte</span>

 <span class="mne">STA</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ Set the altitude of the tile we are smoothing to the</span>
                        <span class="comment">\ average that we just calculated</span>

 <span class="mne">INX</span>                    <span class="comment">\ Increment the tile counter to move along the strip</span>

 <span class="mne">CPX</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ Loop back until we have worked our way through the</span>
 <span class="mne">BCC</span> <a class="popup destination">stri12</a>             <span class="comment">\ strip and have smoothed tiles 0 to 31</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that when we exit the loop, X = 32</span>

                        <span class="comment">\ We now have a very short interlude to set up some of</span>
                        <span class="comment">\ the anti-cracker code before continuing the smoothing</span>
                        <span class="comment">\ process in part 4</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-u"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#u">U</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_3_of_4.html#stri12">stri12</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri13"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_3_of_4.html#stri13">stri13</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri14"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_3_of_4.html#stri14">stri14</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri15"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_3_of_4.html#stri15">stri15</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stripdata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/stripdata.html">stripData</a> (category: Landscape)</div><div class="summary">Storage for tile data when smoothing strips of tiles during the landscape generation process</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html">SmoothTileCorners (Part 2 of 4)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/setcrackerseed.html">SetCrackerSeed</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
