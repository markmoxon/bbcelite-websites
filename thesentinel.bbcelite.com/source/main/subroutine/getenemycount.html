<?php
include_once("../../../templates/template_functions.php");
page_header("landscape", "subroutine_getenemycount.html", "The GetEnemyCount subroutine", "Landscape: GetEnemyCount", "Annotated code for the GetEnemyCount subroutine in The Sentinel", "the_sentinel-code", "source_landscape", "subroutine_getenemycount", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/processcharacter.html">ProcessCharacter</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getnextseed0to22.html">GetNextSeed0To22</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetEnemyCount</span>                                           <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate the number of enemies for the current landscape</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_g.html#header-getenemycount">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/spawnenemies.html">SpawnEnemies</a> calls <a href="#getenemycount">GetEnemyCount</a></span>
</div>
<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The enemy count for the landscape (in the range 1 to 8,</span>
                        <span class="argumentEntry">with higher values for higher landscape numbers)</span>

</div></div>
<span class="label">.GetEnemyCount</span><a id="getenemycount" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">landscapeNumberHi</a>  <span class="comment">\ Set T = (landscapeNumberHi / 4) + 2</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ Because the landscape number is in BCD and in the form</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ 0000 to 9999, this extracts the top digit and adds 2</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">CLC</span>                    <span class="comment">\ So T is in the range 2 to 11, with higher values of T</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ for higher landscape numbers</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>

<span class="label">.enem1</span><a id="enem1" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">GetNextSeedNumber</a>  <span class="comment">\ Set A to the next number from the landscape's sequence</span>
                        <span class="comment">\ of seed numbers, which we now use to calculate the</span>
                        <span class="comment">\ enemy count for this landscape (so the same number is</span>
                        <span class="comment">\ calculated for the same landscape number each time)</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">7</span>                 <span class="comment">\ Set Y = 7 to use as the count of clear bits in A when</span>
                        <span class="comment">\ A is zero</span>

 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\ Set the C flag from bit 7 of this landscape's seed</span>
                        <span class="comment">\ number and clear bit 0 of A, leaving bits 6 to 0 of</span>
                        <span class="comment">\ the original A in bits 7 to 1</span>

 <span class="mne">PHP</span>                    <span class="comment">\ Store the status flags on the stack, so we can use the</span>
                        <span class="comment">\ C flag below to decide whether to negate the result</span>

                        <span class="comment">\ We now count the number of continuous clear bits at</span>
                        <span class="comment">\ the top of A, ignoring bit 0, so we count zeroes from</span>
                        <span class="comment">\ bit 7 down until we hit a 1, and put the result into Y</span>

 <span class="mne">BEQ</span> <a class="popup destination">enem3</a>              <span class="comment">\ If A = 0 then jump to enem3 with Y = 7, as we have a</span>
                        <span class="comment">\ continuous run of seven clear bits in bits 7 to 1</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ Otherwise set Y = -1 so the following loop counts the</span>
                        <span class="comment">\ number of zeroes correctly</span>

<span class="label">.enem2</span><a id="enem2" class="anchor"></a>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the zero counter in Y</span>

 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\ Shift A to the left, moving the top bit into the C</span>
                        <span class="comment">\ flag</span>

 <span class="mne">BCC</span> <a class="popup destination">enem2</a>              <span class="comment">\ Loop back to keep shifting and counting zeroes until</span>
                        <span class="comment">\ we shift a 1 out of bit 7, at which point Y contains</span>
                        <span class="comment">\ the length of the run of zeroes in bits 6 to 0 of the</span>
                        <span class="comment">\ landscape's original seed number</span>

<span class="label">.enem3</span><a id="enem3" class="anchor"></a>

 <span class="mne">TYA</span>                    <span class="comment">\ At this point Y contains a number in the range 0 to 7,</span>
                        <span class="comment">\ so copy this into A</span>

 <span class="mne">PLP</span>                    <span class="comment">\ If the C flag we stored on the stack above was set,</span>
 <span class="mne">BCC</span> <a class="popup destination">enem4</a>              <span class="comment">\ invert A, so this flips the result into the range -1</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\ to -8 if bit 7 of the landscape's original seed number</span>
                        <span class="comment">\ was set</span>

<span class="label">.enem4</span><a id="enem4" class="anchor"></a>

                        <span class="comment">\ At this point A is in the range -8 to 7</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Set A = A + T</span>
 <span class="mne">ADC</span> <a class="popup variable">T</a>                  <span class="comment">\</span>
                        <span class="comment">\ T is in the range 2 to 11, so A is now in the range</span>
                        <span class="comment">\ -6 to 18</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">8</span>                 <span class="comment">\ If A &lt; 0 or A >= 8 then loop back to enem1 to try</span>
 <span class="mne">BCS</span> <a class="popup destination">enem1</a>              <span class="comment">\ again</span>

                        <span class="comment">\ If we get here then A is now in the range 0 to 7, with</span>
                        <span class="comment">\ higher values for higher landscape numbers</span>

 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set A = A + 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This addition works as we know the C flag is clear</span>
                        <span class="comment">\ because we just passed through a BCS</span>

                        <span class="comment">\ So A is now a number in the range 1 to 8, with higher</span>
                        <span class="comment">\ values for higher landscape numbers, which we can use</span>
                        <span class="comment">\ as our enemy count (after capping it to the value of</span>
                        <span class="comment">\ maxNumberOfEnemies after we return from the</span>
                        <span class="comment">\ subroutine)</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getnextseednumber"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/getnextseednumber.html">GetNextSeedNumber</a> (category: Maths (Arithmetic))</div><div class="summary">Set A to a seed number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enem1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getenemycount.html#enem1">enem1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enem2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getenemycount.html#enem2">enem2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enem3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getenemycount.html#enem3">enem3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enem4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getenemycount.html#enem4">enem4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-landscapenumberhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#landscapenumberhi">landscapeNumberHi</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The high byte of the four-digit binary coded decimal landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/processcharacter.html">ProcessCharacter</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getnextseed0to22.html">GetNextSeed0To22</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
