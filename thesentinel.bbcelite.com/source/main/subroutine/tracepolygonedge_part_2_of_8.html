<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_polygons", "subroutine_tracepolygonedge_part_2_of_8.html", "The TracePolygonEdge (Part 2 of 8) subroutine", "Drawing polygons: TracePolygonEdge (Part 2 of 8)", "Annotated code for the TracePolygonEdge (Part 2 of 8) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_polygons", "subroutine_tracepolygonedge_part_2_of_8", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/tracepolygonedge_part_1_of_8.html">TracePolygonEdge (Part 1 of 8)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html">TracePolygonEdge (Part 3 of 8)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">TracePolygonEdge (Part 2 of 8)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing polygons</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Trace a polygon edge with a steep gradient by stepping along the</span>
             <span class="headerEntry">y-axis</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-tracepolygonedge-part-2-of-8">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
                        <span class="comment">\ If we get here then xEdgeDelta &lt; yEdgeDeltaLo, so the</span>
                        <span class="comment">\ y-axis delta is the biggest and the polygon edge has a</span>
                        <span class="comment">\ steep gradient</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We therefore step along the y-axis one pixel at a time</span>
                        <span class="comment">\ and cumulatively add the gradient to calculate the</span>
                        <span class="comment">\ x-coordinate at each step</span>

 <span class="mne">STA</span> <a class="popup variable">tred13</a><span class="operator">+</span><span class="decimal">2</span>           <span class="comment">\ Modify the instruction at tred13 to use the address in</span>
 <span class="mne">STY</span> <a class="popup variable">tred13</a><span class="operator">+</span><span class="decimal">1</span>           <span class="comment">\ (A Y), so it becomes:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   STX into address (xPolygonAddrHi yEdgeStartLo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ xPolygonAddrHi is set to the high byte of either</span>
                        <span class="comment">\ xPolygonLeft or xPolygonRight, and both of these</span>
                        <span class="comment">\ tables start on a page boundary, so this sets the</span>
                        <span class="comment">\ address to offset yEdgeStartLo within the table</span>
                        <span class="comment">\ specified by xPolygonAddrHi</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We will decrement this address for each step along the</span>
                        <span class="comment">\ edge, so we step along the y-axis as we trace the edge</span>

 <span class="mne">STX</span> <a class="popup variable">tred12</a>             <span class="comment">\ Modify the instruction at tred12 to use the opcode</span>
                        <span class="comment">\ specified in X, so we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * DEX when xEdgeStartLo - xEdgeEndLo is positive</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * INX when xEdgeStartLo - xEdgeEndLo is negative</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We store the x-coordinate in X, so this ensures that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * We step left when required with DEX, for when the</span>
                        <span class="comment">\     start point is to the right of the end point</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * We step right when required with INX, for when the</span>
                        <span class="comment">\     start point is to the left of the end point</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We will run this instruction when we need to step</span>
                        <span class="comment">\ along the x-axis, according to the cumulative value of</span>
                        <span class="comment">\ the slope error</span>

 <span class="mne">LDY</span> <a class="popup variable">yEdgeDeltaLo</a>       <span class="comment">\ Set Y = yEdgeDeltaLo + 1</span>
 <span class="mne">INY</span>                    <span class="comment">\</span>
                        <span class="comment">\ We can use this as a pixel counter when stepping along</span>
                        <span class="comment">\ the polygon edge's y-axis delta one pixel at a time,</span>
                        <span class="comment">\ as there are yEdgeDeltaLo + 1 pixels along the edge</span>
                        <span class="comment">\ (the additional one ensures we include the pixels at</span>
                        <span class="comment">\ both ends)</span>

 <span class="mne">LDA</span> <a class="popup variable">yEdgeDeltaLo</a>       <span class="comment">\ Set A = ~(yEdgeDeltaLo / 2)</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">EOR</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ We use A to keep track of the slope error ???</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag so the first addition we do in the</span>
                        <span class="comment">\ following loop will work correctly</span>

                        <span class="comment">\ We already ensured in part 1 that yEdgeStart(Hi Lo)</span>
                        <span class="comment">\ is positive, so the following check only matches</span>
                        <span class="comment">\ yEdgeStartHi when it's in the range 1 to 127</span>

 <span class="mne">LDX</span> <a class="popup variable">yEdgeStartHi</a>       <span class="comment">\ If 0 &lt; yEdgeStartHi &lt; 128 then the start point is</span>
 <span class="mne">BNE</span> <a class="popup destination">tred26</a>             <span class="comment">\ beyond the top of the screen, so jump to part 4 to</span>
                        <span class="comment">\ trace the edge from the start until it reaches the</span>
                        <span class="comment">\ screen, but without storing the results</span>
                        <span class="comment">\</span>
                        <span class="comment">\ When the tracing reaches the top of the screen, part 4</span>
                        <span class="comment">\ will jump into the loop below at tred14 to continue</span>
                        <span class="comment">\ the normal tracing process</span>

 <span class="mne">LDX</span> <a class="popup variable">xEdgeStartLo</a>       <span class="comment">\ Set X to the x-coordinate of the starting point, so we</span>
                        <span class="comment">\ can start tracing from the start of the edge</span>

 <span class="mne">JMP</span> <a class="popup destination">tred13</a>             <span class="comment">\ Jump into the middle of the loop at tred13</span>

<span class="label">.tred11</span><a id="tred11" class="anchor"></a>

 <span class="mne">ADC</span> <a class="popup variable">xEdgeDelta</a>         <span class="comment">\ Add the x-axis delta to the slope error in A, so we</span>
                        <span class="comment">\ keep track of the slope error as we move along the</span>
                        <span class="comment">\ y-axis</span>

 <span class="mne">BCC</span> <a class="popup destination">tred13</a>             <span class="comment">\ If the addition didn't overflow then we have not moved</span>
                        <span class="comment">\ into a new x-coordinate with this step along the</span>
                        <span class="comment">\ y-axis, so jump to tred13 so we do not move along the</span>
                        <span class="comment">\ x-axis</span>

                        <span class="comment">\ If we get here then the addition overflowed and the</span>
                        <span class="comment">\ cumulative slope error along the x-axis has added up</span>
                        <span class="comment">\ to a whole pixel, so we now need to step along the</span>
                        <span class="comment">\ x-axis by a pixel</span>

 <span class="mne">SBC</span> <a class="popup variable">yEdgeDeltaLo</a>       <span class="comment">\ Set A = A - yEdgeDeltaLo ???</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This subtraction works as we just passed through a</span>
                        <span class="comment">\ BCC, so we know the C flag is set</span>

<span class="label">.tred12</span><a id="tred12" class="anchor"></a>

 <span class="mne">INX</span>                    <span class="comment">\ This instruction is modified above to:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * INX (if we are stepping right along the edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * DEX (if we are stepping left along the edge)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So in either case this steps us along the x-axis by</span>
                        <span class="comment">\ one pixel</span>

<span class="label">.tred13</span><a id="tred13" class="anchor"></a>

                        <span class="comment">\ This is the entry point for the tracing loop and the</span>
                        <span class="comment">\ point where we record the current pixel in the edge</span>
                        <span class="comment">\ that we are tracing</span>

 <span class="mne">STX</span> <a class="popup variable">xPolygonRight</a><span class="operator">+</span><span class="hex">&9F</span>  <span class="comment">\ This instruction is modified above to the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   STX into address (xPolygonAddrHi yEdgeStartLo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this stores the current x-coordinate as we step</span>
                        <span class="comment">\ along the edge, storing the coordinate in either the</span>
                        <span class="comment">\ xPolygonRight or xPolygonLeft table, and storing the</span>
                        <span class="comment">\ coordinate in the offset given by the y-coordinate</span>
                        <span class="comment">\ of the current position along the edge we are tracing</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The original value of xPolygonRight+&9F is just</span>
                        <span class="comment">\ workspace noise and has no meaning, as it is modified</span>
                        <span class="comment">\ before we get here</span>

 <span class="mne">DEC</span> <a class="popup variable">tred13</a><span class="operator">+</span><span class="decimal">1</span>           <span class="comment">\ Decrement the low byte of the address in the</span>
                        <span class="comment">\ instruction above so that it points to the table</span>
                        <span class="comment">\ entry for the next y-coordinate down</span>

 <span class="mne">BEQ</span> <a class="popup destination">tred17</a>             <span class="comment">\ If we just decremented the low byte of the address to</span>
                        <span class="comment">\ zero then we have finished stepping along the y-axis,</span>
                        <span class="comment">\ so jump to tred17 to finish off</span>

<span class="label">.tred14</span><a id="tred14" class="anchor"></a>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the pixel counter in Y</span>

 <span class="mne">BNE</span> <a class="popup destination">tred11</a>             <span class="comment">\ Loop back to keep tracing the polygon edge until we</span>
                        <span class="comment">\ have worked our way through all the pixels along the</span>
                        <span class="comment">\ y-axis</span>

                        <span class="comment">\ If we get here then we have finished tracing the edge</span>
                        <span class="comment">\ and Y = 0, so we can now finish off</span>

<span class="label">.tred15</span><a id="tred15" class="anchor"></a>

 <span class="mne">STY</span> <a class="popup variable">drawPolygon</a>        <span class="comment">\ Set drawPolygon = 0 so the polygon gets drawn</span>

<span class="label">.tred16</span><a id="tred16" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.tred17</span><a id="tred17" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set Y = 0 to store as the value of drawPolygon so the</span>
                        <span class="comment">\ polygon gets drawn</span>

 <span class="mne">BEQ</span> <a class="popup destination">tred15</a>             <span class="comment">\ Jump to tred15 to set drawPolygon and return from the</span>
                        <span class="comment">\ subroutine (this BEQ is effectively a JMP as Y is</span>
                        <span class="comment">\ always zero)</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawpolygon"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawpolygon">drawPolygon</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A flag to record whether the polygon we are currently processing contains any visible pixels, so it can be used to control whether we actually draw the polygon</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred11">tred11</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred12">tred12</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred13"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred13">tred13</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred15"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred15">tred15</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred17"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_2_of_8.html#tred17">tred17</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tred26"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/tracepolygonedge_part_4_of_8.html#tred26">tred26</a> in subroutine <a href="/source/main/subroutine/tracepolygonedge_part_4_of_8.html">TracePolygonEdge (Part 4 of 8)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xedgedelta"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xedgedelta">xEdgeDelta</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The scaled and signed x-axis delta between two polygon points when tracing the polygon edges (single byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xedgestartlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xedgestartlo">xEdgeStartLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of the start point in the polygon edge being processed (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xpolygonright"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xpolygonright.html">xPolygonRight</a> (category: Drawing polygons)</div><div class="summary">The pixel x-coordinate of the right edge of each pixel line in the polygon being drawn</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yedgedeltalo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#yedgedeltalo">yEdgeDeltaLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The difference in pitch angle between two polygon points, i.e. the delta along the y-axis (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-yedgestarthi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#yedgestarthi">yEdgeStartHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The y-coordinate of the start point in the polygon edge being processed (high byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/tracepolygonedge_part_1_of_8.html">TracePolygonEdge (Part 1 of 8)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/tracepolygonedge_part_3_of_8.html">TracePolygonEdge (Part 3 of 8)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
