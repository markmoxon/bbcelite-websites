<?php
include_once("../../../templates/template_functions.php");
page_header("setup", "subroutine_configuremachine.html", "The ConfigureMachine subroutine", "Setup: ConfigureMachine", "Annotated code for the ConfigureMachine subroutine in The Sentinel", "the_sentinel-code", "source_setup", "subroutine_configuremachine", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/playmusic.html">PlayMusic</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/clearmemory.html">ClearMemory</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">ConfigureMachine</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Setup</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Configure the custom screen mode, set the break handler to clear</span>
             <span class="headerEntry">memory, move code, reset timers and set the interrupt handler</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_j.html#header-configuremachine">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/entry.html">Entry</a> calls <a href="#configuremachine">ConfigureMachine</a></span>
</div>
<hr class="light">
 The custom screen mode is based on screen mode 5, but with only 25 character
 rows rather than 32. This gives the game screen a letterbox appearance.

 The custom mode has a vertical resolution of 25 * 8 = 200 pixels, compared to
 the 256 pixels of standard mode 5. The horizontal resolution is the same at
 160 pixels.

 Screen memory for the custom mode runs from &6000 to &7F3F, with four pixels
 per byte and four colours per pixel.

</div></div>
<span class="directive"> CLEAR &3F00, &4100     </span><span class="comment">\ Memory from &3F00 to &4100 has three separate uses</span>
<span class="directive"> ORG &3F00              </span><span class="comment">\</span>
                        <span class="comment">\ During startup it is used to store the startup</span>
                        <span class="comment">\ routines ConfigureMachine and ClearMemory, which</span>
                        <span class="comment">\ aren't needed again once the game has started</span>
                        <span class="comment">\</span>
                        <span class="comment">\ While the landscape is being generated it is used to</span>
                        <span class="comment">\ store the secret code stash at secretCodeStash</span>
                        <span class="comment">\</span>
                        <span class="comment">\ While the game is running it is used to store the</span>
                        <span class="comment">\ first few rows of the screen buffer, starting from</span>
                        <span class="comment">\ screenBufferRow0</span>
                        <span class="comment">\</span>
                        <span class="comment">\ These lines rewind BeebAsm's assembly back to &3F00</span>
                        <span class="comment">\ and clear the block from that point to the end of the</span>
                        <span class="comment">\ startup code at &4100, so we can assemble the startup</span>
                        <span class="comment">\ routines</span>
                        <span class="comment">\</span>
                        <span class="comment">\ At the end of the ClearMemory routine, the game binary</span>
                        <span class="comment">\ actually contains snippets of the original source</span>
                        <span class="comment">\ code, left over from the BBC Micro assembly process,</span>
                        <span class="comment">\ so we include this workspace noise to ensure that we</span>
                        <span class="comment">\ generate an exact match for the game binary</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set bit 7 of gameInProgress to indicate that a game is</span>
 <span class="mne">ROR</span> <a class="popup variable">gameInProgress</a>     <span class="comment">\ not currently in progress and that we are in the title</span>
                        <span class="comment">\ and preview screens (so the interrupt handler doesn't</span>
                        <span class="comment">\ progress the game)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This code is never actually run in this location</span>
                        <span class="comment">\ (identical code can be found at the start of the</span>
                        <span class="comment">\ ResetVariables routine)</span>

<span class="label">.ConfigureMachine</span><a id="configuremachine" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Call OSBYTE with A = 4, X = 1 and Y = 0 to disable</span>
 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ cursor editing</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">1</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">144</span>               <span class="comment">\ Call OSBYTE with A = 144, X = 0 and Y = 0 to switch</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ interlace on</span>
 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">22</span>                <span class="comment">\ Switch to screen mode 5 with the following VDU</span>
 <span class="mne">JSR</span> <a class="popup destination">OSWRCH</a>             <span class="comment">\ command:</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\</span>
 <span class="mne">JSR</span> <a class="popup destination">OSWRCH</a>             <span class="comment">\   VDU 22, 5</span>

 <span class="mne">SEI</span>                    <span class="comment">\ Disable interrupts so we can update the 6845 registers</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">6</span>                 <span class="comment">\ Set 6845 register R6 = 25</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&00</span>         <span class="comment">\</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">25</span>                <span class="comment">\ This is the "vertical displayed" register, which sets</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&01</span>         <span class="comment">\ the number of displayed character rows to 25. For</span>
                        <span class="comment">\ comparison, this value is 32 for standard mode 5, but</span>
                        <span class="comment">\ we claw back seven rows to create the game's letterbox</span>
                        <span class="comment">\ screen mode</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">7</span>                 <span class="comment">\ Set 6845 register R7 = 32</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&00</span>         <span class="comment">\</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ This is the "vertical sync position" register, which</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&01</span>         <span class="comment">\ determines the vertical sync position with respect to</span>
                        <span class="comment">\ the reference, programmed in character row times. For</span>
                        <span class="comment">\ comparison this is 34 for mode 5, but it needs to be</span>
                        <span class="comment">\ adjusted for our custom screen's vertical sync</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\ Set 6845 register R10 = %00100000</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&00</span>         <span class="comment">\</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%00100000</span>         <span class="comment">\ This is the "cursor start" register, and bits 5 and 6</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&01</span>         <span class="comment">\ define the "cursor display mode", as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * %00 = steady, non-blinking cursor</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * %01 = do not display a cursor</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * %10 = fast blinking cursor (blink at 1/16 of the</span>
                        <span class="comment">\           field rate)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * %11 = slow blinking cursor (blink at 1/32 of the</span>
                        <span class="comment">\           field rate)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We can therefore turn off the cursor completely by</span>
                        <span class="comment">\ setting cursor display mode %01, with bit 6 of R10</span>
                        <span class="comment">\ clear and bit 5 of R10 set</span>

 <span class="mne">CLI</span>                    <span class="comment">\ Re-enable interrupts</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">151</span>               <span class="comment">\ Call OSBYTE with A = 151, X = &42 and Y = %11111111 to</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="hex">&42</span>               <span class="comment">\ write the value %11111111 to SHEILA+&42</span>
 <span class="mne">LDY</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>             <span class="comment">\ This sets the direction of all eight ports of the 6522</span>
                        <span class="comment">\ System VIA to output by setting the corresponding bits</span>
                        <span class="comment">\ in the Data Direction Register B (SHEILA &42)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">151</span>               <span class="comment">\ Call OSBYTE with A = 151, X = &40 and Y = %00000101 to</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="hex">&40</span>               <span class="comment">\ write the value %00000101 to SHEILA+&40</span>
 <span class="mne">LDY</span> <span class="hash">#</span><span class="binary">%00000101</span>         <span class="comment">\</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>             <span class="comment">\ Writing a value of %vaaa to SHEILA+&40 writes to the</span>
                        <span class="comment">\ System VIA's addressable latch, setting latch address</span>
                        <span class="comment">\ %aaa to value v</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This therefore sets address %101 to 1, which is</span>
                        <span class="comment">\ address B5 in the System VIA</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now we set B4 as well</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">151</span>               <span class="comment">\ Call OSBYTE with A = 151, X = &40 and Y = %00001100 to</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="hex">&40</span>               <span class="comment">\ write the value %00001100 to SHEILA+&40</span>
 <span class="mne">LDY</span> <span class="hash">#</span><span class="binary">%00001100</span>         <span class="comment">\</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>             <span class="comment">\ Writing a value of %vaaa to SHEILA+&40 writes to the</span>
                        <span class="comment">\ System VIA's addressable latch, setting latch address</span>
                        <span class="comment">\ %aaa to value v</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This therefore sets address %100 to 0, which is</span>
                        <span class="comment">\ address B4 in the System VIA</span>
                        <span class="comment">\</span>
                        <span class="comment">\ B4 and B5 in the System VIA control the address of the</span>
                        <span class="comment">\ start of screen memory and the screen size, so this</span>
                        <span class="comment">\ sets screen memory to &6000 and screen size to 8K (see</span>
                        <span class="comment">\ page 429 of the "Advanced User Guide for the BBC</span>
                        <span class="comment">\ Micro" by Bray, Dickens and Holmes for details)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Call OSBYTE with A = 0 and X = 255 to fetch the</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">255</span>               <span class="comment">\ operating system version into X</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>

 <span class="mne">CPX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ If X = 0 then this is either a BBC Micro running an</span>
 <span class="mne">BEQ</span> <a class="popup destination">setp1</a>              <span class="comment">\ operating system version of 1.00 or earlier, or it's</span>
                        <span class="comment">\ an Electron, so in either case jump to setp1 to skip</span>
                        <span class="comment">\ the following</span>

                        <span class="comment">\ If we get here then this is not an Electron or an</span>
                        <span class="comment">\ early operating system, so it must be a BBC Micro with</span>
                        <span class="comment">\ MOS 1.20 or later, or a BBC Master</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">200</span>               <span class="comment">\ Call OSBYTE with A = 200, X = 2 and Y = 0 to set the</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ normal action for the ESCAPE key and clear memory if</span>
 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ the BREAK key is pressed</span>
 <span class="mne">JSR</span> <a class="popup destination">OSBYTE</a>

 <span class="mne">JMP</span> <a class="popup destination">setp3</a>              <span class="comment">\ Jump to setp3 to skip the setup for the Electron</span>

<span class="label">.setp1</span><a id="setp1" class="anchor"></a>

                        <span class="comment">\ If we get here then this is either a BBC Micro running</span>
                        <span class="comment">\ MOS 1.00 or earlier, or it's an Electron</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In MOS 0.10, OSBYTE 200 does not let you set the BREAK</span>
                        <span class="comment">\ key to clear memory, so we need to set this up by hand</span>
                        <span class="comment">\ (otherwise crackers could load the game on MOS 0.10</span>
                        <span class="comment">\ and simply press BREAK to access the loaded game code)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The Electron and MOS 1.00 do not need this code, as</span>
                        <span class="comment">\ OSBYTE 200 is supported in these versions of the</span>
                        <span class="comment">\ operating system, but OSBYTE 0 doesn't distinguish</span>
                        <span class="comment">\ between the Electron and MOS 1.00 and earlier (they</span>
                        <span class="comment">\ all return X = 0)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ There's no harm in manually clearing memory on those</span>
                        <span class="comment">\ systems, though, so the following code is run on</span>
                        <span class="comment">\ BREAK on MOS 1.00 and earlier and on the Electron</span>
                        <span class="comment">\</span>
                        <span class="comment">\ To set this up, we copy the break handler routine from</span>
                        <span class="comment">\ ClearMemory to address BRKI (this points to the</span>
                        <span class="comment">\ cassette filing system workspace, which is unused</span>
                        <span class="comment">\ now that the game is loaded, so it's a suitable</span>
                        <span class="comment">\ location for our handler)</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="hex">&1C</span>               <span class="comment">\ Set a counter in X for the size of the ClearMemory</span>
                        <span class="comment">\ routine</span>

<span class="label">.setp2</span><a id="setp2" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">ClearMemory</a>,<span class="register">X</span>      <span class="comment">\ Copy the X-th byte of the ClearMemory routine into the</span>
 <span class="mne">STA</span> <a class="popup variable">BRKI</a>,<span class="register">X</span>             <span class="comment">\ X-th byte of BRKI</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the byte counter</span>

 <span class="mne">BPL</span> <a class="popup destination">setp2</a>              <span class="comment">\ Loop back until we have copied the whole ClearMemory</span>
                        <span class="comment">\ routine to BRKI</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&4C</span>               <span class="comment">\ Set the Break Intercept code to the following, so that</span>
 <span class="mne">STA</span> <a class="popup variable">BRKIV</a>              <span class="comment">\ BRKI gets called when the BREAK key is pressed:</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="operator">LO</span><span class="bracket">(</span><a class="popup variable">BRKI</a><span class="bracket">)</span>          <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">BRKIV</a><span class="operator">+</span><span class="decimal">1</span>            <span class="comment">\    4C 80 03   JMP BRKI</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="operator">HI</span><span class="bracket">(</span><a class="popup variable">BRKI</a><span class="bracket">)</span>          <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">BRKIV</a><span class="operator">+</span><span class="decimal">2</span>            <span class="comment">\ &4C is the opcode for the JMP instruction, and BRKI is</span>
                        <span class="comment">\ at address &0380 (part of the cassette filing system</span>
                        <span class="comment">\ workspace)</span>

<span class="label">.setp3</span><a id="setp3" class="anchor"></a>

                        <span class="comment">\ Next we copy a block of game code in memory as</span>
                        <span class="comment">\ follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * &4100-&49FF is copied to &5800-&60FF</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The game binary could easily have been structured to</span>
                        <span class="comment">\ avoid this copy, so presumably it's just done to make</span>
                        <span class="comment">\ the game code harder to crack</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&00</span>               <span class="comment">\ Set (Q P) = &4100</span>
 <span class="mne">STA</span> <a class="popup variable">P</a>                  <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">R</a>                  <span class="comment">\ We use this as the source address for the copy</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&41</span>
 <span class="mne">STA</span> <a class="popup variable">Q</a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&58</span>               <span class="comment">\ Set (S R) = &5800</span>
 <span class="mne">STA</span> <a class="popup variable">S</a>                  <span class="comment">\</span>
                        <span class="comment">\ We use this as the destination address for the copy</span>

<span class="label">.setp4</span><a id="setp4" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set up a byte counter in Y</span>

<span class="label">.setp5</span><a id="setp5" class="anchor"></a>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>              <span class="comment">\ Copy the Y-th byte of (Q P) to the Y-th byte of (S R)</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">R</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the byte counter</span>

 <span class="mne">BNE</span> <a class="popup destination">setp5</a>              <span class="comment">\ Loop back until we have copied a whole page of bytes</span>

 <span class="mne">INC</span> <a class="popup variable">Q</a>                  <span class="comment">\ Increment the high byte of (Q P) to point to the next</span>
                        <span class="comment">\ page in memory</span>

 <span class="mne">INC</span> <a class="popup variable">S</a>                  <span class="comment">\ Increment the high byte of (S R) to point to the next</span>
                        <span class="comment">\ page in memory</span>

 <span class="mne">LDA</span> <a class="popup variable">Q</a>                  <span class="comment">\ Loop back until (Q P) reaches &4A00, at which point we</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&4A</span>               <span class="comment">\ have copied the whole block of memory</span>
 <span class="mne">BCC</span> <a class="popup destination">setp4</a>

 <span class="mne">SEI</span>                    <span class="comment">\ Disable interrupts so we can update the interrupt</span>
                        <span class="comment">\ vector and VIA</span>

 <span class="mne">LDA</span> <a class="popup variable">IRQ1V</a>              <span class="comment">\ Store the current address from the IRQ1V vector in</span>
 <span class="mne">STA</span> <a class="popup variable">irq1Address</a>        <span class="comment">\ irq1Address, so the IRQ handler can jump to it after</span>
 <span class="mne">LDA</span> <a class="popup variable">IRQ1V</a><span class="operator">+</span><span class="decimal">1</span>            <span class="comment">\ implementing the custom interrupt handler</span>
 <span class="mne">STA</span> <a class="popup variable">irq1Address</a><span class="operator">+</span><span class="decimal">1</span>

                        <span class="comment">\ We now wait for the vertical sync, which we can check</span>
                        <span class="comment">\ by reading bit 1 of the 6522 System VIA status byte</span>
                        <span class="comment">\ (SHEILA &4D), which is set if vertical sync has</span>
                        <span class="comment">\ occurred on the video system</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%00000010</span>         <span class="comment">\ Set a bit mask in A that we can use to read bit 1 of</span>
                        <span class="comment">\ the 6522 System VIA status byte</span>

<span class="label">.setp6</span><a id="setp6" class="anchor"></a>

 <span class="mne">BIT</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&4D</span>         <span class="comment">\ Loop around until bit 1 of the 6522 System VIA status</span>
 <span class="mne">BEQ</span> <a class="popup destination">setp6</a>              <span class="comment">\ byte is set, so we wait until the vertical sync</span>

                        <span class="comment">\ We now set timer 1 in the 6522 User VIA to count down</span>
                        <span class="comment">\ regularly, triggering the interrupt handler routine at</span>
                        <span class="comment">\ IRQHandler every time it counts down</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The timer is initially set to count down from 14,592</span>
                        <span class="comment">\ to zero, and then a value of 19,998 is latched into</span>
                        <span class="comment">\ the timer so that it triggers the interrupt every time</span>
                        <span class="comment">\ it counts down from 20,000 to zero (the latching</span>
                        <span class="comment">\ process takes two ticks, which gives us a total count</span>
                        <span class="comment">\ of 20,000)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The timer counts down at 1 MHz. or one million times a</span>
                        <span class="comment">\ second, so this means the interrupt is triggered every</span>
                        <span class="comment">\ 0.02 seconds, or exactly 50 times a second</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This regular interrupt is used to progress the game</span>
                        <span class="comment">\ counters and manage the screen panning effect (see the</span>
                        <span class="comment">\ IRQHandler routine for details)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ Set 6522 User VIA auxiliary control register ACR</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&6B</span>         <span class="comment">\ (SHEILA &6B) bits 7 and 6 to disable PB7 (which is one</span>
                        <span class="comment">\ of the pins on the user port) and set continuous</span>
                        <span class="comment">\ interrupts for timer 1</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%11000000</span>         <span class="comment">\ Set 6522 User VIA interrupt enable register IER</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&6E</span>         <span class="comment">\ (SHEILA &4E) bits 6 and 7 (i.e. enable the Timer1</span>
                        <span class="comment">\ interrupt from the User VIA)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&00</span>               <span class="comment">\ Set 6522 User VIA T1C-L timer 1 low-order counter</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&64</span>         <span class="comment">\ (SHEILA &64) to &00 (so this sets the low-order</span>
                        <span class="comment">\ counter but does not start counting until the</span>
                        <span class="comment">\ high-order counter is set)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&39</span>               <span class="comment">\ Set 6522 User VIA T1C-H timer 1 high-order counter</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&65</span>         <span class="comment">\ (SHEILA &45) to &39 to start the T1 counter</span>
                        <span class="comment">\ counting down from &3900 (14592) at a rate of 1 MHz</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&1E</span>               <span class="comment">\ Set 6522 User VIA T1L-L timer 1 low-order latches</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&66</span>         <span class="comment">\ to &1E (so this sets the low-order counter but does</span>
                        <span class="comment">\ not start counting until the high-order counter is</span>
                        <span class="comment">\ set)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&4E</span>               <span class="comment">\ Set 6522 User VIA T1L-H timer 1 high-order latches</span>
 <span class="mne">STA</span> <a class="popup variable">SHEILA</a><span class="operator">+</span><span class="hex">&67</span>         <span class="comment">\ to &4E (so this sets the timer to &4E1E (19998) but</span>
                        <span class="comment">\ does not start counting until the current timer has</span>
                        <span class="comment">\ run down)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="operator">HI</span><span class="bracket">(</span><a class="popup variable">IRQHandler</a><span class="bracket">)</span>    <span class="comment">\ Set the IRQ1V vector to IRQHandler, so the IRQHandler</span>
 <span class="mne">STA</span> <a class="popup variable">IRQ1V</a><span class="operator">+</span><span class="decimal">1</span>            <span class="comment">\ routine is now the interrupt handler</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="operator">LO</span><span class="bracket">(</span><a class="popup variable">IRQHandler</a><span class="bracket">)</span>
 <span class="mne">STA</span> <a class="popup variable">IRQ1V</a>

 <span class="mne">CLI</span>                    <span class="comment">\ Re-enable interrupts</span>

 <span class="mne">JMP</span> <a class="popup destination">MainTitleLoop</a>      <span class="comment">\ Jump to MainTitleLoop to start the main title loop,</span>
                        <span class="comment">\ where we display the title screen, fetch the landscape</span>
                        <span class="comment">\ number and code, preview the landscape and then jump</span>
                        <span class="comment">\ to the main game loop</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-brki"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Configuration variable <a href="/source/all/workspaces.html#brki">BRKI</a> = &0380</div><div class="summary">The CFS workspace, which we can use for the Break Intercept handler</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-brkiv"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Configuration variable <a href="/source/all/workspaces.html#brkiv">BRKIV</a> = &0287</div><div class="summary">The Break Intercept code (which is a JMP instruction to the Break Intercept handler)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-clearmemory"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/clearmemory.html">ClearMemory</a> (category: Setup)</div><div class="summary">Clear game memory, so that the BREAK key can remove all trace of the game code in early versions of the operating system</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-irq1v"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Configuration variable <a href="/source/all/workspaces.html#irq1v">IRQ1V</a> = &0204</div><div class="summary">The IRQ1V vector that we intercept to implement the interrupt handler</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-irqhandler"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/irqhandler.html">IRQHandler</a> (category: Main game loop)</div><div class="summary">The main interrupt handler, which gets run 50 times a second to update the game state and check for game key presses</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-maintitleloop"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/maintitleloop.html">MainTitleLoop</a> (category: Main title loop)</div><div class="summary">The main title loop: display the title screen, fetch the landscape number/code, preview the landscape and jump to the main game loop</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-osbyte"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Configuration variable <a href="/source/all/workspaces.html#osbyte">OSBYTE</a> = &FFF4</div><div class="summary">The address for the OSBYTE routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-oswrch"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Configuration variable <a href="/source/all/workspaces.html#oswrch">OSWRCH</a> = &FFEE</div><div class="summary">The address for the OSWRCH routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-p"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#p">P</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-q"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#q">Q</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-r"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#r">R</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-s"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#s">S</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sheila"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Configuration variable <a href="/source/all/workspaces.html#sheila">SHEILA</a> = &FE00</div><div class="summary">Memory-mapped space for accessing internal hardware, such as the video ULA, 6845 CRTC and 6522 VIAs (also known as SHEILA)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gameinprogress"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#gameinprogress">gameInProgress</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Flags whether or not a game is in progress (i.e. the player is playing a landscape rather than interacting with the title and preview screens)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-irq1address"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/irq1address.html">irq1Address</a> (category: Main game loop)</div><div class="summary">Stores the previous value of IRQ1V before we install our custom IRQ handler</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-setp1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/configuremachine.html#setp1">setp1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-setp2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/configuremachine.html#setp2">setp2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-setp3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/configuremachine.html#setp3">setp3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-setp4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/configuremachine.html#setp4">setp4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-setp5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/configuremachine.html#setp5">setp5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-setp6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/configuremachine.html#setp6">setp6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/playmusic.html">PlayMusic</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/clearmemory.html">ClearMemory</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
