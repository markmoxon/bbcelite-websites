<?php
include_once("../../../templates/template_functions.php");
page_header("title_screen", "subroutine_spawncharacter3d_part_2_of_2.html", "The SpawnCharacter3D (Part 2 of 2) subroutine", "Title screen: SpawnCharacter3D (Part 2 of 2)", "Annotated code for the SpawnCharacter3D (Part 2 of 2) subroutine in The Sentinel", "the_sentinel-code", "source_title_screen", "subroutine_spawncharacter3d_part_2_of_2", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/checkcrackerseed.html">CheckCrackerSeed</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/objblocknumber.html">objBlockNumber</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">SpawnCharacter3D (Part 2 of 2)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Title screen</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Spawn large 3D blocks for the extracted character definition</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-spawncharacter3d-part-2-of-2">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
                        <span class="comment">\ We now loop through the top seven rows in the</span>
                        <span class="comment">\ character definition, using X as the row counter</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We draw the character from the bottom up on the</span>
                        <span class="comment">\ landscape, so that's drawing the character rows on</span>
                        <span class="comment">\ the landscape from front the back as we work through</span>
                        <span class="comment">\ the character definition from bottom to top</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The row counter in X therefore iterates from 7 down</span>
                        <span class="comment">\ to 0, with row 7 spawning the blocks for the</span>
                        <span class="comment">\ penultimate row in the character definition, and row 0</span>
                        <span class="comment">\ spawning a blank row (as this moves the blank row in</span>
                        <span class="comment">\ the character definition from the bottom to the top,</span>
                        <span class="comment">\ as discussed in part 1)</span>

<span class="label">.spac3</span><a id="spac3" class="anchor"></a>

 <span class="mne">ASL</span> <a class="popup variable">characterDef</a>,<span class="register">X</span>     <span class="comment">\ The leftmost column of each character definition is</span>
                        <span class="comment">\ blank, so that characters are spaced out, so this</span>
                        <span class="comment">\ shifts the character definition row to the left to</span>
                        <span class="comment">\ move this blank column to the right side of the</span>
                        <span class="comment">\ character definition, so the character's 3D blocks</span>
                        <span class="comment">\ start at the correct tile coordinate</span>

 <span class="mne">LDA</span> <a class="popup variable">xTileCharacter</a>     <span class="comment">\ Set xTile to the x-coordinate where we want to spawn</span>
 <span class="mne">STA</span> <a class="popup variable">xTile</a>              <span class="comment">\ the character</span>

                        <span class="comment">\ Each row in the character definition consists of eight</span>
                        <span class="comment">\ bits (where each bit will be represented by a block on</span>
                        <span class="comment">\ the landscape)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In order to get tall characters on-screen, rather than</span>
                        <span class="comment">\ the rather square characters in the operating system's</span>
                        <span class="comment">\ font, we actually draw each character so that it's</span>
                        <span class="comment">\ four tiles wide and eight tiles tall, so each tile</span>
                        <span class="comment">\ contains a pair of blocks that represents a pair of</span>
                        <span class="comment">\ bits in the character definition</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Set a loop counter in loopCounter to work through the</span>
 <span class="mne">STA</span> <a class="popup variable">loopCounter</a>        <span class="comment">\ four pairs in the eight-block row</span>

<span class="label">.spac4</span><a id="spac4" class="anchor"></a>

 <span class="mne">ASL</span> <a class="popup variable">characterDef</a>,<span class="register">X</span>     <span class="comment">\ Shift the character definition row to the left by two</span>
 <span class="mne">ROL</span> <span class="register">A</span>                  <span class="comment">\ places and extract the top two bits into bits 0 and 1</span>
 <span class="mne">ASL</span> <a class="popup variable">characterDef</a>,<span class="register">X</span>     <span class="comment">\ of A, so this is the leftmost block pair from this row</span>
 <span class="mne">ROL</span> <span class="register">A</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000011</span>         <span class="comment">\ Clear bits 2 to 7 of A and store the result in Y, so</span>
 <span class="mne">TAY</span>                    <span class="comment">\ Y contains the bit pattern for the two leftmost bits</span>
                        <span class="comment">\ in the character row</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We can now use this as an index into the table that</span>
                        <span class="comment">\ maps bit patterns to object numbers in objBlockNumber</span>

 <span class="mne">LDA</span> <a class="popup variable">objBlockNumber</a>,<span class="register">Y</span>   <span class="comment">\ Fetch the object number of the 3D text block object</span>
                        <span class="comment">\ that matches the bit pair that we just extracted</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This actually fetches the object number + 32, though</span>
                        <span class="comment">\ the 32 part is removed when the block is drawn in the</span>
                        <span class="comment">\ DrawTileAndObjects, so this doesn't seem to have any</span>
                        <span class="comment">\ effect</span>

 <span class="mne">PHA</span>                    <span class="comment">\ Store the object number on the stack, as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 32 + 0 for no blocks in the pair</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 32 + 7 for no block (left), block (right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 32 + 8 for block (left), no block (right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 32 + 9 for block (left), no block (right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This maps the pair to one of the three 3D text block</span>
                        <span class="comment">\ objects</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileData</a>        <span class="comment">\ Set A to the tile data for the tile anchored at</span>
                        <span class="comment">\ (xTile, zTile), which we ignore, but this also sets</span>
                        <span class="comment">\ the tile page in tileDataPage and the index in Y, so</span>
                        <span class="comment">\ tileDataPage+Y now points to the tile data entry in</span>
                        <span class="comment">\ the tileData table</span>

 <span class="mne">PLA</span>                    <span class="comment">\ Retrieve the object number for the 3D text block pair</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">tileDataPage</a><span class="bracket">)</span>,<span class="register">Y</span>   <span class="comment">\ and store it in the tile data for the tile where we</span>
                        <span class="comment">\ want to spawn this part of the character definition</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that the DrawTileAndObjects routine has separate</span>
                        <span class="comment">\ logic when drawing 3D text, so this doesn't follow the</span>
                        <span class="comment">\ normal tile data rules, and instead we just need the</span>
                        <span class="comment">\ object number in the low nibble, which we fetched from</span>
                        <span class="comment">\ the objBlockNumber above</span>

 <span class="mne">INC</span> <a class="popup variable">xTile</a>              <span class="comment">\ Increment the x-coordinate to move on to the next tile</span>
                        <span class="comment">\ to the right, for the next bit pair</span>

 <span class="mne">DEC</span> <a class="popup variable">loopCounter</a>        <span class="comment">\ Decrement the loop counter to move onto the next bit</span>
                        <span class="comment">\ pair in the character definition</span>

 <span class="mne">BNE</span> <a class="popup destination">spac4</a>              <span class="comment">\ Loop back to spawn the next bit pair's objects until</span>
                        <span class="comment">\ we have done all four pairs in the character row</span>

 <span class="mne">INC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Increment the z-coordinate to move backwards to the</span>
                        <span class="comment">\ tile row behind in the landscape</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the character row counter in X</span>

 <span class="mne">BMI</span> <a class="popup destination">spac5</a>              <span class="comment">\ If we just spawned row 0 then X will now be negative,</span>
                        <span class="comment">\ so jump to spac5 to finish off as we have spawned all</span>
                        <span class="comment">\ eight character rows</span>

 <span class="mne">BNE</span> <a class="popup destination">spac3</a>              <span class="comment">\ Otherwise loop back until we have spawned rows 7 to 1</span>

                        <span class="comment">\ If we get here then we just spawned row 1, so now we</span>
                        <span class="comment">\ need to spawn a blank for row 0</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Zero the character definition row that we will use</span>
 <span class="mne">STA</span> <a class="popup variable">characterDef</a>       <span class="comment">\ when X is 0, so we don't spawn any blocks for the top</span>
                        <span class="comment">\ row of the 3D text block character</span>

 <span class="mne">BEQ</span> <a class="popup destination">spac3</a>              <span class="comment">\ Jump to spac3 to spawn row 0 (this BEQ is effectively</span>
                        <span class="comment">\ a JMP as A is always zero)</span>

<span class="label">.spac5</span><a id="spac5" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">xTileCharacter</a>     <span class="comment">\ We just spawned a character in the landscape, so add 4</span>
 <span class="mne">CLC</span>                    <span class="comment">\ to xTileCharacter so the next character gets spawned</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ to the right of the one we just spawned</span>
 <span class="mne">STA</span> <a class="popup variable">xTileCharacter</a>

 <span class="mne">PLA</span>                    <span class="comment">\ Pull A from the stack to reverse the push that we did</span>
                        <span class="comment">\ at the start of the routine</span>

 <span class="mne">TAY</span>                    <span class="comment">\ Retrieve X and Y from the stack so they are preserved</span>
 <span class="mne">PLA</span>
 <span class="mne">TAX</span>
 <span class="mne">PLA</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettiledata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/gettiledata.html">GetTileData</a> (category: Landscape)</div><div class="summary">Get the tile data and tile data address for a specific tile</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-characterdef"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#characterdef">characterDef</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">An OSWORD block for reading a character definition</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-loopcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#loopcounter">loopCounter</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A general-purpose loop counter</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objblocknumber"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/objblocknumber.html">objBlockNumber</a> (category: Title screen)</div><div class="summary">A lookup table to convert bit pairs into object numbers for spawning 3D text blocks on the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spac3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/spawncharacter3d_part_2_of_2.html#spac3">spac3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spac4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/spawncharacter3d_part_2_of_2.html#spac4">spac4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spac5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/spawncharacter3d_part_2_of_2.html#spac5">spac5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tiledatapage"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#tiledatapage">tileDataPage</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The address of the tileData page containing the current tile's data</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtile">xTile</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Tile corner x-coordinate</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtilecharacter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#xtilecharacter">xTileCharacter</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The tile x-coordinate of the character being spawned in large 3D blocks on the landscape for the title screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ztile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#ztile">zTile</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Tile corner z-coordinate</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/checkcrackerseed.html">CheckCrackerSeed</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/objblocknumber.html">objBlockNumber</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
