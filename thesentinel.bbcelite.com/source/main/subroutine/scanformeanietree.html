<?php
include_once("../../../templates/template_functions.php");
page_header("gameplay", "subroutine_scanformeanietree.html", "The ScanForMeanieTree subroutine", "Gameplay: ScanForMeanieTree", "Annotated code for the ScanForMeanieTree subroutine in The Sentinel", "the_sentinel-code", "source_gameplay", "subroutine_scanformeanietree", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/resetmeaniescan.html">ResetMeanieScan</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/drainobjectenergy.html">DrainObjectEnergy</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">ScanForMeanieTree</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Scan through the objects in the landscape to see if any of them</span>
             <span class="headerEntry">are trees that are suitable for turning into a meanie</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-scanformeanietree">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_7_of_8.html">ApplyTactics (Part 7 of 8)</a> calls <a href="#scanformeanietree">ScanForMeanieTree</a></span>
</div>
<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">The result of the tree scan:</span>

                        <span class="argumentEntry">  * Clear = we have successfully turned a tree into a</span>
                        <span class="argumentEntry">            meanie</span>

                        <span class="argumentEntry">  * Set = we have not been able to find a suitable tree</span>
                        <span class="argumentEntry">          to turn into a meanie</span>

</div></div>
<span class="label">.ScanForMeanieTree</span><a id="scanformeanietree" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">40</span>                <span class="comment">\ Set enemyViewingArc = 40, so the enemy's gaze has a</span>
 <span class="mne">STA</span> <a class="popup variable">enemyViewingArc</a>    <span class="comment">\ viewing arc that's twice the width of the screen (as</span>
                        <span class="comment">\ the screen is 20 yaw angles across)</span>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set the viewing object to the enemy so the gaze checks</span>
 <span class="mne">STX</span> <a class="popup variable">viewingObject</a>      <span class="comment">\ below are performed from the point of view of the</span>
                        <span class="comment">\ enemy object</span>

<span class="label">.mean1</span><a id="mean1" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set X to the object number of the enemy to which we</span>
                        <span class="comment">\ are applying tactics (so this is now object #X)</span>

 <span class="mne">LDY</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ Set Y to the object number that we have reached while</span>
                        <span class="comment">\ scanning for a tree to turn into a meanie, which is</span>
                        <span class="comment">\ stored in the enemyMeanieScan for this enemy</span>

 <span class="mne">BNE</span> <a class="popup destination">mean2</a>              <span class="comment">\ If enemyMeanieScan is non-zero then we have not yet</span>
                        <span class="comment">\ scanned every object for a tree to turn into a meanie,</span>
                        <span class="comment">\ so jump to mean2 to check the next object</span>

 <span class="mne">INC</span> <a class="popup variable">enemyFailCounter</a>,<span class="register">X</span> <span class="comment">\ We just failed to find a suitable tree to attack the</span>
                        <span class="comment">\ target, so increment the failure counter for the enemy</span>
                        <span class="comment">\ in enemyFailCounter</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyTarget</a>,<span class="register">X</span>      <span class="comment">\ We just failed to find a suitable tree to attack the</span>
 <span class="mne">STA</span> <a class="popup variable">enemyFailTarget</a>,<span class="register">X</span>  <span class="comment">\ target, so store the target number in enemyFailTarget</span>
                        <span class="comment">\ for this enemy to record this fact, so the enemy</span>
                        <span class="comment">\ doesn't try spawning a meanie for this target again</span>
                        <span class="comment">\ (at least, until the enemy's data is reset)</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag to indicate that we have not been able</span>
                        <span class="comment">\ to find a suitable tree to turn into a meanie</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.mean2</span><a id="mean2" class="anchor"></a>

 <span class="mne">DEC</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ Decrement the object number that we are checking for</span>
                        <span class="comment">\ meanie potential, so we work our way down the object</span>
                        <span class="comment">\ list</span>

 <span class="mne">DEY</span>                    <span class="comment">\ We already set Y to the object number before jumping</span>
                        <span class="comment">\ here, so decrement Y as well, so object #Y is our</span>
                        <span class="comment">\ potential meanie</span>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">Y</span>      <span class="comment">\ If bit 7 of the object flags for the potential meanie</span>
 <span class="mne">BMI</span> <a class="popup destination">mean1</a>              <span class="comment">\ is set then the object number doesn't have an</span>
                        <span class="comment">\ associated object, so jump to mean1 to move on to the</span>
                        <span class="comment">\ next object to check that instead</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ If the potential meanie is not a tree (an object of</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ type 2) then it can't be turned into a meanie, so jump</span>
 <span class="mne">BNE</span> <a class="popup destination">mean1</a>              <span class="comment">\ to mean1 to move on to the next object to check that</span>
                        <span class="comment">\ instead</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyTarget</a>,<span class="register">X</span>      <span class="comment">\ Set X to the enemy's current target object, so object</span>
 <span class="mne">TAX</span>                    <span class="comment">\ #X is the target object</span>

 <span class="mne">LDA</span> <a class="popup variable">xObject</a>,<span class="register">X</span>          <span class="comment">\ Set A to the difference in x-coordinate between object</span>
 <span class="mne">SEC</span>                    <span class="comment">\ #X and object #Y (i.e. between the target and</span>
 <span class="mne">SBC</span> <a class="popup variable">xObject</a>,<span class="register">Y</span>          <span class="comment">\ potential meanie)</span>

 <span class="mne">BPL</span> <a class="popup destination">mean3</a>              <span class="comment">\ If the result is positive, jump to mean3 as the result</span>
                        <span class="comment">\ is already the correct sign</span>

 <span class="mne">EOR</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ Negate A using two's complement, so that A is now</span>
 <span class="mne">CLC</span>                    <span class="comment">\ positive and contains the absolute value of the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ distance in the x-axis between the target and</span>
                        <span class="comment">\ potential meanie</span>

<span class="label">.mean3</span><a id="mean3" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\ If the target and potential meanie are ten or more</span>
 <span class="mne">BCS</span> <a class="popup destination">mean1</a>              <span class="comment">\ tiles apart then this is too far away from the target</span>
                        <span class="comment">\ to be turned into a meanie, so jump to mean1 to move</span>
                        <span class="comment">\ on to the next object to check that instead</span>

 <span class="mne">LDA</span> <a class="popup variable">zObject</a>,<span class="register">X</span>          <span class="comment">\ Set A to the difference in z-coordinate between object</span>
 <span class="mne">SEC</span>                    <span class="comment">\ #X and object #Y (i.e. between the target and</span>
 <span class="mne">SBC</span> <a class="popup variable">zObject</a>,<span class="register">Y</span>          <span class="comment">\ potential meanie)</span>

 <span class="mne">BPL</span> <a class="popup destination">mean4</a>              <span class="comment">\ If the result is positive, jump to mean4 as the result</span>
                        <span class="comment">\ is already the correct sign</span>

 <span class="mne">EOR</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ Negate A using two's complement, so that A is now</span>
 <span class="mne">CLC</span>                    <span class="comment">\ positive and contains the absolute value of the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ distance in the z-axis between the target and</span>
                        <span class="comment">\ potential meanie</span>

<span class="label">.mean4</span><a id="mean4" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">10</span>                <span class="comment">\ If the target and potential meanie are ten or more</span>
 <span class="mne">BCS</span> <a class="popup destination">mean1</a>              <span class="comment">\ tiles apart then this is too far away from the target</span>
                        <span class="comment">\ to be turned into a meanie, so jump to mean1 to move</span>
                        <span class="comment">\ on to the next object to check that instead</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ Call CheckEnemyGaze to check the gaze of the enemy</span>
 <span class="mne">JSR</span> <a class="popup destination">CheckEnemyGaze</a>     <span class="comment">\ towards the potential meanie in object #Y, returning</span>
                        <span class="comment">\ the following if object #Y is a tree (an object of</span>
                        <span class="comment">\ type 2), which we have already confirmed:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * targetVisibility = bit 7 set if the tree's tile</span>
                        <span class="comment">\     is visible, bit 6 set if the tree is visible</span>

 <span class="mne">LDA</span> <a class="popup variable">targetVisibility</a>   <span class="comment">\ If bit 7 of targetVisibility is clear then the enemy</span>
 <span class="mne">BPL</span> <a class="popup destination">mean1</a>              <span class="comment">\ can't see the tree's tile, so it can't turn it into</span>
                        <span class="comment">\ a meanie, so jump to mean1 to move on to the next</span>
                        <span class="comment">\ object to check that instead</span>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set X to the object number of the enemy to which we</span>
                        <span class="comment">\ are applying tactics (so this is now object #X)</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Set A to the object number of the potential meanie</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckObjVisibility</a> <span class="comment">\ Check whether the potential meanie in object A is</span>
                        <span class="comment">\ visible and could therefore be seen on-screen by the</span>
                        <span class="comment">\ player</span>

 <span class="mne">BCC</span> <a class="popup destination">mean5</a>              <span class="comment">\ If the C flag is clear then we are about to repeat the</span>
                        <span class="comment">\ same screen pan (as the player is still holding down</span>
                        <span class="comment">\ the same pan key) and the potential meanie would be</span>
                        <span class="comment">\ visible in the landscape view if we drew it again</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that when we pan the screen, the new part</span>
                        <span class="comment">\ of the screen that pans into view might show part of</span>
                        <span class="comment">\ the meanie while the rest of the screen won't, and</span>
                        <span class="comment">\ that won't look good</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So jump to mean5 to stop processing this potential</span>
                        <span class="comment">\ meanie for now, but set things up so we can come back</span>
                        <span class="comment">\ to it the next time we process tactics for this enemy,</span>
                        <span class="comment">\ as the player might not be panning the screen by then</span>

                        <span class="comment">\ If we get here then we have found a suitable tree to</span>
                        <span class="comment">\ turn into a meanie, so let's do that</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Set enemyMeanieTree for this enemy to Y, as object #Y</span>
 <span class="mne">STA</span> <a class="popup variable">enemyMeanieTree</a>,<span class="register">X</span>  <span class="comment">\ is the object number of the tree that we are going to</span>
                        <span class="comment">\ turn into a meanie, and storing it in enemyMeanieTree</span>
                        <span class="comment">\ records the fact that the enemy has changed this</span>
                        <span class="comment">\ object from a tree into a meanie</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Set the type of object #Y to 4, so it turns into a</span>
 <span class="mne">STA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ meanie (an object of type 4)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">104</span>               <span class="comment">\ Set minObjWidth = 104 so we use the width of the wider</span>
 <span class="mne">STA</span> <a class="popup variable">minObjWidth</a>        <span class="comment">\ object, the tree, when we calculate the object's</span>
                        <span class="comment">\ visibility when updating the object on-screen ???</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that we have successfully</span>
                        <span class="comment">\ turned a tree into a meanie</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.mean5</span><a id="mean5" class="anchor"></a>

 <span class="mne">INC</span> <a class="popup variable">enemyMeanieScan</a>,<span class="register">X</span>  <span class="comment">\ If we get here then we have found a suitable tree to</span>
                        <span class="comment">\ turn into a meanie but updating it on-screen might</span>
                        <span class="comment">\ corrupt the landscape view as a pan is in progress</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So increment the object number in enemyMeanieScan, so</span>
                        <span class="comment">\ the next time we apply tactics to this enemy, we can</span>
                        <span class="comment">\ pick up where we left off, by which time the player</span>
                        <span class="comment">\ might no longer be panning the screen</span>

 <span class="mne">JMP</span> <a class="popup destination">FinishEnemyTactics</a> <span class="comment">\ Jump to FinishEnemyTactics to stop applying tactics to</span>
                        <span class="comment">\ the current enemy and return to the ProcessGameplay</span>
                        <span class="comment">\ routine to continue with the gameplay loop</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkenemygaze"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/checkenemygaze_part_1_of_2.html">CheckEnemyGaze (Part 1 of 2)</a> (category: Gameplay)</div><div class="summary">Check to see whether the current enemy can see a specific target object of a specific type</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkobjvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/checkobjvisibility.html">CheckObjVisibility</a> (category: Drawing objects)</div><div class="summary">Check whether an object is visible on-screen and should therefore not be changed if a pan operation is about to happen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-finishenemytactics"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/finishenemytactics.html">FinishEnemyTactics</a> (category: Gameplay)</div><div class="summary">Stop applying tactics to the current enemy and return to the ProcessGameplay routine to continue with the gameplay loop</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyfailcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemyfailcounter">enemyFailCounter</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Enemy failed to find meanie: counter (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyfailtarget"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemyfailtarget">enemyFailTarget</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Enemy failed to find meanie: target object (one byte</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemymeaniescan"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemymeaniescan">enemyMeanieScan</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Enemy meanie scan object counter (one byte per enemy)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemymeanietree"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemymeanietree">enemyMeanieTree</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Enemy has turned a tree into a meanie (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#enemyobject">enemyObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The object number of the enemy to which we are applying tactics in this iteration around the main loop (0-7)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemytarget"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemytarget">enemyTarget</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The object number of the enemy's target (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyviewingarc"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemyviewingarc">enemyViewingArc</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The viewing arc of the enemy that is being processed in the ApplyTactics routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanformeanietree.html#mean1">mean1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanformeanietree.html#mean2">mean2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanformeanietree.html#mean3">mean3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanformeanietree.html#mean4">mean4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-mean5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/scanformeanietree.html#mean5">mean5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-minobjwidth"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#minobjwidth">minObjWidth</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The on-screen width to use when updating objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objecttypes"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/objecttypes.html">objectTypes</a> (category: 3D objects)</div><div class="summary">The object types table for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-targetvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#targetvisibility">targetVisibility</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Reports whether a target object is visible from an enemy in the CheckEnemyGaze routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-viewingobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#viewingobject">viewingObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the viewing object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xobject.html">xObject</a> (category: 3D objects)</div><div class="summary">The x-coordinates in 3D space for the 3D objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/zobject.html">zObject</a> (category: 3D objects)</div><div class="summary">The z-coordinates in 3D space for the 3D objects</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/resetmeaniescan.html">ResetMeanieScan</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/drainobjectenergy.html">DrainObjectEnergy</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
