<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_the_landscape", "subroutine_getrowvisibility_part_2_of_2.html", "The GetRowVisibility (Part 2 of 2) subroutine", "Drawing the landscape: GetRowVisibility (Part 2 of 2)", "Annotated code for the GetRowVisibility (Part 2 of 2) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_the_landscape", "subroutine_getrowvisibility_part_2_of_2", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/checksecretstash.html">CheckSecretStash</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/gettilealtitudes.html">GetTileAltitudes</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetRowVisibility (Part 2 of 2)</span>                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing the landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate whether each tile corner in a tile row is obscured from</span>
             <span class="headerEntry">the player by any intervening landscape</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_d.html#header-getrowvisibility-part-2-of-2">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
                        <span class="comment">\ In part 1 we set up xVector(Hi Lo Bot) with the vector</span>
                        <span class="comment">\ from the player to the tile corner, split up into</span>
                        <span class="comment">\ traceStepCounter steps, each of which is smaller than</span>
                        <span class="comment">\ the size of a tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We can therefore trace the vector from the player to</span>
                        <span class="comment">\ the tile corner by taking the player's coordinates and</span>
                        <span class="comment">\ adding the vector:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   [ xVector(Hi Lo Bot) ]</span>
                        <span class="comment">\   [ yVector(Hi Lo Bot) ]</span>
                        <span class="comment">\   [ zVector(Hi Lo Bot) ]</span>
                        <span class="comment">\</span>
                        <span class="comment">\ traceStepCounter times, knowing that together, these</span>
                        <span class="comment">\ steps will stop over every tile between the player and</span>
                        <span class="comment">\ the tile corner in the process (we may stop over some</span>
                        <span class="comment">\ tiles more than once, but that's OK)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ I'll refer to this vector as the player's gaze, as it</span>
                        <span class="comment">\ represents the line-of-sight from the player to the</span>
                        <span class="comment">\ tile corner we are analysing</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So now we step along the player's gaze, checking on</span>
                        <span class="comment">\ each step whether the gaze is passing over a tile that</span>
                        <span class="comment">\ has a high enough altitude to block the player's view</span>
                        <span class="comment">\ of the tile corner we are analysing</span>

<span class="label">.rvis6</span><a id="rvis6" class="anchor"></a>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ We now work through all three axes in turn, so set an</span>
                        <span class="comment">\ axis counter in X to iterate through 2, 1 and 0 (for</span>
                        <span class="comment">\ the z-axis, y-axis and x-axis respectively)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The comments in the following loop will concentrate on</span>
                        <span class="comment">\ the x-axis to keep things simple</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag so the initial addition at rvis8 will</span>
                        <span class="comment">\ start properly</span>

 <span class="mne">BCC</span> <a class="popup destination">rvis8</a>              <span class="comment">\ Jump into the following loop at rvis8 so we start off</span>
                        <span class="comment">\ that calculations with the z-axis and skip the bottom</span>
                        <span class="comment">\ byte</span>

<span class="label">.rvis7</span><a id="rvis7" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">xCoordBot</a>,<span class="register">X</span>        <span class="comment">\ For the y-axis calculation, we include the bottom byte</span>
 <span class="mne">ADC</span> <a class="popup variable">xVectorBot</a>,<span class="register">X</span>       <span class="comment">\ for more accuracy, so we calculate the following:</span>
 <span class="mne">STA</span> <a class="popup variable">xCoordBot</a>,<span class="register">X</span>        <span class="comment">\</span>
                        <span class="comment">\   xCoord(Hi Lo Bot) += xVector(Hi Lo Bot)</span>

<span class="label">.rvis8</span><a id="rvis8" class="anchor"></a>

                        <span class="comment">\ This is where we join the loop to add the next step to</span>
                        <span class="comment">\ the vector containing the current position along the</span>
                        <span class="comment">\ player's gaze towards the tile corner we're analysing</span>

 <span class="mne">LDA</span> <a class="popup variable">xCoordLo</a>,<span class="register">X</span>         <span class="comment">\ Set xCoord(Hi Lo) += xVector(Hi Lo)</span>
 <span class="mne">ADC</span> <a class="popup variable">xVectorLo</a>,<span class="register">X</span>
 <span class="mne">STA</span> <a class="popup variable">xCoordLo</a>,<span class="register">X</span>
 <span class="mne">LDA</span> <a class="popup variable">xCoordHi</a>,<span class="register">X</span>
 <span class="mne">ADC</span> <a class="popup variable">xVectorHi</a>,<span class="register">X</span>
 <span class="mne">STA</span> <a class="popup variable">xCoordHi</a>,<span class="register">X</span>

                        <span class="comment">\ The calculation above adds the scaled vector from the</span>
                        <span class="comment">\ player to the tile corner, which is in xVector, to the</span>
                        <span class="comment">\ player's object coordinate, which is in xCoord</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this calculation effectively follows the player's</span>
                        <span class="comment">\ gaze towards the tile corner, adding one of the steps</span>
                        <span class="comment">\ to the vector x-coordinate in xVector(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We repeat this for all three axes, calculating the</span>
                        <span class="comment">\ x- and z-axes with 16-bit accuracy, and the y-axis</span>
                        <span class="comment">\ with 24-bit accuracy (as y-coordinates are stored in</span>
                        <span class="comment">\ this way)</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag so the following additions work</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the axis counter</span>

 <span class="mne">BEQ</span> <a class="popup destination">rvis8</a>              <span class="comment">\ If we are just about to calculate the x-axis, jump</span>
                        <span class="comment">\ back to rvis8 to skip the bottom byte</span>

 <span class="mne">BPL</span> <a class="popup destination">rvis7</a>              <span class="comment">\ If we are about to calculate the y-axis, jump back to</span>
                        <span class="comment">\ rvis7 to include the bottom byte</span>

                        <span class="comment">\ We now work out whether this step has made the</span>
                        <span class="comment">\ player's gaze pass over a tile that is high enough to</span>
                        <span class="comment">\ block the player's view of the tile corner that we are</span>
                        <span class="comment">\ heading for</span>

 <span class="mne">LDA</span> <a class="popup variable">zCoordHi</a>           <span class="comment">\ Set the top byte of (S R) to the high byte of the</span>
 <span class="mne">STA</span> <a class="popup variable">S</a>                  <span class="comment">\ z-coordinate of our current step along gaze vector</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Because we added &60 to the starting z-coordinate in</span>
                        <span class="comment">\ part 1, this will point to the &xx20 table of altitude</span>
                        <span class="comment">\ data for the tile row over which the gaze is passing</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The GetTileAltitude routine populates the &xx20 table</span>
                        <span class="comment">\ with the altitude of the highest tile corner for each</span>
                        <span class="comment">\ tile, so (S R) now points to this data for the row</span>
                        <span class="comment">\ over which we are passing</span>

 <span class="mne">LDY</span> <a class="popup variable">xCoordHi</a>           <span class="comment">\ Set Y to the high byte of the x-coordinate of our</span>
                        <span class="comment">\ current step along gaze vector, which is the tile</span>
                        <span class="comment">\ x-coordinate of the tile that the gaze vector is</span>
                        <span class="comment">\ currently passing over</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that (S R) + Y will contain the altitude</span>
                        <span class="comment">\ of the highest tile corner for the tile that we are</span>
                        <span class="comment">\ passing over</span>

 <span class="mne">LDA</span> <a class="popup variable">yCoordHi</a>           <span class="comment">\ Set A to the high byte of the y-coordinate of our</span>
                        <span class="comment">\ current step along gaze vector</span>

 <span class="mne">CMP</span> <span class="bracket">(</span><a class="popup variable">R</a><span class="bracket">)</span>,<span class="register">Y</span>              <span class="comment">\ If yCoordHi &lt; (S R) + Y then the altitude of the gaze</span>
 <span class="mne">BCC</span> <a class="popup destination">rvis9</a>              <span class="comment">\ vector is lower than the altitude of the highest point</span>
                        <span class="comment">\ of the landscape on the tile over which we are</span>
                        <span class="comment">\ passing, which means the gaze vector has hit the</span>
                        <span class="comment">\ landscape before reaching the end</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So jump to rvis9 to record that this tile corner is</span>
                        <span class="comment">\ not visible from the player's perspective, as it is</span>
                        <span class="comment">\ hidden behind a higher part of the landscape between</span>
                        <span class="comment">\ the player and the tile corner</span>

 <span class="mne">DEC</span> <a class="popup variable">traceStepCounter</a>   <span class="comment">\ Otherwise decrement the step counter to keep moving</span>
                        <span class="comment">\ along the vector</span>

 <span class="mne">BNE</span> <a class="popup destination">rvis6</a>              <span class="comment">\ If we haven't yet done all the steps, loop back to</span>
                        <span class="comment">\ rvis6 to do the next step in the ray-trace</span>

                        <span class="comment">\ If we get here then we have finished the ray-tracing</span>
                        <span class="comment">\ process and we didn't bump into any tiles on the way,</span>
                        <span class="comment">\ so the tile corner is not obscured by the landscape</span>
                        <span class="comment">\ and is therefore deemed to be visible</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag so we store %11111111 in the</span>
                        <span class="comment">\ visibility table to indicate that this tile corner is</span>
                        <span class="comment">\ visible</span>

 <span class="mne">BCC</span> <a class="popup destination">rvis10</a>             <span class="comment">\ Jump to rvis10 to store the result (this BCC is</span>
                        <span class="comment">\ effectively a JMP as the C flag is always clear)</span>

<span class="label">.rvis9</span><a id="rvis9" class="anchor"></a>

 <span class="mne">SEC</span>                    <span class="comment">\ Set the C flag so we store %00000000 in the visibility</span>
                        <span class="comment">\ table to indicate that this tile corner is not visible</span>

<span class="label">.rvis10</span><a id="rvis10" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">xTileRow</a>           <span class="comment">\ Set Y = drawingTableOffset + xTileRow</span>
 <span class="mne">ORA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\</span>
 <span class="mne">TAY</span>                    <span class="comment">\ The value of drawingTableOffset is either 0 or 32, so</span>
                        <span class="comment">\ this creates an index in Y that we can use to store</span>
                        <span class="comment">\ the result in either oddVisibility (when it is 0) or</span>
                        <span class="comment">\ evenVisibility when it is 32)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set A = 0 - 0 - (1 - C)</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\       = C - 1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ so this sets:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = %00000000 if the C flag is set (not visible)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * A = %11111111 if the C flag is clear (visible)</span>

 <span class="mne">STA</span> <a class="popup variable">oddVisibility</a>,<span class="register">Y</span>    <span class="comment">\ Store the result in either the oddVisibility or</span>
                        <span class="comment">\ evenVisibility table, as determined by the value of</span>
                        <span class="comment">\ drawingTableOffset</span>

 <span class="mne">DEC</span> <a class="popup variable">xTileRow</a>           <span class="comment">\ Decrement xTileRow to move left along the tile row we</span>
                        <span class="comment">\ are analysing</span>

 <span class="mne">BMI</span> <a class="popup destination">rvis11</a>             <span class="comment">\ If we have already processed the leftmost tile then</span>
                        <span class="comment">\ jump to rvis11 to return from the subroutine</span>

 <span class="mne">JMP</span> <a class="popup destination">rvis1</a>              <span class="comment">\ Otherwise jump back to part 1 to analyse the next tile</span>
                        <span class="comment">\ to the left</span>

<span class="label">.rvis11</span><a id="rvis11" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-r"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#r">R</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-s"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#s">S</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawingtableoffset"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawingtableoffset">drawingTableOffset</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to use within the various drawing data tables for the tile we are analysing</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-oddvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#oddvisibility">oddVisibility</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">The visibility of tiles corners in odd rows as they are processed by the GetRowVisibility routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_1_of_2.html#rvis1">rvis1</a> in subroutine <a href="/source/main/subroutine/getrowvisibility_part_1_of_2.html">GetRowVisibility (Part 1 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_2_of_2.html#rvis10">rvis10</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_2_of_2.html#rvis11">rvis11</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_2_of_2.html#rvis6">rvis6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_2_of_2.html#rvis7">rvis7</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_2_of_2.html#rvis8">rvis8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rvis9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrowvisibility_part_2_of_2.html#rvis9">rvis9</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-tracestepcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#tracestepcounter">traceStepCounter</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of steps in the ray-tracing process when calculating tile visibility in the GetRowVisibility routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordbot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xcoordbot">xCoordBot</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of an object or point (bottom byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xcoordhi">xCoordHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of an object or point (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xcoordlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xcoordlo">xCoordLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of an object or point (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtilerow"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtilerow">xTileRow</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile x-coordinate of the tile we are analysing in the GetRowVisibility routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xvectorbot"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xvectorbot">xVectorBot</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of a vector (bottom byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xvectorhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xvectorhi">xVectorHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of a vector (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xvectorlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xvectorlo">xVectorLo</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The x-coordinate of a vector (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ycoordhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#ycoordhi">yCoordHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The y-coordinate of an object or point (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zcoordhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#zcoordhi">zCoordHi</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The z-coordinate of an object or point (high byte)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/checksecretstash.html">CheckSecretStash</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/gettilealtitudes.html">GetTileAltitudes</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
