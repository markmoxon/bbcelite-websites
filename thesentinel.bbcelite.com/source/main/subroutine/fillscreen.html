<?php
include_once("../../../templates/template_functions.php");
page_header("graphics", "subroutine_fillscreen.html", "The FillScreen subroutine", "Graphics: FillScreen", "Annotated code for the FillScreen subroutine in The Sentinel", "the_sentinel-code", "source_graphics", "subroutine_fillscreen", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drawobjectstack.html">DrawObjectStack</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/backgroundeven.html">backgroundEven</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">FillScreen</span>                                              <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Graphics</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Fill a rectangular in screen memory or the screen buffer with the</span>
             <span class="headerEntry">specified background</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_d.html#header-fillscreen">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/clearscreen.html">ClearScreen</a> calls <a href="#fillscreen">FillScreen</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/drawupdatedobject.html">DrawUpdatedObject</a> calls <a href="#fillscreen">FillScreen</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/panlandscapeview.html">PanLandscapeView</a> calls <a href="#fillscreen">FillScreen</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">Determines whether we fill screen memory or the screen</span>
                        <span class="argumentEntry">buffer:</span>

                        <span class="argumentEntry">  * 0 = fill the screen</span>

                        <span class="argumentEntry">  * 25 = fill the screen buffer</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">The number of character columns to fill</span>

   <span class="argumentLabel">Y</span>                    <span class="argumentEntry">The number of character rows to fill</span>

   <span class="argumentLabel">screenBackground</span>     <span class="argumentEntry">The type of background to fill the rectangle with:</span>

                        <span class="argumentEntry">  * 0 = fill with alternating colour 0/1 (blue/black)</span>
                        <span class="argumentEntry">        pixel rows, for the sky during gameplay</span>

                        <span class="argumentEntry">  * 1 = fill with solid colour 0 (blue)</span>

                        <span class="argumentEntry">  * 2 = fill with dithered pixels in colour 0 (blue)</span>
                        <span class="argumentEntry">        and colour 3 (e.g. green in landscape 0000)</span>
                        <span class="argumentEntry">        by alternating colour 3/0/3/0 and 0/3/0/3</span>
                        <span class="argumentEntry">        pixel bytes</span>

                        <span class="argumentEntry">  * 3 = fill with solid colour 1 (black)</span>

</div></div>
<span class="label">.FillScreen</span><a id="fillscreen" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">fillRowNumber</a>      <span class="comment">\ Set fillRowNumber = A, so we start filling from this</span>
                        <span class="comment">\ character row number</span>
                        <span class="comment">\</span>
                        <span class="comment">\ When we are filling the screen buffer, this value is</span>
                        <span class="comment">\ 25 + the row number, so we can use this value as a</span>
                        <span class="comment">\ lookup into the screenRowAddrLo and screenRowAddrHi</span>
                        <span class="comment">\ tables, and it will return the corresponding address</span>
                        <span class="comment">\ from the bufferRowAddrLo or bufferRowAddrHi table, to</span>
                        <span class="comment">\ give us the row address in the screen buffer</span>

 <span class="mne">STY</span> <a class="popup variable">screenRowCounter</a>   <span class="comment">\ Set screenRowCounter = Y, so we will fill this many</span>
                        <span class="comment">\ character rows</span>

 <span class="mne">TXA</span>                    <span class="comment">\ If X &lt; 32 then each character row in the fill will fit</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ into 256 bytes (as each character block is eight bytes</span>
 <span class="mne">BCC</span> <a class="popup destination">fill1</a>              <span class="comment">\ and 32 * 8 = 256), so jump to fill1 to set bit 7 of</span>
                        <span class="comment">\ moreColumnsToFill to record this fact</span>

                        <span class="comment">\ If we get here then each character row in the fill</span>
                        <span class="comment">\ needs more than 256 bytes, so we set A to the number</span>
                        <span class="comment">\ of columns that we need to fill beyond the 256-byte</span>
                        <span class="comment">\ limit, which we get by subtracting 32 from the total</span>
                        <span class="comment">\ number of columns we need to fill</span>

 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ Set A = X - 32 to store in moreColumnsToFill below</span>
                        <span class="comment">\ (this subtraction works as we just passed through a</span>
                        <span class="comment">\ BCC instruction, so we know the C flag is set)</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ Set X = 32 to set as the value of columnCounter below,</span>
                        <span class="comment">\ so we fill 32 columns in the first iteration around</span>
                        <span class="comment">\ the fill loop, and then fill moreColumnsToFill columns</span>
                        <span class="comment">\ in the second iteration</span>

 <span class="mne">BNE</span> <a class="popup destination">fill2</a>              <span class="comment">\ Jump to fill2 to skip the following instruction (this</span>
                        <span class="comment">\ BNE is effectively a JMP as X is never zero)</span>

<span class="label">.fill1</span><a id="fill1" class="anchor"></a>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%10000000</span>         <span class="comment">\ Set bit 7 of moreColumnsToFill in the next instruction</span>
                        <span class="comment">\ to indicate that this fill does not require more than</span>
                        <span class="comment">\ 32 columns</span>

<span class="label">.fill2</span><a id="fill2" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">moreColumnsToFill</a>  <span class="comment">\ Set moreColumnsToFill to the value of A that we set</span>
                        <span class="comment">\ above</span>

 <span class="mne">STX</span> <a class="popup variable">columnCounter</a>      <span class="comment">\ Set columnCounter to the updated value of X, so this</span>
                        <span class="comment">\ contains the number of columns to fill in the first</span>
                        <span class="comment">\ iteration around the fill loop (i.e. the total number</span>
                        <span class="comment">\ of columns if it's less than 32, or 32 if we need to</span>
                        <span class="comment">\ do the fill in two stages)</span>

 <span class="mne">LDX</span> <a class="popup variable">screenBackground</a>   <span class="comment">\ Set T to the backgroundEven pixel byte for the screen</span>
 <span class="mne">LDA</span> <a class="popup variable">backgroundEven</a>,<span class="register">X</span>   <span class="comment">\ background type in screenBackground, to give us the</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ pixel byte we should be clearing the screen to for</span>
                        <span class="comment">\ even pixel rows</span>

 <span class="mne">LDA</span> <a class="popup variable">backgroundOdd</a>,<span class="register">X</span>    <span class="comment">\ Set U to the backgroundOdd pixel byte for the screen</span>
 <span class="mne">STA</span> <a class="popup variable">U</a>                  <span class="comment">\ background type in screenBackground, to give us the</span>
                        <span class="comment">\ pixel byte we should be clearing the screen to for odd</span>
                        <span class="comment">\ pixel rows</span>

<span class="label">.fill3</span><a id="fill3" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">fillRowNumber</a>      <span class="comment">\ Set (Q P) to the entry from the screenRowAddrLo and</span>
 <span class="mne">LDA</span> <a class="popup variable">screenRowAddrLo</a>,<span class="register">X</span>  <span class="comment">\ screenRowAddrHi tables for the character row whose</span>
 <span class="mne">STA</span> <a class="popup variable">P</a>                  <span class="comment">\ number is in fillRowNumber</span>
 <span class="mne">LDA</span> <a class="popup variable">screenRowAddrHi</a>,<span class="register">X</span>  <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">Q</a>                  <span class="comment">\ When we are filling the screen buffer, fillRowNumber</span>
                        <span class="comment">\ is 25 + the row number, so we can use this value as a</span>
                        <span class="comment">\ lookup into the screenRowAddrLo and screenRowAddrHi</span>
                        <span class="comment">\ tables, and it will return the corresponding address</span>
                        <span class="comment">\ from the bufferRowAddrLo or bufferRowAddrHi table, to</span>
                        <span class="comment">\ give us the row address in the screen buffer</span>

 <span class="mne">LDX</span> <a class="popup variable">columnCounter</a>      <span class="comment">\ Set X to the number of columns that we need to fill</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set loopCounter = 1 so we only do a maximum of two</span>
 <span class="mne">STA</span> <a class="popup variable">loopCounter</a>        <span class="comment">\ fill stages, to prevent an incorrectly configured fill</span>
                        <span class="comment">\ from filling up more than 64 columns</span>

                        <span class="comment">\ We now fill X character blocks from screen address</span>
                        <span class="comment">\ (Q P) onwards, alternating each pixel row between the</span>
                        <span class="comment">\ pixel bytes in T and U</span>

<span class="label">.fill4</span><a id="fill4" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ Set Y = &FF so we increment Y to zero at the start of</span>
                        <span class="comment">\ the following loop, so we can use it as an index into</span>
                        <span class="comment">\ the block of screen memory starting at (P Q)</span>

<span class="label">.fill5</span><a id="fill5" class="anchor"></a>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the first byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set the first byte in the character block to T</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the second byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set the second byte in the character block to U</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the third byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set the third byte in the character block to T</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the fourth byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set the fourth byte in the character block to U</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the fifth byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set the fifth byte in the character block to T</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the sixth byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set the sixth byte in the character block to U</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the seventh byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set the seventh byte in the character block to T</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the index in Y to point to the eighth byte</span>
                        <span class="comment">\ in the character block</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set the eighth byte in the character block to U</span>
 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">P</a><span class="bracket">)</span>,<span class="register">Y</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the column counter in X</span>

 <span class="mne">BNE</span> <a class="popup destination">fill5</a>              <span class="comment">\ Loop back until we have filled X character blocks</span>

 <span class="mne">DEC</span> <a class="popup variable">loopCounter</a>        <span class="comment">\ Decrement the loop counter</span>

 <span class="mne">BMI</span> <a class="popup destination">fill6</a>              <span class="comment">\ If we have already run two fill loops, jump to fill6</span>
                        <span class="comment">\ to move on to the next row, so we never do more than</span>
                        <span class="comment">\ two fill stages</span>

 <span class="mne">LDX</span> <a class="popup variable">moreColumnsToFill</a>  <span class="comment">\ Set X to the value of moreColumnsToFill, which either</span>
                        <span class="comment">\ has bit 7 set, or contains the number of columns we</span>
                        <span class="comment">\ still need to fill on top of the 32 we just filled</span>

 <span class="mne">BMI</span> <a class="popup destination">fill6</a>              <span class="comment">\ If bit 7 of moreColumnsToFill is set then each row in</span>
                        <span class="comment">\ the fill fits into 256 bytes, so we will have already</span>
                        <span class="comment">\ filled in the required bytes and can jump to fill6 to</span>
                        <span class="comment">\ move on to the next row</span>

 <span class="mne">INC</span> <a class="popup variable">Q</a>                  <span class="comment">\ Increment the high byte of (Q P) to point to the next</span>
                        <span class="comment">\ page in memory</span>

 <span class="mne">JMP</span> <a class="popup destination">fill4</a>              <span class="comment">\ Loop back to fill4 to continue filling along the</span>
                        <span class="comment">\ character row, filling the number of columns in X to</span>
                        <span class="comment">\ take us to the correct total number for the row</span>

<span class="label">.fill6</span><a id="fill6" class="anchor"></a>

 <span class="mne">INC</span> <a class="popup variable">fillRowNumber</a>      <span class="comment">\ Increment the row number to move down to the next</span>
                        <span class="comment">\ character row</span>

 <span class="mne">DEC</span> <a class="popup variable">screenRowCounter</a>   <span class="comment">\ Decrement the row counter</span>

 <span class="mne">BNE</span> <a class="popup destination">fill3</a>              <span class="comment">\ Loop back to fill the next character row until we have</span>
                        <span class="comment">\ filled the number of rows in screenRowCounter</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-p"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#p">P</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-q"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#q">Q</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-u"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#u">U</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-backgroundeven"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/backgroundeven.html">backgroundEven</a> (category: Graphics)</div><div class="summary">Pixel bytes for even pixel rows in the screen background</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-backgroundodd"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/backgroundodd.html">backgroundOdd</a> (category: Graphics)</div><div class="summary">Pixel bytes for odd pixel rows in the screen background</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-columncounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#columncounter">columnCounter</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A counter for the number of columns to fill in the FillScreen routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fill1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/fillscreen.html#fill1">fill1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fill2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/fillscreen.html#fill2">fill2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fill3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/fillscreen.html#fill3">fill3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fill4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/fillscreen.html#fill4">fill4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fill5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/fillscreen.html#fill5">fill5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fill6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/fillscreen.html#fill6">fill6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-fillrownumber"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#fillrownumber">fillRowNumber</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the character row we are currently filling in the FillScreen routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-loopcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#loopcounter">loopCounter</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A general-purpose loop counter</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-morecolumnstofill"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#morecolumnstofill">moreColumnsToFill</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Stores the number of extra columns we need to fill in the FillScreen routine after filling up to 32 columns</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-screenbackground"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#screenbackground">screenBackground</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The type of screen background when clearing the screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-screenrowaddrhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/screenrowaddrhi.html">screenRowAddrHi</a> (category: Graphics)</div><div class="summary">Address lookup table for character rows in screen memory (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-screenrowaddrlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/screenrowaddrlo.html">screenRowAddrLo</a> (category: Screen buffer)</div><div class="summary">Address lookup table for character rows in screen memory (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-screenrowcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#screenrowcounter">screenRowCounter</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">A counter for filling screen rows in the FillScreen routine</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drawobjectstack.html">DrawObjectStack</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/backgroundeven.html">backgroundEven</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
