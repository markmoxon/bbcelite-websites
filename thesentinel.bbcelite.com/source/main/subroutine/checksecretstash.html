<?php
include_once("../../../templates/template_functions.php");
page_header("cracker_protection", "subroutine_checksecretstash.html", "The CheckSecretStash subroutine", "Cracker protection: CheckSecretStash", "Annotated code for the CheckSecretStash subroutine in The Sentinel", "the_sentinel-code", "source_cracker_protection", "subroutine_checksecretstash", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getrowvisibility_part_1_of_2.html">GetRowVisibility (Part 1 of 2)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getrowvisibility_part_2_of_2.html">GetRowVisibility (Part 2 of 2)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">CheckSecretStash</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Cracker protection</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Check whether the secret code stash is correctly set up, as part</span>
             <span class="headerEntry">of the anti-cracker code</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_d.html#header-checksecretstash">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.CheckSecretStash</span><a id="checksecretstash" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">doNotCheckSecret</a>   <span class="comment">\ If bit 7 of doNotCheckSecret is set then jump down to</span>
 <span class="mne">BMI</span> <a class="popup destination">stas2</a>              <span class="comment">\ part 2 of GetRowVisibility to skip checking the secret</span>
                        <span class="comment">\ code stash</span>

                        <span class="comment">\ The following code does a check on the secret entry</span>
                        <span class="comment">\ code for the current landscape to ensure that it</span>
                        <span class="comment">\ matches the entered code in the keyboard input buffer</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If the check fails, then the game restarts by jumping</span>
                        <span class="comment">\ to MainTitleLoop to display the title screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Specifically, the following code checks for four bytes</span>
                        <span class="comment">\ in the secretCodeStash that correspond to the results</span>
                        <span class="comment">\ of the comparisons made in the CheckSecretCode routine</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This ensures that crackers who manage to bypass the</span>
                        <span class="comment">\ CheckSecretCode routine will find that the game</span>
                        <span class="comment">\ restarts, unless they also disable this rather</span>
                        <span class="comment">\ well-hidden check</span>

 <span class="mne">LDA</span> <a class="popup variable">stashOffset</a><span class="operator">-</span><span class="decimal">255</span>,<span class="register">X</span>  <span class="comment">\ We know that X is 255 from the loop above, so this</span>
                        <span class="comment">\ sets A = stashOffset</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The value of stashOffset is set in the SetSecretStash</span>
                        <span class="comment">\ routine during the landscape drawing process, where it</span>
                        <span class="comment">\ is set to a value that is unique and consistent for</span>
                        <span class="comment">\ each individual landscape</span>

                        <span class="comment">\ We now set stashAddr(1 0) to point to the four bytes</span>
                        <span class="comment">\ in the secretCodeStash that correspond to the four</span>
                        <span class="comment">\ comparisons we made for the secret entry code in the</span>
                        <span class="comment">\ CheckSecretCode routine</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Set stashAddr = A + 41</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">41</span>                <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">stashAddr</a>          <span class="comment">\ So that's the low byte</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ Set X = 3 so we can use it to count four bytes in the</span>
                        <span class="comment">\ loop below (as well as in the following calculation)</span>

 <span class="mne">TXA</span>                    <span class="comment">\ Set stashAddr+1 = HI(secretCodeStash) - 3 + 3</span>
 <span class="mne">CLC</span>                    <span class="comment">\                 = HI(secretCodeStash)</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="operator">HI</span><span class="bracket">(</span><a class="popup variable">secretCodeStash</a><span class="bracket">)</span> <span class="operator">-</span> <span class="decimal">3</span>
 <span class="mne">STA</span> <a class="popup variable">stashAddr</a><span class="operator">+</span><span class="decimal">1</span>

                        <span class="comment">\ So we now have the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   stashAddr(1 0) = secretCodeStash + stashOffset + 41</span>
                        <span class="comment">\</span>
                        <span class="comment">\ When the secretCodeStash gets populated in the</span>
                        <span class="comment">\ CheckSecretCode routine, we add one byte for each</span>
                        <span class="comment">\ iteration and comparison in the secret code generation</span>
                        <span class="comment">\ process</span>
                        <span class="comment">\</span>
                        <span class="comment">\ That process starts by performing 38 iterations and</span>
                        <span class="comment">\ storing the results in the secretCodeStash from offset</span>
                        <span class="comment">\ stashOffset to stashOffset + 37</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It then generates the four BCD numbers that make up</span>
                        <span class="comment">\ the secret code, storing the results in the stash from</span>
                        <span class="comment">\ offset stashOffset + 38 to stashOffset + 41</span>
                        <span class="comment">\</span>
                        <span class="comment">\ (And it then generates one more result, but we ignore</span>
                        <span class="comment">\ that)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So stashAddr(1 0) points to the last of those bytes in</span>
                        <span class="comment">\ the secretCodeStash, i.e. the byte at stashOffset + 41</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The value that is stashed in the secretCodeStash is</span>
                        <span class="comment">\ the result of subtracting the entered code from the</span>
                        <span class="comment">\ generated code, which will be zero if they match, and</span>
                        <span class="comment">\ then %01111111 is added to the result (%01111111 being</span>
                        <span class="comment">\ the object flags for the Sentinel, which is all part</span>
                        <span class="comment">\ of the obfuscation of this process)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So if the secretCodeStash contains %01111111, this</span>
                        <span class="comment">\ means that particular byte matched, so if all four</span>
                        <span class="comment">\ bytes at offset stashOffset + 38 to stashOffset + 41</span>
                        <span class="comment">\ equal %01111111, this means the secret code was deemed</span>
                        <span class="comment">\ correct by CheckSecretCode</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set Y = 0 so we can fetch a value from the address in</span>
                        <span class="comment">\ stashAddr(1 0) in the following (we don't change its</span>
                        <span class="comment">\ value)</span>

                        <span class="comment">\ We use X as the loop counter to work through all four</span>
                        <span class="comment">\ bytes, as we set it to 3 above</span>

<span class="label">.stas1</span><a id="stas1" class="anchor"></a>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">stashAddr</a><span class="bracket">)</span>,<span class="register">Y</span>      <span class="comment">\ Fetch the contents of address stashAddr(1 0)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01111111</span>         <span class="comment">\ If it does not match %01111111 then this byte from the</span>
 <span class="mne">BNE</span> <a class="popup destination">talt2</a>              <span class="comment">\ secret code was not matched by the CheckSecretCode</span>
                        <span class="comment">\ routine (so it must have been bypassed by crackers),</span>
                        <span class="comment">\ so jump to MainTitleLoop via talt2 to restart the game</span>

 <span class="mne">DEC</span> <a class="popup variable">stashAddr</a>          <span class="comment">\ Decrement stashAddr(1 0) to point to the previous byte</span>
                        <span class="comment">\ in memory (we decrement as we initialised stashAddr</span>
                        <span class="comment">\ above to point to the last result byte in memory, so</span>
                        <span class="comment">\ this moves on to the next of the four bytes)</span>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the loop counter</span>

 <span class="mne">BPL</span> <a class="popup destination">stas1</a>              <span class="comment">\ Loop back until we have checked all four secret code</span>
                        <span class="comment">\ bytes</span>

                        <span class="comment">\ The four code bytes have now been checked, but we have</span>
                        <span class="comment">\ one more check to do, that of the comparison just</span>
                        <span class="comment">\ before the four bytes</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This comparison would have been between inputBuffer+4</span>
                        <span class="comment">\ and a BCD number from the landscape's sequence of seed</span>
                        <span class="comment">\ numbers</span>
                        <span class="comment">\</span>
                        <span class="comment">\ When the landscape code is entered, it is converted</span>
                        <span class="comment">\ into four BCD numbers in inputBuffer, and the rest of</span>
                        <span class="comment">\ the buffer is padded out with &FF, so inputBuffer+4</span>
                        <span class="comment">\ contains &FF at the point of comparison</span>
                        <span class="comment">\</span>
                        <span class="comment">\ &FF is not a valid BCD number, so it can never match a</span>
                        <span class="comment">\ BCD number from the landscape's sequence of seed</span>
                        <span class="comment">\ numbers, so we know that this comparison can never</span>
                        <span class="comment">\ have matched</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So if stashAddr(1 0) contains %01111111 to indicate a</span>
                        <span class="comment">\ match, then we know that the stash has been modified</span>
                        <span class="comment">\ by a cracker, so we restart the game</span>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">stashAddr</a><span class="bracket">)</span>,<span class="register">Y</span>      <span class="comment">\ Fetch the contents of address stashAddr(1 0)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01111111</span>         <span class="comment">\ If it matches %01111111 then we know the stash has</span>
 <span class="mne">BEQ</span> <a class="popup destination">talt2</a>              <span class="comment">\ been compromised, so jump to MainTitleLoop via talt2</span>
                        <span class="comment">\ to restart the game</span>

 <span class="mne">SEC</span>                    <span class="comment">\ Set bit 7 of doNotCheckSecret so we do not repeat the</span>
 <span class="mne">ROR</span> <a class="popup variable">doNotCheckSecret</a>   <span class="comment">\ secret code check again (at least, until we reach the</span>
                        <span class="comment">\ next landscape)</span>

<span class="label">.stas2</span><a id="stas2" class="anchor"></a>

                        <span class="comment">\ Fall through into part 2 of GetRowVisibility to</span>
                        <span class="comment">\ continue with the visibility calculations</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-donotchecksecret"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#donotchecksecret">doNotCheckSecret</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A flag to control whether we perform the secret code check that's buried in the GetRowVisibility routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-secretcodestash"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/secretcodestash.html">secretCodeStash</a> (category: Landscape)</div><div class="summary">A stash for calculated values for each iteration in the CheckSecretCode routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stas1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/checksecretstash.html#stas1">stas1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stas2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/checksecretstash.html#stas2">stas2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stashaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#stashaddr">stashAddr</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The address of the four bytes in the secretCodeStash that correspond to the landscape's secret code</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stashoffset"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#stashoffset">stashOffset</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The offset into the secretCodeStash where we store a set of generated values for later checking in the GetRowVisibility routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-talt2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Entry point <a href="/source/main/subroutine/gettilealtitudes.html#talt2">talt2</a> in subroutine <a href="/source/main/subroutine/gettilealtitudes.html">GetTileAltitudes</a> (category: Drawing the landscape)</div><div class="summary">Jump to MainTitleLoop via game10</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getrowvisibility_part_1_of_2.html">GetRowVisibility (Part 1 of 2)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getrowvisibility_part_2_of_2.html">GetRowVisibility (Part 2 of 2)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
