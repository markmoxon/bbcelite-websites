<?php
include_once("../../../templates/template_functions.php");
page_header("sights", "subroutine_initialisesights.html", "The InitialiseSights subroutine", "Sights: InitialiseSights", "Annotated code for the InitialiseSights subroutine in The Sentinel", "the_sentinel-code", "source_sights", "subroutine_initialisesights", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/resetscreenaddress.html">ResetScreenAddress</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/scanforgamekeys.html">ScanForGameKeys</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">InitialiseSights</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Sights</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Initialise the variables used to manage the sights, so the sights</span>
             <span class="headerEntry">appear in the middle of the screen</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_b.html#header-initialisesights">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkforkeypresses.html">CheckForKeyPresses</a> calls <a href="#initialisesights">InitialiseSights</a></span>
</div>
</div></div>
<span class="label">.InitialiseSights</span><a id="initialisesights" class="anchor"></a>

                        <span class="comment">\ We start by calculating the screen address for the</span>
                        <span class="comment">\ sights when they are in the middle of the screen,</span>
                        <span class="comment">\ which is where we initialise them</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The base screen address has already been set up in</span>
                        <span class="comment">\ viewScreenAddr(1 0), and we want to place the sights</span>
                        <span class="comment">\ halfway down and halfway across the screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The custom screen mode 5 used by the game contains 25</span>
                        <span class="comment">\ character rows, each of which is eight pixels high</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The top character row is used for the energy icon and</span>
                        <span class="comment">\ scanner, and viewScreenAddr(1 0) points to the start</span>
                        <span class="comment">\ of screen memory just below this top row, so the</span>
                        <span class="comment">\ player's view is 24 character rows high and row 12 is</span>
                        <span class="comment">\ halfway down the screen</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Each character row in screen mode 5 takes up 320 bytes</span>
                        <span class="comment">\ (40 character blocks of eight bytes each), so the</span>
                        <span class="comment">\ offset within screen memory of the start of row 12 is</span>
                        <span class="comment">\ 12 * 320, and we can move halfway along that row by</span>
                        <span class="comment">\ adding a further 160, so that's an offset of:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   12 * 320 + 160 = 4000</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So the address of the sights in screen memory is:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   viewScreenAddr(1 0) + 4000</span>
                        <span class="comment">\</span>
                        <span class="comment">\ which is what we calculate now</span>

 <span class="mne">LDA</span> <a class="popup variable">viewScreenAddr</a>     <span class="comment">\ Calculate the following:</span>
 <span class="mne">CLC</span>                    <span class="comment">\</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&A0</span>               <span class="comment">\   (A sightsScreenAddr) = viewScreenAddr(1 0) + &0FA0</span>
 <span class="mne">STA</span> <a class="popup variable">sightsScreenAddr</a>   <span class="comment">\                        = viewScreenAddr(1 0) + 4000</span>
                        <span class="comment">\</span>
                        <span class="comment">\ starting with the low bytes</span>

 <span class="mne">LDA</span> <a class="popup variable">viewScreenAddr</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ And then the high bytes</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&0F</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&80</span>               <span class="comment">\ If the high byte in A >= &80 then the new address is</span>
 <span class="mne">BCC</span> <a class="popup destination">sesi1</a>              <span class="comment">\ past the end of screen memory, so subtract &20 from</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\ the high byte so the address wraps around within the</span>
                        <span class="comment">\ range of screen memory between &6000 and &8000</span>

<span class="label">.sesi1</span><a id="sesi1" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">sightsScreenAddr</a><span class="operator">+</span><span class="decimal">1</span> <span class="comment">\ Store the high byte of the result, so we now have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sightsScreenAddr(1 0) = viewScreenAddr(1 0) + 4000</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">80</span>                <span class="comment">\ Set the on-screen x-coordinate of the sights to 80,</span>
 <span class="mne">STA</span> <a class="popup variable">xSights</a>            <span class="comment">\ which is in the middle of the 160-pixel wide screen</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">95</span>                <span class="comment">\ Set the on-screen y-coordinate of the sights to 95,</span>
 <span class="mne">STA</span> <a class="popup variable">ySights</a>            <span class="comment">\ which is in the middle of the 192-pixel high player's</span>
                        <span class="comment">\ view (which is the whole screen apart from the energy</span>
                        <span class="comment">\ icon and scanner row at the top)</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sesi1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/initialisesights.html#sesi1">sesi1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsscreenaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#sightsscreenaddr">sightsScreenAddr</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The screen address of the sights</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-viewscreenaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#viewscreenaddr">viewScreenAddr</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The screen address of the player's scrolling landscape view, which is just below the icon and scanner row at the top of the screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xsights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#xsights">xSights</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The pixel x-coordinate of the sights on-screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ysights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#ysights">ySights</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The pixel y-coordinate of the sights on-screen</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/resetscreenaddress.html">ResetScreenAddress</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/scanforgamekeys.html">ScanForGameKeys</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
