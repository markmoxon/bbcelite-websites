<?php
include_once("../../../templates/template_functions.php");
page_header("maths_geometry", "subroutine_getrotationmatrix_part_3_of_5.html", "The GetRotationMatrix (Part 3 of 5) subroutine", "Maths (Geometry): GetRotationMatrix (Part 3 of 5)", "Annotated code for the GetRotationMatrix (Part 3 of 5) subroutine in The Sentinel", "the_sentinel-code", "source_maths_geometry", "subroutine_getrotationmatrix_part_3_of_5", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getrotationmatrix_part_2_of_5.html">GetRotationMatrix (Part 2 of 5)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getrotationmatrix_part_4_of_5.html">GetRotationMatrix (Part 4 of 5)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetRotationMatrix (Part 3 of 5)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate sin(H G) for bigger angles</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_a.html#header-getrotationmatrix-part-3-of-5">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.rotm3</span><a id="rotm3" class="anchor"></a>

                        <span class="comment">\ If we get here then (H G) = yawRadians / 2 and</span>
                        <span class="comment">\ H >= 122</span>

                        <span class="comment">\ PI is represented by 804, as 804 / 256 = 3.14, so 201</span>
                        <span class="comment">\ represents PI/4, which we use in the following</span>
                        <span class="comment">\ subtraction</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set (U T) = (201 0) - (H G)</span>
 <span class="mne">SEC</span>                    <span class="comment">\           = PI/4 - yawRadians / 2</span>
 <span class="mne">SBC</span> <a class="popup variable">G2</a>                 <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ starting with the low bytes</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">201</span>               <span class="comment">\ And then the high bytes</span>
 <span class="mne">SBC</span> <a class="popup variable">H2</a>
 <span class="mne">STA</span> <a class="popup variable">U</a>

 <span class="mne">STA</span> <a class="popup variable">V</a>                  <span class="comment">\ Set (V T) = (U T)</span>
                        <span class="comment">\           = PI/4 - yawRadians / 2</span>

 <span class="mne">JSR</span> <a class="popup destination">Multiply8x16</a>       <span class="comment">\ Set (U T) = U * (V T) / 256</span>
                        <span class="comment">\           = U * (PI/4 - yawRadians / 2)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ U is the high byte of (U T), which also contains</span>
                        <span class="comment">\ PI/4 - yawRadians / 2, so this approximation holds</span>
                        <span class="comment">\ true:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (U T) = U * (PI/4 - yawRadians / 2)</span>
                        <span class="comment">\         =~ (PI/4 - yawRadians / 2) ^ 2</span>

 <span class="mne">ASL</span> <a class="popup variable">T</a>                  <span class="comment">\ Set (U T) = (U T) * 2</span>
 <span class="mne">ROL</span> <a class="popup variable">U</a>                  <span class="comment">\           = (PI/4 - yawRadians / 2) ^ 2 * 2</span>

                        <span class="comment">\ By this point we have the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (U T) = (PI/4 - yawRadians / 2) ^ 2 * 2</span>
                        <span class="comment">\         = ((PI/2 - yawRadians) / 2) ^ 2 * 2</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If we define x = PI/2 - yawRadians, then we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (U T) = (x / 2) ^ 2 * 2</span>
                        <span class="comment">\         = ((x ^ 2) / (2 ^ 2)) * 2</span>
                        <span class="comment">\         = (x ^ 2) / 2</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The small angle approximation states that for small</span>
                        <span class="comment">\ values of x, the following approximation holds true:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(x) =~ 1 - (x ^ 2) / 2!</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As yawRadians is large, this means x is small, so we</span>
                        <span class="comment">\ can use this approximation</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We are storing the cosine, which is in the range 0 to</span>
                        <span class="comment">\ 1, in the 16-bit variable (U T), so in terms of 16-bit</span>
                        <span class="comment">\ arithmetic, the 1 in the above equation is (1 0 0)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this is the same as:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(x) =~ (1 0 0) - (x ^ 2) / 2!</span>
                        <span class="comment">\          =  (1 0 0) - (U T)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It's a trigonometric identity that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(PI/2 - x) = sin(x)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ so we have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(x) = cos(PI/2 - yawRadians)</span>
                        <span class="comment">\          = sin(yawRadians)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and we already calculated that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   cos(x) =~ (1 0 0) - (U T)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ so that means that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sin(yawRadians) = cos(x)</span>
                        <span class="comment">\                   =~ (1 0 0) - (U T)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So we just need to calculate (1 0 0) - (U T) to get</span>
                        <span class="comment">\ our result</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set A = (1 0 0) - (U T)</span>
 <span class="mne">SEC</span>                    <span class="comment">\</span>
 <span class="mne">SBC</span> <a class="popup variable">T</a>                  <span class="comment">\ starting with the low bytes</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%11111110</span>         <span class="comment">\ Which we store in sinAngleLo, with bit 0 cleared to</span>
 <span class="mne">STA</span> <a class="popup variable">sinAngleLo</a>,<span class="register">X</span>       <span class="comment">\ denote a positive result (as it's a sign-magnitude</span>
                        <span class="comment">\ number we want to store)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ And then the high bytes</span>
 <span class="mne">SBC</span> <a class="popup variable">U</a>

 <span class="mne">BCC</span> <a class="popup destination">rotm4</a>              <span class="comment">\ We now need to subtract the top bytes, i.e. the 1 in</span>
                        <span class="comment">\ (1 0 0) and the 0 in (0 U T), while including the</span>
                        <span class="comment">\ carry from the high byte subtraction</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So the top byte should be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   A = 1 - 0 - (1 - C)</span>
                        <span class="comment">\     = 1 - (1 - C)</span>
                        <span class="comment">\     = C</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If the C flag is clear, then that means the top byte</span>
                        <span class="comment">\ is zero, so we already have a valid result from the</span>
                        <span class="comment">\ high and low bytes, so we jump to rotm4 to store the</span>
                        <span class="comment">\ high byte of the result in sinAngleHi</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If the C flag is set, then the result is (1 A T), but</span>
                        <span class="comment">\ the highest possible value for sin or cos is 1, so</span>
                        <span class="comment">\ that's what we return</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Because sinAngle is a sign-magnitude number with</span>
                        <span class="comment">\ the sign bit in bit 0, we return the following value</span>
                        <span class="comment">\ to represent the closest value to 1 that we can fit</span>
                        <span class="comment">\ into 16 bits:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (11111111 11111110)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%11111110</span>         <span class="comment">\ Set sinAngleLo to the highest possible positive</span>
 <span class="mne">STA</span> <a class="popup variable">sinAngleLo</a>,<span class="register">X</span>       <span class="comment">\ value (i.e. all ones except for the sign in bit 0)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="binary">%11111111</span>         <span class="comment">\ Set A to the highest possible value of sinAngleHi,</span>
                        <span class="comment">\ so we can store it in the next instruction</span>

<span class="label">.rotm4</span><a id="rotm4" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">sinAngleHi</a>,<span class="register">X</span>       <span class="comment">\ Store A in the high byte in sinAngleHi</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-g2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#g2">G2</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Temporary storage, used in the maths routines from Revs, where the original variable name was G (this variable has been renamed to G2 to prevent a clash with the G variable that is used by The Sentinel)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-h2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#h2">H2</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Temporary storage, used in the maths routines from Revs, where the original variable name was H (this variable has been renamed to H2 to prevent a clash with the H variable that is used by The Sentinel)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-multiply8x16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/multiply8x16.html">Multiply8x16</a> (category: Maths (Arithmetic))</div><div class="summary">Multiply an 8-bit and a 16-bit number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-u"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#u">U</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-v"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#v">V</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rotm4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrotationmatrix_part_3_of_5.html#rotm4">rotm4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sinanglehi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#sinanglehi">sinAngleHi</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The high byte of the sine of a pitch or yaw angle, as calculated by the GetRotationMatrix routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sinanglelo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#sinanglelo">sinAngleLo</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The low byte of the sine of a pitch or yaw angle, as calculated by the GetRotationMatrix routine</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getrotationmatrix_part_2_of_5.html">GetRotationMatrix (Part 2 of 5)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getrotationmatrix_part_4_of_5.html">GetRotationMatrix (Part 4 of 5)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
