<?php
include_once("../../../templates/template_functions.php");
page_header("gameplay", "subroutine_findobjecttodrain.html", "The FindObjectToDrain subroutine", "Gameplay: FindObjectToDrain", "Annotated code for the FindObjectToDrain subroutine in The Sentinel", "the_sentinel-code", "source_gameplay", "subroutine_findobjecttodrain", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/finishlandscape.html">FinishLandscape</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/abortwhenvisible.html">AbortWhenVisible</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">FindObjectToDrain</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Find a suitable target object for an enemy to drain</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-findobjecttodrain">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_4_of_8.html">ApplyTactics (Part 4 of 8)</a> calls <a href="#findobjecttodrain">FindObjectToDrain</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_5_of_8.html">ApplyTactics (Part 5 of 8)</a> calls <a href="#findobjecttodrain">FindObjectToDrain</a></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">viewingObject</span>        <span class="argumentEntry">The viewing object (i.e. the enemy doing the scanning)</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag:</span>

                        <span class="argumentEntry">  * Clear if we have found an object that is a suitable</span>
                        <span class="argumentEntry">    target for the enemy to drain (i.e. a tree that is</span>
                        <span class="argumentEntry">    stacked on top of another object, or a boulder,</span>
                        <span class="argumentEntry">    which is exposed to the enemy and on a tile that can</span>
                        <span class="argumentEntry">    be seen by the enemy)</span>

                        <span class="argumentEntry">  * Set if no objects of them are suitable targets for</span>
                        <span class="argumentEntry">    the enemy to drain</span>

   <span class="argumentLabel">targetObject</span>         <span class="argumentEntry">The number of the target object (if the C flag is set)</span>

</div></div>
<span class="label">.FindObjectToDrain</span><a id="findobjecttodrain" class="anchor"></a>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">63</span>                <span class="comment">\ Set a counter in X to work through the object numbers</span>
                        <span class="comment">\ until we find a suitable tree or boulder that can be</span>
                        <span class="comment">\ seen by the viewing object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that we only call this routine with the viewing</span>
                        <span class="comment">\ object set to the enemy that we are processing in the</span>
                        <span class="comment">\ ApplyTactics routine, so I'll refer to the viewing</span>
                        <span class="comment">\ object as the enemy in the following to make it</span>
                        <span class="comment">\ easier to follow</span>

<span class="label">.dran1</span><a id="dran1" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">X</span>      <span class="comment">\ Set A to the object flags for object #X, which are</span>
                        <span class="comment">\ stored in the X-th entry in the objectFlags table</span>

 <span class="mne">BMI</span> <a class="popup destination">dran4</a>              <span class="comment">\ If bit 7 of object flags for object #X is set then</span>
                        <span class="comment">\ this object number is not yet allocated to an object,</span>
                        <span class="comment">\ so jump to dran4 to move on to the next object number</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%01000000</span>         <span class="comment">\ If bit 6 of the object flags for object #X is set</span>
 <span class="mne">BCS</span> <a class="popup destination">dran2</a>              <span class="comment">\ then object #X is stacked on top of another object,</span>
                        <span class="comment">\ so jump to dran2 to keep checking as this is a</span>
                        <span class="comment">\ potential target</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ If object #X is not a boulder (an object of type 3)</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ then jump to dran4 to move on to the next object</span>
 <span class="mne">BNE</span> <a class="popup destination">dran4</a>              <span class="comment">\ number</span>

<span class="label">.dran2</span><a id="dran2" class="anchor"></a>

                        <span class="comment">\ If we get here then object #X is either a boulder or</span>
                        <span class="comment">\ it is an object that is stacked on top of another</span>
                        <span class="comment">\ object</span>

 <span class="mne">LDA</span> <a class="popup variable">xObject</a>,<span class="register">X</span>          <span class="comment">\ Set (xTile, zTile) to the tile coordinates of the</span>
 <span class="mne">STA</span> <a class="popup variable">xTile</a>              <span class="comment">\ tile containing object #X</span>
 <span class="mne">LDA</span> <a class="popup variable">zObject</a>,<span class="register">X</span>
 <span class="mne">STA</span> <a class="popup variable">zTile</a>

 <span class="mne">JSR</span> <a class="popup destination">GetTileData</a>        <span class="comment">\ Set A to the tile data for the tile anchored at</span>
                        <span class="comment">\ (xTile, zTile), setting the C flag if the tile</span>
                        <span class="comment">\ contains an object</span>

 <span class="mne">BCC</span> <a class="popup destination">dran4</a>              <span class="comment">\ If the C flag is clear then this tile does not already</span>
                        <span class="comment">\ have an object placed on it, so jump to dran4 to move</span>
                        <span class="comment">\ on to the next object number</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00111111</span>         <span class="comment">\ Because the tile has an object on it, the tile data</span>
 <span class="mne">TAY</span>                    <span class="comment">\ contains the number of the top object on the tile in</span>
                        <span class="comment">\ bits 0 to 5, so extract the object number into Y (so</span>
                        <span class="comment">\ object #Y is either directly on the tile or is on the</span>
                        <span class="comment">\ top of the stack, so in either case it is the exposed</span>
                        <span class="comment">\ object in terms of potential targets)</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">Y</span>      <span class="comment">\ Set A to the type of object that's exposed on the tile</span>
                        <span class="comment">\ (i.e. the type of object #Y)</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ If the exposed object is a tree (an object of type 2),</span>
 <span class="mne">BEQ</span> <a class="popup destination">dran3</a>              <span class="comment">\ jump to dran3 to keep checking as this is a potential</span>
                        <span class="comment">\ target</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ If the exposed object is a boulder (an object of</span>
 <span class="mne">BNE</span> <a class="popup destination">dran4</a>              <span class="comment">\ type 3), jump to dran4 to move on to the next object</span>
                        <span class="comment">\ number</span>

<span class="label">.dran3</span><a id="dran3" class="anchor"></a>

                        <span class="comment">\ If we get here then object #Y is either a boulder or</span>
                        <span class="comment">\ it is a tree that is stacked on top of another object,</span>
                        <span class="comment">\ and it is exposed as a potential target, so now we</span>
                        <span class="comment">\ check whether the enemy can see the object's tile (and</span>
                        <span class="comment">\ therefore whether it can be drained of energy by the</span>
                        <span class="comment">\ enemy)</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckEnemyGaze</a>     <span class="comment">\ Call CheckEnemyGaze to check the gaze of the enemy</span>
                        <span class="comment">\ towards object #Y, returning the following if the</span>
                        <span class="comment">\ the object matches the object type in A:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * targetVisibility = bit 7 set if the object's tile</span>
                        <span class="comment">\     is visible, bit 6 set if the object is visible</span>

 <span class="mne">LDA</span> <a class="popup variable">targetVisibility</a>   <span class="comment">\ If bit 7 of targetVisibility is clear then the enemy</span>
 <span class="mne">BPL</span> <a class="popup destination">dran4</a>              <span class="comment">\ can't see the exposed object's tile, so jump to dran4</span>
                        <span class="comment">\ to move on to the next object number</span>

                        <span class="comment">\ If we get here then object #Y's tile can be seen by</span>
                        <span class="comment">\ the enemy, so it is a suitable target for draining</span>

 <span class="mne">STY</span> <a class="popup variable">targetObject</a>       <span class="comment">\ Set targetObject to the object number in Y</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that the enemy can see a</span>
                        <span class="comment">\ drainable tree or boulder</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.dran4</span><a id="dran4" class="anchor"></a>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the counter in X to move on to the next</span>
                        <span class="comment">\ object number</span>

 <span class="mne">BPL</span> <a class="popup destination">dran1</a>              <span class="comment">\ Loop back to dran1 to check the next object number</span>

 <span class="mne">SEC</span>                    <span class="comment">\ If we get here then we have checked all 64 object</span>
                        <span class="comment">\ numbers and none of them are suitable targets for the</span>
                        <span class="comment">\ enemy to drain, so set the C flag to indicate this</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkenemygaze"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/checkenemygaze_part_1_of_2.html">CheckEnemyGaze (Part 1 of 2)</a> (category: Gameplay)</div><div class="summary">Check to see whether the current enemy can see a specific target object of a specific type</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettiledata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/gettiledata.html">GetTileData</a> (category: Landscape)</div><div class="summary">Get the tile data and tile data address for a specific tile</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/findobjecttodrain.html#dran1">dran1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/findobjecttodrain.html#dran2">dran2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/findobjecttodrain.html#dran3">dran3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dran4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/findobjecttodrain.html#dran4">dran4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objecttypes"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/objecttypes.html">objectTypes</a> (category: 3D objects)</div><div class="summary">The object types table for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-targetobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#targetobject">targetObject</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The number of the object that is being targeted in the DrainObjectEnergy routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-targetvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#targetvisibility">targetVisibility</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Reports whether a target object is visible from an enemy in the CheckEnemyGaze routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xobject.html">xObject</a> (category: 3D objects)</div><div class="summary">The x-coordinates in 3D space for the 3D objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtile">xTile</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Tile corner x-coordinate</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-zobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/zobject.html">zObject</a> (category: 3D objects)</div><div class="summary">The z-coordinates in 3D space for the 3D objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ztile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#ztile">zTile</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Tile corner z-coordinate</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/finishlandscape.html">FinishLandscape</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/abortwhenvisible.html">AbortWhenVisible</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
