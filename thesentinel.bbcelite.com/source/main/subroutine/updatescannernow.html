<?php
include_once("../../../templates/template_functions.php");
page_header("scanner_energy_row", "subroutine_updatescannernow.html", "The UpdateScannerNow subroutine", "Scanner/energy row: UpdateScannerNow", "Annotated code for the UpdateScannerNow subroutine in The Sentinel", "the_sentinel-code", "source_scanner_energy_row", "subroutine_updatescannernow", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/updatescanner.html">UpdateScanner</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/scannerstatic.html">scannerStatic</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">UpdateScannerNow</span>                                        <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Scanner/energy row</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Update the scanner to a new state</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_b.html#header-updatescannernow">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processpausekeys.html">ProcessPauseKeys</a> calls <a href="#updatescannernow">UpdateScannerNow</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/updatescanner.html">UpdateScanner</a> calls <a href="#updatescannernow">UpdateScannerNow</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/updatescanner.html">UpdateScanner</a> calls via <a href="#scan6">scan6</a></span></span>
</div>
<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">A</span>                    <span class="argumentEntry">The new state of the scanner:</span>

                        <span class="argumentEntry">  * 0 = fill scanner with black</span>

                        <span class="argumentEntry">  * 4 = fill the scanner with static in colour 3</span>

                        <span class="argumentEntry">  * 8 = fill scanner with green</span>

<hr class="light">
<span class="subheader"> Other entry points:</span>

   <span class="argumentLabel">scan6</span>                <span class="argumentEntry">Contains an RTS</span>

</div></div>
<span class="label">.UpdateScannerNow</span><a id="updatescannernow" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">lastScannerState</a>   <span class="comment">\ Store the new state of the scanner in lastScannerState</span>
                        <span class="comment">\ so we can use this to check for when the scanner state</span>
                        <span class="comment">\ changes in the future</span>

 <span class="mne">STA</span> <a class="popup variable">scannerState</a>       <span class="comment">\ Store the new state of the scanner in scannerState so</span>
                        <span class="comment">\ we can refer to it (and possibly change it) during the</span>
                        <span class="comment">\ routine</span>

                        <span class="comment">\ We start by calculating the screen address of the</span>
                        <span class="comment">\ scanner, which is 79 bytes before the start of the</span>
                        <span class="comment">\ player's scrolling landscape view (79 bytes represents</span>
                        <span class="comment">\ ten character blocks of eight bytes each, less one</span>
                        <span class="comment">\ byte, so the scanner address is the second pixel row</span>
                        <span class="comment">\ in the character block that's ten blocks from the</span>
                        <span class="comment">\ right end of the energy icon and scanner row at the</span>
                        <span class="comment">\ top of the screen (the top pixel row contains the</span>
                        <span class="comment">\ scanner box border)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ viewScreenAddr(1 0) contains the address of the</span>
                        <span class="comment">\ latter, so we can simply subtract 79</span>

 <span class="mne">LDA</span> <a class="popup variable">viewScreenAddr</a>     <span class="comment">\ Set (A screenAddr) = viewScreenAddr(1 0) - &004F</span>
 <span class="mne">SEC</span>                    <span class="comment">\                    = viewScreenAddr(1 0) - 79</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&4F</span>
 <span class="mne">STA</span> <a class="popup variable">screenAddr</a>
 <span class="mne">LDA</span> <a class="popup variable">viewScreenAddr</a><span class="operator">+</span><span class="decimal">1</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&00</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&60</span>               <span class="comment">\ If the high byte in A &lt; &60 then the new address is</span>
 <span class="mne">BCS</span> <a class="popup destination">scan1</a>              <span class="comment">\ before the start of screen memory, so add &20 to the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\ high byte so the address wraps around within the range</span>
                        <span class="comment">\ of screen memory between &6000 and &8000</span>

<span class="label">.scan1</span><a id="scan1" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">screenAddr</a><span class="operator">+</span><span class="decimal">1</span>       <span class="comment">\ Store the high byte of the result, so we now have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   screenAddr(1 0) = viewScreenAddr(1 0) - 79</span>
                        <span class="comment">\</span>
                        <span class="comment">\ with the address wrapped around as required</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">8</span>                 <span class="comment">\ The inside portion of the scanner consists of eight</span>
 <span class="mne">STA</span> <a class="popup variable">scannerBlock</a>       <span class="comment">\ character blocks (the box edges on either side are</span>
                        <span class="comment">\ outside of these eight blocks), so set scannerBlock</span>
                        <span class="comment">\ to 8 so we can use it to count through the character</span>
                        <span class="comment">\ blocks as we draw the scanner</span>
<span class="label">.scan2</span><a id="scan2" class="anchor"></a>

                        <span class="comment">\ Each character block contains one pixel row at the top</span>
                        <span class="comment">\ for the top scanner box edge, then four pixel rows of</span>
                        <span class="comment">\ scanner content, followed by another pixel row for the</span>
                        <span class="comment">\ bottom scanner box edge</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now draw the four pixel rows of scanner content,</span>
                        <span class="comment">\ avoiding drawing over the top and bottom edges</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ Set Y = 3 to use as a counter for drawing four pixel</span>
                        <span class="comment">\ rows in the drawing loop</span>

 <span class="mne">JSR</span> <a class="popup destination">GetRandomNumber</a>    <span class="comment">\ Set A to a random number to seed the drawing loop, of</span>
                        <span class="comment">\ which we use two bits for each of the four pixel bytes</span>
                        <span class="comment">\ we draw</span>

 <span class="mne">JMP</span> <a class="popup destination">scan4</a>              <span class="comment">\ Jump to scan4 to join the drawing loop</span>

<span class="label">.scan3</span><a id="scan3" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">scannerStatic</a>      <span class="comment">\ Shift the random number in scannerStatic to the right</span>
 <span class="mne">LSR</span> <span class="register">A</span>                  <span class="comment">\ by two places</span>
 <span class="mne">LSR</span> <span class="register">A</span>

<span class="label">.scan4</span><a id="scan4" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">scannerStatic</a>      <span class="comment">\ Store the random number in scannerStatic (on the first</span>
                        <span class="comment">\ iteration this is the full random number, while on</span>
                        <span class="comment">\ subsequent iterations the number is shifted right by</span>
                        <span class="comment">\ two places on each loop)</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000011</span>         <span class="comment">\ Extract bits 0 and 1 from the random number, so we</span>
                        <span class="comment">\ get two different random bits on each iteration and</span>
                        <span class="comment">\ a value of A in the range 0 to 3</span>

 <span class="mne">ORA</span> <a class="popup variable">scannerState</a>       <span class="comment">\ Add the scanner state to the two random bits to get</span>
                        <span class="comment">\ the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If scannerState = 0 then this leaves A in the</span>
                        <span class="comment">\     range 0 to 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If scannerState = 4 then this sets A into the</span>
                        <span class="comment">\     range 4 to 7</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If scannerState = 8 then this sets A into the</span>
                        <span class="comment">\     range 8 to 11</span>

 <span class="mne">TAX</span>                    <span class="comment">\ Copy A into X so we can use it as an index into the</span>
                        <span class="comment">\ scannerPixelByte table</span>

 <span class="mne">LDA</span> <a class="popup variable">scannerPixelByte</a>,<span class="register">X</span> <span class="comment">\ Set A to the X-th pixel byte from the relevant part of</span>
                        <span class="comment">\ the scannerPixelByte lookup table, which will return a</span>
                        <span class="comment">\ pixel byte containing black, random static or green,</span>
                        <span class="comment">\ according to the value of scannerState</span>

 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">screenAddr</a><span class="bracket">)</span>,<span class="register">Y</span>     <span class="comment">\ Draw the Y-th pixel row for this character block in</span>
                        <span class="comment">\ the scanner</span>

 <span class="mne">DEY</span>                    <span class="comment">\ Decrement the pixel row counter in Y</span>

 <span class="mne">BPL</span> <a class="popup destination">scan3</a>              <span class="comment">\ Loop back to scan3 to draw the next pixel row until we</span>
                        <span class="comment">\ have drawn all four pixel rows</span>

                        <span class="comment">\ We now move along the scanner to draw the next</span>
                        <span class="comment">\ character block to the right</span>

 <span class="mne">LDA</span> <a class="popup variable">screenAddr</a>         <span class="comment">\ Set (A screenAddr) = screenAddr(1 0) + 8</span>
 <span class="mne">CLC</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&08</span>
 <span class="mne">STA</span> <a class="popup variable">screenAddr</a>
 <span class="mne">LDA</span> <a class="popup variable">screenAddr</a><span class="operator">+</span><span class="decimal">1</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&00</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&80</span>               <span class="comment">\ If the high byte in A >= &80 then the new address is</span>
 <span class="mne">BCC</span> <a class="popup destination">scan5</a>              <span class="comment">\ past the end of screen memory, so subtract &20 from</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\ the high byte so the address wraps around within the</span>
                        <span class="comment">\ range of screen memory between &6000 and &8000</span>

<span class="label">.scan5</span><a id="scan5" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">screenAddr</a><span class="operator">+</span><span class="decimal">1</span>       <span class="comment">\ Store the high byte of the result, so we now have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   screenAddr(1 0) = screenAddr(1 0) + 8</span>
                        <span class="comment">\</span>
                        <span class="comment">\ with the address wrapped around as required</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This updates screenAddr(1 0) to point to the next</span>
                        <span class="comment">\ character block to the right, so we move along the</span>
                        <span class="comment">\ scanner</span>

 <span class="mne">DEC</span> <a class="popup variable">scannerBlock</a>       <span class="comment">\ Decrement scannerBlock to move on to the next block</span>
                        <span class="comment">\ in the scanner</span>

 <span class="mne">BEQ</span> <a class="popup destination">scan6</a>              <span class="comment">\ If we have drawn all eight columns, jump to scan6 to</span>
                        <span class="comment">\ return</span>

 <span class="mne">LDA</span> <a class="popup variable">scannerBlock</a>       <span class="comment">\ If scannerBlock &lt;> 4 then loop back to scan2 to keep</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ drawing the scanner</span>
 <span class="mne">BNE</span> <a class="popup destination">scan2</a>

                        <span class="comment">\ If we get here then scannerBlock = 4, so we have drawn</span>
                        <span class="comment">\ the left half of the scanner</span>

 <span class="mne">LDA</span> <a class="popup variable">playerTileIsHidden</a> <span class="comment">\ If playerTileIsHidden &lt;> 64 then the player's tile is</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">64</span>                <span class="comment">\ not hidden from the Sentinel or sentry doing the scan,</span>
 <span class="mne">BNE</span> <a class="popup destination">scan2</a>              <span class="comment">\ so loop back to scan2 to keep drawing the scanner</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ If we get here then playerTileIsHidden = 64, so the</span>
 <span class="mne">STA</span> <a class="popup variable">scannerState</a>       <span class="comment">\ player's tile is hidden from the Sentinel or sentry</span>
                        <span class="comment">\ doing the scan</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We represent this by only filling the left half of the</span>
                        <span class="comment">\ scanner and leaving the right half blank, so set</span>
                        <span class="comment">\ scannerState to zero so the rest of the fill routine</span>
                        <span class="comment">\ fills the right half with black</span>

 <span class="mne">BEQ</span> <a class="popup destination">scan2</a>              <span class="comment">\ Jump back to scan2 to keep drawing the scanner (this</span>
                        <span class="comment">\ BEQ is effectively a JMP as A is always zero)</span>

<span class="label">.scan6</span><a id="scan6" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getrandomnumber"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/getrandomnumber.html">GetRandomNumber</a> (category: Maths (Arithmetic))</div><div class="summary">Set A to a random number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-lastscannerstate"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#lastscannerstate">lastScannerState</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The state of the scanner the last time that it was updated</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playertileishidden"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#playertileishidden">playerTileIsHidden</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A flag that records when the player is being scanned but the player's tile is hidden from the Sentinel or sentry doing the scan</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scan1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/updatescannernow.html#scan1">scan1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scan2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/updatescannernow.html#scan2">scan2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scan3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/updatescannernow.html#scan3">scan3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scan4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/updatescannernow.html#scan4">scan4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scan5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/updatescannernow.html#scan5">scan5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scan6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Entry point <a href="/source/main/subroutine/updatescannernow.html#scan6">scan6</a> in subroutine <a href="/source/main/subroutine/updatescannernow.html">UpdateScannerNow</a> (category: Scanner/energy row)</div><div class="summary">Contains an RTS</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scannerblock"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/scannerblock.html">scannerBlock</a> (category: Scanner/energy row)</div><div class="summary">A counter for the eight character blocks that make up the scanner</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scannerpixelbyte"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/scannerpixelbyte.html">scannerPixelByte</a> (category: Scanner/energy row)</div><div class="summary">Pixel bytes for the three states of the scanner (black, static and green)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scannerstate"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/scannerstate.html">scannerState</a> (category: Scanner/energy row)</div><div class="summary">The current state of the scanner (black, static or green)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scannerstatic"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/scannerstatic.html">scannerStatic</a> (category: Scanner/energy row)</div><div class="summary">Storage for a random number that's used to generate static in the scanner</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-screenaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#screenaddr">screenAddr</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Storage for a screen address</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-viewscreenaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#viewscreenaddr">viewScreenAddr</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The screen address of the player's scrolling landscape view, which is just below the icon and scanner row at the top of the screen</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/updatescanner.html">UpdateScanner</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/scannerstatic.html">scannerStatic</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
