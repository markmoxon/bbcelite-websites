<?php
include_once("../../../templates/template_functions.php");
page_header("drawing_the_landscape", "subroutine_drawlandscapeview_part_3_of_3.html", "The DrawLandscapeView (Part 3 of 3) subroutine", "Drawing the landscape: DrawLandscapeView (Part 3 of 3)", "Annotated code for the DrawLandscapeView (Part 3 of 3) subroutine in The Sentinel", "the_sentinel-code", "source_drawing_the_landscape", "subroutine_drawlandscapeview_part_3_of_3", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html">DrawLandscapeView (Part 2 of 3)</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/quadrantoffsets.html">quadrantOffsets</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">DrawLandscapeView (Part 3 of 3)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Drawing the landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Draw a tile row in two parts, one on either side of the viewer</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_e.html#header-drawlandscapeview-part-3-of-3">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.dlan18</span><a id="dlan18" class="anchor"></a>

                        <span class="comment">\ If we get here then the tile row we are drawing</span>
                        <span class="comment">\ contains the viewer</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The viewer can only see one half of the row, because</span>
                        <span class="comment">\ they are standing on it, so we need to work out which</span>
                        <span class="comment">\ half this is (if they can see any of the row at all)</span>
                        <span class="comment">\ and then draw it</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We don't draw the viewer's tile yet, as we do that</span>
                        <span class="comment">\ later</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ Set Y to the tile number just inside the left edge of</span>
 <span class="mne">INY</span>                    <span class="comment">\ the visible portion of the row</span>

 <span class="mne">CPY</span> <a class="popup variable">xTileViewer</a>        <span class="comment">\ If this isn't the viewer's tile, jump to dlan19 to</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan19</a>             <span class="comment">\ perform the same check on the right side</span>

                        <span class="comment">\ If we get here then the visible part of the viewer's</span>
                        <span class="comment">\ tile row starts on the tile just to the left of their</span>
                        <span class="comment">\ position, so we are looking left and should draw that</span>
                        <span class="comment">\ part of the visible row</span>

 <span class="mne">STY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ Set the right edge to the viewer's tile, so we draw</span>
                        <span class="comment">\ from the left edge up to (but not including) the</span>
                        <span class="comment">\ viewer's tile</span>

 <span class="mne">JMP</span> <a class="popup destination">dlan20</a>             <span class="comment">\ Jump to dlan20 to draw the tile row containing the</span>
                        <span class="comment">\ viewer</span>

<span class="label">.dlan19</span><a id="dlan19" class="anchor"></a>

                        <span class="comment">\ If we get here then the left edge is not just to the</span>
                        <span class="comment">\ left of the viewer, so now we check the right edge</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ Set Y to the tile number that's two to the left of the</span>
 <span class="mne">DEY</span>                    <span class="comment">\ right edge of the visible portion</span>
 <span class="mne">DEY</span>

 <span class="mne">CPY</span> <a class="popup variable">xTileViewer</a>        <span class="comment">\ If this isn't the viewer's tile, jump to dlan21 to</span>
 <span class="mne">BNE</span> <a class="popup destination">dlan21</a>             <span class="comment">\ skip drawing the tile row altogether, as we can't see</span>
                        <span class="comment">\ it to the left or the right (so instead we move on to</span>
                        <span class="comment">\ drawing the player's tile)</span>

                        <span class="comment">\ If we get here then the visible part of the viewer's</span>
                        <span class="comment">\ tile row starts on the tile just to the right of their</span>
                        <span class="comment">\ position, so we are looking right and should draw that</span>
                        <span class="comment">\ part of the visible row</span>

 <span class="mne">INY</span>                    <span class="comment">\ Set the left edge to the tile just right of the</span>
 <span class="mne">STY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ viewer's tile, so we draw from just right of the</span>
                        <span class="comment">\ viewer's tile to the right edge</span>

<span class="label">.dlan20</span><a id="dlan20" class="anchor"></a>

                        <span class="comment">\ We now draw the tile row containing the viewer, but</span>
                        <span class="comment">\ first we need to ensure we have the data for the tiles</span>
                        <span class="comment">\ at each end</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewLeftEdge</a>  <span class="comment">\ Set Y to the left edge of the viewer's tile row</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewRightEdge</a> <span class="comment">\ Set Y to the right edge of the viewer's tile row</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

 <span class="mne">JSR</span> <a class="popup destination">DrawLandscapeRow</a>   <span class="comment">\ Draw the tile row at z-coordinate zTile, between tiles</span>
                        <span class="comment">\ xTileViewLeftEdge and xTileViewRightEdge, including</span>
                        <span class="comment">\ any objects on any of the tiles</span>

<span class="label">.dlan21</span><a id="dlan21" class="anchor"></a>

                        <span class="comment">\ We now draw the tile row beneath the viewer, but first</span>
                        <span class="comment">\ we need to ensure we have the data for the tile just</span>
                        <span class="comment">\ in front of it</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set drawingTableOffset = 0 so the following call to</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ GetTileViewAngles (which we call to fetch the data for</span>
                        <span class="comment">\ the tile corner row in front of viewer) will populate</span>
                        <span class="comment">\ the tables at tileViewYaw+0 and tileViewPitch+0</span>

 <span class="mne">INC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Increment the row number so it's the row in front of</span>
                        <span class="comment">\ the viewer</span>

 <span class="mne">LDY</span> <a class="popup variable">xTileViewer</a>        <span class="comment">\ Set Y to the tile column for the viewer's tile, so we</span>
                        <span class="comment">\ can fetch the tile data for the tile directly in front</span>
                        <span class="comment">\ of the viewer</span>

 <span class="mne">JSR</span> <a class="popup destination">GetTileViewAngles</a>  <span class="comment">\ Calculate the pitch and yaw angles for the tile corner</span>
                        <span class="comment">\ at (Y, zTile), from the perspective of the viewer, and</span>
                        <span class="comment">\ store them in the following tables in the relevant</span>
                        <span class="comment">\ entry for this tile corner:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewYaw(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * drawViewPitch(Hi Lo)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileViewData</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * tileIsOnScreen (also returned in A and the Z flag)</span>

                        <span class="comment">\ By this point we have the following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * The tables at tileViewYaw+0 and tileViewPitch+0</span>
                        <span class="comment">\     contain data for the tile corner row in front of</span>
                        <span class="comment">\     the viewer, i.e. for the front edge of the tile on</span>
                        <span class="comment">\     which the viewer sits</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * The tables at tileViewYaw+32 and tileViewPitch+32</span>
                        <span class="comment">\     contain data for the tile corner row containing</span>
                        <span class="comment">\     the viewer, i.e. for the rear edge of the tile on</span>
                        <span class="comment">\     which the viewer sits</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Y is the offset of the viewer's tile within these</span>
                        <span class="comment">\ tables, so, for example:</span>
                        <span class="comment">\</span>
                        <span class="comment">\    * drawViewPitchHi,Y is the corner at the front</span>
                        <span class="comment">\      left of the viewer's tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\    * drawViewPitchHi+1,Y is the corner at the front</span>
                        <span class="comment">\      right of the viewer's tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\    * drawViewPitchHi+32,Y is the corner at the rear</span>
                        <span class="comment">\      left of the viewer's tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\    * drawViewPitchHi+32+1,Y is the corner at the rear</span>
                        <span class="comment">\      right of the viewer's tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We now set up the angles for the tile to ensure that</span>
                        <span class="comment">\ it looks correct</span>

 <span class="mne">LDA</span> <a class="popup variable">drawViewPitchHi</a>,<span class="register">Y</span>  <span class="comment">\ If the high byte of the pitch angle of the front-left</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ edge of the viewer's tile is 2 or more, then it is off</span>
 <span class="mne">BCS</span> <a class="popup destination">dlan22</a>             <span class="comment">\ the top of the screen, so jump to dlan22 to skip</span>
                        <span class="comment">\ drawing it and instead return from the subroutine ???</span>

 <span class="mne">STA</span> <a class="popup variable">drawViewPitchHi</a><span class="operator">+</span><span class="decimal">1</span>,<span class="register">Y</span>    <span class="comment">\ Set the pitch angle for the tile corner in the</span>
 <span class="mne">LDA</span> <a class="popup variable">drawViewPitchLo</a>,<span class="register">Y</span>      <span class="comment">\ front-right corner of the viewer's tile to be the</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewPitchLo</a><span class="operator">+</span><span class="decimal">1</span>,<span class="register">Y</span>    <span class="comment">\ same as the front-left corner, so this ensures</span>
                            <span class="comment">\ that the two front corners of the tile containing</span>
                            <span class="comment">\ the viewer are horizontally level</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">32</span>                <span class="comment">\ Set drawingTableOffset = 0 so the following call to</span>
 <span class="mne">STA</span> <a class="popup variable">drawingTableOffset</a> <span class="comment">\ DrawFlatTile (for the tile row beneath the viewer)</span>
                        <span class="comment">\ will fetch data from the tables at tileViewData+32,</span>
                        <span class="comment">\ tileViewYaw+32 and tileViewPitch+32</span>

 <span class="mne">DEC</span> <a class="popup variable">zTile</a>              <span class="comment">\ Decrement the row number so it goes back to the row</span>
                        <span class="comment">\ containing the viewer</span>

                        <span class="comment">\ We now position the corners of the viewer's tile so</span>
                        <span class="comment">\ it spreads to the left and right screen edges and</span>
                        <span class="comment">\ appears to dip down behind the viewer (so it spreads</span>
                        <span class="comment">\ down to the bottom of the screen as well)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&FF</span>                       <span class="comment">\ Set the pitch angle for the two rear tile</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewPitchHi</a><span class="operator">+</span><span class="decimal">32</span>,<span class="register">Y</span>       <span class="comment">\ corners to be as low down as possible (as the</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewPitchHi</a><span class="operator">+</span><span class="decimal">32</span><span class="operator">+</span><span class="decimal">1</span>,<span class="register">Y</span>     <span class="comment">\ high byte of &FF makes the angle negative)</span>

 <span class="mne">STA</span> <a class="popup variable">drawViewYawHi</a><span class="operator">+</span><span class="decimal">32</span>,<span class="register">Y</span> <span class="comment">\ Set the yaw angle for the two left tile corners to be</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewYawHi</a>,<span class="register">Y</span>    <span class="comment">\ as far left as possible</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">20</span>                    <span class="comment">\ Set the yaw angle for the two right tile corners</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewYawHi</a><span class="operator">+</span><span class="decimal">32</span><span class="operator">+</span><span class="decimal">1</span>,<span class="register">Y</span>   <span class="comment">\ to 20, which is a full screen width, so this puts</span>
 <span class="mne">STA</span> <a class="popup variable">drawViewYawHi</a><span class="operator">+</span><span class="decimal">1</span>,<span class="register">Y</span>      <span class="comment">\ them on the right edge of the screen</span>

 <span class="mne">LDA</span> <a class="popup variable">xTileViewer</a>        <span class="comment">\ Set xTileToDraw to the column of the viewer's tile, so</span>
 <span class="mne">STA</span> <a class="popup variable">xTileToDraw</a>        <span class="comment">\ the call to DrawFlatTile draws this tile</span>

 <span class="mne">JSR</span> <a class="popup destination">DrawFlatTile</a>       <span class="comment">\ Draw the flat tile under the viewer</span>

<span class="label">.dlan22</span><a id="dlan22" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate that we have drawn the</span>
                        <span class="comment">\ whole landscape</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawflattile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/drawflattile.html">DrawFlatTile</a> (category: Drawing the landscape)</div><div class="summary">Draw a flat tile in the correct colour for the chess board effect that we use to draw the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawlandscaperow"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/drawlandscaperow.html">DrawLandscapeRow</a> (category: Drawing the landscape)</div><div class="summary">Draw a row of tiles between the left visible edge and the right visible, in two parts towards each side of the viewer</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-gettileviewangles"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/gettileviewangles_part_1_of_4.html">GetTileViewAngles (Part 1 of 4)</a> (category: Drawing the landscape)</div><div class="summary">Calculate the pitch and yaw angles for a tile corner, relative to a viewer object (e.g. the player), and whether it is on-screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan19"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html#dlan19">dlan19</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan20"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html#dlan20">dlan20</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan21"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html#dlan21">dlan21</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dlan22"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawlandscapeview_part_3_of_3.html#dlan22">dlan22</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewpitchhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewpitchhi.html">drawViewPitchHi</a> (category: Drawing the landscape)</div><div class="summary">Storage for the pitch angles of tiles and object points for drawing the current landscape view (high bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewpitchlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewpitchlo.html">drawViewPitchLo</a> (category: Drawing the landscape)</div><div class="summary">Storage for the pitch angles of tiles and object points for drawing the current landscape view (low bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawviewyawhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/drawviewyawhi.html">drawViewYawHi</a> (category: Drawing the landscape)</div><div class="summary">Storage for the yaw angles of tiles and object points for drawing the current landscape view (high bytes)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawingtableoffset"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#drawingtableoffset">drawingTableOffset</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The offset to use within the various drawing data tables for the tile we are analysing</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtiletodraw"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtiletodraw">xTileToDraw</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The column number of the tile we are currently drawing</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewleftedge"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewleftedge">xTileViewLeftEdge</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile number at the left edge of the visible portion of the row we are currently processing when drawing the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewrightedge"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewrightedge">xTileViewRightEdge</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile number at the right edge of the visible portion of the row we are currently processing when drawing the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xtileviewer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#xtileviewer">xTileViewer</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The tile x-coordinate of the viewer, but with the axes rotated to match the orientation of the viewer, so we can draw the landscape along the line of sight, towards the viewer's tile</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ztile"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#ztile">zTile</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Tile corner z-coordinate</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drawlandscapeview_part_2_of_3.html">DrawLandscapeView (Part 2 of 3)</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/quadrantoffsets.html">quadrantOffsets</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
