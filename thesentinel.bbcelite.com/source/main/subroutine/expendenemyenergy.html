<?php
include_once("../../../templates/template_functions.php");
page_header("gameplay", "subroutine_expendenemyenergy.html", "The ExpendEnemyEnergy subroutine", "Gameplay: ExpendEnemyEnergy", "Annotated code for the ExpendEnemyEnergy subroutine in The Sentinel", "the_sentinel-code", "source_gameplay", "subroutine_expendenemyenergy", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drainobjectenergy.html">DrainObjectEnergy</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/finishlandscape.html">FinishLandscape</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">ExpendEnemyEnergy</span>                                       <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Drain one unit of energy from an enemy and expend it onto the</span>
             <span class="headerEntry">landscape by spawning a tree, if possible</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-expendenemyenergy">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applyenemytactics.html">ApplyEnemyTactics</a> calls <a href="#expendenemyenergy">ExpendEnemyEnergy</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/applytactics_part_3_of_8.html">ApplyTactics (Part 3 of 8)</a> calls <a href="#expendenemyenergy">ExpendEnemyEnergy</a></span>
</div>
<hr class="light">
 If we can't spawn a tree because we are about to pan the screen and the tree
 would spawn in a position that would be visible on-screen, then the routine
 does not drain energy or spawn a tree, and instead it gives up and aborts
 applying tactics for this gameplay loop.

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">enemyObject</span>          <span class="argumentEntry">The object number of the enemy to drain</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">C flag</span>               <span class="argumentEntry">Status flag:</span>

                        <span class="argumentEntry">  * Clear if the energy is drained and a tree is spawned</span>
                        <span class="argumentEntry">    successfully</span>

                        <span class="argumentEntry">  * Set if:</span>

                        <span class="argumentEntry">    * The enemy had no energy to drain</span>

                        <span class="argumentEntry">    * We could not spawn a tree to take on the drained</span>
                        <span class="argumentEntry">      energy</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">The object number of the spawned tree, if one was</span>
                        <span class="argumentEntry">spawned</span>

</div></div>
<span class="label">.ExpendEnemyEnergy</span><a id="expendenemyenergy" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Set X to the object number of the enemy we are</span>
                        <span class="comment">\ draining (so this is now object #X)</span>

 <span class="mne">SEC</span>                    <span class="comment">\ If the enemy has zero energy, jump to dren1 to return</span>
 <span class="mne">LDA</span> <a class="popup variable">enemyEnergy</a>,<span class="register">X</span>      <span class="comment">\ from the subroutine with the C flag set</span>
 <span class="mne">BEQ</span> <a class="popup destination">dren1</a>

                        <span class="comment">\ If we get here then the enemy has got some energy</span>
                        <span class="comment">\ left, so we spawn a tree and decrease the enemy's</span>
                        <span class="comment">\ energy level by one (as a tree is worth one energy</span>
                        <span class="comment">\ unit)</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">2</span>                 <span class="comment">\ Spawn a tree (an object of type 2), returning the</span>
 <span class="mne">JSR</span> <a class="popup destination">SpawnObject</a>        <span class="comment">\ object number of the new object in X and currentObject</span>

 <span class="mne">LDA</span> <a class="popup variable">minEnemyAltitude</a>   <span class="comment">\ Set A to altitude of the lowest enemy on the landscape</span>

 <span class="mne">JSR</span> <a class="popup destination">PlaceObjectBelow</a>   <span class="comment">\ Attempt to place the tree on a tile that is below the</span>
                        <span class="comment">\ maximum altitude specified in A (though we may end up</span>
                        <span class="comment">\ placing the tree higher than this)</span>

 <span class="mne">BCS</span> <a class="popup destination">dren1</a>              <span class="comment">\ If the call to PlaceObjectBelow sets the C flag then</span>
                        <span class="comment">\ the tree has not been successfully placed, so jump to</span>
                        <span class="comment">\ dren1 to return from the subroutine with the C flag</span>
                        <span class="comment">\ set</span>

 <span class="mne">TXA</span>                    <span class="comment">\ Set A to the object number of the tree we added to the</span>
                        <span class="comment">\ landscape so we can pass it to CheckObjVisibility</span>

 <span class="mne">JSR</span> <a class="popup destination">CheckObjVisibility</a> <span class="comment">\ Check whether the tree in object A is visible and</span>
                        <span class="comment">\ could therefore be seen on-screen by the player</span>

 <span class="mne">BCC</span> <a class="popup destination">dren2</a>              <span class="comment">\ If the C flag is clear then we are about to repeat the</span>
                        <span class="comment">\ same screen pan (as the player is still holding down</span>
                        <span class="comment">\ the same pan key) and the tree we just added would be</span>
                        <span class="comment">\ visible in the landscape view if we drew it again</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that when we pan the screen, the new part</span>
                        <span class="comment">\ of the screen that pans into view might show part of</span>
                        <span class="comment">\ the tree while the rest of the screen won't, and that</span>
                        <span class="comment">\ won't look good</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So jump to dren2 to delete the tree and stop applying</span>
                        <span class="comment">\ tactics to the enemy, thus aborting the whole process</span>

                        <span class="comment">\ If we get here then we are either not repeating the</span>
                        <span class="comment">\ same screen pan, or we are but the object is not</span>
                        <span class="comment">\ visible on-screen, so in either case the tree won't</span>
                        <span class="comment">\ only partially appear on-screen so we can go ahead</span>
                        <span class="comment">\ with the energy drain</span>

 <span class="mne">LDX</span> <a class="popup variable">enemyObject</a>        <span class="comment">\ Decrement enemyEnergy for the enemy object we are</span>
 <span class="mne">DEC</span> <a class="popup variable">enemyEnergy</a>,<span class="register">X</span>      <span class="comment">\ draining</span>

 <span class="mne">LDX</span> <a class="popup variable">currentObject</a>      <span class="comment">\ Set X to currentObject to return from the subroutine,</span>
                        <span class="comment">\ which the call to CheckObjVisibility set to the object</span>
                        <span class="comment">\ number of the newly spawned tree</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Clear the C flag to indicate success</span>

<span class="label">.dren1</span><a id="dren1" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>

<span class="label">.dren2</span><a id="dren2" class="anchor"></a>

 <span class="mne">JSR</span> <a class="popup destination">DeleteObject</a>       <span class="comment">\ Delete the tree in object #X and remove it from the</span>
                        <span class="comment">\ landscape</span>

 <span class="mne">JMP</span> <a class="popup destination">FinishEnemyTactics</a> <span class="comment">\ Jump to FinishEnemyTactics to stop applying tactics to</span>
                        <span class="comment">\ the current enemy and return to the ProcessGameplay</span>
                        <span class="comment">\ routine to continue with the gameplay loop</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-checkobjvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/checkobjvisibility.html">CheckObjVisibility</a> (category: Drawing objects)</div><div class="summary">Check whether an object is visible on-screen and should therefore not be changed if a pan operation is about to happen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-deleteobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/deleteobject.html">DeleteObject</a> (category: 3D objects)</div><div class="summary">Delete an object, removing it from the landscape and vacating its object number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-finishenemytactics"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/finishenemytactics.html">FinishEnemyTactics</a> (category: Gameplay)</div><div class="summary">Stop applying tactics to the current enemy and return to the ProcessGameplay routine to continue with the gameplay loop</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-placeobjectbelow"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/placeobjectbelow.html">PlaceObjectBelow</a> (category: 3D objects)</div><div class="summary">Attempt to place an object on a tile that is below the maximum altitude specified in A</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/spawnobject.html">SpawnObject</a> (category: 3D objects)</div><div class="summary">Add a new object of the specified type to the objectTypes table</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-currentobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#currentobject">currentObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the object we are currently processing</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dren1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/expendenemyenergy.html#dren1">dren1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dren2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/expendenemyenergy.html#dren2">dren2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyenergy"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemyenergy">enemyEnergy</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Enemy energy levels (one byte per enemy)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#enemyobject">enemyObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The object number of the enemy to which we are applying tactics in this iteration around the main loop (0-7)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-minenemyaltitude"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#minenemyaltitude">minEnemyAltitude</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The altitude of the lowest enemy on the landscape</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/drainobjectenergy.html">DrainObjectEnergy</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/finishlandscape.html">FinishLandscape</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
