<?php
include_once("../../../templates/template_functions.php");
page_header("landscape", "subroutine_checksecretcode_part_2_of_2.html", "The CheckSecretCode (Part 2 of 2) subroutine", "Landscape: CheckSecretCode (Part 2 of 2)", "Annotated code for the CheckSecretCode (Part 2 of 2) subroutine in The Sentinel", "the_sentinel-code", "source_landscape", "subroutine_checksecretcode_part_2_of_2", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/variable/landscapecolour3.html">landscapeColour3</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/landscapecolour2.html">landscapeColour2</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">CheckSecretCode (Part 2 of 2)</span>                           <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Check the results of the secret code matching process, and if the</span>
             <span class="headerEntry">secret codes match, jump to PlayGame to play the game</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_b.html#header-checksecretcode-part-2-of-2">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
</div></div>
<span class="label">.srct4</span><a id="srct4" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">secretCodeChecks</a>   <span class="comment">\ If bits 1 to 4 of secretCodeChecks are not all set,</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00011110</span>         <span class="comment">\ then one or more of the four BCD bytes in the secret</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%00011110</span>         <span class="comment">\ code do not match, so jump to srct3 to return from the</span>
 <span class="mne">BNE</span> <a class="popup destination">srct3</a>              <span class="comment">\ subroutine normally, to display the "WRONG SECRET</span>
                        <span class="comment">\ CODE" error page</span>

                        <span class="comment">\ If get here then bits 1 to 4 of secretCodeChecks are</span>
                        <span class="comment">\ all set, so the entered secret entry code matches the</span>
                        <span class="comment">\ generated code, so we can now proceed to playing the</span>
                        <span class="comment">\ landscape</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The following code simply jumps to the PlayGame</span>
                        <span class="comment">\ routine, but in an obfuscated way that changes the</span>
                        <span class="comment">\ return address on the stack to PlayGame-1, so the RTS</span>
                        <span class="comment">\ instruction will jump to PlayGame (as that's how the</span>
                        <span class="comment">\ RTS instruction works)</span>

 <span class="mne">PLA</span>                    <span class="comment">\ Remove the return address from the stack and discard</span>
 <span class="mne">PLA</span>                    <span class="comment">\ it</span>

                        <span class="comment">\ In the following we use the value in objectFlags,</span>
                        <span class="comment">\ which contains the object flags for the object #0</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Object #0 is always the Sentinel, and the Sentinel</span>
                        <span class="comment">\ is always placed on top of the Sentinel's tower, so</span>
                        <span class="comment">\ the object flags for the Sentinel are constructed as</span>
                        <span class="comment">\ follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bits 0-5 = the number of the object beneath this</span>
                        <span class="comment">\                one</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bit 6 = set to indicate that this object is on top</span>
                        <span class="comment">\             of another object</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Bit 7 = clear to indicate that this object number</span>
                        <span class="comment">\             is allocated to an object</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The Sentinel's tower is always the first object to be</span>
                        <span class="comment">\ spawned, and object numbers are allocated from 63 and</span>
                        <span class="comment">\ down, so this means the tower is always object #63, or</span>
                        <span class="comment">\ %111111</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The Sentinel's object flags are therefore %01111111</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The following code uses this fact to push the address</span>
                        <span class="comment">\ of PlayGame-1 onto the stack, but in a totally</span>
                        <span class="comment">\ obfuscated manner</span>
                        <span class="comment">\</span>
                        <span class="comment">\ It calculates the high byte as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\     objectFlags + HI(PlayGame-1) - %01111111</span>
                        <span class="comment">\   = %01111111 + HI(PlayGame-1) - %01111111</span>
                        <span class="comment">\   = HI(PlayGame-1)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ and the low byte as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\     high byte + LO(PlayGame-1) - HI(PlayGame-1)</span>
                        <span class="comment">\   = HI(PlayGame-1) + LO(PlayGame-1) - HI(PlayGame-1)</span>
                        <span class="comment">\   = LO(PlayGame-1)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ For the first calculation, we need to apply a little</span>
                        <span class="comment">\ hack to the code to get around a limitation in BeebAsm</span>
                        <span class="comment">\ that rejects negative constants</span>
                        <span class="comment">\</span>
                        <span class="comment">\ HI(PlayGame-1) - %01111111 in the first calculation is</span>
                        <span class="comment">\ negative, so to persuade BeebAsm to accept it as a</span>
                        <span class="comment">\ constant, we can wrap it in LO() to convert it into</span>
                        <span class="comment">\ a two's complement value that BeebAsm will accept</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The LO() part is effectively applying MOD 256 in a way</span>
                        <span class="comment">\ that works with negative arguments</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Push PlayGame-1 onto the stack, high byte first</span>
 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="operator">LO</span><span class="bracket">(</span><span class="operator">HI</span><span class="bracket">(</span><a class="popup variable">PlayGame</a><span class="operator">-</span><span class="decimal">1</span><span class="bracket">)</span> <span class="operator">-</span> <span class="binary">%01111111</span><span class="bracket">)</span>
 <span class="mne">PHA</span>
 <span class="mne">CLC</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="operator">LO</span><span class="bracket">(</span><a class="popup variable">PlayGame</a><span class="operator">-</span><span class="decimal">1</span><span class="bracket">)</span> <span class="operator">-</span> HI(PlayGame<span class="operator">-</span><span class="decimal">1</span><span class="bracket">)</span>
 <span class="mne">PHA</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine, which will take the</span>
                        <span class="comment">\ address off the stack, increment it and jump to that</span>
                        <span class="comment">\ address</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this jumps to PlayGame to play the actual game</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playgame"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/playgame.html">PlayGame</a> (category: Main game loop)</div><div class="summary">Start playing the generated landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-secretcodechecks"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#secretcodechecks">secretCodeChecks</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Bits 1 to 4 store the results of checking each of the four two-digit numbers in a landscape's secret entry code</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-srct3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/checksecretcode_part_1_of_2.html#srct3">srct3</a> in subroutine <a href="/source/main/subroutine/checksecretcode_part_1_of_2.html">CheckSecretCode (Part 1 of 2)</a></div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/variable/landscapecolour3.html">landscapeColour3</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/landscapecolour2.html">landscapeColour2</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
