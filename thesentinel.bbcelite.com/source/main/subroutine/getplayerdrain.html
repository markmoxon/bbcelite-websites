<?php
include_once("../../../templates/template_functions.php");
page_header("gameplay", "subroutine_getplayerdrain.html", "The GetPlayerDrain subroutine", "Gameplay: GetPlayerDrain", "Annotated code for the GetPlayerDrain subroutine in The Sentinel", "the_sentinel-code", "source_gameplay", "subroutine_getplayerdrain", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/variable/xstoreenemygaze.html">xStoreEnemyGaze</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/resetmeaniescan.html">ResetMeanieScan</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetPlayerDrain</span>                                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Gameplay</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate whether the player is being scanned by an enemy and</span>
             <span class="headerEntry">whether the enemy can see the player's tile</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-getplayerdrain">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processgameplay.html">ProcessGameplay</a> calls <a href="#getplayerdrain">GetPlayerDrain</a></span>
</div>
</div></div>
<span class="label">.GetPlayerDrain</span><a id="getplayerdrain" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Set Y = 0 to use as the default state of the scanner</span>
                        <span class="comment">\ (fill scanner with black)</span>

 <span class="mne">STY</span> <a class="popup variable">T</a>                  <span class="comment">\ Set T = 0 to store in playerTileIsHidden after the</span>
                        <span class="comment">\ loop below, so the default value is that the player</span>
                        <span class="comment">\ is not exposed to an enemy scan (though we may change</span>
                        <span class="comment">\ this)</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">7</span>                 <span class="comment">\ We now loop through all eight enemies, so set an enemy</span>
                        <span class="comment">\ counter in X</span>

<span class="label">.pdra1</span><a id="pdra1" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">objectFlags</a>,<span class="register">X</span>      <span class="comment">\ If bit 7 is set for object #Y then this object number</span>
 <span class="mne">BMI</span> <a class="popup destination">pdra3</a>              <span class="comment">\ is not allocated to an object, so jump to pdra3 to</span>
                        <span class="comment">\ move on to the next enemy object</span>

 <span class="mne">LDA</span> <a class="popup variable">objectTypes</a>,<span class="register">X</span>      <span class="comment">\ Set A to the object type for the enemy in object #X</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ If object #X is a sentry (an object of type 1) then</span>
 <span class="mne">BEQ</span> <a class="popup destination">pdra2</a>              <span class="comment">\ jump to pdra2</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ If object #X is not the Sentinel (an object of type</span>
 <span class="mne">BNE</span> <a class="popup destination">pdra3</a>              <span class="comment">\ 5), then jump to pdra3 to move on to the next enemy</span>
                        <span class="comment">\ object</span>

<span class="label">.pdra2</span><a id="pdra2" class="anchor"></a>

                        <span class="comment">\ If we get here then object #X is the Sentinel or a</span>
                        <span class="comment">\ sentry</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyTarget</a>,<span class="register">X</span>      <span class="comment">\ If the enemy's target is not the player, jump to pdra3</span>
 <span class="mne">CMP</span> <a class="popup variable">playerObject</a>       <span class="comment">\ to move on to the next enemy object</span>
 <span class="mne">BNE</span> <a class="popup destination">pdra3</a>

 <span class="mne">LDA</span> <a class="popup variable">enemyDrainTimer</a>,<span class="register">X</span>  <span class="comment">\ If the drain timer for the enemy is zero, jump to</span>
 <span class="mne">BEQ</span> <a class="popup destination">pdra3</a>              <span class="comment">\ pdra3 to move on to the next enemy object</span>

                        <span class="comment">\ If we get here then the enemy is targeting the player</span>
                        <span class="comment">\ and has a non-zero drain timer, so the player is at</span>
                        <span class="comment">\ least partially exposed to an enemy who can drain them</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Set Y = 4 to use as the state of the scanner (fill the</span>
                        <span class="comment">\ scanner with static in colour 3)</span>

 <span class="mne">LDA</span> <a class="popup variable">enemyVisibility</a>,<span class="register">X</span>  <span class="comment">\ Set T to the visibility of the enemy's target (the</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ player) to store in playerTileIsHidden after the loop</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This will either have bit 7 set (target's tile is</span>
                        <span class="comment">\ visible) or bit 6 set (target's tile is not visible</span>
                        <span class="comment">\ but target object is)</span>

 <span class="mne">BMI</span> <a class="popup destination">pdra4</a>              <span class="comment">\ If bit 7 of enemyVisibility is set then the enemy can</span>
                        <span class="comment">\ see the player's tile, so jump to pdra4 to record this</span>
                        <span class="comment">\ fact</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If bit 7 of enemyVisibility is clear then the enemy</span>
                        <span class="comment">\ can see the player object but it can't see the</span>
                        <span class="comment">\ player's tile, so we keep looping in case there is</span>
                        <span class="comment">\ another target whose tile the enemy can see, as this</span>
                        <span class="comment">\ will take precedence over the partially exposed player</span>

<span class="label">.pdra3</span><a id="pdra3" class="anchor"></a>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the enemy counter in X</span>

 <span class="mne">BPL</span> <a class="popup destination">pdra1</a>              <span class="comment">\ Loop back until we have checked all eight enemies</span>

<span class="label">.pdra4</span><a id="pdra4" class="anchor"></a>

 <span class="mne">STY</span> <a class="popup variable">scannerUpdate</a>      <span class="comment">\ Set scannerUpdate to the value of Y, which will be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Zero if the player is not exposed to the enemy (so</span>
                        <span class="comment">\     the scanner will not be updated)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Non-zero (i.e. 4) if the player is exposed to the</span>
                        <span class="comment">\     enemy (so the scanner will then be updated)</span>

 <span class="mne">LDA</span> <a class="popup variable">T</a>                  <span class="comment">\ Set playerTileIsHidden to the value of T, which will</span>
 <span class="mne">STA</span> <a class="popup variable">playerTileIsHidden</a> <span class="comment">\ be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Zero if the player is not exposed to the enemy</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 128 (i.e. bit 7 set) if the player's tile is</span>
                        <span class="comment">\     exposed to the enemy</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 64 (i.e. bit 6 set) if the player is exposed to</span>
                        <span class="comment">\     the enemy but the enemy can't see the player's</span>
                        <span class="comment">\     tile</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This value is used in the UpdateScannerNow routine</span>
                        <span class="comment">\ to determine whether we show the scanner with a full</span>
                        <span class="comment">\ display of static (not 64) or only half (64)</span>

 <span class="mne">LDA</span> <a class="popup variable">soundEffect</a>        <span class="comment">\ Set A to soundEffect, which determines how the current</span>
                        <span class="comment">\ sound is processed by the ProcessSound routine</span>

 <span class="mne">CPY</span> <a class="popup variable">soundEffect</a>        <span class="comment">\ Set the flags on the comparison of the current setting</span>
                        <span class="comment">\ of soundEffect and the value of Y</span>

 <span class="mne">STY</span> <a class="popup variable">soundEffect</a>        <span class="comment">\ Set soundEffect to Y, which will be:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Zero if the player is not exposed to the enemy (so</span>
                        <span class="comment">\     no sound processing is required)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * Non-zero (i.e. 4) if the player is exposed to the</span>
                        <span class="comment">\     enemy (so the scanner sound is processed in the</span>
                        <span class="comment">\     ProcessSound routine)</span>

 <span class="mne">BEQ</span> <a class="popup destination">pdra5</a>              <span class="comment">\ If the value of soundEffect has not changed, jump to</span>
                        <span class="comment">\ pdra5 to return from the subroutine</span>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="hex">&12</span>               <span class="comment">\ Set the first parameter of sound block #2 (channel) to</span>
 <span class="mne">STY</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">16</span>       <span class="comment">\ &12, so we make the scanner sound on channel 2 and</span>
                        <span class="comment">\ with a flush control of 1 to make the sound instantly</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ We set A to soundEffect above, so if soundEffect = 3,</span>
 <span class="mne">BEQ</span> <a class="popup destination">pdra5</a>              <span class="comment">\ which denotes that we are currently applying the music</span>
                        <span class="comment">\ sound effect, jump to pdra5 to return from the</span>
                        <span class="comment">\ subroutine to let the music sound finish first</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">6</span>                 <span class="comment">\ Otherwise we are not currently applying the music</span>
 <span class="mne">JSR</span> <a class="popup destination">FlushBuffer</a>        <span class="comment">\ sound effect, so call the FlushBuffer routine with</span>
                        <span class="comment">\ X = 6 to flush the sound channel 2 buffer</span>

<span class="label">.pdra5</span><a id="pdra5" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-flushbuffer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/flushbuffer.html">FlushBuffer</a> (category: Keyboard)</div><div class="summary">Flush the specified buffer</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemydraintimer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemydraintimer">enemyDrainTimer</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A timer for each enemy that counts down every 0.06</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemytarget"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemytarget">enemyTarget</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The object number of the enemy's target (one byte per</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-enemyvisibility"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#enemyvisibility">enemyVisibility</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Visibility of the enemy's target (one byte per enemy)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objectflags"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a> in workspace <a href="/source/main/workspace/stack_variables.html">Stack variables</a></div><div class="summary">Object flags for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-objecttypes"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/objecttypes.html">objectTypes</a> (category: 3D objects)</div><div class="summary">The object types table for up to 64 objects</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getplayerdrain.html#pdra1">pdra1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getplayerdrain.html#pdra2">pdra2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getplayerdrain.html#pdra3">pdra3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getplayerdrain.html#pdra4">pdra4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pdra5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getplayerdrain.html#pdra5">pdra5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playerobject"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#playerobject">playerObject</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the player object</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-playertileishidden"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#playertileishidden">playerTileIsHidden</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A flag that records when the player is being scanned but the player's tile is hidden from the Sentinel or sentry doing the scan</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-scannerupdate"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#scannerupdate">scannerUpdate</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A flag to control whether the scanner gets updated</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sounddata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/sounddata.html">soundData</a> (category: Sound)</div><div class="summary">OSWORD blocks for making the various game sounds</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-soundeffect"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#soundeffect">soundEffect</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Determines how the current sound is processed by the ProcessSound routine</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/variable/xstoreenemygaze.html">xStoreEnemyGaze</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/resetmeaniescan.html">ResetMeanieScan</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
