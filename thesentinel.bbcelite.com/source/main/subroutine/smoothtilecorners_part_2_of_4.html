<?php
include_once("../../../templates/template_functions.php");
page_header("landscape", "subroutine_smoothtilecorners_part_2_of_4.html", "The SmoothTileCorners (Part 2 of 4) subroutine", "Landscape: SmoothTileCorners (Part 2 of 4)", "Annotated code for the SmoothTileCorners (Part 2 of 4) subroutine in The Sentinel", "the_sentinel-code", "source_landscape", "subroutine_smoothtilecorners_part_2_of_4", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/smoothtilecorners_part_1_of_4.html">SmoothTileCorners (Part 1 of 4)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/smoothtilecorners_part_3_of_4.html">SmoothTileCorners (Part 3 of 4)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">SmoothTileCorners (Part 2 of 4)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Landscape</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Smooth a strip by moving each outlier tile corner to the altitude</span>
             <span class="headerEntry">of its closest immediate neighbour (in terms of altitude)</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_f.html#header-smoothtilecorners-part-2-of-4">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">No direct references to this subroutine in this source file</span>
</div>
<hr class="light">
 This part smoothes the strip by working along the strip and applying the
 following algorithm:

   * If this tile corner is higher than both its neighbours, move it down

   * If this tile corner is lower than both its neighbours, move it up

 In each case, we move the tile corner until it is level with the closest one
 to its original altitude. This has the effect of smoothing out single-point
 spikes or troughs in the strip.

</div></div>
                        <span class="comment">\ If we get here then bit 6 of processAction is set, so</span>
                        <span class="comment">\ we smooth the tile strip by moving each outlier tile</span>
                        <span class="comment">\ to the altitude of its closest immediate neighbour (in</span>
                        <span class="comment">\ terms of altitude)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This smoothes out single-point spikes or troughs</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">31</span>                <span class="comment">\ We now work our way along the strip, smoothing the</span>
                        <span class="comment">\ altitudes of tiles 1 to 32, so set a tile counter in X</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that we smooth tiles 1 to 32 rather than tiles</span>
                        <span class="comment">\ 0 to 31 (tile 0 remains unchanged by the smoothing</span>
                        <span class="comment">\ process)</span>

<span class="label">.stri4</span><a id="stri4" class="anchor"></a>

                        <span class="comment">\ In the following, we are processing the tile at</span>
                        <span class="comment">\ position X + 1, i.e. stripData+1,X</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We smooth a tile by looking at the altitudes of the</span>
                        <span class="comment">\ two tiles either side of that tile, i.e. stripData,X</span>
                        <span class="comment">\ and stripData+2,X</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We are smoothing from high values of X to low values,</span>
                        <span class="comment">\ so by this point the tile at stripData+2,X has already</span>
                        <span class="comment">\ been smoothed</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Let's name the tiles as follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * stripData+2,X = "previous tile" (as it has already</span>
                        <span class="comment">\                     been smoothed)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * stripData+1,X = "this tile" (as this is the tile</span>
                        <span class="comment">\                      we are smoothing)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * stripData,X   = "next tile" (as this is the tile</span>
                        <span class="comment">\                      we will be smoothing next)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The smoothing algorithm is implemented as follows,</span>
                        <span class="comment">\ where we are comparing the altitude of each tile (as</span>
                        <span class="comment">\ at this stage tileData only contains tile altitudes):</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If this = previous, do nothing</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If this &lt; previous and this >= next, do nothing</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If this &lt; previous and this &lt; next, set</span>
                        <span class="comment">\     this = min(previous, next)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If this > previous and this &lt;= next, do nothing</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If this > previous and this > next, set</span>
                        <span class="comment">\     this = max(previous, next)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Or to simplify:</span>
                        <span class="comment">\</span>
                        <span class="comment">\  * If this tile is higher than both its neighbours,</span>
                        <span class="comment">\    move it down until it isn't</span>
                        <span class="comment">\</span>
                        <span class="comment">\  * If this tile is lower than both its neighbours,</span>
                        <span class="comment">\    move it up until it isn't</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this algorithm smoothes the landscape by squeezing</span>
                        <span class="comment">\ the landscape into a flatter shape, moving outlier</span>
                        <span class="comment">\ tiles closer to the landscape's overall line</span>

 <span class="mne">LDA</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">1</span>,<span class="register">X</span>      <span class="comment">\ If this tile is at the same altitude as the previous</span>
 <span class="mne">CMP</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">2</span>,<span class="register">X</span>      <span class="comment">\ tile, jump to stri9 to move on to smoothing the next</span>
 <span class="mne">BEQ</span> <a class="popup destination">stri9</a>              <span class="comment">\ tile, as the transition from the previous tile to this</span>
                        <span class="comment">\ tile is already flat</span>

 <span class="mne">BCS</span> <a class="popup destination">stri5</a>              <span class="comment">\ If this tile is higher than the previous tile, jump to</span>
                        <span class="comment">\ stri5</span>

                        <span class="comment">\ If we get here then this tile is lower than the</span>
                        <span class="comment">\ previous tile</span>

 <span class="mne">CMP</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ If this tile is at the same altitude or higher than</span>
 <span class="mne">BEQ</span> <a class="popup destination">stri9</a>              <span class="comment">\ the next tile, jump to stri9 to move on to smoothing</span>
 <span class="mne">BCS</span> <a class="popup destination">stri9</a>              <span class="comment">\ the next tile</span>

                        <span class="comment">\ If we get here then this tile is lower than the</span>
                        <span class="comment">\ previous tile and lower than the next tile</span>

 <span class="mne">LDA</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">2</span>,<span class="register">X</span>      <span class="comment">\ Set the flags from comparing the previous and next</span>
 <span class="mne">CMP</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ tiles (so in stri6, tile A is the previous tile and</span>
                        <span class="comment">\ tile B is the next tile)</span>

 <span class="mne">JMP</span> <a class="popup destination">stri6</a>              <span class="comment">\ Jump to stri6, so that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If previous &lt; next, set this = previous</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If previous >= next, set this = next</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In other words, set:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   this = min(previous, next)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ before moving on to the next tile</span>

<span class="label">.stri5</span><a id="stri5" class="anchor"></a>

                        <span class="comment">\ If we get here then this tile is higher than the</span>
                        <span class="comment">\ previous tile</span>

 <span class="mne">CMP</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ If this tile is at the same altitude or lower than the</span>
 <span class="mne">BEQ</span> <a class="popup destination">stri9</a>              <span class="comment">\ next tile jump to stri9 to move on to smoothing the</span>
 <span class="mne">BCC</span> <a class="popup destination">stri9</a>              <span class="comment">\ next tile</span>

                        <span class="comment">\ If we get here then this tile is higher than the</span>
                        <span class="comment">\ previous tile and this tile is higher than the next</span>
                        <span class="comment">\ tile</span>

 <span class="mne">LDA</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ Set the flags from comparing the next and previous</span>
 <span class="mne">CMP</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">2</span>,<span class="register">X</span>      <span class="comment">\ tiles (so in stri6, tile A is the next tile and</span>
                        <span class="comment">\ tile B is the previous tile)</span>

                        <span class="comment">\ Fall through into stri6, so that:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If next &lt; previous, set this = previous</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If next >= previous, set this = next</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In other words, set:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   this = max(previous, next)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ before moving on to the next tile</span>
<span class="label">.stri6</span><a id="stri6" class="anchor"></a>

                        <span class="comment">\ We get here after comparing two tiles; let's call them</span>
                        <span class="comment">\ tile A and tile B</span>

 <span class="mne">BCC</span> <a class="popup destination">stri7</a>              <span class="comment">\ If tile A is lower than tile B, jump to stri7 to set</span>
                        <span class="comment">\ the altitude of this tile to the altitude of the</span>
                        <span class="comment">\ previous tile</span>

 <span class="mne">LDA</span> <a class="popup variable">stripData</a>,<span class="register">X</span>        <span class="comment">\ Set A to the altitude of the next tile and jump to</span>
 <span class="mne">JMP</span> <a class="popup destination">stri8</a>              <span class="comment">\ stri8 to set the altitude of this tile to the altitude</span>
                        <span class="comment">\ of the next tile</span>

<span class="label">.stri7</span><a id="stri7" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">2</span>,<span class="register">X</span>      <span class="comment">\ Set A to the altitude of the previous tile</span>

<span class="label">.stri8</span><a id="stri8" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">stripData</a><span class="operator">+</span><span class="decimal">1</span>,<span class="register">X</span>      <span class="comment">\ Set the altitude of this tile to the value in A</span>

<span class="label">.stri9</span><a id="stri9" class="anchor"></a>

 <span class="mne">DEX</span>                    <span class="comment">\ Decrement the strip tile counter in X</span>

 <span class="mne">BPL</span> <a class="popup destination">stri4</a>              <span class="comment">\ Loop back until we have worked our way through the</span>
                        <span class="comment">\ whole strip</span>

 <span class="mne">BIT</span> <a class="popup variable">doNotPlayLandscape</a> <span class="comment">\ If bit 7 of doNotPlayLandscape is set then we do not</span>
 <span class="mne">BMI</span> <a class="popup destination">stri10</a>             <span class="comment">\ want to play the landscape after generating it, so</span>
                        <span class="comment">\ jump to stri10 to skip the following, leaving the</span>
                        <span class="comment">\ stack unmodified</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that the JSR GenerateLandscape instruction</span>
                        <span class="comment">\ that got us here will return normally, so the RTS at</span>
                        <span class="comment">\ the end of the GenerateLandscape routine will behave</span>
                        <span class="comment">\ as expected, like this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If we called GenerateLandscape from the</span>
                        <span class="comment">\     MainTitleLoop routine, then we return there to</span>
                        <span class="comment">\     fall through into SecretCodeError, which displays</span>
                        <span class="comment">\     the "WRONG SECRET CODE" error message for when the</span>
                        <span class="comment">\     player enters an incorrect secret code</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If we called GenerateLandscape from the</span>
                        <span class="comment">\     FinishLandscape routine, then we return there to</span>
                        <span class="comment">\     display the landscape's secret entry code</span>
                        <span class="comment">\     on-screen, for when the player completes a level</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If bit 7 of doNotPlayLandscape is clear then we keep</span>
                        <span class="comment">\ going to modify the return address on the stack, so</span>
                        <span class="comment">\ that the RTS at the end of the GenerateLandscape takes</span>
                        <span class="comment">\ us to the PreviewLandscape routine</span>

                        <span class="comment">\ The above loop ended with X set to &FF, so &0100 + X</span>
                        <span class="comment">\ in the following points to the top of the stack at</span>
                        <span class="comment">\ &01FF</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="operator">HI</span><span class="bracket">(</span><a class="popup variable">JumpToPreview</a><span class="bracket">)</span> <span class="comment">\ Set the return address on the bottom of the stack at</span>
 <span class="mne">STA</span> <span class="hex">&0100</span>,<span class="register">X</span>            <span class="comment">\ (&01FE &01FF) to JumpToPreview</span>
 <span class="mne">DEX</span>                    <span class="comment">\</span>
 <span class="mne">LDA</span> <span class="hash">#</span><span class="operator">LO</span><span class="bracket">(</span><a class="popup variable">JumpToPreview</a><span class="bracket">)</span> <span class="comment">\ Note that when an RTS instruction is executed, it pops</span>
 <span class="mne">STA</span> <span class="hex">&0100</span>,<span class="register">X</span>            <span class="comment">\ the address off the top of the stack and then jumps to</span>
                        <span class="comment">\ that address + 1, so putting the JumpToPreview address</span>
                        <span class="comment">\ on the stack means that the RTS at the end of the</span>
                        <span class="comment">\ GenerateLandscape routine will actually send us to</span>
                        <span class="comment">\ address JumpToPreview+1</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is intentional and is intended to confuse any</span>
                        <span class="comment">\ crackers who might have reached this point, because</span>
                        <span class="comment">\ the JumpToPreview routine not only contains a JMP</span>
                        <span class="comment">\ instruction at JumpToPreview, but it also contains a</span>
                        <span class="comment">\ BMI instruction at JumpToPreview+1, if our crackers</span>
                        <span class="comment">\ forgot about this subtlety of the RTS instruction,</span>
                        <span class="comment">\ they might end up going down a rabbit hole</span>

<span class="label">.stri10</span><a id="stri10" class="anchor"></a>

 <span class="mne">JMP</span> <a class="popup destination">stri16</a>             <span class="comment">\ Jump to stri16 to copy the tile data for the smoothed</span>
                        <span class="comment">\ strip back into the tileData table</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-jumptopreview"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/jumptopreview.html">JumpToPreview</a> (category: Cracker protection)</div><div class="summary">An intentionally confusing jump point for controlling the main title loop flow when returning from the GenerateLandscape routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-donotplaylandscape"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#donotplaylandscape">doNotPlayLandscape</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A flag that controls whether we preview and play the landscape after generating it</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri10">stri10</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri16"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_4_of_4.html#stri16">stri16</a> in subroutine <a href="/source/main/subroutine/smoothtilecorners_part_4_of_4.html">SmoothTileCorners (Part 4 of 4)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri4">stri4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri5">stri5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri6">stri6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri7">stri7</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri8">stri8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stri9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/smoothtilecorners_part_2_of_4.html#stri9">stri9</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-stripdata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/stripdata.html">stripData</a> (category: Landscape)</div><div class="summary">Storage for tile data when smoothing strips of tiles during the landscape generation process</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/smoothtilecorners_part_1_of_4.html">SmoothTileCorners (Part 1 of 4)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/smoothtilecorners_part_3_of_4.html">SmoothTileCorners (Part 3 of 4)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
