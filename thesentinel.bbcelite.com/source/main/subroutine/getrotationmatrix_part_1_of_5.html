<?php
include_once("../../../templates/template_functions.php");
page_header("maths_geometry", "subroutine_getrotationmatrix_part_1_of_5.html", "The GetRotationMatrix (Part 1 of 5) subroutine", "Maths (Geometry): GetRotationMatrix (Part 1 of 5)", "Annotated code for the GetRotationMatrix (Part 1 of 5) subroutine in The Sentinel", "the_sentinel-code", "source_maths_geometry", "subroutine_getrotationmatrix_part_1_of_5", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getanglefromcoords_part_3_of_3.html">GetAngleFromCoords (Part 3 of 3)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getrotationmatrix_part_2_of_5.html">GetRotationMatrix (Part 2 of 5)</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">GetRotationMatrix (Part 1 of 5)</span>                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Maths (Geometry)</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Calculate the rotation matrix for rotating the pitch or yaw angle</span>
             <span class="headerEntry">for the sights into the global 3D coordinate system</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_a.html#header-getrotationmatrix-part-1-of-5">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/getvectorforangles.html">GetVectorForAngles</a> calls <a href="#getrotationmatrix">GetRotationMatrix</a></span>
</div>
<hr class="light">
 This routine is used to calculate the following:

   sinAngle = sin(vectorPitchAngle)
   cosAngle = cos(vectorPitchAngle)

 or:

   sinAngle = sin(vectorYawAngle)
   cosAngle = cos(vectorYawAngle)

 We can use these to convert the pitch and yaw angles of the vector from the
 player's eyes to the sights into a cartesian vector within the 3D world.

 This routine is from Revs, Geoff Crammond's previous game. There are only
 minor differences: the argument is (A T) instead of (A X), and the value of X
 is preserved. Note that to avoid clashing names, the variables G and H have
 been renamed to G2 and H2, but the routine is otherwise the same.

 For the calculations in The Sentinel we don't need a full rotation matrix,
 but the Revs routine calculates the values that we do need, as mentioned
 above. I could have renamed this routine for The Sentinel to something like
 GetSinAndCos16, as all it does is calculate the sine and cosine to 16-bit
 accuracy, but I've left the Revs code alone as much as possible to show the
 influence of Geoff Crammond's previous game.

 Also, because this routine comes from Revs, where it is only used to rotate
 through the driver's yaw angle, I have renamed the result variables from
 sinYawAngle and cosYawAngle to sinAngle and cosAngle, as The Sentinel uses
 the routine to rotate through both yaw angles and pitch angles. To keep things
 simple the commentary still refers to yaw angles, but the calculations apply
 equally to pitch angles.

<hr class="light">
<span class="subheader"> Arguments:</span>

   <span class="argumentLabel">(A T)</span>                <span class="argumentEntry">The pitch or yaw angle to encapsulate in the rotation</span>
                        <span class="argumentEntry">matrix</span>

<hr class="light">
<span class="subheader"> Returns:</span>

   <span class="argumentLabel">X</span>                    <span class="argumentEntry">X is preserved</span>

</div></div>
<span class="label">.GetRotationMatrix</span><a id="getrotationmatrix" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">J</a>                  <span class="comment">\ Set (J T) = (A T)</span>
                        <span class="comment">\           = vectorYawAngle or vectorPitchAngle</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Note that because this routine is copied almost</span>
                        <span class="comment">\ verbatim from Revs, the commentary only refers to yaw</span>
                        <span class="comment">\ angles, but this routine can work just as well with</span>
                        <span class="comment">\ pitch angles as arguments</span>

 <span class="mne">STX</span> <a class="popup variable">xStoreMatrix</a>       <span class="comment">\ Store X in xStoreMatrix so it can be preserved across</span>
                        <span class="comment">\ calls to the routine</span>

 <span class="mne">JSR</span> <a class="popup destination">GetAngleInRadians</a>  <span class="comment">\ Set (U A) to the vectorYawAngle, reduced to a quarter</span>
                        <span class="comment">\ circle, converted to radians, and halved</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Let's call this yawRadians / 2, where yawRadians is</span>
                        <span class="comment">\ the reduced player yaw angle in radians</span>

 <span class="mne">STA</span> <a class="popup variable">G2</a>                 <span class="comment">\ Set (U G) = (U A) = yawRadians / 2</span>

 <span class="mne">LDA</span> <a class="popup variable">U</a>                  <span class="comment">\ Set (A G) = (U G) = yawRadians / 2</span>

 <span class="mne">STA</span> <a class="popup variable">H2</a>                 <span class="comment">\ Set (H G) = (A G) = yawRadians / 2</span>

                        <span class="comment">\ So we now have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   (H G) = (A G) = (U G) = yawRadians / 2</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is the angle vector that we now project onto the</span>
                        <span class="comment">\ x- and z-axes of the world 3D coordinate system</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">1</span>                 <span class="comment">\ Set X = 0 and secondAxis = 1, so we project sin(H G)</span>
 <span class="mne">STX</span> <a class="popup variable">secondAxis</a>         <span class="comment">\ into sinAngle and cos(H G) into cosAngle</span>
 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>

 <span class="mne">BIT</span> <a class="popup variable">J</a>                  <span class="comment">\ If bit 6 of J is clear, then vectorYawAngle is in one</span>
 <span class="mne">BVC</span> <a class="popup destination">rotm1</a>              <span class="comment">\ of these ranges:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 0 to 63 (%00000000 to %00111111)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * -128 to -65 (%10000000 to %10111111)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The degree system in the Sentinel looks like this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\            0</span>
                        <span class="comment">\      -32   |   +32         Overhead view of player</span>
                        <span class="comment">\         \  |  /</span>
                        <span class="comment">\          \ | /             0 = looking straight ahead</span>
                        <span class="comment">\           \|/              +64 = looking sharp right</span>
                        <span class="comment">\   -64 -----+----- +64      -64 = looking sharp left</span>
                        <span class="comment">\           /|\</span>
                        <span class="comment">\          / | \</span>
                        <span class="comment">\         /  |  \</span>
                        <span class="comment">\      -96   |   +96</span>
                        <span class="comment">\           128</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So vectorYawAngle is in the top-right or bottom-left</span>
                        <span class="comment">\ quarter in the above diagram</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In both cases we jump to rotm1 to set sinAngle and</span>
                        <span class="comment">\ cosAngle</span>

                        <span class="comment">\ If we get here then bit 6 of J is set, so</span>
                        <span class="comment">\ vectorYawAngle is in one of these ranges:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * 64 to 127 (%01000000 to %01111111)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * -64 to -1 (%11000000 to %11111111)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So vectorYawAngle is in the bottom-right or top-left</span>
                        <span class="comment">\ quarter in the above diagram</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In both cases we set the variables the other way</span>
                        <span class="comment">\ round, as the triangle we draw to calculate the angle</span>
                        <span class="comment">\ is the opposite way round (i.e. it's reflected in the</span>
                        <span class="comment">\ x-axis or y-axis)</span>

 <span class="mne">INX</span>                    <span class="comment">\ Set X = 1 and secondAxis = 0, so we project sin(H G)</span>
 <span class="mne">DEC</span> <a class="popup variable">secondAxis</a>         <span class="comment">\ into cosAngle and cos(H G) into sinAngle</span>

                        <span class="comment">\ We now enter a loop that sets sinAngle + X to</span>
                        <span class="comment">\ sin(H G) on the first iteration, and sets</span>
                        <span class="comment">\ sinAngle + secondAxis to cos(H G) on the second</span>
                        <span class="comment">\ iteration</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The commentary is for the sin(H G) iteration, see the</span>
                        <span class="comment">\ end of the loop for details of how the second</span>
                        <span class="comment">\ iteration calculates cos(H G) instead</span>

<span class="label">.rotm1</span><a id="rotm1" class="anchor"></a>

                        <span class="comment">\ If we get here, then we are set up to calculate the</span>
                        <span class="comment">\ following:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If vectorYawAngle is top-right or bottom-left:</span>
                        <span class="comment">\</span>
                        <span class="comment">\     sinAngle = sin(vectorYawAngle)</span>
                        <span class="comment">\     cosAngle = cos(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * If vectorYawAngle is bottom-right or top-left:</span>
                        <span class="comment">\</span>
                        <span class="comment">\     sinAngle = cos(vectorYawAngle)</span>
                        <span class="comment">\     cosAngle = sin(vectorYawAngle)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ In each case, the calculation gives us the correct</span>
                        <span class="comment">\ coordinate, as the second set of results uses angles</span>
                        <span class="comment">\ that are "reflected" in the x-axis or y-axis by the</span>
                        <span class="comment">\ capping process in the GetAngleInRadians routine</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">122</span>               <span class="comment">\ If A &lt; 122, i.e. U &lt; 122 and H &lt; 122, jump to rotm2</span>
 <span class="mne">BCC</span> <a class="popup destination">rotm2</a>              <span class="comment">\ to calculate sin(H G) for smaller angles</span>

 <span class="mne">BCS</span> <a class="popup destination">rotm3</a>              <span class="comment">\ Jump to rotm3 to calculate sin(H G) for larger angles</span>
                        <span class="comment">\ (this BCS is effectively a JMP as we just passed</span>
                        <span class="comment">\ through a BCS)</span>

 <span class="mne">LDA</span> <a class="popup variable">G2</a>                 <span class="comment">\ It doesn't look like this code is ever reached, so</span>
 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">240</span>               <span class="comment">\ presumably it's left over from development</span>
 <span class="mne">BCS</span> <a class="popup destination">rotm3</a>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-g2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#g2">G2</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Temporary storage, used in the maths routines from Revs, where the original variable name was G (this variable has been renamed to G2 to prevent a clash with the G variable that is used by The Sentinel)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getangleinradians"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/getangleinradians.html">GetAngleInRadians</a> (category: Maths (Geometry))</div><div class="summary">Convert a 16-bit angle into radians, restricted to a quarter circle</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-h2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#h2">H2</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Temporary storage, used in the maths routines from Revs, where the original variable name was H (this variable has been renamed to H2 to prevent a clash with the H variable that is used by The Sentinel)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-j"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#j">J</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">Temporary storage, used in the maths routines from Revs</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-u"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#u">U</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rotm1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrotationmatrix_part_1_of_5.html#rotm1">rotm1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rotm2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrotationmatrix_part_2_of_5.html#rotm2">rotm2</a> in subroutine <a href="/source/main/subroutine/getrotationmatrix_part_2_of_5.html">GetRotationMatrix (Part 2 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-rotm3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/getrotationmatrix_part_3_of_5.html#rotm3">rotm3</a> in subroutine <a href="/source/main/subroutine/getrotationmatrix_part_3_of_5.html">GetRotationMatrix (Part 3 of 5)</a></div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-secondaxis"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#secondaxis">secondAxis</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">The number of the second axis to calculate in the GetRotationMatrix routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xstorematrix"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xstorematrix.html">xStoreMatrix</a> (category: Maths (Geometry))</div><div class="summary">Temporary storage for X so it can be preserved through calls to GetRotationMatrix</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/getanglefromcoords_part_3_of_3.html">GetAngleFromCoords (Part 3 of 3)</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/getrotationmatrix_part_2_of_5.html">GetRotationMatrix (Part 2 of 5)</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
