<?php
include_once("../../../templates/template_functions.php");
page_header("sound", "subroutine_processmusic.html", "The ProcessMusic subroutine", "Sound: ProcessMusic", "Annotated code for the ProcessMusic subroutine in The Sentinel", "the_sentinel-code", "source_sound", "subroutine_processmusic", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/processpausekeys.html">ProcessPauseKeys</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/flushsoundbuffers.html">FlushSoundBuffers</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">ProcessMusic</span>                                            <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Sound</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Play the configured music in the background</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_g.html#header-processmusic">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/processsound.html">ProcessSound</a> calls <a href="#processmusic">ProcessMusic</a></span>
</div>
</div></div>
<span class="label">.ProcessMusic</span><a id="processmusic" class="anchor"></a>

 <span class="mne">LDX</span> <a class="popup variable">musicCounter</a>       <span class="comment">\ Set X to the music counter, which points to the</span>
                        <span class="comment">\ current place in the music data</span>

 <span class="mne">BMI</span> <a class="popup destination">musi4</a>              <span class="comment">\ If bit 7 of musicCounter is set then there is no music</span>
                        <span class="comment">\ playing, so jump to musi4 to return from the</span>
                        <span class="comment">\ subroutine</span>

 <span class="mne">INC</span> <a class="popup variable">musicCounter</a>       <span class="comment">\ Otherwise there is some music being played, so</span>
                        <span class="comment">\ increment the music counter to move through the music</span>
                        <span class="comment">\ data</span>

 <span class="mne">LDA</span> <a class="popup variable">musicData</a>,<span class="register">X</span>        <span class="comment">\ Set A to the next byte of music data</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&FF</span>               <span class="comment">\ If A = &FF then we just reached the end of this piece</span>
 <span class="mne">BEQ</span> <a class="popup destination">musi3</a>              <span class="comment">\ of music, so jump to musi3 to stop playing music</span>

                        <span class="comment">\ If we get here then we need to process the byte of</span>
                        <span class="comment">\ music data in A</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">200</span>               <span class="comment">\ If A &lt; 200 then jump to musi1 to make the sound</span>
 <span class="mne">BCC</span> <a class="popup destination">musi1</a>

                        <span class="comment">\ If we get here then A contains the sound counter to</span>
                        <span class="comment">\ set for all following notes, with the form 200 + x</span>
                        <span class="comment">\ setting the counter to 4 * x</span>

 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">200</span>               <span class="comment">\ Set noteCounter = (A - 200) * 4</span>
 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\</span>
 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\ This subtraction works because we just passed through</span>
 <span class="mne">STA</span> <a class="popup variable">noteCounter</a>        <span class="comment">\ a BCC, so we know the C flag is set</span>

 <span class="mne">JMP</span> <a class="popup destination">ProcessMusic</a>       <span class="comment">\ Loop back to the start of the routine to process the</span>
                        <span class="comment">\ next byte of music data</span>

<span class="label">.musi1</span><a id="musi1" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">20</span>       <span class="comment">\ Set the third parameter of sound data block #2 to A,</span>
                        <span class="comment">\ to set the pitch</span>

 <span class="mne">LDA</span> <a class="popup variable">noteCounter</a>        <span class="comment">\ Set soundCounter to the note duration so the note</span>
 <span class="mne">STA</span> <a class="popup variable">soundCounter</a>       <span class="comment">\ plays for the correct amount of time</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This means that the ProcessSound routine will do</span>
                        <span class="comment">\ nothing until this counter has run down, so we can</span>
                        <span class="comment">\ play three-note chords by setting the delay to zero</span>
                        <span class="comment">\ for the first two notes in the chord, so that there is</span>
                        <span class="comment">\ no delay between them, and then setting the delay for</span>
                        <span class="comment">\ the last note to the duration of the chord, so the</span>
                        <span class="comment">\ three chord notes play together for that period</span>
                        <span class="comment">\</span>
                        <span class="comment">\ All we need to do is ensure that the three notes can</span>
                        <span class="comment">\ play together, which is what we do next</span>

 <span class="mne">LDA</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">16</span>       <span class="comment">\ Set A to the first parameter of sound data block #2,</span>
                        <span class="comment">\ which contains the channel</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This is in the form &1x for sound channel x, and it</span>
                        <span class="comment">\ starts out at &12 for channel 2</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Channels 1 to 3 are for tones, so we work our way</span>
                        <span class="comment">\ through channels &11 to &13, playing each note on the</span>
                        <span class="comment">\ next channel number</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This plays the music with the last three notes being</span>
                        <span class="comment">\ sustained, which lets us play three-note chords as</span>
                        <span class="comment">\ described above, giving the game music its distinctive</span>
                        <span class="comment">\ chord style</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Add 1 to move A onto the number of the next channel</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">1</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&14</span>               <span class="comment">\ If A &lt; &14 then we are still in the range &11 to &13,</span>
 <span class="mne">BCC</span> <a class="popup destination">musi2</a>              <span class="comment">\ so jump to musi2 to use this channel</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&11</span>               <span class="comment">\ Otherwise warp around to channel &11</span>

<span class="label">.musi2</span><a id="musi2" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">16</span>       <span class="comment">\ Set the first parameter of sound data block #2 to A,</span>
                        <span class="comment">\ which sets the channel</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">4</span>                 <span class="comment">\ Set the second parameter of sound data block #2 to 4,</span>
 <span class="mne">STA</span> <a class="popup variable">soundData</a><span class="operator">+</span><span class="decimal">18</span>       <span class="comment">\ which sets the amplitude</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="decimal">3</span>                 <span class="comment">\ Make sound #3 (music), which plays the next note of</span>
 <span class="mne">JMP</span> <a class="popup destination">MakeSound</a>          <span class="comment">\ music, returning from the subroutine using a tail call</span>

<span class="label">.musi3</span><a id="musi3" class="anchor"></a>

                        <span class="comment">\ If we get here then we just reached the end of the</span>
                        <span class="comment">\ piece of music and A = &FF</span>

 <span class="mne">STA</span> <a class="popup variable">musicCounter</a>       <span class="comment">\ Set bit 7 of the music counter to flag that we are no</span>
                        <span class="comment">\ longer playing any music</span>

<span class="label">.musi4</span><a id="musi4" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-makesound"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/makesound.html">MakeSound</a> (category: Sound)</div><div class="summary">Make a sound</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-processmusic"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/processmusic.html">ProcessMusic</a> (category: Sound)</div><div class="summary">Play the configured music in the background</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-musi1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/processmusic.html#musi1">musi1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-musi2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/processmusic.html#musi2">musi2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-musi3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/processmusic.html#musi3">musi3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-musi4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/processmusic.html#musi4">musi4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-musiccounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#musiccounter">musicCounter</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A counter for the music currently being made, which counts up in the ProcessMusic routine while the music is being played</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-musicdata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/musicdata.html">musicData</a> (category: Sound)</div><div class="summary">Data for the game's music</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-notecounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#notecounter">noteCounter</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The sound counter for an individual note while playing chords in the music player</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-soundcounter"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#soundcounter">soundCounter</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A counter for the sound currently being made, which counts down in the IRQHandler routine at a rate of 50 times a second</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sounddata"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/sounddata.html">soundData</a> (category: Sound)</div><div class="summary">OSWORD blocks for making the various game sounds</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/processpausekeys.html">ProcessPauseKeys</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/flushsoundbuffers.html">FlushSoundBuffers</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
