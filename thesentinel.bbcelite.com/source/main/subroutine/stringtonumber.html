<?php
include_once("../../../templates/template_functions.php");
page_header("text", "subroutine_stringtonumber.html", "The StringToNumber subroutine", "Text: StringToNumber", "Annotated code for the StringToNumber subroutine in The Sentinel", "the_sentinel-code", "source_text", "subroutine_stringtonumber", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/printinputbuffer.html">PrintInputBuffer</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/digittonumber.html">DigitToNumber</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">StringToNumber</span>                                          <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Text</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Convert a string of ASCII digits in the input buffer in-place into</span>
             <span class="headerEntry">a multi-byte BCD number</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_g.html#header-stringtonumber">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/maintitleloop.html">MainTitleLoop</a> calls <a href="#stringtonumber">StringToNumber</a></span>
</div>
</div></div>
<span class="label">.StringToNumber</span><a id="stringtonumber" class="anchor"></a>

 <span class="mne">LDY</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ We want to work through the input buffer, converting</span>
                        <span class="comment">\ each character in turn from an ASCII digit into a</span>
                        <span class="comment">\ number, so set an index in Y to work through the</span>
                        <span class="comment">\ buffer, one ASCII digit at a time</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ Each pair of ASCII digits gets converted into a value</span>
                        <span class="comment">\ that will fit into a single BCD byte, which we store</span>
                        <span class="comment">\ in-place, so set an index in X to work through the</span>
                        <span class="comment">\ buffer, so we can store the resulting BCD number one</span>
                        <span class="comment">\ byte at a time (i.e. two ASCII digits at a time)</span>

<span class="label">.snum1</span><a id="snum1" class="anchor"></a>

                        <span class="comment">\ We now fetch two digits from the input buffer and</span>
                        <span class="comment">\ convert them into a single BCD number, remembering</span>
                        <span class="comment">\ that the input buffer is stored as an ascending stack,</span>
                        <span class="comment">\ so the digits on the left of the stack (i.e. those</span>
                        <span class="comment">\ that were typed first) are lower significance than</span>
                        <span class="comment">\ those on the right of the stack (i.e. those that were</span>
                        <span class="comment">\ typed last)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Effectively the stack is little-endian, just like the</span>
                        <span class="comment">\ 6502 processor</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The calls to DigitToNumber will backfill the input</span>
                        <span class="comment">\ buffer with &FF if we are reading from the last four</span>
                        <span class="comment">\ characters of the input buffer, so the final result</span>
                        <span class="comment">\ will have four BCD numbers at the start of inputBuffer</span>
                        <span class="comment">\ (from inputBuffer to inputBuffer+3), and the rest of</span>
                        <span class="comment">\ the buffer will be padded out with four &FF bytes</span>
                        <span class="comment">\ (from inputBuffer+4 to inputBuffer+7)</span>

 <span class="mne">JSR</span> <a class="popup destination">DigitToNumber</a>      <span class="comment">\ Set T to the numerical value of the character at index</span>
 <span class="mne">STA</span> <a class="popup variable">T</a>                  <span class="comment">\ Y in the input buffer, which is the low significance</span>
                        <span class="comment">\ digit of the number we are fetching, and in the range</span>
                        <span class="comment">\ 0 to 9</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment Y to the next character in the input buffer</span>

 <span class="mne">JSR</span> <a class="popup destination">DigitToNumber</a>      <span class="comment">\ Set A to the numerical value of the character at index</span>
                        <span class="comment">\ Y in the input buffer, which is the high significance</span>
                        <span class="comment">\ digit of the number we are fetching, and in the range</span>
                        <span class="comment">\ 0 to 9</span>

 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\ Shift the high significance digit in A into bits 4-7,</span>
 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\ so A contains the first digit of the BCD number</span>
 <span class="mne">ASL</span> <span class="register">A</span>
 <span class="mne">ASL</span> <span class="register">A</span>

 <span class="mne">ORA</span> <a class="popup variable">T</a>                  <span class="comment">\ Insert the high significance digit in T into bits 0-3,</span>
                        <span class="comment">\ so A now contains both the first and second digits of</span>
                        <span class="comment">\ the BCD number</span>

 <span class="mne">STA</span> <a class="popup variable">inputBuffer</a>,<span class="register">X</span>      <span class="comment">\ Store the BCD number in-place at index X</span>

 <span class="mne">INX</span>                    <span class="comment">\ Increment the result index in X to move on to the next</span>
                        <span class="comment">\ BCD number</span>

 <span class="mne">INY</span>                    <span class="comment">\ Increment the buffer index in Y to move on to the next</span>
                        <span class="comment">\ pair of digits</span>

 <span class="mne">CPY</span> <span class="hash">#</span><span class="decimal">8</span>                 <span class="comment">\ Loop back until we have converted the whole string</span>
 <span class="mne">BNE</span> <a class="popup destination">snum1</a>              <span class="comment">\ into a multi-byte BCD number</span>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-digittonumber"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/digittonumber.html">DigitToNumber</a> (category: Text)</div><div class="summary">Convert a digit from the input buffer into a number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-t"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#t">T</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Temporary storage, used in a number of places</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-inputbuffer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#inputbuffer">inputBuffer</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The eight-byte keyboard input buffer</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-snum1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/stringtonumber.html#snum1">snum1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/printinputbuffer.html">PrintInputBuffer</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/digittonumber.html">DigitToNumber</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
