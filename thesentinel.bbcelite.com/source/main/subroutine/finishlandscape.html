<?php
include_once("../../../templates/template_functions.php");
page_header("main_game_loop", "subroutine_finishlandscape.html", "The FinishLandscape subroutine", "Main game loop: FinishLandscape", "Annotated code for the FinishLandscape subroutine in The Sentinel", "the_sentinel-code", "source_main_game_loop", "subroutine_finishlandscape", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/expendenemyenergy.html">ExpendEnemyEnergy</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/findobjecttodrain.html">FindObjectToDrain</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">FinishLandscape</span>                                         <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Main game loop</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Add the player's energy to the landscape number to get the number</span>
             <span class="headerEntry">of the next landscape and display that landscape's secret code</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_c.html#header-finishlandscape">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/maingameloop.html">MainGameLoop</a> calls <a href="#finishlandscape">FinishLandscape</a></span>
</div>
</div></div>
<span class="label">.FinishLandscape</span><a id="finishlandscape" class="anchor"></a>

 <span class="mne">SED</span>                    <span class="comment">\ Set the D flag to switch arithmetic to binary coded</span>
                        <span class="comment">\ decimal (BCD), so the call to GetPlayerEnergyBCD and</span>
                        <span class="comment">\ the following addition are all done in BCD</span>

 <span class="mne">JSR</span> <a class="popup destination">GetPlayerEnergyBCD</a> <span class="comment">\ Set A to the player's energy in BCD</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Set (Y X) = landscapeNumber(Hi Lo) + A</span>
 <span class="mne">ADC</span> <a class="popup variable">landscapeNumberLo</a>  <span class="comment">\</span>
 <span class="mne">TAX</span>                    <span class="comment">\ This addition is done in BCD so the result is a new</span>
 <span class="mne">LDA</span> <a class="popup variable">landscapeNumberHi</a>  <span class="comment">\ landscape number that's also in BCD (which we need to</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">0</span>                 <span class="comment">\ do as landscape numbers are in BCD)</span>
 <span class="mne">TAY</span>

 <span class="mne">CLD</span>                    <span class="comment">\ Clear the D flag to switch arithmetic to normal</span>

 <span class="mne">JSR</span> <a class="popup destination">InitialiseSeeds</a>    <span class="comment">\ Initialise the seed number generator to generate the</span>
                        <span class="comment">\ sequence of seed numbers for the landscape number in</span>
                        <span class="comment">\ (Y X) and set maxNumberOfEnemies and the landscapeZero</span>
                        <span class="comment">\ flag accordingly</span>

                        <span class="comment">\ We set bit 7 of doNotPlayLandscape when the landscape</span>
                        <span class="comment">\ was completed in the PerformHyperspace routine, so the</span>
                        <span class="comment">\ following calls to GenerateLandscape and SpawnPlayer</span>
                        <span class="comment">\ return normally, without previewing the landscape</span>
                        <span class="comment">\ (GenerateLandscape) or starting the game (SpawnPlayer)</span>

 <span class="mne">JSR</span> <a class="popup destination">GenerateLandscape</a>  <span class="comment">\ Call GenerateLandscape to generate the landscape</span>

 <span class="mne">JSR</span> <a class="popup destination">SpawnEnemies</a>       <span class="comment">\ Calculate the number of enemies for this landscape,</span>
                        <span class="comment">\ add them to the landscape and set the palette</span>
                        <span class="comment">\ accordingly</span>

 <span class="mne">JSR</span> <a class="popup destination">SpawnPlayer</a>        <span class="comment">\ Add the player and trees to the landscape</span>

 <span class="mne">LDA</span> <span class="hash">#</span><span class="hex">&80</span>               <span class="comment">\ Call DrawTitleScreen with A = &80 to draw the screen</span>
 <span class="mne">JSR</span> <a class="popup destination">DrawTitleScreen</a>    <span class="comment">\ showing the landscape's secret code</span>

 <span class="mne">LDX</span> <span class="hash">#</span><span class="decimal">5</span>                 <span class="comment">\ Print text token 5: Print "SECRET ENTRY CODE" at</span>
 <span class="mne">JSR</span> <a class="popup destination">PrintTextToken</a>     <span class="comment">\ (64, 768), "LANDSCAPE" at (192, 704), move cursor</span>
                        <span class="comment">\ right</span>

 <span class="mne">JMP</span> <a class="popup destination">PrintLandscapeNum</a>  <span class="comment">\ Print the four-digit landscape (0000 to 9999) and</span>
                        <span class="comment">\ return from the subroutine using a tail call</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-drawtitlescreen"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/drawtitlescreen.html">DrawTitleScreen</a> (category: Title screen)</div><div class="summary">Draw the title screen or the screen showing the secret code</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-generatelandscape"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/generatelandscape.html">GenerateLandscape</a> (category: Landscape)</div><div class="summary">Generate tile data for the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-getplayerenergybcd"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/getplayerenergybcd.html">GetPlayerEnergyBCD</a> (category: Maths (Arithmetic))</div><div class="summary">Fetch the player's energy in binary coded decimal (BCD)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-initialiseseeds"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/initialiseseeds.html">InitialiseSeeds</a> (category: Landscape)</div><div class="summary">Initialise the seed number generator so it generates the sequence of seed numbers for a specific landscape number</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-printlandscapenum"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/printlandscapenum.html">PrintLandscapeNum</a> (category: Text)</div><div class="summary">Print the four-digit landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-printtexttoken"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/printtexttoken.html">PrintTextToken</a> (category: Text)</div><div class="summary">Print a recursive text token</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnenemies"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/spawnenemies.html">SpawnEnemies</a> (category: Landscape)</div><div class="summary">Calculate the number of enemies for this landscape, add them to the landscape and set the palette accordingly</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-spawnplayer"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/spawnplayer.html">SpawnPlayer</a> (category: Landscape)</div><div class="summary">Add the player object to the landscape, ideally placing it below all the enemies and in the bottom half of the landscape</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-landscapenumberhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#landscapenumberhi">landscapeNumberHi</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The high byte of the four-digit binary coded decimal landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-landscapenumberlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#landscapenumberlo">landscapeNumberLo</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The low byte of the four-digit binary coded decimal landscape number (0000 to 9999)</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/expendenemyenergy.html">ExpendEnemyEnergy</a><a class="next" rel="next" title="Next routine" href="/source/main/subroutine/findobjecttodrain.html">FindObjectToDrain</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
