<?php
include_once("../../../templates/template_functions.php");
page_header("sights", "subroutine_drawsights.html", "The DrawSights subroutine", "Sights: DrawSights", "Annotated code for the DrawSights subroutine in The Sentinel", "the_sentinel-code", "source_sights", "subroutine_drawsights", "");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/setsightsaddress.html">SetSightsAddress</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/pixelbytecolour2.html">pixelByteColour2</a></nav>
				</div>

				<div class="codeBlockWrapper">
<pre class="codeBlock sourceCode initial"><div class="headerBlockWrapper"><div class="headerBlock"><span class="headerLabel">       Name:</span> <span class="headerEntry">DrawSights</span>                                              <span class="routineLink">[<a class="extraDataLink" href="#">Show more</a>]</span>
<span class="headerLabel">       Type:</span> <span class="headerEntry">Subroutine</span>
<span class="headerLabel">   Category:</span> <span class="headerEntry">Sights</span>
<span class="headerLabel">    Summary:</span> <span class="headerEntry">Draw the sights on the screen, saving the existing screen contents</span>
             <span class="headerEntry">in the sights pixel byte stash</span>
<div class="extraData"><span class="headerLabel">    Context:</span> <span class="headerEntry">See this subroutine <a href="/source/all/the_sentinel_h.html#header-drawsights">in context in the source code</a></span>
<span class="headerLabel"> References:</span> <span class="headerEntry">This subroutine is called as follows:</span>
             <span class="headerEntry">* <a href="/source/main/subroutine/checkforkeypresses.html">CheckForKeyPresses</a> calls <a href="#drawsights">DrawSights</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/drawupdatedobject.html">DrawUpdatedObject</a> calls <a href="#drawsights">DrawSights</a></span>
             <span class="headerEntry">* <a href="/source/main/subroutine/movesights.html">MoveSights</a> calls <a href="#drawsights">DrawSights</a></span>
</div>
</div></div>
<span class="label">.DrawSights</span><a id="drawsights" class="anchor"></a>

 <span class="mne">LDA</span> <a class="popup variable">doNotDrawSights</a>    <span class="comment">\ If bit 7 of doNotDrawSights is set then we do not draw</span>
 <span class="mne">BMI</span> <a class="popup destination">dras2</a>              <span class="comment">\ the sights, so jump to dras12 via dras2 to return from</span>
                        <span class="comment">\ the subroutine</span>

 <span class="mne">JSR</span> <a class="popup destination">RemoveSights</a>       <span class="comment">\ First we remove the sights from the screen (if there</span>
                        <span class="comment">\ are any sights on-screen), so if we are drawing the</span>
                        <span class="comment">\ sights to move them, this removes the old sights</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This also sets sightsByteCount = 0 to reset the sights</span>
                        <span class="comment">\ pixel byte stash</span>

                        <span class="comment">\ We now set the coordinates of the "brush" that we're</span>
                        <span class="comment">\ going to use to draw the sights</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The coordinates of the brush are stored relative to</span>
                        <span class="comment">\ the top-left corner of the character block containing</span>
                        <span class="comment">\ the top of the sights</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The current coordinate of the brush is stored as</span>
                        <span class="comment">\ follows:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * sightsByteAddr(1 0) contains the address of the</span>
                        <span class="comment">\     character block in which we are dabbing our brush</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * The x-coordinate is stored in xSightsBrush in the</span>
                        <span class="comment">\     form of a pixel offset within the character block</span>
                        <span class="comment">\     pointed to by sightsByteAddr(1 0), so this is</span>
                        <span class="comment">\     always in the range 0 to 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\   * The y-coordinate is stored in Y in the form of a</span>
                        <span class="comment">\     pixel row offset within the character block</span>
                        <span class="comment">\     pointed to by sightsByteAddr(1 0), so this is</span>
                        <span class="comment">\     always in the range 0 to 7</span>

 <span class="mne">LDA</span> <a class="popup variable">xSights</a>            <span class="comment">\ Set xSightsBrush as follows:</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000011</span>         <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">xSightsBrush</a>       <span class="comment">\   xSightsBrush = xSights mod 4</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Each pixel byte contains four pixels, so this sets</span>
                        <span class="comment">\ xSightsBrush to the x-coordinate of the sights within</span>
                        <span class="comment">\ the pixel byte in which the sights appear, in the</span>
                        <span class="comment">\ range 0 to 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This gives us the x-coordinate of the starting point</span>
                        <span class="comment">\ for the brush at the top of the sights, relative to</span>
                        <span class="comment">\ the top-left corner of the character block containing</span>
                        <span class="comment">\ the top of the sights</span>

 <span class="mne">LDA</span> <a class="popup variable">sightsScreenAddr</a>   <span class="comment">\ Set Y to bits 0-2 of the address of the sights in</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000111</span>         <span class="comment">\ screen memory, so Y contains the number of the pixel</span>
 <span class="mne">TAY</span>                    <span class="comment">\ row within the character block containing the sights</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This gives us the y-coordinate of the starting point</span>
                        <span class="comment">\ for the brush at the top of the sights, relative to</span>
                        <span class="comment">\ the top-left corner of the character block containing</span>
                        <span class="comment">\ the top of the sights</span>

 <span class="mne">LDA</span> <a class="popup variable">sightsScreenAddr</a>   <span class="comment">\ Set sightsByteAddr(1 0) to bits 3-15 of the address</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%11111000</span>         <span class="comment">\ of the sights in screen memory, so it contains the</span>
 <span class="mne">STA</span> <a class="popup variable">sightsByteAddr</a>     <span class="comment">\ address of the top-left corner of the character block</span>
 <span class="mne">LDA</span> <a class="popup variable">sightsScreenAddr</a><span class="operator">+</span><span class="decimal">1</span> <span class="comment">\ containing the top of the sights</span>
 <span class="mne">STA</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>

                        <span class="comment">\ We now draw the sights one step at a time, dabbing the</span>
                        <span class="comment">\ brush on the screen for each step</span>
                        <span class="comment">\</span>
                        <span class="comment">\ There are 12 steps when drawing the sights, and we</span>
                        <span class="comment">\ draw one screen byte (four pixels) in each step,</span>
                        <span class="comment">\ storing the original screen contents in the sights</span>
                        <span class="comment">\ pixel byte stash, so we can easily remove the sights</span>
                        <span class="comment">\ later</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We start by placing our brush at the top of the sights</span>
                        <span class="comment">\ and dabbing the screen to draw the first pixel byte</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The top of the sights are at a relative coordinate of</span>
                        <span class="comment">\ (xSightsBrush, Y) from the start of the character</span>
                        <span class="comment">\ block of the sights, so this is where we start</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We then apply the steps from the xSightsStep and</span>
                        <span class="comment">\ ySightsStep tables to the brush coordinates, dabbing</span>
                        <span class="comment">\ the screen at each step, starting from step 0 and</span>
                        <span class="comment">\ moving as follows (where steps 10 and 11 are shown as</span>
                        <span class="comment">\ A and B):</span>
                        <span class="comment">\</span>
                        <span class="comment">\        00</span>
                        <span class="comment">\        11</span>
                        <span class="comment">\        22</span>
                        <span class="comment">\   334455667788</span>
                        <span class="comment">\        99</span>
                        <span class="comment">\        AA</span>
                        <span class="comment">\        BB</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The current step number is stored in sightsByteCount,</span>
                        <span class="comment">\ which also tracks the size of the sights pixel byte</span>
                        <span class="comment">\ stash</span>

<span class="label">.dras1</span><a id="dras1" class="anchor"></a>

                        <span class="comment">\ We start by adding the next step to the y-coordinate</span>
                        <span class="comment">\ of the brush and updating sightsByteAddr(1 0) and Y</span>
                        <span class="comment">\ accordingly</span>

 <span class="mne">LDX</span> <a class="popup variable">sightsByteCount</a>    <span class="comment">\ Set X to the current step number, which is also the</span>
                        <span class="comment">\ current size of the sights pixel byte stash</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Set A = Y + the X-th entry in ySightsStep</span>
 <span class="mne">CLC</span>                    <span class="comment">\</span>
 <span class="mne">ADC</span> <a class="popup variable">ySightsStep</a>,<span class="register">X</span>      <span class="comment">\ So this applies the next step from the ySightsStep</span>
                        <span class="comment">\ table to the relative y-coordinate of the brush in Y</span>

 <span class="mne">BPL</span> <a class="popup destination">dras3</a>              <span class="comment">\ The table at ySightsStep is terminated by %10000000,</span>
                        <span class="comment">\ so if bit 7 of the result is clear then we haven't yet</span>
                        <span class="comment">\ reached the end of the table, so jump to dras3 to keep</span>
                        <span class="comment">\ drawing</span>

                        <span class="comment">\ Otherwise we just read the terminator at the end of</span>
                        <span class="comment">\ the ySightsStep table, so fall through into dras2 to</span>
                        <span class="comment">\ return from the subroutine</span>

<span class="label">.dras2</span><a id="dras2" class="anchor"></a>

 <span class="mne">JMP</span> <a class="popup destination">dras12</a>             <span class="comment">\ Jump to dras12 to return from the subroutine</span>

<span class="label">.dras3</span><a id="dras3" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="decimal">8</span>                 <span class="comment">\ Compare A and 8 and set the status flags for us to</span>
                        <span class="comment">\ check below</span>

 <span class="mne">TAY</span>                    <span class="comment">\ Set Y to the updated value of A, so Y now contains the</span>
                        <span class="comment">\ updated y-coordinate of the brush after applying the</span>
                        <span class="comment">\ next step from ySightsStep</span>

 <span class="mne">BCC</span> <a class="popup destination">dras5</a>              <span class="comment">\ If A &lt; 8 then the y-coordinate has not moved past the</span>
                        <span class="comment">\ bottom of the current character row, so jump to dras5</span>
                        <span class="comment">\ to move on to processing the x-coordinate</span>

                        <span class="comment">\ We have just stepped down into the next character row,</span>
                        <span class="comment">\ so we need to recalculate the values in Y and</span>
                        <span class="comment">\ sightsByteAddr(1 0) to point to the correct address</span>
                        <span class="comment">\ in the next character row</span>

 <span class="mne">SBC</span> <span class="hash">#</span><span class="decimal">8</span>                 <span class="comment">\ Set Y = Y - 8</span>
 <span class="mne">TAY</span>                    <span class="comment">\</span>
                        <span class="comment">\ This resets Y to the number of the pixel row in the</span>
                        <span class="comment">\ next character row down, as each character row is</span>
                        <span class="comment">\ eight bytes high</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This subtraction works as we passed through a BCC</span>
                        <span class="comment">\ above, so we know the C flag is set</span>

 <span class="mne">LDA</span> <a class="popup variable">sightsByteAddr</a>     <span class="comment">\ Set (A sightsByteAddr) = sightsByteAddr(1 0) + &140</span>
 <span class="mne">CLC</span>                    <span class="comment">\                        = sightsByteAddr(1 0) + 320</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&40</span>               <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">sightsByteAddr</a>     <span class="comment">\ Each character row in screen mode 5 takes up 320 bytes</span>
 <span class="mne">LDA</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ (40 character blocks of eight bytes each), so this</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&01</span>               <span class="comment">\ sets sightsByteAddr(1 0) to the address of the next</span>
                        <span class="comment">\ row down in screen memory</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&80</span>               <span class="comment">\ If the high byte in A >= &80 then the new address is</span>
 <span class="mne">BCC</span> <a class="popup destination">dras4</a>              <span class="comment">\ past the end of screen memory, so subtract &20 from</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\ the high byte so the address wraps around within the</span>
                        <span class="comment">\ range of screen memory between &6000 and &8000</span>

<span class="label">.dras4</span><a id="dras4" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ Store the high byte of the result, so we now have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sightsByteAddr(1 0) = sightsByteAddr(1 0) + 320</span>
                        <span class="comment">\</span>
                        <span class="comment">\ with the address wrapped around as required</span>

<span class="label">.dras5</span><a id="dras5" class="anchor"></a>

                        <span class="comment">\ We now need to add the next step to the x-coordinate</span>
                        <span class="comment">\ of the brush and update sightsByteAddr(1 0) and</span>
                        <span class="comment">\ xSightsBrush accordingly</span>

 <span class="mne">LDA</span> <a class="popup variable">xSightsStep</a>,<span class="register">X</span>      <span class="comment">\ Set A to the next step from the xSightsStep that we</span>
                        <span class="comment">\ need to apply to the relative x-coordinate in</span>
                        <span class="comment">\ xSightsBrush</span>

 <span class="mne">BEQ</span> <a class="popup destination">dras9</a>              <span class="comment">\ If the step is zero then we don't need to change the</span>
                        <span class="comment">\ x-coordinate in xSightsBrush, so jump to dras9 to</span>
                        <span class="comment">\ move on to the actual drawing step</span>

 <span class="mne">CLC</span>                    <span class="comment">\ Set xSightsBrush = xSightsBrush + A</span>
 <span class="mne">ADC</span> <a class="popup variable">xSightsBrush</a>       <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">xSightsBrush</a>       <span class="comment">\ So this applies the next step from the xSightsStep</span>
                        <span class="comment">\ table to the relative x-coordinate of the brush in</span>
                        <span class="comment">\ xSightsBrush</span>

 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%11111100</span>         <span class="comment">\ Set A = (A * 2) div 8</span>
 <span class="mne">ASL</span> <span class="register">A</span>                  <span class="comment">\</span>
                        <span class="comment">\ All the step values in xSightsStep and ySightsStep</span>
                        <span class="comment">\ and the brush coordinates in xSightsBrush and Y are</span>
                        <span class="comment">\ in pixels, with each step in the x-coordinate drawing</span>
                        <span class="comment">\ two pixels, so these steps:</span>
                        <span class="comment">\</span>
                        <span class="comment">\        00</span>
                        <span class="comment">\        11</span>
                        <span class="comment">\        22</span>
                        <span class="comment">\   334455667788</span>
                        <span class="comment">\        99</span>
                        <span class="comment">\        AA</span>
                        <span class="comment">\        BB</span>
                        <span class="comment">\</span>
                        <span class="comment">\ end up drawing pixels like this:</span>
                        <span class="comment">\</span>
                        <span class="comment">\        x.</span>
                        <span class="comment">\        x.</span>
                        <span class="comment">\        x.</span>
                        <span class="comment">\   x.x.x.x.x.x.</span>
                        <span class="comment">\        x.</span>
                        <span class="comment">\        x.</span>
                        <span class="comment">\        x.</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Screen mode 5 contains four pixels in each byte, so to</span>
                        <span class="comment">\ convert the x-coordinate of the brush offset from step</span>
                        <span class="comment">\ pixels into screen pixels, we have to double it</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We then apply div 8 to the result to give us the</span>
                        <span class="comment">\ offset of the start of the character block containing</span>
                        <span class="comment">\ the new position of the brush, as each character block</span>
                        <span class="comment">\ contains eight bytes</span>

 <span class="mne">BPL</span> <a class="popup destination">dras6</a>              <span class="comment">\ If A is a negative value then to make the following</span>
 <span class="mne">DEC</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ addition work we would have to add (&FF A) to make</span>
                        <span class="comment">\ the 16-bit addition work in signed 16-bit arithmetic,</span>
                        <span class="comment">\ but to save having to do this we can simply decrement</span>
                        <span class="comment">\ the high byte of sightsByteAddr(1 0) in advance and</span>
                        <span class="comment">\ add (0 A) instead</span>

<span class="label">.dras6</span><a id="dras6" class="anchor"></a>

 <span class="mne">CLC</span>                    <span class="comment">\ Set (A sightsByteAddr) = sightsByteAddr(1 0) + A</span>
 <span class="mne">ADC</span> <a class="popup variable">sightsByteAddr</a>     <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">sightsByteAddr</a>     <span class="comment">\ So this applies the step in A to sightsByteAddr(1 0)</span>
 <span class="mne">LDA</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="decimal">0</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&60</span>               <span class="comment">\ If the high byte in A &lt; &60 then the new address is</span>
 <span class="mne">BCS</span> <a class="popup destination">dras7</a>              <span class="comment">\ before the start of screen memory, so add &20 to the</span>
 <span class="mne">ADC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\ high byte so the address wraps around within the range</span>
                        <span class="comment">\ of screen memory between &6000 and &8000</span>

 <span class="mne">JMP</span> <a class="popup destination">dras8</a>              <span class="comment">\ Jump to dras8 to skip the next check, as we know it</span>
                        <span class="comment">\ doesn't apply</span>

<span class="label">.dras7</span><a id="dras7" class="anchor"></a>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="hex">&80</span>               <span class="comment">\ If the high byte in A >= &80 then the new address is</span>
 <span class="mne">BCC</span> <a class="popup destination">dras8</a>              <span class="comment">\ past the end of screen memory, so subtract &20 from</span>
 <span class="mne">SBC</span> <span class="hash">#</span><span class="hex">&20</span>               <span class="comment">\ the high byte so the address wraps around within the</span>
                        <span class="comment">\ range of screen memory between &6000 and &8000</span>

<span class="label">.dras8</span><a id="dras8" class="anchor"></a>

 <span class="mne">STA</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ Store the high byte of the result, so we now have:</span>
                        <span class="comment">\</span>
                        <span class="comment">\   sightsByteAddr(1 0) = sightsByteAddr(1 0) + A</span>
                        <span class="comment">\</span>
                        <span class="comment">\ with the address wrapped around as required</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So this applies the next step to sightsByteAddr(1 0)</span>
                        <span class="comment">\ to give us the screen address of the character block</span>
                        <span class="comment">\ that we need to update to make the next brush stroke</span>

 <span class="mne">LDA</span> <a class="popup variable">xSightsBrush</a>       <span class="comment">\ Set xSightsBrush as follows:</span>
 <span class="mne">AND</span> <span class="hash">#</span><span class="binary">%00000011</span>         <span class="comment">\</span>
 <span class="mne">STA</span> <a class="popup variable">xSightsBrush</a>       <span class="comment">\   xSightsBrush = xSightsBrush mod 4</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Each pixel byte contains four pixels, so this sets</span>
                        <span class="comment">\ xSightsBrush to the x-coordinate of the sights within</span>
                        <span class="comment">\ the pixel byte in which the sights appear, in the</span>
                        <span class="comment">\ range 0 to 3</span>

<span class="label">.dras9</span><a id="dras9" class="anchor"></a>

                        <span class="comment">\ We have now set up sightsByteAddr(1 0), xSightsBrush</span>
                        <span class="comment">\ and Y to the address of the next pixel byte to paint,</span>
                        <span class="comment">\ so let's dab the brush for this step</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The address of the pixel byte we need to paint is</span>
                        <span class="comment">\ sightsByteAddr(1 0) + Y</span>
                        <span class="comment">\</span>
                        <span class="comment">\ The offset of the pixel within that pixel byte (in</span>
                        <span class="comment">\ terms of step pixels) is in xSightsBrush</span>

                        <span class="comment">\ First, we need to save the current contents of the</span>
                        <span class="comment">\ screen in the sights pixel byte stash by storing the</span>
                        <span class="comment">\ screen address of the pixel in the X-th entry of</span>
                        <span class="comment">\ sightsByteAddr(Hi Lo), and then storing the existing</span>
                        <span class="comment">\ contents of that address to the X-th entry of</span>
                        <span class="comment">\ sightsByte</span>

 <span class="mne">TYA</span>                    <span class="comment">\ Set the X-th entry in the sights pixel byte stash</span>
 <span class="mne">ORA</span> <a class="popup variable">sightsByteAddr</a>     <span class="comment">\ address list at sightsByteAddr(Hi Lo) to</span>
 <span class="mne">STA</span> <a class="popup variable">sightsByteAddrLo</a>,<span class="register">X</span> <span class="comment">\ sightsByteAddr(1 0) + Y, which is the address of</span>
 <span class="mne">LDA</span> <a class="popup variable">sightsByteAddr</a><span class="operator">+</span><span class="decimal">1</span>   <span class="comment">\ the pixel byte we are about to change</span>
 <span class="mne">STA</span> <a class="popup variable">sightsByteAddrHi</a>,<span class="register">X</span>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">sightsByteAddr</a><span class="bracket">)</span>,<span class="register">Y</span> <span class="comment">\ Set A to the current screen contents of the pixel byte</span>
                        <span class="comment">\ we are updating</span>

 <span class="mne">STA</span> <a class="popup variable">sightsByte</a>,<span class="register">X</span>       <span class="comment">\ Store the current screen contents in the X-th entry in</span>
                        <span class="comment">\ the sights pixel byte stash at sightsByte</span>

                        <span class="comment">\ We now apply the brush to the pixel byte in screen</span>
                        <span class="comment">\ memory at sightsByteAddr(1 0) + Y</span>
                        <span class="comment">\</span>
                        <span class="comment">\ We do this by taking the existing screen pixel byte in</span>
                        <span class="comment">\ A and setting the pixel number xSightsBrush to either</span>
                        <span class="comment">\ colour 1 or colour 2, depending on the current colour</span>
                        <span class="comment">\ in that pixel</span>
                        <span class="comment">\</span>
                        <span class="comment">\ Specifically, we draw the sights in colour 2 when the</span>
                        <span class="comment">\ background is colour 0 or 1, and we draw the sights in</span>
                        <span class="comment">\ colour 1 when the background is colour 2 or 3</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As an example of physical colours, in landscape 0000</span>
                        <span class="comment">\ we paint the sights pixels in white (colour 2) when</span>
                        <span class="comment">\ the background is blue (colour 0) or black (colour 1),</span>
                        <span class="comment">\ and we paint the sights pixels in black (colour 1)</span>
                        <span class="comment">\ when the background is white (colour 2) or green</span>
                        <span class="comment">\ (colour 3)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ This ensures that the sights are visible wherever they</span>
                        <span class="comment">\ are on-screen, irrespective of the current screen</span>
                        <span class="comment">\ contents</span>

 <span class="mne">LDX</span> <a class="popup variable">xSightsBrush</a>       <span class="comment">\ Convert xSightsBrush from a number in the range 0 to 3</span>
 <span class="mne">AND</span> <a class="popup variable">pixelBitMask</a>,<span class="register">X</span>     <span class="comment">\ into a bit mask with that pixel number set (where</span>
                        <span class="comment">\ pixel 0 is on the left and pixel 3 is on the right)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ So if xSightsBrush is 2, for example, the resulting</span>
                        <span class="comment">\ mask will be %00100010, in which pixel 2 is set</span>

                        <span class="comment">\ At this point, A contains the existing contents of the</span>
                        <span class="comment">\ screen byte into which we need to draw the sights,</span>
                        <span class="comment">\ with all bits zeroed except for those for the pixel we</span>
                        <span class="comment">\ want to colour in</span>

 <span class="mne">CMP</span> <span class="hash">#</span><span class="binary">%00010000</span>         <span class="comment">\ Set the status flags on the comparison of A and</span>
 <span class="mne">PHP</span>                    <span class="comment">\ %00010000 and push the resulting flags on the stack</span>
                        <span class="comment">\ so we can retrieve them below</span>

 <span class="mne">LDA</span> <span class="bracket">(</span><a class="popup variable">sightsByteAddr</a><span class="bracket">)</span>,<span class="register">Y</span> <span class="comment">\ Set A to the current screen contents of the pixel byte</span>
                        <span class="comment">\ we are updating</span>

 <span class="mne">AND</span> <a class="popup variable">clearPixelMask</a>,<span class="register">X</span>   <span class="comment">\ Clear the pixel number in xSightsBrush by applying a</span>
                        <span class="comment">\ pixel bit mask from clearPixelMask where the bits for</span>
                        <span class="comment">\ every pixel are set except for pixel X</span>

 <span class="mne">PLP</span>                    <span class="comment">\ Using the status flags that we put on the stack above,</span>
 <span class="mne">BCS</span> <a class="popup destination">dras10</a>             <span class="comment">\ check whether A >= %00010000, where A contains the</span>
                        <span class="comment">\ existing contents of the screen for pixel X</span>
                        <span class="comment">\</span>
                        <span class="comment">\ If A >= %00010000 then A must have at least one bit</span>
                        <span class="comment">\ set in the high nibble, which means the existing</span>
                        <span class="comment">\ contents of pixel X on-screen has to have its top bit</span>
                        <span class="comment">\ set, so it must either be colour %10 (2) or %11 (3)</span>
                        <span class="comment">\</span>
                        <span class="comment">\ As the background is colour 2 or 3, jump to dras10 to</span>
                        <span class="comment">\ paint the sights pixel in colour 1</span>

                        <span class="comment">\ If we get here then the existing screen contents are</span>
                        <span class="comment">\ in colour 0 or 1, so we now paint the sights pixel in</span>
                        <span class="comment">\ colour 2</span>

 <span class="mne">ORA</span> <a class="popup variable">pixelByteColour2</a>,<span class="register">X</span> <span class="comment">\ Set the colour of pixel X to colour 2 by OR'ing in a</span>
                        <span class="comment">\ pixel mask where pixel X is set to %10 for colour 2</span>

 <span class="mne">BCC</span> <a class="popup destination">dras11</a>             <span class="comment">\ Jump to dras11 to skip the following instruction (this</span>
                        <span class="comment">\ BCC is effectively a JMP as we just passed through a</span>
                        <span class="comment">\ BCS)</span>

<span class="label">.dras10</span><a id="dras10" class="anchor"></a>

 <span class="mne">ORA</span> <a class="popup variable">pixelByteColour1</a>,<span class="register">X</span> <span class="comment">\ Set the colour of pixel X to colour 1 by OR'ing in a</span>
                        <span class="comment">\ pixel mask where pixel X is set to %01 for colour 1</span>

<span class="label">.dras11</span><a id="dras11" class="anchor"></a>

 <span class="mne">STA</span> <span class="bracket">(</span><a class="popup variable">sightsByteAddr</a><span class="bracket">)</span>,<span class="register">Y</span> <span class="comment">\ Store the updated pixel byte in screen memory to apply</span>
                        <span class="comment">\ the brush to the canvas</span>

 <span class="mne">INC</span> <a class="popup variable">sightsByteCount</a>    <span class="comment">\ Increment sightsByteCount to move on to the next step</span>
                        <span class="comment">\ in the drawing process</span>

 <span class="mne">JMP</span> <a class="popup destination">dras1</a>              <span class="comment">\ Loop back to draw the next step of the sights</span>

<span class="label">.dras12</span><a id="dras12" class="anchor"></a>

 <span class="mne">RTS</span>                    <span class="comment">\ Return from the subroutine</span>
</pre>
				</div>

				<div class="codeBlockWrapper popupWrapper" id="popup-removesights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Subroutine <a href="/source/main/subroutine/removesights.html">RemoveSights</a> (category: Sights)</div><div class="summary">Remove the sights from the screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-clearpixelmask"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/clearpixelmask.html">clearPixelMask</a> (category: Graphics)</div><div class="summary">A table for converting a pixel number in the range 0 to 3 into a screen mode 5 bit mask with that pixel's bits clear and others set</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-donotdrawsights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#donotdrawsights">doNotDrawSights</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">A flag that controls whether we draw the sights in the DrawSights routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras1">dras1</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras10"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras10">dras10</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras11"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras11">dras11</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras12"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras12">dras12</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras2">dras2</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras3"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras3">dras3</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras4"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras4">dras4</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras5"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras5">dras5</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras6"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras6">dras6</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras7"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras7">dras7</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras8"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras8">dras8</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-dras9"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Label <a href="/source/main/subroutine/drawsights.html#dras9">dras9</a> is local to this routine</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pixelbitmask"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/pixelbitmask.html">pixelBitMask</a> (category: Graphics)</div><div class="summary">A table for converting a pixel number in the range 0 to 3 into a screen mode 5 bit mask with that pixel's bits set and others clear</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pixelbytecolour1"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/pixelbytecolour1.html">pixelByteColour1</a> (category: Sights)</div><div class="summary">A table for converting a pixel number in the range 0 to 3 into a screen mode 5 pixel byte with that pixel set to colour 1 (%01)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-pixelbytecolour2"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/pixelbytecolour2.html">pixelByteColour2</a> (category: Graphics)</div><div class="summary">A table for converting a pixel number in the range 0 to 3 into a screen mode 5 pixel byte with that pixel set to colour 2 (%10)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsbyte"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/sightsbyte.html">sightsByte</a> (category: Sights)</div><div class="summary">The sights pixel byte stash, which contains the screen pixel bytes behind the sights, so they can be restored to remove the sights</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsbyteaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/zero_page.html#sightsbyteaddr">sightsByteAddr</a> in workspace <a href="/source/main/workspace/zero_page.html">Zero page</a></div><div class="summary">Storage for an address that loops through the pixel bytes in screen memory where the sights appear, so the sights can be drawn and removed using the contents of the sights pixel byte stash</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsbyteaddrhi"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/sightsbyteaddrhi.html">sightsByteAddrHi</a> (category: Sights)</div><div class="summary">The screen addresses of the bytes in the sights pixel byte stash, to which they can be restored to remove the sights (high byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsbyteaddrlo"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/sightsbyteaddrlo.html">sightsByteAddrLo</a> (category: Sights)</div><div class="summary">The screen addresses of the bytes in the sights pixel byte stash, to which they can be restored to remove the sights (low byte)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsbytecount"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#sightsbytecount">sightsByteCount</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The number of screen bytes in the sights pixel byte stash that contain the contents of the screen behind the sights (so they can be restored to remove the sights)</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-sightsscreenaddr"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#sightsscreenaddr">sightsScreenAddr</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The screen address of the sights</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xsights"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#xsights">xSights</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The pixel x-coordinate of the sights on-screen</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xsightsbrush"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="name">Variable <a href="/source/main/workspace/main_variable_workspace.html#xsightsbrush">xSightsBrush</a> in workspace <a href="/source/main/workspace/main_variable_workspace.html">Main variable workspace</a></div><div class="summary">The x-coordinate of the "brush" that we use to draw the sights, relative to the top-left corner of the character block containing the top of the sights</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-xsightsstep"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/xsightsstep.html">xSightsStep</a> (category: Sights)</div><div class="summary">Steps to take along the x-axis when drawing the sights</div></div></div></div>

				<div class="codeBlockWrapper popupWrapper" id="popup-ysightsstep"><div class="codeBlock"><div class="close">[X]</div><div class="content"><div class="link">Variable <a href="/source/main/variable/ysightsstep.html">ySightsStep</a> (category: Sights)</div><div class="summary">Steps to take along the y-axis when drawing the sights</div></div></div></div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous routine" href="/source/main/subroutine/setsightsaddress.html">SetSightsAddress</a><a class="next" rel="next" title="Next routine" href="/source/main/variable/pixelbytecolour2.html">pixelByteColour2</a></nav>
				</div>
			</article>

<?php
include_once("../../../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
