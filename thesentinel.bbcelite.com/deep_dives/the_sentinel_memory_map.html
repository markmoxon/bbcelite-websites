<?php
include_once("../templates/template_functions.php");
page_header("deep_dives", "the_sentinel_memory_map.html", "The Sentinel memory map", "The Sentinel memory map", "A deep dive into the Sentinel memory map in The Sentinel on the BBC Micro", "the_sentinel", "deep_dives_memory_maps", "the_sentinel_memory_map");
?>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="/deep_dives/">Index of deep dives</a><a class="next" rel="next" title="Next deep dive" href="entry_and_setup_code.html">Entry and setup code</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">Interleaving code and data to make the most of the BBC Micro's 32K of RAM</h2>

						<p>Compared to Revs, Geoff Crammond's previous game, The Sentinel is slightly less cramped when it's squeezed in the BBC Micro's relatively conservative 32K of RAM, but it still manages to use pretty much every part of memory.</p>


<pre class="articleIndented">  +-----------------------------------+   &amp;FFFF
  |                                   |
  | Machine Operating System (MOS)    |
  |                                   |
  +-----------------------------------+   &amp;C000
  |                                   |
  | Paged ROMs                        |
  |                                   |
  +-----------------------------------+-- &amp;8000
  |                                   |
  | Screen memory (custom mode 5)     |
  |                                   |
  +-----------------------------------+-- &amp;6000
  |                                   |
  | Main game code                    |
  |                                   |
  +-----------------------------------+   &amp;5260 = <a href="/source/main/variable/objsentinel.html">objSentinel</a>
  |                                   |
  | Main game code & screen buffers   |
  |                                   |
  +-----------------------------------+-- &amp;3F00 = <a href="/source/main/variable/screenbufferrow0.html">screenBufferRow0</a>
  |                                   |
  | Main game code                    |
  |                                   |
  +-----------------------------------+   &amp;0D00 = <a href="/source/main/subroutine/nmihandler.html">NMIHandler</a>
  |                                   |
  | Main variable workspace           |
  |                                   |
  +-----------------------------------+   &amp;0C00 = <a href="/source/main/workspace/main_variable_workspace.html#sinanglelo">sinAngleLo</a>
  |                                   |
  | Object variables &amp; drawing tables |
  |                                   |
  +-----------------------------------+   &amp;0900 = <a href="/source/main/variable/xobject.html">xObject</a>
  |                                   |
  | MOS sound envelope buffer         |
  |                                   |
  +-----------------------------------+   &amp;08C0
  |                                   |
  | MOS printer buffer                |
  |                                   |
  +-----------------------------------+   &amp;0880
  |                                   |
  | MOS sound workspace and buffer    |
  |                                   |
  +-----------------------------------+   &amp;0800
  |                                   |
  | Tile data                         |
  |                                   |
  +-----------------------------------+   &amp;0400 = <a href="/source/main/variable/tiledata.html">tileData</a>
  |                                   |
  | MOS VDU workspace                 |
  |                                   |
  +-----------------------------------+   &amp;0300
  |                                   |
  | MOS general workspace             |
  |                                   |
  +-----------------------------------+   &amp;0200
  |                                   |
  | 6502 stack descends from &amp;01FF    |
  |                                   |
  +-----------------------------------+
  |                                   |
  .                                   .
  .                                   .
  .                                   .
  .                                   .
  .                                   .
  |                                   |
  +-----------------------------------+   &amp;01C0
  |                                   |
  | Stack variables workspace         |
  |                                   |
  +-----------------------------------+   &amp;0100 = <a href="/source/main/workspace/stack_variables.html#objectflags">objectFlags</a>
  |                                   |
  | Zero page workspace               |
  |                                   |
  +-----------------------------------+   &amp;0000 = <a href="/source/main/workspace/zero_page.html#enemyobject">enemyObject</a>
</pre>

						<p>Note that the memory map shows the full 64K of addressable memory that's supported by the BBC's 6502 processor, but only the bottom 32K is writable RAM, and hence usable by The Sentinel. The top 16K is mapped to the MOS (Machine Operating System) ROM, and the next 16K is mapped to the currently selected paged ROM, which might be anything from BBC BASIC to the VIEW word processor.</p>

						<p>This 32K of RAM includes both screen memory and the various operating system workspaces, which can leave a pretty small amount for programs (especially in high resolution screen modes). Let's take a look at exactly how much unused memory there is in The Sentinel.</p>

						<h2 class="articleSubheader">Memory usage<br>
													 ------------</h2>

						<p>Here's a full breakdown of memory usage in bytes, once The Sentinel is loaded and running. The figures show the number of available bytes in each section and how many of those are unused:</p>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (ROMs)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Paged ROMs</td><td>&amp;8000 to &amp;BFFF</td><td class="right">16,384</td><td class="right">-</td></tr>
							<tr><td>Machine operating system (MOS) ROM</td><td>&amp;C000 to &amp;FFFF</td><td class="right">16,384</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total ROM memory</td><td>&nbsp;</td><td class="right">32,768</td><td class="right">-</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (MOS workspace)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>MOS zero page filing system workspace</td><td>&amp;00B0 to &amp;00CF</td><td class="right">32</td><td class="right">32</td></tr>
							<tr><td>MOS zero page VDU workspace</td><td>&amp;00D0 to &amp;00E1</td><td class="right">18</td><td class="right">-</td></tr>
							<tr><td>MOS zero page tape filing system workspace</td><td>&amp;00E2 to &amp;00E3</td><td class="right">2</td><td class="right">2</td></tr>
							<tr><td>MOS zero page general workspace</td><td>&amp;00E4 to &amp;00FF</td><td class="right">28</td><td class="right">-</td></tr>
							<tr><td>MOS general workspace</td><td>&amp;0200 to &amp;02FF</td><td class="right">256</td><td class="right">-</td></tr>
							<tr><td>MOS VDU workspace</td><td>&amp;0300 to &amp;037F</td><td class="right">128</td><td class="right">-</td></tr>
							<tr><td>MOS tape filing system workspace</td><td>&amp;0380 to &amp;03DF</td><td class="right">96</td><td class="right">96</td></tr>
							<tr><td>MOS keyboard buffer</td><td>&amp;03E0 to &amp;03FF</td><td class="right">32</td><td class="right">-</td></tr>
							<tr><td>MOS sound workspace and buffer</td><td>&amp;0800 to &amp;087F</td><td class="right">128</td><td class="right">-</td></tr>
							<tr><td>MOS printer buffer</td><td>&amp;0880 to &amp;08BF</td><td class="right">64</td><td class="right">64</td></tr>
							<tr><td>MOS envelope buffer</td><td>&amp;08C0 to &amp;08FF</td><td class="right">64</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total MOS workspace memory</td><td>&nbsp;</td><td class="right">848</td><td class="right">194</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (shared memory)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>6502 stack</td><td>&amp;01C0 to &amp;01FF</td><td class="right">64</td><td class="right">-</td></tr>
							<tr><td>Memory for the custom screen mode</td><td>&amp;6000 to &amp;7FFF</td><td class="right">8,192</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total shared memory</td><td>&nbsp;</td><td class="right">8,256</td><td class="right">-</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (game code)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Zero page workspace</td><td>&amp;0000 to &amp;00AF</td><td class="right">176</td><td class="right">41</td></tr>
							<tr><td>Stack variables</td><td>&amp;0100 to &amp;01BF</td><td class="right">192</td><td class="right">-</td></tr>
							<tr><td>Tile data</td><td>&amp;0400 to &amp;07FF</td><td class="right">1,024</td><td class="right">-</td></tr>
							<tr><td>Object variables & drawing tables</td><td>&amp;0900 to &amp;0BFF</td><td class="right">768</td><td class="right">-</td></tr>
							<tr><td>Main variable workspace</td><td>&amp;0C00 to &amp;0CFF</td><td class="right">256</td><td class="right">35</td></tr>
							<tr><td>Main game code, excluding screen buffers</td><td>&amp;0D00 to &amp;5FFF</td><td class="right">17,408</td><td class="right">21</td></tr>
							<tr><td>24 screen buffers (160 bytes each)</td><td>&amp;3F00 to &amp;525F</td><td class="right">3,840</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total game code memory</td><td>&nbsp;</td><td class="right">23,664</td><td class="right">97</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Summary</th><th style="width: 15ch">&nbsp;</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Total ROM memory</td><td>&nbsp;</td><td class="right">32,768</td><td class="right">-</td></tr>
							<tr><td>Total MOS workspace memory</td><td>&nbsp;</td><td class="right">848</td><td class="right">194</td></tr>
							<tr><td>Total shared memory</td><td>&nbsp;</td><td class="right">8,256</td><td class="right">-</td></tr>
							<tr><td>Total game code memory</td><td>&nbsp;</td><td class="right">23,664</td><td class="right">97</td></tr>
							<tr class="codeSummaryCategory"><td>Totals</td><td>&nbsp;</td><td class="right">65,536</td><td class="right">291</td></tr>
						</table>

						<p>In total, once the game is loaded and running, there are just 291 unused bytes; given that the BBC Micro has 32,768 bytes of RAM, that's pretty packed.</p>

						<p>Because the game doesn't need to use the filing system once it's been loaded, and it also doesn't use a printer, there are 194 unused bytes in MOS workspace memory that could potentially be used by the game. And within the game itself there are 97 unused bytes, with 41 unused bytes in zero page, 35 unused bytes in the main variable workspace and 21 unused bytes dotted throughout the main game code (a number of which are the result of aligning lookup tables in memory).</p>

						<p>It doesn't leave a lot of space.</p>

						<h2 class="articleSubheader">The Sentinel code as an image<br>
													 -----------------------------</h2>

						<p>To see just how small the game code for The Sentinel is, we can convert the main game binary into an image, with one byte per pixel, and a greyscale showing each byte's value, with 0 being shown as black, 255 being shown as white, and interim values as greyscale pixels. The result is a 147-pixel square, like this (shown here at double size, so you can see the pixels more clearly):</p>

						<img class="titleImage" style="width: 294px" src="/images/general/code.png" alt="The game binary for The Sentinel on the BBC Micro as an image">

						<p>The game binary includes 2,304 bytes of workspace data at the start that could easily have been omitted from the binary, as the workspaces are initialised when the game loads. This includes the tile data workspace, the MOS sound/printer workspace, the object variables, the drawing tables and the main variable workspace, all of which can be seen in the black strip at the top of the image. Meanwhile, the white stripes towards the bottom of the image are the screen buffers, which mainly contain workspace noise consisting of &amp;00 and &amp;FF bytes, which show up as black and white in the image.</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="/deep_dives/">Index of deep dives</a><a class="next" rel="next" title="Next deep dive" href="entry_and_setup_code.html">Entry and setup code</a></nav>
				</div>

			</article>

<?php
include_once("../templates_local/navigation.php");

?>
		</div>
	</body>
</html>
