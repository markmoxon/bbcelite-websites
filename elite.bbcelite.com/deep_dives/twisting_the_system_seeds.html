<?php
include_once("../templates/template_functions.php");
page_header("deep_dives", "twisting_the_system_seeds.html", "Twisting the system seeds", "Twisting the system seeds", "A deep dive into twisting the system seeds in BBC Micro Elite", "elite", "deep_dives_simulating_the_universe", "twisting_the_system_seeds");
?>
				<!-- Start of article -->
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="generating_system_names.html">Generating system names</a><a class="next" rel="next" title="Next deep dive" href="market_item_prices_and_availability.html">Market item prices and availability</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">How the system seeds are twisted to produce entire galaxies of stars</h2>

						<p>Data on each star system in Elite's galaxies is generated procedurally, and the core of this process is the set of three 16-bit seeds that describe each system in the universe. Each of the eight galaxies in the game is generated in the same way, by taking an initial set of seeds and "twisting" them to generate 256 systems, one after the other.</p>

						<p>Specifically, given the initial set of seeds, we can generate the next system in the sequence by twisting that system's seeds four times. As we do these twists, we can extract the system's data from the seed values - including the system name, which is generated by the subroutine cpl, where you can read about how this aspect works.</p>

						<p>The starting point is a system called Tibedied in the first galaxy - so this is system 0 in galaxy 0. Here it is on the Long-range Chart, 17.6 light years from Lave; you can just make out the crosshairs halfway up the the left edge of the chart:</p>

						<img class="titleImage" src="/images/cassette/tibedied.png" alt="The Long-range Chart showing Tibedied in the BBC Micro version of Elite" />

						<p>The seeds for Tibedied are s0 = &amp;5A4A, s1 = &amp;0248 and s2 = &amp;B753, and all 2000 of the unique systems in Elite are derived from this one set of seeds (that's 256 systems in each of the eight galaxies)</p>

						<p>It is therefore no exaggeration that the twisting process implemented in the <a href="/cassette/main/subroutine/tt20.html">TT20</a> and <a href="/cassette/main/subroutine/tt54.html">TT54</a> routines is the fundamental building block of Elite's "universe in a bottle" approach, which enabled the authors to squeeze eight galaxies of 256 planets out of nothing more than three initial numbers and a short twisting routine (and they could have had far larger galaxies and many more of them, if they had wanted, but they made the wise decision to limit the number).</p>

						<p>Let's look at how this twisting process works.</p>

						<h2 class="articleSubheader">Twisting the system seeds<br />
													 -------------------------</h2>

						<p>The three seeds that describe a system represent three consecutive numbers in a Tribonacci sequence, where each number is equal to the sum of the preceding three numbers (the name is a play on Fibonacci sequence, in which each number is equal to the sum of the preceding two numbers). Twisting is the process of moving along the sequence by one place. So, say our seeds currently point to these numbers in the sequence:</p>

<pre class="articleIndented">  0   0   1   1   2   4   7   13   24   44   ...
                      ^   ^    ^
</pre>

						<p>so they are 4, 7 and 13, then twisting would move them all along by one place, like this:</p>

<pre class="articleIndented">  0   0   1   1   2   4   7   13   24   44   ...
                          ^    ^    ^
</pre>

						<p>giving us 7, 13 and 24. To generalise this, if we start with seeds s0, s1 and s2 and we want to work out their new values after we perform a twist (let's call the new values s0´, s1´ and s2´), then:</p>

<pre class="articleIndented">  s0´ = s1
  s1´ = s2
  s2´ = s0 + s1 + s2
</pre>

						<p>So given an existing set of seeds in s0, s1 and s2, we can get the new values s0´, s1´ and s2´ simply by doing the above sums. And if we want to do the above in-place without creating three new s´ variables, then we can do the following:</p>

<pre class="articleIndented">  tmp = s0 + s1
  s0 = s1
  s1 = s2
  s2 = tmp + s1
</pre>

						<p>In Elite, the numbers we're dealing with are two-byte, 16-bit numbers, and because these 16-bit numbers can only hold values up to 65535, the sequence wraps around at the end. But the maths is the same, it just has to be done on 16-bit numbers, one byte at a time.</p>

						<p>The seeds are stored as little-endian 16-bit numbers, so the low (least significant) byte is first, followed by the high (most significant) byte. Taking the case of the currently selected system, whose seeds are stored in the six bytes from QQ15, that means our seed values are stored like this:</p>

<pre class="articleIndented">      low byte  high byte
  s0  QQ15      QQ15+1
  s1  QQ15+2    QQ15+3
  s2  QQ15+4    QQ15+5
</pre>

						<p>If we denote the low byte of s0 as s0_lo and the high byte as s0_hi, then the twist operation above can be rewritten for 16-bit values like this, assuming the additions include the C flag:</p>

<pre class="articleIndented">  tmp_lo = s0_lo + s1_lo          (tmp = s0 + s1)
  tmp_hi = s0_hi + s1_hi
  s0_lo  = s1_lo                  (s0 = s1)
  s0_hi  = s1_hi
  s1_lo  = s2_lo                  (s1 = s2)
  s1_hi  = s2_hi
  s2_lo  = tmp_lo + s1_lo         (s2 = tmp + s1)
  s2_hi  = tmp_hi + s1_hi
</pre>

						<p>And that's exactly what the <a href="/cassette/main/subroutine/tt20.html">TT20</a> and <a href="/cassette/main/subroutine/tt54.html">TT54</a> routines do to twist our three 16-bit seeds to the next values in the sequence, using X to store tmp_lo and Y to store tmp_hi.</p>

						<h2 class="articleSubheader">Twisting the galaxy seeds<br />
													 -------------------------</h2>

						<p>The <a href="/cassette/main/subroutine/ghy.html">Ghy</a> routine updates the galaxy seeds to point to the next galaxy. Using a galactic hyperdrive rotates each seed byte to the left, rolling each byte left within itself like this:</p>

<pre class="articleIndented">  01234567 -&gt; 12345670
</pre>

						<p>to get the seeds for the next galaxy. So after 8 galactic jumps, the seeds roll round to those of the first galaxy again.</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="generating_system_names.html">Generating system names</a><a class="next" rel="next" title="Next deep dive" href="market_item_prices_and_availability.html">Market item prices and availability</a></nav>
				</div>
				<!-- End of article -->
			</article>

<?php
include_once("../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
