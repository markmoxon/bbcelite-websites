<?php
include_once("../templates/template_functions.php");
page_header("deep_dives", "music_in_nes_elite.html", "Music in NES Elite", "Music in NES Elite", "A deep dive into music in NES Elite", "elite", "deep_dives_sound_and_music", "music_in_nes_elite");
?>
				<!-- Start of article -->
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="music_in_commodore_64_elite.html">Music in Commodore 64 Elite</a><a class="next" rel="next" title="Next deep dive" href="the_key_logger.html">The key logger</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">How David Whittaker's music module plays The Blue Danube</h2>

						<p>NES Elite has four tunes in it. Two of them are converted from the Commodore 64 version ("Elite Theme" and "The Blue Danube"), while two are brand new compositions by David Whittaker ("Game Theme" and "Assassin's Touch"). There are five tune numbers, with the last one combining the two new tunes into one (as they always play one after the other in the combat demo).</p>

						<p>The tune numbers are as follows:</p>

						<ul>
							<li>0 for the title music ("Elite Theme"), which is set in the <a href="/nes/bank_0/subroutine/title.html">TITLE</a> routine and as the default tune in the <a href="/nes/bank_7/subroutine/resetmusic.html">ResetMusic</a> routine</li>

							<li>1 for docking ("The Blue Danube"), which is set in the <a href="/nes/bank_0/subroutine/tt102.html">TT102</a> routine</li>

							<li>2 for the combat demo music ("Game Theme"), though this is never set directly, only via tune 4</li>

							<li>3 for the scroll text music ("Assassin's Touch"), though this is never set directly, only via tune 4</li>

							<li>4 for the full combat demo suite ("Assassin's Touch" followed by "Game Theme"), which is set in the <a href="/nes/bank_0/subroutine/death2.html">DEATH2</a> routine</li>
						</ul>

						<p>You can listen to all these tunes in the Video Game Music Preservation Foundation's entry on <a href="https://www.vgmpf.com/Wiki/index.php?title=Elite_(NES)">NES Elite</a>.</p>

						<p>As with the sound routines, which you can read about in the deep dive on <a href="sound_effects_in_nes_elite.html">sound effects in NES Elite</a>, the music routines were written by David Whittaker, one of the most prolific sound artists of the 8-bit era. His CV is really quite astonishing - here's a biography that includes a <a href="https://www.vgmpf.com/Wiki/index.php?title=David_Whittaker">list of games on which he worked</a>. It takes a lot of scrolling to get to the end...</p>

						<p>Let's see how the music routines work.</p>

						<h2 class="articleSubheader">The music routines<br />
													 ------------------</h2>

						<p>Music is played by the <a href="/nes/bank_6/subroutine/choosemusic.html">ChooseMusic</a> routine, which takes a tune number as an argument. The routine initialises four 19-byte blocks of memory, one for each of the APU channels; the block for the SQ1 channel, for example, runs from <a href="/nes/common/workspace/wp.html#sectiondatasq1">sectionDataSQ1</a> to <a href="/nes/common/workspace/wp.html#applyvolumesq1">applyVolumeSQ1</a>. Not every channel uses every variable (the NOISE channel doesn't have an applyVolumeNOISE variable, for example), but the same block structure is used anyway, betraying the fact that David Whittaker's sound routines were almost certainly generated by macros.</p>

						<p>Once the music data blocks are set up, the actual playing of the music is taken on by the NMI handler. As with the sound routines, the NMI handler calls the <a href="/nes/bank_6/subroutine/makesounds.html">MakeSounds</a> routine in every VBlank, which then calls the <a href="/nes/bank_6/subroutine/makemusic.html">MakeMusic</a> routine to play the music. This in turn calls <a href="/nes/bank_6/subroutine/makemusiconsq1.html">MakeMusicOnSQ1</a>, <a href="/nes/bank_6/subroutine/makemusiconsq2.html">MakeMusicOnSQ2</a>, <a href="/nes/bank_6/subroutine/makemusicontri.html">MakeMusicOnTRI</a> and  <a href="/nes/bank_6/subroutine/makemusiconnoise.html">MakeMusicOnNOISE</a> to send the music data to the APU.</p>

						<p>The data that is sent to the APU for each tune is defined in the <a href="/nes/bank_6/variable/tunedata.html">tuneData</a> table. This table contains the bulk of the data for the game music (though there are two other tables, <a href="/nes/bank_6/variable/volumeenvelope.html">volumeEnvelope</a> for the volume envelope data and <a href="/nes/bank_6/variable/pitchenvelope.html">pitchEnvelope</a> for the pitch envelope data). All these tables are implemented using linked trees of varying depths, so let's take a look at that now.</p>

						<h2 class="articleSubheader">Linked tree format<br />
													 ------------------</h2>

						<p>The bulk of the music data is in the <a href="/nes/bank_6/variable/tunedata.html">tuneData</a> table. There are five tunes, numbered 0 to 4. The data for each tune is stored as a linked tree, with the data at level 3, so this would be the path in tuneData to reach the first block of music data for the SQ1 channel in the first part of the first tune:</p>

<pre class="articleIndented">  <a href="/nes/bank_6/variable/tunedata.html#tune0data">tune0Data</a> -> <a href="/nes/bank_6/variable/tunedata.html#tune0data_sq1">tune0Data_SQ1</a> -> <a href="/nes/bank_6/variable/tunedata.html#tune0data_sq1_0">tune0Data_SQ1_0</a>
</pre>

						<p>Let's look at each level in turn. Each tune has a lookup table at the start of tuneData that consists of a single byte (containing the tune speed) followed by the addresses of four blocks, one for each channel. So tune 0 has the following lookup table at <a href="/nes/bank_6/variable/tunedata.html#tune0data">tune0Data</a>, for example:</p>

<pre class="articleIndented">  EQUB 47
  EQUW tune0Data_SQ1
  EQUW tune0Data_SQ2
  EQUW tune0Data_TRI
  EQUW tune0Data_NOISE
</pre>

						<p>So tune 0 is played with speed 47, and then there are four addresses, one for each sound channel. These addresses each point to another list of links, which contain the addresses of each section in the tune. So, for example, we have the following section links in <a href="/nes/bank_6/variable/tunedata.html#tune0data_sq1">tune0Data_SQ1</a> for tune 0's SQ1 channel:</p>

<pre class="articleIndented">  EQUW tune0Data_SQ1_0
  EQUW tune0Data_SQ1_0
  EQUW tune0Data_SQ1_1
  EQUW tune0Data_SQ1_2
  EQUW tune0Data_SQ1_1
  EQUW tune0Data_SQ1_2
  EQUW tune0Data_SQ1_1
  EQUW tune0Data_SQ1_3
  EQUW tune0Data_SQ1_1
  EQUW tune0Data_SQ1_4
  EQUW 0
</pre>

						<p>These blocks of section links are typically terminated by a null address, at which point the tune wraps around to the start again. If there is no null terminator, then the tune will keep playing by moving on to the sections in the next list in memory, which it will play until a null terminator is found.</p>

						<p>Each of these section addresses points to the actual note data for each section, so that's <a href="/nes/bank_6/variable/tunedata.html#tune0data_sq1_0">tune0Data_SQ1_0</a> in our example, which contains the following music data for the SQ1 channel for the first section of tune 0:</p>

<pre class="articleIndented">  EQUB $FA, $70, $F7, $05, $F6, $09, $65, $0C
  EQUB $0C, $0C, $63, $07, $61, $07, $63, $07
  EQUB $07, $FF
</pre>

						<p>These blocks contain note data in the command format described below, and define what gets sent to the APU for this section of the tune.</p>

						<p>Note that tunes 3 and 4 share data, so in these cases there are two labels applied to the shared data (so <a href="/nes/bank_6/variable/tunedata.html#tune3data_sq1_0">tune3Data_SQ1_0</a> and <a href="/nes/bank_6/variable/tunedata.html#tune4data_sq1_0">tune4Data_SQ1_0</a> point to the same data, for example).</p>

						<h2 class="articleSubheader">Music data format<br />
													 -----------------</h2>

						<p>The note data consists of notes, rests and commands. If A is a byte from the note data (such as the example shown above), then it is interpreted as follows:</p>

						<ul>
							<li>If $00 &lt;= A &lt;= $5F then this is a note, so send it to the APU after converting the note value (which is a frequency) into an APU period (so higher values of A are higher notes with shorter periods). This conversion is done via the <a href="/nes/bank_6/variable/notefrequency.html">noteFrequency</a> table.</li>

							<li>If $60 &lt;= A &lt;= $7F then this is a rest, with the length of the rest given by A - $5F (so if A = $60 the rest length is one iteration, and if A = $7F the rest length is 32 iterations).</li>

							<li>If A >= $80 (i.e. bit 7 is set) then this is a command byte. The commands are between one and three bytes in size, and are listed in the table below.</li>
						</ul>

						<p>The commands are as follows:</p>

						<table class="spacedTableBorder codeSummary">
							<tr class="codeSummaryHeader"><th>Command</th><th>Description</th></tr>
							<tr><td>&lt;$F4 $xx></td><td>Set the playback speed to $xx</td></tr>
							<tr><td>&lt;$F5 $xx $yy></td><td>Change tune to the tune data at address $yyxx (so if $yyxx is tune2Data_SQ1, then this will jump to the start of tune 2, assuming this is the SQ1 data)</td></tr>
							<tr><td>&lt;$F6 $xx></td><td>Set the volume envelope number to $xx</td></tr>
							<tr><td>&lt;$F7 $xx></td><td>Set the pitch envelope number to $xx</td></tr>
							<tr><td>&lt;$F8></td><td>Set the volume of the current channel to zero</td></tr>
							<tr><td>&lt;$F9></td><td>Enable the volume envelope for the current channel</td></tr>
							<tr><td>&lt;$FA&nbsp;%ddlc0000></td><td>Configure the volume of the current channel in the APU: duty %dd, loop %l, const %c</td></tr>
							<tr><td>&lt;$FB $xx></td><td>Set the tuning for all channels to $xx (so this adds $xx to the pitch of all notes)</td></tr>
							<tr><td>&lt;$FC $xx></td><td>Set the tuning for the current channel to $xx (so this adds $xx to the pitch of all notes on the specified channel)</td></tr>
							<tr><td>&lt;$FD $xx></td><td>Set the sweep for the current channel to $xx</td></tr>
							<tr><td>&lt;$FE></td><td>Stop the music and disable sound</td></tr>
							<tr><td>&lt;$FF></td><td>Move to the next section in the current tune</td></tr>
						</table>

						<p>If a command byte is fetched that doesn't appear in the above list, then it is ignored.</p>

						<p>The volume envelope data can be found in the <a href="/nes/bank_6/variable/volumeenvelope.html">volumeEnvelope</a> table, and the pitch envelope in the <a href="/nes/bank_6/variable/pitchenvelope.html">pitchEnvelope</a> table. The changes in volume and pitch defined in these envelopes are applied to the music by four routines, one for each channel: <a href="/nes/bank_6/subroutine/applyenvelopesq1.html">ApplyEnvelopeSQ1</a>, <a href="/nes/bank_6/subroutine/applyenvelopesq2.html">ApplyEnvelopeSQ2</a>, <a href="/nes/bank_6/subroutine/applyenvelopetri.html">ApplyEnvelopeTRI</a> and <a href="/nes/bank_6/subroutine/applyenvelopetri.html">ApplyEnvelopeTRI</a>.</p>

						<p>The values in these tables get applied to the channel volume and pitch using the envelopes set by the $F6 and $F7 commands.</p>

						<p>For the volume envelope, the first byte indicates how many VBlanks each value in the envelope should be applied for, so this effectively sets the speed of the envelope. A value with bit 7 set indicates that this is the last entry in the envelope.</p>

						<p>The envelope is applied one step at a time, by setting the channel's volume in the APU as follows:</p>

						<ul>
							<li>The high nibble is taken from that value that's set via command byte $FA and which contains the duty, loop and NES envelope settings to send to the APU</li>

							<li>The low nibble (i.e. the volume) is set to the low nibble of the byte from the envelope</li>
						</ul>

						<p>So the volume envelope describes how the volume of the music on each channel changes with each new VBlank.</p>

						<p>The pitch envelope is similar, but it affects the pitch. The pitch envelope is always applied at a rate of one byte per VBlank, with a value of $80 indicating the end of the envelope (in which case we wrap around to the start of the envelope). The current byte in the envelope gets added to the low byte of the pitch that's sent to the APU, so the pitch varies by the amount in each byte of the pitch envelope, and because the addition is signed, envelope values greater than $80 reduce the pitch.</p>

						<p>Overall, the music player is pretty flexible. Hats off to David Whittaker for creating a system that not only brought these iconic tunes to Elite on the NES, but for composing two of them as well. That's some talent!</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="music_in_commodore_64_elite.html">Music in Commodore 64 Elite</a><a class="next" rel="next" title="Next deep dive" href="the_key_logger.html">The key logger</a></nav>
				</div>
				<!-- End of article -->
			</article>

<?php
include_once("../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
