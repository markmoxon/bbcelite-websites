<?php
include_once("../templates/template_functions.php");
page_header("deep_dives", "the_elite_memory_map.html", "BBC Micro cassette Elite memory map", "BBC Micro cassette Elite memory map", "A deep dive into the memory map of the cassette version of BBC Micro Elite", "elite", "deep_dives_memory_maps", "the_elite_memory_map");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="the_competition_code.html">The competition code</a><a class="next" rel="next" title="Next deep dive" href="the_elite_memory_map_disc.html">BBC Micro disc Elite memory map</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">Memory usage in the classic version of Elite, where space is really tight</h2>

						<p>The cassette version of BBC Micro Elite uses almost every nook and cranny of the BBC Micro Model B, which isn't surprising when you consider just how much the authors managed to squeeze into this 32K micro. Sure, the BBC Micro disc version of the game has more features, but that's because the main game code is split into two different programs, one that's loaded when you're docked and another that's loaded for spaceflight. The cassette version that's documented here doesn't have the luxury of fast loading - quite the opposite, in fact - so it has to cram the whole game into memory, all at once. It's an absolute marvel of efficiency.</p>

						<p>When the cassette version of Elite is loaded, this is how the memory map of the BBC Micro Model B looks.</p>

<pre class="articleIndented">  +-----------------------------------+   &amp;FFFF
  |                                   |
  | Machine Operating System (MOS)    |
  |                                   |
  +-----------------------------------+   &amp;C000
  |                                   |
  | Paged ROMs                        |
  |                                   |
  +-----------------------------------+   &amp;8000
  |                                   |
  | Python blueprint (PYTHON.bin)     |
  |                                   |
  +-----------------------------------+   &amp;7F00 = <a href="/cassette/main/variable/ship_python.html">SHIP_PYTHON</a>
  |                                   |
  | Memory for the split-screen mode  |
  |                                   |
  +-----------------------------------+   &amp;6000
  |                                   |
  | Ship blueprints (SHIPS.bin)       |
  |                                   |
  +-----------------------------------+   &amp;563A = <a href="/cassette/main/variable/xx21.html">XX21</a>
  |                                   |
  | Main game code (ELTcode.bin)      |
  |                                   |
  +-----------------------------------+   &amp;0F40 = <a href="/cassette/main/workspace/s_per_cent.html">S%</a>
  |                                   |
  | &amp;0F34-&amp;0F3F unused                |
  |                                   |
  +-----------------------------------+   &amp;0F34
  |                                   |
  | WP workspace                      |
  |                                   |
  +-----------------------------------+   &amp;0D40 = <a href="/cassette/main/workspace/wp.html">WP</a>
  |                                   |
  | Ship line heap descends from WP   |
  |                                   |
  +-----------------------------------+   SLSP
  |                                   |
  .                                   .
  .                                   .
  .                                   .
  .                                   .
  .                                   .
  |                                   |
  +-----------------------------------+   &amp;0AB0 when all ship slots are used
  |                                   |
  | Ship data blocks ascend from K%   |
  |                                   |
  +-----------------------------------+   &amp;0900 = <a href="/cassette/main/workspace/k_per_cent.html">K%</a>
  |                                   |
  | MOS sound envelope buffer         |
  |                                   |
  +-----------------------------------+   &amp;08C0
  |                                   |
  | MOS printer buffer                |
  |                                   |
  +-----------------------------------+   &amp;0880
  |                                   |
  | MOS sound workspace and buffer    |
  |                                   |
  +-----------------------------------+   &amp;0800
  |                                   |
  | Recursive tokens (WORDS9.bin)     |
  |                                   |
  +-----------------------------------+   &amp;0400 = <a href="/cassette/main/variable/qq18.html">QQ18</a>
  |                                   |
  | MOS tape filing system workspace  |
  |                                   |
  +-----------------------------------+   &amp;0380
  |                                   |
  | &amp;0372-&amp;037F unused                |
  |                                   |
  +-----------------------------------+   &amp;0372
  |                                   |
  | T% workspace                      |
  |                                   |
  +-----------------------------------+   &amp;0300 = <a href="/cassette/main/workspace/t_per_cent.html">T%</a>
  |                                   |
  | MOS general workspace             |
  |                                   |
  +-----------------------------------+   &amp;0200
  |                                   |
  | 6502 stack descends from &amp;01FF    |
  |                                   |
  +-----------------------------------+   &amp;0170
  |                                   |
  | Heap space ascends from XX3       |
  |                                   |
  +-----------------------------------+   &amp;0100 = <a href="/cassette/main/workspace/xx3.html">XX3</a>
  |                                   |
  | Zero page workspace               |
  |                                   |
  +-----------------------------------+   &amp;0000 = <a href="/cassette/main/workspace/zp.html">ZP</a>
</pre>

						<p>This memory map shows the full 64K of addressable memory that's supported by the BBC's 6502 processor, but only the bottom 32K is writable RAM, and hence usable by Elite. The top 16K is mapped to the MOS (Machine Operating System) ROM, and the next 16K is mapped to the currently selected paged ROM, which might be anything from BBC BASIC to the VIEW word processor.</p>

						<p>This 32K of RAM includes both screen memory and the various operating system workspaces, which can leave a pretty small amount for programs (especially in high resolution screen modes). Let's take a look at how the authors managed to shoehorn their game into such a small amount of memory.</p>

						<h2 class="articleSubheader">Memory usage<br>
													 ------------</h2>

						<p>Here's a full breakdown of memory usage in bytes, once the cassette version of Elite is loaded and running. The figures show the number of available bytes in each section and how many of those are unused:</p>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (ROMs)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Paged ROMs</td><td>&amp;8000 to &amp;BFFF</td><td class="right">16,384</td><td class="right">-</td></tr>
							<tr><td>Machine operating system (MOS) ROM</td><td>&amp;C000 to &amp;FFFF</td><td class="right">16,384</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total ROM memory</td><td>&nbsp;</td><td class="right">32,768</td><td class="right">-</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (MOS workspace)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>MOS zero page filing system workspace</td><td>&amp;00B0 to &amp;00CF</td><td class="right">32</td><td class="right">-</td></tr>
							<tr><td>MOS zero page VDU status byte</td><td>&amp;00D0</td><td class="right">1</td><td class="right">-</td></tr>
							<tr><td>MOS zero page tape filing system workspace</td><td>&amp;00E2 to &amp;00E3</td><td class="right">2</td><td class="right">-</td></tr>
							<tr><td>MOS zero page general workspace</td><td>&amp;00E4 to &amp;00FF</td><td class="right">28</td><td class="right">-</td></tr>
							<tr><td>MOS general workspace</td><td>&amp;0200 to &amp;02FF</td><td class="right">256</td><td class="right">-</td></tr>
							<tr><td>MOS tape filing system workspace</td><td>&amp;0380 to &amp;03DF</td><td class="right">96</td><td class="right">-</td></tr>
							<tr><td>MOS keyboard buffer</td><td>&amp;03E0 to &amp;03FF</td><td class="right">32</td><td class="right">-</td></tr>
							<tr><td>MOS sound workspace and buffer</td><td>&amp;0800 to &amp;087F</td><td class="right">128</td><td class="right">-</td></tr>
							<tr><td>MOS printer buffer</td><td>&amp;0880 to &amp;08BF</td><td class="right">64</td><td class="right">64</td></tr>
							<tr><td>MOS envelope buffer</td><td>&amp;08C0 to &amp;08FF</td><td class="right">64</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total MOS workspace memory</td><td>&nbsp;</td><td class="right">703</td><td class="right">64</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (shared memory)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>6502 stack</td><td>&amp;0170 to &amp;01FF</td><td class="right">144</td><td class="right">-</td></tr>
							<tr><td>Memory for the custom screen mode</td><td>&amp;6000 to &amp;7EFF</td><td class="right">7,936</td><td class="right">-</td></tr>
							<tr class="codeSummaryCategory"><td>Total shared memory</td><td>&nbsp;</td><td class="right">8,080</td><td class="right">-</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (game code)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Main game code</td><td>&amp;0F40 to &amp;5639</td><td class="right">18,170</td><td class="right">34</td></tr>
							<tr><td>Ship blueprints (except Python)</td><td>&amp;563A to &amp;5FFF</td><td class="right">2,502</td><td class="right">-</td></tr>
							<tr><td>QQ18 (game text)</td><td>&amp;0400 to &amp;07FF</td><td class="right">1,024</td><td class="right">1</td></tr>
							<tr><td>Python ship blueprint, SVN, VEC</td><td>&amp;7F00 to &amp;7FFF</td><td class="right">256</td><td class="right">11</td></tr>
							<tr class="codeSummaryCategory"><td>Total game code memory</td><td>&nbsp;</td><td class="right">21,952</td><td class="right">46</td></tr>
						</table>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Memory contents (workspaces)</th><th style="width: 15ch">Address range</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Zero page workspace 1</td><td>&amp;0000 to &amp;00AF</td><td class="right">176</td><td class="right">1</td></tr>
							<tr><td>Zero page workspace 2</td><td>&amp;00D1 to &amp;00E1</td><td class="right">17</td><td class="right">-</td></tr>
							<tr><td>XX3 (temporary heap)</td><td>&amp;0100 to &amp;016F</td><td class="right">112</td><td class="right">-</td></tr>
							<tr><td>K% (ship data blocks, line heaps)</td><td>&amp;0900 to &amp;0D3F</td><td class="right">1,088</td><td class="right">-</td></tr>
							<tr><td>WP (ship slots, variables)</td><td>&amp;0D40 to &amp;0F33</td><td class="right">500</td><td class="right">1</td></tr>
							<tr><td>Unused space after WP</td><td>&amp;0F34 to &amp;0F3F</td><td class="right">12</td><td class="right">12</td></tr>
							<tr><td>T% (commander data, stardust data)</td><td>&amp;0300 to &amp;0371</td><td class="right">114</td><td class="right">6</td></tr>
							<tr><td>Unused space after T%</td><td>&amp;0372 to &amp;037F</td><td class="right">14</td><td class="right">14</td></tr>
							<tr class="codeSummaryCategory"><td>Total workspace memory</td><td>&nbsp;</td><td class="right">2,033</td><td class="right">34</td></tr>

						<table class="spacedTableBorder codeSummary"></td></tr>
							<tr class="codeSummaryHeader"><th>Summary</th><th style="width: 15ch">&nbsp;</th><th class="right" style="width: 6ch">Bytes</th><th class="right" style="width: 6ch">Unused</th></tr></td></tr>
							<tr><td>Total ROM memory</td><td>&nbsp;</td><td class="right">32,768</td><td class="right">-</td></tr>
							<tr><td>Total MOS workspace memory</td><td>&nbsp;</td><td class="right">703</td><td class="right">64</td></tr>
							<tr><td>Total shared memory</td><td>&nbsp;</td><td class="right">8,080</td><td class="right">-</td></tr>
							<tr><td>Total game code memory</td><td>&nbsp;</td><td class="right">21,952</td><td class="right">46</td></tr>
							<tr><td>Total workspace memory</td><td>&nbsp;</td><td class="right">2,033</td><td class="right">34</td></tr>
							<tr class="codeSummaryCategory"><td>Totals</td><td>&nbsp;</td><td class="right">65,536</td><td class="right">144</td></tr>
						</table>

						<p>As you can see - and contrary to popular legend - Elite does not use every single last byte of the BBC Micro's usable memory. There are actually quite a few unused bytes in the cassette version, as noted in the "Unused" column above; 144 of them, to be precise. Here are the details, in the order in which they appear above:</p>

						<ul>
							<li>There are 64 unused bytes in the MOS printer buffer from &amp;0880 to &amp;08BF (as the game does not need a printer).</li>

							<li>There are 34 unused bytes in the main game code:

								<ul>
									<li>There are six unused bytes in the last saved commander data at NA%. Two of them are between LASER and CRGO, just after the four laser powers; they were originally used for up and down lasers, but those views were dropped and the space never reclaimed. There are four more unused bytes between the escape pod at ESCP and the cargo bay capacity at CRGO, which might have been for additional equipment that didn't get implemented... who knows?</li>

									<li>There's an unused and unlabelled duplicate of the multiplication routine MULTU sandwiched between FMLTU and MLTU2 that takes up 24 bytes.</li>

									<li>The MUT3 routine is never called and would be identical to MUT2 even if it were, so that's another four bytes that aren't used.</li>
								</ul>

							</li>

							<li>There is one unused byte at &amp;07FF in the recursive text token table at QQ18, right at the end of the table.</li>

							<li>There are 11 unused bytes in the Python workspace, between the end of the Python ship blueprint and the SVN and VEC variables, right at the top of user memory.</li>

							<li>In the zero page workspace, the one-byte variable XX14 is never used.</li>

							<li>There are 13 unused bytes in and after the WP workspace:

								<ul>
									<li>The one-byte variable XX24 is never used.</li>

									<li>There are 12 bytes after the end of the WP workspace, from &amp;0F34 to &amp;0F40, which aren't used.</li>
								</ul>

							</li>

							<li>There are 20 unused bytes in and after the T% workspace:

								<ul>
									<li>There are six unused bytes in the current commander data block at T%, which correspond with the unused bytes in the last saved commander data block at NA% (see above).</li>

									<li>There are 14 bytes after the end of the T% workspace, from &amp;0372 to &amp;037F, which aren't used.</li>
								</ul>

							</li>
						</ul>

						<p>On top of this, there are quite a few instructions in the main game code that have no effect and could have been culled without impact; I've identified 22 of them, but there are no doubt more of them to find (search the comments for "no effect" to find the ones I've spotted).</p>

						<p>But this is splitting hairs, as Elite swells the BBC Micro to near bursting point while being both incredibly clever and incredibly efficient, and for that, very serious respect is due to the authors.</p>

						<h2 class="articleSubheader">The XX3 heap<br>
													 ------------</h2>

						<p>The XX3 heap shares page 1 with the 6502 stack, with XX3 growing up from &amp;0100 and the stack growing down from &amp;01FF. XX3 is used to store temporary values, and the biggest collection of values is stored when drawing ships, when the projected screen coordinates of the ship's visible vertices are stored in the heap. (XX3 is also used to store a copy of the INWK workspace, but at 36 bytes, this is much smaller than the vertex heap.)</p>

						<p>In this context, "visible" just means that the vertex is close enough to be seen, irrespective of whether the corresponding face is hidden, so the heap is at its fullest when the ship with the largest number of vertices is close enough for them all to be deemed visible.</p>

						<p>In the standard versions of Elite (i.e. the cassette version of BBC Micro Elite and the Acorn Electron version), the Cobra Mk III has the largest number of vertices at 28, There are four bytes stored per vertex, so this means the largest heap size is 28 * 4 = 112 bytes, in which case XX3 takes up memory from &amp;0100 to &amp;016F.</p>

						<p>In the enhanced versions of Elite, the Transporter has the largest number of vertices at 37, so the largest heap size is 37 * 4 = 148 bytes, and XX3 takes up memory from &amp;0100 to &amp;0193.</p>

						<h2 class="articleSubheader">Shared locations<br>
													 ----------------</h2>

						<p>Some locations have two names in the source code. This is partly because some of the code was developed on an Acorn Atom, which restricts the names you can use for labels to two letters followed by one or more numbers. Presumably when this code was merged with the code that was developed on a BBC Micro, where label naming is more flexible, it was easier just to share label names than refactor the Atom code.</p>

						<p>The following label names point to the same locations in memory, and are therefore interchangeable:</p>

<pre class="articleIndented">  LOIN        = LL30
  INWK        = XX1
  INWK(34 33) = XX19(1 0)
  X1          = XX15
  Y1          = XX15+1
  X2          = XX15+2
  Y2          = XX15+3
  K5          = XX18         = QQ17
  K3          = XX2
  LSO         = LSX
  CABTMP      = MANY
</pre>

						<p>The last one is slightly different, in that the first byte of the MANY table is unused, so CABTMP simply makes the most of the otherwise unused location.</p>

						<h2 class="articleSubheader">Elite code as an image<br>
													 ----------------------</h2>

						<p>To see just how small the cassette version of Elite is, we can convert the main game binary into an image, with one byte per pixel, and a greyscale showing each byte's value, with 0 being shown as black, 255 being shown as white, and interim values as greyscale pixels. The result is a 162-pixel square, like this (shown here at double size, so you can see the pixels more clearly):</p>

						<img class="titleImage" style="width: 324px" src="/images/cassette/code.png" alt="The game binary for BBC Micro cassette Elite as an image">

						<p>This image contains the entire main game. That's some nice, bloat-free code!</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="the_competition_code.html">The competition code</a><a class="next" rel="next" title="Next deep dive" href="the_elite_memory_map_disc.html">BBC Micro disc Elite memory map</a></nav>
				</div>
			</article>

<?php
include_once("../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
