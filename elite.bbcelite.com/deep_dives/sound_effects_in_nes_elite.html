<?php
include_once("../templates/template_functions.php");
page_header("deep_dives", "sound_effects_in_nes_elite.html", "Sound effects in NES Elite", "Sound effects in NES Elite", "A deep dive into sound effects in NES Elite", "elite", "deep_dives_sound_and_music", "sound_effects_in_nes_elite");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="sound_effects_in_apple_ii_elite.html">Sound effects in Apple II Elite</a><a class="next" rel="next" title="Next deep dive" href="music_in_commodore_64_elite.html">Music in Commodore 64 Elite</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">The largest set of sound effects in all the 6502 Elites</h2>

						<p>The original Elite isn't particularly well-known for its sound effects - space, it turns out, is pretty quiet most of the time. NES Elite doesn't break with this trend, but it does have a lot more sound effects than in the earlier versions, so that's something.</p>

						<p>(Incidentally, Elite Dangerous is completely the other way around; the sound design in E:D is really quite special, and deserves all the praise it gets.)</p>

						<p>As with the music routines in NES Elite, the sound routines were written by David Whittaker, one of the most prolific sound artists of the 8-bit era. His CV is quite astonishing - here's a biography that includes a <a href="https://www.vgmpf.com/Wiki/index.php?title=David_Whittaker">list of games on which he worked</a>. Warning: it's a very long list.</p>

						<p>Let's see how these sound effects work.</p>

						<h2 class="articleSubheader">The sound effects<br />
													 -----------------</h2>

						<p>The <a href="/nes/bank_7/subroutine/noise.html">NOISE</a> routine generates all the sound effects in the game. It takes the sound number as an argument, and the full list of sound effects is as follows, along with the names of the routines that initiate them:</p>

						<table class="spacedTableBorder codeSummary">
							<tr class="codeSummaryHeader"><th>#</th><th>Description</th><th>Initiated by</th></tr>
							<tr><td>0</td><td>Unused</td><td>-</td></tr>
							<tr><td>1</td><td>Fuel scoop</td><td><a href="/nes/bank_7/subroutine/makescoopsound.html">MakeScoopSound</a></td></tr>
							<tr><td>2</td><td>E.C.M.</td><td><a href="/nes/bank_7/subroutine/ecblb2.html">ECBLB2</a></td></tr>
							<tr><td>3</td><td>Short, high beep</td><td><a href="/nes/bank_7/subroutine/beep.html">BEEP</a></td></tr>
							<tr><td>4</td><td>Long, low beep</td><td><a href="/nes/bank_7/subroutine/boop.html">BOOP</a></td></tr>
							<tr><td>5</td><td>Trumbles in the hold sound 1, 75% chance</td><td><a href="/nes/bank_0/subroutine/main_game_loop_part_5_of_6.html">Main game loop (Part 5)</a></td></tr>
							<tr><td>6</td><td>Trumbles in the hold sound 2, 25% chance</td><td><a href="/nes/bank_0/subroutine/main_game_loop_part_5_of_6.html">Main game loop (Part 5)</a></td></tr>
							<tr><td>7</td><td>Low energy beep</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_15_of_16.html">Main flight loop (Part 15)</a></td></tr>
							<tr><td>8</td><td>Energy bomb</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_3_of_16.html">Main flight loop (Part 3)</a></td></tr>
							<tr><td>9</td><td>Missile launch</td><td><a href="/nes/bank_0/subroutine/frmis.html">FRMIS</a>, <a href="/nes/bank_0/subroutine/sfrmis.html">SFRMIS</a></td></tr>
							<tr><td>10</td><td>Us making a hit or kill</td><td><a href="/nes/bank_0/subroutine/exno.html">EXNO</a></td></tr>
							<tr><td>11</td><td>Us being hit by lasers</td><td><a href="/nes/bank_0/subroutine/tactics_part_6_of_7.html">TACTICS (Part 6)</a></td></tr>
							<tr><td>12</td><td>First launch sound</td><td><a href="/nes/bank_0/subroutine/laun.html">LAUN</a></td></tr>
							<tr><td>13</td><td>Explosion/collision sound</td><td><a href="/nes/bank_7/subroutine/exno3.html">EXNO3</a></td></tr>
							<tr><td> </td><td>Ship explosion at distance z_hi &lt; 6</td><td><a href="/nes/bank_0/subroutine/exno2.html">EXNO2</a></td></tr>
							<tr><td>14</td><td>Ship explosion at distance z_hi >= 6</td><td><a href="/nes/bank_0/subroutine/exno2.html">EXNO2</a></td></tr>
							<tr><td>15</td><td>Military laser firing</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_3_of_16.html">Main flight loop (Part 3)</a></td></tr>
							<tr><td>16</td><td>Mining laser firing</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_3_of_16.html">Main flight loop (Part 3)</a></td></tr>
							<tr><td>17</td><td>Beam laser firing</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_3_of_16.html">Main flight loop (Part 3)</a></td></tr>
							<tr><td>18</td><td>Pulse laser firing</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_3_of_16.html">Main flight loop (Part 3)</a></td></tr>
							<tr><td>19</td><td>Escape pod launching</td><td><a href="/nes/bank_0/subroutine/escape.html">ESCAPE</a></td></tr>
							<tr><td>20</td><td>Unused</td><td>-</td></tr>
							<tr><td>21</td><td>Hyperspace</td><td><a href="/nes/bank_7/subroutine/makehypersound.html">MakeHyperSound</a></td></tr>
							<tr><td>22</td><td>Galactic hyperspace</td><td><a href="/nes/bank_0/subroutine/ghy.html">Ghy</a></td></tr>
							<tr><td>23</td><td>Ship explosion at distance z_hi >= 8</td><td><a href="/nes/bank_0/subroutine/laun.html">LAUN</a></td></tr>
							<tr><td></td><td>Ship explosion at distance z_hi >= 8</td><td><a href="/nes/bank_0/subroutine/exno2.html">EXNO2</a></td></tr>
							<tr><td>24</td><td>Second launch sound</td><td><a href="/nes/bank_0/subroutine/laun.html">LAUN</a></td></tr>
							<tr><td>25</td><td>Unused</td><td>-</td></tr>
							<tr><td>26</td><td>No noise</td><td><a href="/nes/bank_7/subroutine/flushsoundchannel.html">FlushSoundChannel</a></td></tr>
							<tr><td>27</td><td>Ship explosion at a distance of z_hi >= 16</td><td><a href="/nes/bank_0/subroutine/exno2.html">EXNO2</a></td></tr>
							<tr><td>28</td><td>Trill noise to indicate a purchase</td><td><a href="/nes/bank_0/subroutine/buyandsellcargo.html">BuyAndSellCargo</a></td></tr>
							<tr><td>29</td><td>First mis-jump sound</td><td><a href="/nes/bank_0/subroutine/mjp.html">MJP</a></td></tr>
							<tr><td>30</td><td>Second mis-jump sound</td><td><a href="/nes/bank_0/subroutine/mjp.html">MJP</a></td></tr>
							<tr><td>31</td><td>Trumbles being killed by the sun</td><td><a href="/nes/bank_0/subroutine/main_flight_loop_part_15_of_16.html">Main flight loop (Part 15)</a></td></tr>
						</table>

						<p>The NOISE routine works by first fetching the list of APU channels that the sound effect requires from the <a href="/nes/bank_7/variable/soundchannel.html">soundChannel</a> table; sound effects can use the SQ1, SQ2 and NOISE channels (sound effects in NES Elite don't use the TRI channel). It then checks to see if an existing effect is already being made on those channels; if a channel is empty then the new effect is made, but if there is an existing sound effect being made on a channel, the code compares the priority of the existing effect with the new one, as defined for each effect in the <a href="/nes/bank_7/variable/soundpriority.html">soundPriority</a> table. The higher priority sound effect wins out. (Note that sound effects always take priority over music, but this is controlled by the music routines, rather than using the soundPriority - at this stage we are only prioritising between sound effects.)</p>

						<p>Sound effects are actually made via the <a href="/nes/bank_6/subroutine/starteffect.html">StartEffect</a> routine, which gets called once for each channel that the new sound effect uses. StartEffect then calls <a href="/nes/bank_6/subroutine/starteffectonsq1.html">StartEffectOnSQ1</a>, <a href="/nes/bank_6/subroutine/starteffectonsq2.html">StartEffectOnSQ2</a> or <a href="/nes/bank_6/subroutine/starteffectonnoise.html">StartEffectOnNOISE</a> as appropriate, to start making the correct sounds on the SQ1, SQ2 and NOISE channels as required.</p>

						<p>The Start routines set up the sound effect and send the first batch of data to the APU, but it's the NMI handler that continues the good work. The NMI handler calls the <a href="/nes/bank_6/subroutine/makesounds.html">MakeSounds</a> routine in every VBlank, which then calls the <a href="/nes/bank_6/subroutine/makesound.html">MakeSound</a> routine to make the configured sound effects. This in turn calls the <a href="/nes/bank_6/subroutine/updatevibratoseeds.html">UpdateVibratoSeeds</a> routine to randomise the seeds that are used to make a vibrato effect, and then it calls <a href="/nes/bank_6/subroutine/makesoundonsq1.html">MakeSoundOnSQ1</a>, <a href="/nes/bank_6/subroutine/makesoundonsq2.html">MakeSoundOnSQ2</a> and <a href="/nes/bank_6/subroutine/makesoundonnoise.html">MakeSoundOnNOISE</a> to send the sound effect data to the APU.</p>

						<p>The data that is sent to the APU for each sound effect is defined in that sound's data block. This defines all sorts of aspects of the sound effect, so let's take a look at that next.</p>

						<h2 class="articleSubheader">Sound data format<br />
													 -----------------</h2>

						<p>Each of the above sound effects has an associated data block in the <a href="/nes/bank_6/variable/sounddata.html">soundData</a> table. Each sound data block is made up of 14 bytes, which are copied to the <a href="/nes/common/workspace/wp.html#soundbytesq1">soundByteSQ1</a>, <a href="/nes/common/workspace/wp.html#soundbytesq2">soundByteSQ2</a> or <a href="/nes/common/workspace/wp.html#soundbytenoise">soundByteNOISE</a> blocks (one for each channel) where they can be manipulated. This is so counters within the data block can be updated <i>in situ</i>, as the original soundData table is in ROM and can't be changed.</p>

						<p>The sound data block controls the sending of data to the APU during each iteration of the sound effect routine (which is typically every VBlank). The following documentation talks about channel SQ1, but the same logic applies to the SQ2 and NOISE channels.</p>

						<p>The list of bytes in the sound effect data block is as follows:</p>

						<table class="spacedTableBorder codeSummary">
							<tr>
								<td>
									<p class="highlight">Byte #0</p>
									<pre class="articleIndented">Length of sound (in iterations)</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Ignored if the sound is an infinite loop (i.e. if byte #12 is non-zero)</li>
										<li>Gets decremented on each iteration</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #1</p>
									<pre class="articleIndented">How often we send pitch data to the APU</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>So we send pitch data to the APU every byte #1 iterations</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Bytes #2 and #3</p>
									<pre class="articleIndented">The first 16-bit pitch data to send to (SQ1_HI SQ1_LO)</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Used as 16-bit storage for (soundHiSQ1 soundLoSQ1), which contains the pitch data to send to the APU for this iteration</li>
										<li>This gets sent to the APU via (SQ1_HI SQ1_LO) to set the sound effect's pitch as the effect progresses</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Bytes #4 and #5</p>
									<pre class="articleIndented">A 16-bit value to apply to the pitch every iteration</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>The pitch is only varied if enabled by byte #8 being non-zero</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #6</p>
									<pre class="articleIndented">High nibble of the SQ1_VOL byte</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>This value gets OR'd with the soundVolumeSQ1 variable to send to the APU via SQ1_VOL</li>
										<li>It sets the duty, loop and NES envelope settings to send to the APU</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #7</p>
									<pre class="articleIndented">Add vibrato</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Non-zero means add vibrato to the pitch on each iteration using the randomised vibrato value in soundVibrato</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #8</p>
									<pre class="articleIndented">Enable/disable the pitch variation in byte #4/#5</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Non-zero means:
											<ul>
												<li>Bit 7 clear = subtract byte #4/#5 from the APU pitch on each iteration (so the note frequency goes up)</li>
												<li>Bit 7 set = add byte #4/#5 to the APU pitch on each iteration (so the note frequency goes down)</li>
											</ul>
										</li>
										<li>Zero disables the pitch variation in byte #4/#5 </li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #9</p>
									<pre class="articleIndented">Number of iterations for which we send pitch data to the APU</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Ignored if the sound is an infinite loop (i.e. if byte #12 is non-zero)</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #10</p>
									<pre class="articleIndented">Number of the volume envelope to apply</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>This is the number of the envelope to apply from the <a href="/nes/bank_6/variable/soundvolume.html">soundVolume</a> table</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #11</p>
									<pre class="articleIndented">How often we apply the volume envelope to the sound</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>We apply the next entry from the volume envelope every byte #11 iterations</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #12</p>
									<pre class="articleIndented">Enable/disable infinite loop</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Non-zero means the sound effect loops and keeps being made, even after the counter in byte #0 runs down</li>
										<li>Zero means the sound only runs for the number of iterations in byte #0</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>
									<p class="highlight">Byte #13</p>
									<pre class="articleIndented">How often to apply the pitch variation in byte #4/#5</pre>
								</td>
							</tr>
							<tr>
								<td>
									<ul>
										<li>If pitch variation is enabled by byte #8 being non-zero, then:
											<ul>
												<li>Non-zero means only apply the pitch variation in byte #4/#5 every byte #13 iterations</li>
												<li>Zero means apply the pitch variation every iteration</li>
											</ul>
										</li>
									</ul>
								</td>
							</tr>
						</table>

						<p>The above table defines everything about the sound that we need to send to the APU. Vibrato is applied using the randomised byte from the soundVibrato variable, but the only other bit of data that's needed to make each sound is the volume envelope that's configured by bytes #10 and #11, so let's have a look at that.</p>

						<p>The volume envelopes can be found in the <a href="/nes/bank_6/variable/soundvolume.html">soundVolume</a> table. The changes in volume defined in these envelopes are applied to the sound effect by altering the channel's volume register (such as SQ1_VOL for channel SQ1). Entries in the soundEnvelope table only have the low nibble populated (apart from the $FF value that signifies the end of the data), and this is combined with the high nibble from byte #6 in the sound data block, which sets the duty, loop and NES envelope settings to send to the APU. In this way the volume envelope changes the volume of the sound effect as it progresses, according to the data in the specified envelope and the settings in the sound data block.</p>

						<p>Of course, the table above just describes David Whittaker's sound player, which takes the sound data and pushes it to the APU. The clever part is creating the sound effects in the first place, and encoding them into a sound data block to make the desired noise. How that part works is David Whittaker's secret, though it's clear that the sound routines (as with the music routines) were generated using macros, as each different channel has its own separate routines and variable blocks that contain almost identical code, with channels like NOISE and TRI only differing slightly from the two square-wave channels. Presumably he had a macro-based build system that allowed him to churn out bespoke sound engines for new games relatively easily; it's no wonder he was able to be so prolific.</p>

						<p>The music routines are similarly structured, and are described in the deep dive on <a href="music_in_nes_elite.html">music in NES Elite</a>.</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="sound_effects_in_apple_ii_elite.html">Sound effects in Apple II Elite</a><a class="next" rel="next" title="Next deep dive" href="music_in_commodore_64_elite.html">Music in Commodore 64 Elite</a></nav>
				</div>
			</article>

<?php
include_once("../templates_local/navigation.php");
?>
		</div>
	</body>
</html>
