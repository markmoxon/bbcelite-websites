<?php
include_once("../templates/template_functions.php");
page_header("disassembly_websites", "comparing_elite.html", "Generating code comparisons for Elite", "Generating code comparisons for Elite", "Using a library repository to compare for different versions of Elite", "archaeology", "disassembly_websites", "comparing_elite");
?>
				<!-- Start of article -->
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous page" href="generating_elite.html">Generating source code for Elite</a><a class="next" rel="next" title="Next page" href="code_analysis.html">Scripts that help me manage my websites</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">Using a library repository to compare the different versions of Elite</h2>

						<p>The <a href="https://elite.bbcelite.com/compare/how_to_compare.html">comparison section of the Elite website</a> is a good example of something that would be pretty difficult to create without content generation. It compares the source code for all five Acornsoft versions of Elite on a line-by-line basis, showing all the variations side-by-side, along with indexes and commentary on each variation. Creating this content by hand would be almost impossible, so it's no surprise that this section is generated by a Python script.</p>

						<p>If you've managed to wade through the article on <a href="generating_elite.html">generating source code for Elite</a>, then you'll already know that the library repository is marked up with IF statements that define which code appears in which version of Elite. The comparison section is essentially a web-based version of this information, showing side-by-side code comparisons that reflect the BeebAsm conditional blocks in the library source code.</p>

						<p>Consider this code variation that appears in <a href="https://github.com/markmoxon/library-elite-beebasm/blob/main/library/common/main/subroutine/br1_part_2_of_2.asm">part 2 of the BR1 routine</a>:</p>

<pre class="articleIndented">  IF _CASSETTE_VERSION OR _ELECTRON_VERSION

   LDA #147            \ Call TITLE to show a rotating Mamba (#3) and token
   LDX #3              \ 147 ("PRESS FIRE OR SPACE,COMMANDER.{crlf}{crlf}"),
   JSR TITLE           \ returning with the internal number of the key pressed
                       \ in A

  ELIF _DISC_DOCKED OR _ELITE_A_VERSION

   LDA #7              \ Call TITLE to show a rotating Krait (#KRA) and token
   LDX #KRA            \ 7 ("PRESS SPACE OR FIRE,{single cap}COMMANDER.{cr}
   JSR TITLE           \ {cr}"), returning with the internal number of the key
                       \ pressed in A

  ELIF _6502SP_VERSION

   LDA #7              \ Call TITLE to show a rotating Asp Mk II (#ASP) and
   LDX #ASP            \ token 7 ("PRESS SPACE OR FIRE,{single cap}COMMANDER.
   JSR TITLE           \ {cr}{cr}"), returning with the internal number of the
                       \ key pressed in A

  ELIF _MASTER_VERSION

   LDA #7              \ Call TITLE to show a rotating Cougar (#COU) and token
   LDX #COU            \ 7 ("PRESS SPACE OR FIRE,{single cap}COMMANDER.{cr}
   LDY #100            \ {cr}"), with the ship at a distance of 100, returning
   JSR TITLE           \ with the internal number of the key pressed in A

  ENDIF
</pre>

						<p>You can see this difference in <a href="https://elite.bbcelite.com/compare/main/subroutine/br1_part_2_of_2.html">the comparison section of the website</a>, where the four variations are shown side-by-side. This view is generated by the same <a href="https://github.com/markmoxon/bbcelite-scripts/blob/main/disassembly-website-generator/create-disassembly-websites.py">create-disassembly-websites.py</a> script that generates the code sections of the website, but this time it ingests the content directly from the library repository, rather than from the source code repositories.</p>

						<p>The above example isn't quite the whole story, though, as each IF-block in the library repository is also tagged with meta-information about that difference, which I've left out of the above example to keep things simple. In reality, the first line of each conditional block has a comment after the IF statement that contains a description of the variation, and this is shown not only in the comparison page above, but also in the summary pages like the <a href="https://elite.bbcelite.com/compare/indexes/shared_code_standard.html">compare code for features of standard Elite</a> page - you can see the information for this variation at the top of that page.</p>

						<p>So the first line of the above conditional actually looks like this:</p>

<pre class="articleIndented">  IF _CASSETTE_VERSION OR _ELECTRON_VERSION \ Standard: On the second title
  page (the one that says "Press Space Or Fire,Commander"), the cassette and
  Electron versions show a rotating Mamba, the disc version shows a rotating
  Krait, the 6502SP version shows a rotating Asp Mk II, and the Master
  version shows a rotating Cougar
</pre>

						<p>The first part of the comment, up to the colon, defines the category of this variation, which determines which index page it appears on (in this case it's a standard change, which means it's related to a feature in the standard versions of Elite). The rest of the comment is the description, which appears on the <a href="https://elite.bbcelite.com/compare/indexes/shared_code_standard.html">index page</a> and in the <a href="https://elite.bbcelite.com/compare/main/subroutine/br1_part_2_of_2.html">code comparison</a>.</p>

						<p>Variations can also be grouped together, in case a difference in functionality is split across multiple variations in the same routine. For example, the first variation in the ANGRY routine in the <a href="https://elite.bbcelite.com/compare/indexes/shared_code_enhanced.html">compare code for features of enhanced Elite</a> page is a grouped variation. If you click through to the <a href="https://elite.bbcelite.com/compare/main/subroutine/angry.html">ANGRY routine comparison</a> itself, then you can see that variations 1 and 3 are grouped, and variation 3 contains a link up to variation 1. Variations are grouped together in the library source by adding the group identifier (a letter) after the category, like this in the first variation:</p>

<pre class="articleIndented">  IF _CASSETTE_VERSION \ Enhanced: Group A: In the enhanced versions,
  attacking an innocent bystander (i.e. a ship that has bit 5 of the NEWB
  flags set) will annoy the space station
</pre>

						<p>and like this in subsequent variations:</p>

<pre class="articleIndented">  IF _CASSETTE_VERSION \ Enhanced: See group A
</pre>

						<p>Let's now take a more detailed look at how the script creates the comparison pages.</p>

						<h2 class="articleSubheader">A deeper look at the comparison process<br />
													 ---------------------------------------</h2>

						<p>As mentioned in the article on <a href="generating_elite.html">generating source code repositories for Elite</a>, the generation of the comparison part of the website is implemented by a single line in the <a href="https://github.com/markmoxon/bbcelite-scripts/blob/main/generate-elite.sh">generate-elite.sh</a> shell script:</p>

<pre class="articleIndented">  python3 create-disassembly-websites.py compare
</pre>

						<p>The "compare" argument tells the script to generate the comparison part of the site. Here's a summary of what the script does, along with links to relevant examples of the output on the Elite website:</p>

						<ul>
							<li>Print "Comparison section" to the terminal.</li>

							<li>Call create_folder() to create the folders we need to hold the comparison section of the website.</li>

							<li>Print "Analysing files for comparison" to the terminal.</li>

							<li>Call analyse_files_for_compare() to ingest the source code library and populate the global variables includes_in_versions{} and all_includes{}.</li>

							<li>Call output_compares_indexes() to create the indexes of variations and code usage, such as the list of <a href="https://elite.bbcelite.com/compare/indexes/shared_code_with_variations.html">all shared code that contains variations</a>.</li>

							<li>Call output_compare_category_index() to create the summary of code variations in each category, such as the list of <a href="https://elite.bbcelite.com/compare/indexes/shared_code_standard.html">comparisons of features of standard Elite</a>.</li>

							<li>Call output_compare_other_categories_index() to create the <a href="https://elite.bbcelite.com/compare/indexes/shared_code_other_variations.html">summary of minor variations between versions</a>.</li>

							<li>Print "Writing comparison pages" to the terminal.</li>

							<li>Call output_compare_version_page() to create the individual code variation pages, such as the <a href="https://elite.bbcelite.com/compare/main/subroutine/bline.html">version analysis of BLINE</a>.</li>

							<li>Print "Writing menus" to the terminal.</li>

							<li>Call output_compare_menu() to create the <a href="https://elite.bbcelite.com/templates_local/navigation_compare.php">navigation_compare.php</a> include file containing the left-hand navigation for the comparison section.</li>
						</ul>

						<h2 class="articleSubheader">Global variables<br />
													 ----------------</h2>

						<p>Here's a list of important global variables that are used in the comparison script:</p>

						<ul>
							<li>includes_in_versions{} = a list of include files for each version of Elite</li>

							<li>all_includes{} = detailed data on every single include file in the library repository</li>
						</ul>

						<p>These are populated by process_compare_line() &gt; add_compare_include(), and the script writes their contents into the includes_in_versions.txt and all_includes.txt files in the disassembly-website-generator/debug folder.</p>

						<h2 class="articleSubheader">Call hierarchy<br />
													 --------------</h2>

						<p>Here's a call hierarchy of the above processes, which will help you orientate yourself if you want to look through the script. This is not a breakdown of each routine's actions, it's just a list of function usage in the script, so it's more of a map for your own investigations rather than a full explanation.</p>

						<p>In the following, a + indicates a routine that is called from multiple places, while a - indicates this subroutine is only called once in the whole program.</p>

						<table class="spacedTableBorder codeSummary tight">
							<tr class="codeSummaryHeader"><th>Routine</th><th>Details</th></tr>
							<tr><td><pre>+ create_folder()</pre></td><td>Create skeleton website folders</td></tr>
							<tr><td><pre>+ analyse_files_for_compare()</pre></td><td>Analyse all source code files for comparisons</td></tr>
							<tr><td><pre> + process_compare_file()</pre></td><td>Process an individual source code file for comparisons</td></tr>
							<tr><td><pre>  + strip_elite_a()</pre></td><td>Strip platforms defined in omit_from_compare[] from comparison</td></tr>
							<tr><td><pre>  + process_compare_line()</pre></td><td>Process an individual source code line for comparisons</td></tr>
							<tr><td><pre>   - add_compare_include()</pre></td><td>Add details of each included file to all_includes{}</td></tr>
							<tr><td><pre>- output_compares_indexes()</pre></td><td>Create the indexes of variations and code usage</td></tr>
							<tr><td><pre> + start_html()</pre></td><td>Output the start of the HTML page</td></tr>
							<tr><td><pre> + output_next_prev()</pre></td><td>Output next/prev links for page</td></tr>
							<tr><td><pre> - add_code_link()</pre></td><td>Create a link to a specific version of Elite</td></tr>
							<tr><td><pre> + end_html()</pre></td><td>Output the end of the HTML page</td></tr>
							<tr><td><pre>- output_compare_category_index()</pre></td><td>Create the summary of variations in each category</td></tr>
							<tr><td><pre> + start_html()</pre></td><td>Output the start of the HTML page</td></tr>
							<tr><td><pre> + output_next_prev()</pre></td><td>Output next/prev links for page</td></tr>
							<tr><td><pre> + end_html()</pre></td><td>Output the end of the HTML page</td></tr>
							<tr><td><pre>- output_compare_other_categories_index()</pre></td><td>Create the summary of minor variations between versions</td></tr>
							<tr><td><pre> + start_html()</pre></td><td>Output the start of the HTML page</td></tr>
							<tr><td><pre> + output_next_prev()</pre></td><td>Output next/prev links for page</td></tr>
							<tr><td><pre> + get_url_for_code_page()</pre></td><td>Fetch the URL for a page containing source code</td></tr>
							<tr><td><pre>  - get_stage()</pre></td><td>Fetch the stage (e.g. loader, text_tokens) for an include</td></tr>
							<tr><td><pre> - tag_comments_as_ul()</pre></td><td>Extract the tag comments for a code difference as HTML</td></tr>
							<tr><td><pre> - tag_comments_for_single_platform_variation()</pre></td><td>Extract the tag comments for a single-platform difference as HTML</td></tr>
							<tr><td><pre> + end_html()</pre></td><td>Output the end of the HTML page</td></tr>
							<tr><td><pre>- output_compare_version_page()</pre></td><td>Create the code variation pages for each routine</td></tr>
							<tr><td><pre> + start_code_html()</pre></td><td>Output the start of the HTML code page</td></tr>
							<tr><td><pre> - get_links_for_compared_versions()</pre></td><td>Fetch a list of all versions containing the routine being compared</td></tr>
							<tr><td><pre>  + get_url_for_code_page()</pre></td><td>Fetch the URL for a page containing source code</td></tr>
							<tr><td><pre>   - get_stage()</pre></td><td>Fetch the stage (e.g. loader, text_tokens) for an include</td></tr>
							<tr><td><pre>  + convert_version_to_full_name_comma_list()</pre></td><td>Convert DISC_DOCKED to "Disc (docked)" etc.</td></tr>
							<tr><td><pre> - convert_versions_to_link_list()</pre></td><td>Convert an array of version names to an HTML list</td></tr>
							<tr><td><pre> - output_compare_line()</pre></td><td>Output marked-up HTML for a compared line of code</td></tr>
							<tr><td><pre>  + tidy_source_header_line()</pre></td><td>Add markup to a source code header line</td></tr>
							<tr><td><pre>  - replace_workspace_include_with_variable()</pre></td><td>In compared workspaces, just display variable names and no comments</td></tr>
							<tr><td><pre>  - append_multi_version_compare_line()</pre></td><td>Add a compared code line to the compare buffer for output later</td></tr>
							<tr><td><pre>  + output_buffered_compare_line()</pre></td><td>Output the compare code buffer</td></tr>
							<tr><td><pre> - output_multi_version_section()</pre></td><td>Output HTML for a compared code block with multiple versions</td></tr>
							<tr><td><pre>  - convert_versions_to_list()</pre></td><td>Create a comma-separated list of versions that do not contain a specific comparison</td></tr>
							<tr><td><pre>   + convert_version_to_full_name_comma_list()</pre></td><td>Convert DISC_DOCKED to "Disc (docked)" etc.</td></tr>
							<tr><td><pre>  - add_links_to_compared_routines()</pre></td><td>Create a comma-separated list of versions that contain a specific comparison</td></tr>
							<tr><td><pre> + output_buffered_compare_line()</pre></td><td>Output and flush the compare buffer</td></tr>
							<tr><td><pre> + end_code_html()</pre></td><td>Output the end of the HTML code page</td></tr>
							<tr><td><pre>- output_compare_menu()</pre></td><td>Create the left nav for the comparison section</td></tr>
							<tr><td><pre> - add_compare_article()</pre></td><td>Add compare page to routines{}</td></tr>
						</table>

						<p>Finally, as mentioned in the article on <a href="generating_websites.html">generating websites from source code</a>, there is an additional call made to the analyse_files_for_compare() routine when generating the source code pages for the individual versions on the Elite site. This ensures that the global variables includes_in_versions{} and all_includes{} are populated correctly, so we can use them to add comparison links into the headers of each routine in the main source code section of the site. This isn't needed for Aviator, Revs and Lander, as those sites don't have a comparison section.</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous page" href="generating_elite.html">Generating source code for Elite</a><a class="next" rel="next" title="Next page" href="code_analysis.html">Scripts that help me manage my websites</a></nav>
				</div>
				<!-- End of article -->
			</article>

<?php
include_once("../templates_local/navigation.php");

?>
		</div>
	</body>
</html>
