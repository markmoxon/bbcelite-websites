<?php
include_once("../templates/template_functions.php");
page_header("deep_dives", "the_engine_sounds.html", "The engine sounds", "The engine sounds", "A deep dive into the engine sounds in BBC Micro Revs", "revs", "deep_dives_text", "the_engine_sounds");
?>
				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="text_tokens.html">Text tokens</a><a class="next" rel="next" title="Next deep dive" href="random_numbers.html">Random numbers</a></nav>
				</div>

				<div class="codeBlockWrapper">
					<div class="codeBlock article">
						<h2 class="articleSubheader deepDive">Creating a realistic three-tone engine sound</h2>

						<p>The engine sound is a key part of the driving experience in Revs; it helps you gauge the rev count without taking your eyes off the road. To get a reasonably realistic sound out of the BBC Micro's sound system, the game produces a three-part engine sound, using two tones and a sprinkling of white noise.</p>

						<p>Let's see what's involved in making the engine sound, as well as the game's other noises.</p>

						<h2 class="articleSubheader">The engine sound routine<br />
													 ------------------------</h2>

						<p>The engine sound is generated by the <a href="/source/main/subroutine/makedrivingsounds.html">MakeDrivingSounds</a> routine, which is called twice during the main driving loop. (I'm not sure why it's called twice, as reducing this to one call doesn't seem to affect the sound, but it might be to prevent the sounds from stuttering when the main loop is busier than normal; this, however, is a guess.)</p>

						<p>The engine sound is made up of three parts:</p>

                        <ul>
                            <li>Engine exhaust on sound channel 0</li>

                            <li>Engine tone 1 on sound channel 1</li>

                            <li>Engine tone 2 on sound channel 2</li>
                        </ul>

						<p>Channel 0 is the BBC Micro's noise channel, so the exhaust is a kind of "putter-putter" white-noise sound. The tones on channel 1 and 2 get higher with higher rev counts, with tone 2 sounding for the whole range of engine speeds from idling and up, and tone 1 only kicking in at higher revs. The exhaust sound dies off at higher revs, when the engine is working at high efficiency. The two tones are separated by a pitch of 28, with tone 1 lower than tone 2.</p>

						<p>The engine sounds depend on the value of the <a href="/source/main/workspace/zero_page.html#soundrevtarget">soundRevTarget</a> variable, which is set to revCount + 25 as part of the <a href="modelling_the_engine.html">engine calculations in the driving model</a> (where <a href="/source/main/workspace/zero_page.html#revcount">revCount</a> is the current rev count, as shown on the rev counter). The <a href="/source/main/workspace/zero_page.html#soundrevcount">soundRevCount</a> variable moves towards the value of soundRevTarget in steps of 1 on each call of the MakeDrivingSounds routine, so the engine sound is constantly trying to match the target in soundRevTarget, pitching up or down in small steps where necessary.</p>

						<p>Note that the sound routines aren't responsible for the throbbing of the engine that you can hear when the engine is idling; that's added by the <a href="/source/main/subroutine/throbrevsnotorque.html">ThrobRevsNoTorque</a> routine, which alters the rev count in a random manner to simulate the idling sound. The sound routine also doesn't affect the rev count itself, it just makes the correct sound depending on the current value of soundRevCount.</p>

						<p>This is how the engine sounds are generated, depending on the value of soundRevCount:</p>

						<ul>
							<li>If soundRevCount &lt; 28:

								<ul>
									<li>The engine is off (revCount &lt; 3)</li>

									<li>The rev counter hand is resting on the pin at 8 o'clock (i.e. the minimum)</li>

									<li>Stop all engine-related sounds</li>
								</ul>
							</li>


							<li>If 28 &lt;= soundRevCount &lt; 64:

								<ul>
									<li>The engine is idling (3 &lt;= revCount &lt; 39)</li>

									<li>When the engine is idling, soundRevCount drops below 28 every now and then, so the engine sound cuts out as if it is misfiring, but generally it stays just above 28</li>

									<li>The rev counter hand is between 8 o'clock and 9 o'clock</li>

									<li>Make the sound of the engine exhaust</li>

									<li>Silence engine tone 1</li>

									<li>Silence engine tone 2</li>
							    </li>
							</ul>

							<li>If 64 &lt;= soundRevCount &lt; 92:

								<ul>
									<li>The engine is revving up (39 &lt;= revCount &lt; 67)</li>

									<li>The rev counter hand is between 9 o'clock and 11 o'clock</li>

									<li>Make the sound of the engine exhaust</li>

									<li>Silence engine tone 1</li>

									<li>Set the pitch of engine tone 2 to soundRevCount - 64 (which in the range 0 to 27)</li>

									<li>Make the sound of engine tone 2</li>
								</ul>
							</li>

							<li>If soundRevCount &gt;= 92:

								<ul>
									<li>The engine is revved up (revCount &gt;= 67)</li>

									<li>The rev counter hand is past 11 o'clock</li>

									<li>Do not make the sound of the engine exhaust</li>

									<li>Set the pitch of engine tone 1 to soundRevCount - 92 (which in the range 0 and up)</li>

									<li>Make the sound of engine tone 1</li>

									<li>Set the pitch of engine tone 2 to soundRevCount - 64 (which in the range 28 and up)</li>

									<li>Make the sound of engine tone 2</li>
								</ul>
							</li>
                        </ul>

                        <p>Note that in the above, the clock-face times are rounded to the nearest hour, to keep things simple. For example, in the last section, both tones kick in when the rev counter passes 3.5 minutes to 12, which is actually a little way after 11 o'clock.</p>

						<h2 class="articleSubheader">Making the sounds<br />
													 -----------------</h2>

						<p>The MakeDrivingSounds is responsible for deciding which engine sounds to make, but the sounds themselves are made by the <a href="/source/main/subroutine/makesound.html">MakeSound</a> routine, which makes all the different sounds in the game.</p>

						<p>There are five different sounds in Revs that are generated by the MakeSound routine:</p>

						<ul>
							<li>Sound #0: Engine exhaust (channel 0)</li>

							<li>Sound #1: Engine tone 1 (channel 1)</li>

							<li>Sound #2: Engine tone 2 (channel 2)</li>

							<li>Sound #3: Tyre squeal (channel 3)</li>

							<li>Sound #4: Crash/contact (channel 0)</li>
						</ul>

						<p>These are all implemented by OSWORD sound commands that are defined in the <a href="/source/main/variable/sounddata.html">soundData</a> table. We've already talked about the first three, and sound #4 is another simple tone that uses the noise channel to make the sound of a crash, or contact with another car or the verge.</p>

						<p>Sound #3 is a more complex sound than the others, and is the only one to use a sound envelope, which generates the sound of the tyres squealing. The envelope data is defined in the <a href="/source/main/variable/envelopedata.html">envelopeData</a> table.</p>

						<p>The sound system buffers the sounds in each channel by noting which channels are in use via the <a href="/source/main/variable/soundbuffer.html">soundBuffer</a> table. This enables individual sound channels to be flushed by the <a href="/source/main/subroutine/flushsoundbuffer.html">FlushSoundBuffer</a> routine, or all four channels to be flushed by the <a href="/source/main/subroutine/flushsoundbuffers.html">FlushSoundBuffers</a> routine. As an example, this is useful when calculating the tyre forces in the <a href="/source/main/subroutine/applytyresandskids.html">ApplyTyresAndSkids</a> routine, where we stop the tyres from squealing as soon as we leave the track, or if the driving model is no longer marking the tyres as skidding.</p>

						<p>So the sounds in Revs might be fairly basic, but there's no doubt that the tyre squeals and engine sounds are important contributors to the feeling of driving the car. I mean, it wouldn't be Revs without revs, right?</p>
					</div>
				</div>

				<div class="codeBlockWrapper nav">
					<nav class="codeBlock previousNext"><a class="previous" rel="prev" title="Previous deep dive" href="text_tokens.html">Text tokens</a><a class="next" rel="next" title="Next deep dive" href="random_numbers.html">Random numbers</a></nav>
				</div>
			</article>

<?php
include_once("../templates_local/navigation.php");

?>
		</div>
	</body>
</html>
